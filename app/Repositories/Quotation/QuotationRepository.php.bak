<?php
declare(strict_types=1);
namespace App\Repositories\Quotation;

use App\Models\Quotation;
use App\Models\QuotationItem;
use App\Models\QuotationInfo;
use App\Models\ItemDescription;
use App\Models\JobEstimateDetails;
use App\Repositories\AbstractValidator;
use App\Exceptions\Validation\ValidationException;
use Config;
use Illuminate\Support\Facades\DB;

class QuotationRepository extends AbstractValidator implements QuotationInterface {
	
	protected $quotation;
	
	protected static $rules = [];
	protected $matservice;
	protected $module;
	
	public function __construct(Quotation $quotation) {
		$this->quotation = $quotation;
		$this->module = DB::table('parameter2')->where('keyname', 'mod_workshop')->where('status',1)->select('is_active')->first();
		$this->matservice = DB::table('parameter2')->where('keyname', 'mod_material_service')->where('status',1)->select('is_active')->first();
	}
	
	public function all()
	{
		return $this->quotation->get();
	}
	
	public function find($id)
	{
	//	echo '<pre>';print_r($id);exit;
		return $this->quotation->where('id', $id)->first();
	}
	
	//set input fields values
	private function setInputValue($attributes)
	{
		
		$this->quotation->voucher_no   = $attributes['voucher_no'];
		$this->quotation->reference_no = $attributes['reference_no'];
		$this->quotation->voucher_date = ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date']));
		$this->quotation->supplier_id  = $attributes['supplier_id'];
	//	$this->quotation->salesman_id  = $attributes['salesman_id'];
		$this->quotation->subject 	 = (isset($attributes['subject']))?$attributes['subject']:'';
		$this->quotation->description  = (isset($attributes['description']))?$attributes['description']:'';
		$this->quotation->job_id 		 = (isset($attributes['job_id']))?$attributes['job_id']:'';
		$this->quotation->header_id 	 = (isset($attributes['header_id']))?$attributes['header_id']:'';
		$this->quotation->footer_id 	 = (isset($attributes['footer_id']))?$attributes['footer_id']:'';
		$this->quotation->is_fc 		  = isset($attributes['is_fc'])?1:0;
		$this->quotation->currency_id   = (isset($attributes['currency_id']))?$attributes['currency_id']:'';
		$this->quotation->currency_rate = (isset($attributes['currency_rate']))?$attributes['currency_rate']:'';
		$this->quotation->is_export		= isset($attributes['is_export'])?1:0;
	//	$this->quotation->vehicle_id		= isset($attributes['vehicle_id'])?$attributes['vehicle_id']:'';
		$this->quotation->job_type		= isset($attributes['job_type'])?$attributes['job_type']:'';
		$this->quotation->jobnature		= isset($attributes['jobnature'])?$attributes['jobnature']:'';
		$this->quotation->fabrication		= isset($attributes['fabrication'])?$attributes['fabrication']:'';
		$this->quotation->prefix			= isset($attributes['prefix'])?$attributes['prefix']:'';
	//	$this->quotation->kilometer		= isset($attributes['kilometer'])?$attributes['kilometer']:'';
		$this->quotation->terms_id 	 = isset($attributes['terms_id'])?$attributes['terms_id']:'';
	//	$this->quotation->customer_enquiry_id  = isset($attributes['quotation_id'])?$attributes['quotation_id']:'';
	//	$this->quotation->location_id = (isset($attributes['location_id']))?$attributes['location_id']:'';	
	//	$this->quotation_sales->location_id = isset($attributes['location_id'])?$attributes['location_id']:$attributes['location_id'];
		
		return true;
	}
	
	private function setJobdetails($attributes) {
							
		if(isset($attributes['opr_description']) && !empty( array_filter($attributes['opr_description'])) ) {
			
			foreach($attributes['opr_description'] as $key => $value){ 
				if($value != '') {
					$jobEstimateDetails = new JobEstimateDetails();
					$jobEstimateDetails->jobestimate_id = $this->quotation->id;
					$jobEstimateDetails->description = $value;
					$jobEstimateDetails->comment = $attributes['opr_comment'][$key];
					$jobEstimateDetails->status = 1;
					$jobEstimateDetails->save();
				}
			}
		}
		
	}
	public function purchaseOrderList()
	{
		$query = $this->quotation->where('quotation.status',1);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','quotation.supplier_id');
						} )
					->select('quotation.*','am.master_name AS supplier')
					->orderBY('quotation.id', 'DESC')
					->get();
	}
	private function setJobdetailsUpdate($attributes) {
		
		if(isset($attributes['opr_description']) && !empty( array_filter($attributes['opr_description'])) ) {
			foreach($attributes['opr_description'] as $key => $value) { 
			
				if(isset($attributes['jobdetail_id'][$key]) && $attributes['jobdetail_id'][$key]!='') {
					
					$jobEstimateDetails = JobEstimateDetails::find($attributes['jobdetail_id'][$key]);
					$items['description'] = $value;
					$items['comment'] = $attributes['opr_comment'][$key];
					$jobEstimateDetails->update($items);
					
				} else { //new entry.....
					
					if($value != '') {
						$jobEstimateDetails = new JobEstimateDetails();
						$jobEstimateDetails->jobestimate_id = $this->quotation->id;
						$jobEstimateDetails->description = $value;
						$jobEstimateDetails->comment = $attributes['opr_comment'][$key];
						$jobEstimateDetails->status = 1;
						$jobEstimateDetails->save();
					}
				}
			}
		}
		//manage removed items...
		if(isset($attributes['opr_description']) && $attributes['remove_desc']!='')
		{
			$arrids = explode(',', $attributes['remove_desc']);
			$remline_total = $remtax_total = 0;
			foreach($arrids as $row) {
				DB::table('jobestimate_details')->where('id', $row)->update(['status' => 0, 'deleted_at' => now()]);
			}
		}
	}
	
	private function setItemInputValue($attributes, $purchaseOrderItem, $key, $value, $lineTotal) 
	{
		if( isset($attributes['is_fc']) ) {
			$tax        = ( ($attributes['cost'][$key] * $attributes['line_vat'][$key]) / 100) * $attributes['currency_rate'];
			$item_total = ( ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $attributes['line_discount'][$key] ) * $attributes['currency_rate'];
			$tax_total  = round($tax * $attributes['quantity'][$key],2);
			$line_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]) * $attributes['currency_rate'];
			$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['tax_code'][$key];
			$type = 'tax_exclude';
		} else {
			$cost= (isset($attributes['cost']))?$attributes['cost']:0;
			$line_vat= (isset($attributes['line_vat']))?$attributes['line_vat']:0;
			$line_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]);
			
			$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['tax_code'][$key];
						
			if(isset($attributes['is_export']) || $tax_code=="EX" || $tax_code=="ZR") {
				
				$tax        = 0;
				$item_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $attributes['line_discount'][$key];
				$tax_total  = round($tax * $attributes['quantity'][$key],2);
				
			} else if($attributes['tax_include'][$key]==1){
				
				$ln_total   = $attributes['cost'][$key] * $attributes['quantity'][$key];
				$tax_total  = $ln_total *  $attributes['line_vat'][$key] / (100 +  $attributes['line_vat'][$key]);
				$item_total = $ln_total - $tax_total;
				
			} else {
				
				//$tax        = ($cost[$key] * $line_vat[$key]) / 100;
				$item_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $attributes['line_discount'][$key];
			//	$tax_total  = round($tax * $attributes['quantity'][$key],2);
			}
		}
		
		//********DISCOUNT Calculation.............
		$discount = (isset($attributes['discount']))?$attributes['discount']:0;
		$type = 'tax_exclude';
			
		if($attributes['tax_include'][$key]==1 ) {
			$vatPlus = 100 + $attributes['line_vat'][$key];
			$total = $attributes['cost'][$key] * $attributes['quantity'][$key];
			$type = 'tax_include';
		} else {
			$vatPlus = 100;
			$total = $attributes['line_total'][$key];
			$type = 'tax_exclude';
		}
		
		if($discount > 0) {
			$discountAmt = round( (($total / $lineTotal) * $discount),2 );
			$amountTotal = $total - $discountAmt;
			$vatLine = round( (($amountTotal * $attributes['line_vat'][$key]) / $vatPlus),2 );
			//$line_total = $amountTotal;
			$tax_total = $vatLine; 
		} 
		
		$purchaseOrderItem->quotation_id = $this->quotation->id;
		$purchaseOrderItem->item_id    		   = $value;
		$purchaseOrderItem->item_name  		   = $attributes['item_name'][$key];
		$purchaseOrderItem->unit_id   		   = $attributes['unit_id'][$key];
		$purchaseOrderItem->quantity   		   = $attributes['quantity'][$key];
		$purchaseOrderItem->unit_price 		   = (isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key];
		$purchaseOrderItem->vat		   		   = $attributes['line_vat'][$key];
		//$purchaseOrderItem->vat_amount 		   = $tax_total;
		$purchaseOrderItem->vat_amount 		   = $attributes['vatline_amt'][$key];
		$purchaseOrderItem->discount   		   = $attributes['line_discount'][$key];
		$purchaseOrderItem->line_total 		   = $line_total;
		$purchaseOrderItem->tax_code 		   = $tax_code;
		$purchaseOrderItem->tax_include 	   = $attributes['tax_include'][$key];
		$purchaseOrderItem->item_total 		   = $item_total;
		
	//	return array('line_total' => $line_total, 'tax_total' => $tax_total, 'type' => $type, 'item_total' => $item_total);//CHG
	return array('line_total' => $line_total, 'type' => $type, 'item_total' => $item_total);//CHG
	

	}
	
	private function setInfoInputValue($attributes, $purchaseOrderInfo, $key, $value)
	{
		$purchaseOrderInfo->quotation_sales_id = $this->quotation_sales->id;
		$purchaseOrderInfo->title 			   = $value;
		$purchaseOrderInfo->description 	   = $attributes['desc'][$key];
		return true;
	}
	
	
	
	private function calculateTotalAmount($attributes) {
		
		$total = 0;
		if(isset($attributes['item_id'])) {
			foreach($attributes['item_id'] as $key => $value){ 
				
				$total += $attributes['quantity'][$key] * $attributes['cost'][$key];
			}
		}
		
		if(isset($attributes['lbitem_id'])) {
			foreach($attributes['lbitem_id'] as $key => $value){ 
				
				$total += $attributes['lbquantity'][$key] * $attributes['lbcost'][$key];
			}
		}
		
		return $total;
	}
	
	private function setTransferStatusItem($attributes, $key)
	{
		//if quantity partially deliverd, update pending quantity.
		if(isset($attributes['quote_sales_item_id'])) {
			if(isset($attributes['actual_quantity']) && ($attributes['quantity'][$key] != $attributes['actual_quantity'][$key])) {
				if( isset($attributes['quote_sales_item_id'][$key]) ) {
					$quantity 	 = $attributes['actual_quantity'][$key] - $attributes['quantity'][$key];
					//update as partially delivered.
					DB::table('customer_enquiry_item')
								->where('id', $attributes['quote_sales_item_id'][$key])
								->update(['balance_quantity' => $quantity, 'is_transfer' => 2]);
				}
			} else {
					//update as completely delivered.
					DB::table('customer_enquiry_item')
								->where('id', $attributes['quote_sales_item_id'][$key])
								->update(['balance_quantity' => 0, 'is_transfer' => 1]);
			}
		}
	}
	
	private function setTransferStatusQuote($attributes)
	{
		//update purchase order transfer status....
		if(isset($attributes['quotation_id'])) {
			$idarr = explode(',',$attributes['quotation_id']);
			if($idarr) {
				foreach($idarr as $id) {
					DB::table('customer_enquiry')->where('id', $id)->update(['is_editable' => 0]);
					$row1 = DB::table('customer_enquiry_item')->where('customer_enquiry_id', $id)->where('status',1)->whereNull('deleted_at')->count();
					$row2 = DB::table('customer_enquiry_item')->where('customer_enquiry_id', $id)->where('status',1)->whereNull('deleted_at')->where('is_transfer',1)->count();
					if($row1==$row2) {
						DB::table('customer_enquiry')
								->where('id', $id)
								->update(['is_transfer' => 1]);
					}
				}
			}
		}
	}
	
	//SEP25
	protected function addService($attributes) {
		
		$linetotal = $taxtotal = $itemtotal = $lbtax_total = $vat = 0; $type = 'tax_include';
		$discount = (isset($attributes['discount']))?$attributes['discount']:0;
		if($discount > 0)
			$lineTotal = $this->calculateTotalAmount($attributes);
		
		if(isset($attributes['lbitem_id'])) {
			foreach($attributes['lbitem_id'] as $key => $value){ 
			
				$quotationSalesItem = new QuotationItem();
				
				//------------ SEP25
				$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['lbtax_code'][$key];
				$lbline_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);		
				if(isset($attributes['is_export']) || $tax_code=="EX" || $tax_code=="ZR") {
					$tax        = 0;
					$lbitem_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);// - $attributes['line_discount'][$key];
					$lbtax_total  = round($tax * $attributes['lbquantity'][$key],2);
					
				} else if($attributes['lbtax_include'][$key]==1){
					
					$ln_total   = $attributes['lbcost'][$key] * $attributes['lbquantity'][$key];
					$lbtax_total  = $ln_total *  $attributes['lbline_vat'][$key] / (100 +  $attributes['lbline_vat'][$key]);
					$lbitem_total = $ln_total - $lbtax_total;
					
				} else {
					
					/* $tax        = ($attributes['lbcost'][$key] * $attributes['lbline_vat'][$key]) / 100;
					$item_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);// - $attributes['line_discount'][$key];
					$tax_total  = round($tax * $attributes['lbquantity'][$key],2); */
					
					$tax        = ($attributes['lbcost'][$key] * $attributes['lbline_vat'][$key]) / 100;
					$lbitem_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
					$lbtax_total  = round($tax * $attributes['lbquantity'][$key],2);
					$lbline_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
				}
				//--------
				
				/* $tax        = ($attributes['lbcost'][$key] * $attributes['lbline_vat'][$key]) / 100;
				$lbitem_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
				$lbtax_total  = round($tax * $attributes['lbquantity'][$key],2);
				$lbline_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]); */
				
				$type = 'tax_exclude'; //SEP25
				if($attributes['lbtax_include'][$key]==1 ) {
					$vatPlus = 100 + $attributes['lbline_vat'][$key];
					$total = $attributes['lbcost'][$key] * $attributes['lbquantity'][$key];
					$type = 'tax_include';
				} else {
					$vatPlus = 100;
					$total = $attributes['lbline_total'][$key];
					$type = 'tax_exclude';
				}
				
				if($discount > 0) {
					$discountAmt = round( (($total / $lineTotal) * $discount),2 );
					$amountTotal = $total - $discountAmt;
					$vatLine = round( (($amountTotal * $attributes['lbline_vat'][$key]) / $vatPlus),2 );
					$lbtax_total = $vatLine; 
				}
					
				$quotationSalesItem->quotation_sales_id = $this->quotation->id;
				$quotationSalesItem->item_id    		= $value;
				$quotationSalesItem->item_name  		= $attributes['lbitem_name'][$key];
				$quotationSalesItem->unit_id 			= $attributes['lbunit_id'][$key];
				$quotationSalesItem->quantity   		= $attributes['lbquantity'][$key];
				$quotationSalesItem->unit_price 		= (isset($attributes['is_fc']))?$attributes['lbcost'][$key]*$attributes['currency_rate']:$attributes['lbcost'][$key];
				$quotationSalesItem->vat		    	= $attributes['lbline_vat'][$key];
				$quotationSalesItem->vat_amount 		= $lbtax_total;
				$quotationSalesItem->discount   		= $attributes['lbline_discount'][$key];
				$quotationSalesItem->line_total 		= $lbline_total;
				$quotationSalesItem->tax_code 			= $attributes['lbtax_code'][$key];
				$quotationSalesItem->tax_include 		= $attributes['lbtax_include'][$key];
				$quotationSalesItem->item_total 		= $lbitem_total;
				$quotationSalesItem->item_type = 1;
				$quotationSalesItem->status = 1;
				$itemObj = $this->quotation->quotationItem()->save($quotationSalesItem);
				
				$linetotal += $lbline_total;
				$taxtotal += $lbtax_total;
				$itemtotal += $lbitem_total;
				$vat = $attributes['lbline_vat'][$key];
			}
		}
		return array('line_total' => $linetotal, 'tax_total' => $taxtotal, 'item_total' => $itemtotal, 'type' => $type, 'vat' => $vat );//SEP25
	}
	
	//SEP25
	protected function updateService($attributes)
	{
		
		$line_total = $tax_total = $item_total = $lbtax_total = 0;
		$discount = (isset($attributes['discount']))?$attributes['discount']:0;
		if($discount > 0)
			$lineTotal = $this->calculateTotalAmount($attributes);
	   //
		foreach($attributes['lbitem_id'] as $key => $value) { 
					
			if($attributes['lborder_item_id'][$key]!='') {
				
				$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['lbtax_code'][$key];
				$linetotal = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
				
				if(isset($attributes['is_export']) || $tax_code=="EX" || $tax_code=="ZR") {
					//echo '<pre>';print_r($attributes);exit;
					$tax        = 0;
					$itemtotal = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);// - $attributes['line_discount'][$key];
					$lbtax_total  = round($tax * $attributes['lbquantity'][$key],2);
					
				} else if($attributes['lbtax_include'][$key]==1){
					
					$ln_total   = $attributes['lbcost'][$key] * $attributes['lbquantity'][$key];
					$lbtax_total  = $ln_total *  $attributes['lbline_vat'][$key] / (100 +  $attributes['lbline_vat'][$key]);
					$itemtotal = $ln_total - $lbtax_total;
					
				} else {
					
					$tax        = ($attributes['lbcost'][$key] * $attributes['lbline_vat'][$key]) / 100;
					$itemtotal = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
					$lbtax_total  = round($tax * $attributes['lbquantity'][$key], 2);
				}
				
				$type = 'tax_exclude';
				if($attributes['lbtax_include'][$key]==1 ) {
					$vatPlus = 100 + $attributes['lbline_vat'][$key];
					$total = $attributes['lbcost'][$key] * $attributes['lbquantity'][$key];
					$type = 'tax_include';
				} else {
					$vatPlus = 100;
					$total = $attributes['lbline_total'][$key];
					$type = 'tax_exclude';
				}
				
				if($discount > 0) {
					$discountAmt = round( (($total / $lineTotal) * $discount),2 );
					$amountTotal = $total - $discountAmt;
					$vatLine = round( (($amountTotal * $attributes['lbline_vat'][$key]) / $vatPlus),2 );
					$lbtax_total = $vatLine; 
				}
				
				$quotationSalesItem = QuotationItem::find($attributes['lborder_item_id'][$key]);
				$oldqty = $quotationSalesItem->quantity;
				$items['item_name'] = $attributes['lbitem_name'][$key];
				$items['item_id'] = $value;
				$items['unit_id'] = $attributes['lbunit_id'][$key];
				$items['quantity'] = $attributes['lbquantity'][$key];
				$items['unit_price'] = (isset($attributes['is_fc']))?$attributes['lbcost'][$key]*$attributes['currency_rate']:$attributes['lbcost'][$key];
				$items['vat']		 = $attributes['lbline_vat'][$key];
				$items['vat_amount'] = $lbtax_total;
				$items['discount'] = $attributes['lbline_discount'][$key];
				$items['line_total'] = $linetotal;
				$items['item_total'] = $itemtotal;
				$items['tax_code'] 	= $attributes['lbtax_code'][$key];
				$items['tax_include'] = $attributes['lbtax_include'][$key];//CHG
				$exi_quantity = $quotationSalesItem->quantity;
				$quotationSalesItem->update($items);
				
				$tax_total += $lbtax_total;
				$line_total += $linetotal;
				$item_total += $itemtotal;
				
			} else { //add new service
				
				$quotationSalesItem = new QuotationItem();
				
				$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['lbtax_code'][$key];
				$lbline_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);		
				if(isset($attributes['is_export']) || $tax_code=="EX" || $tax_code=="ZR") {
					$tax        = 0;
					$lbitem_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);// - $attributes['line_discount'][$key];
					$lbtax_total  = round($tax * $attributes['lbquantity'][$key],2);
					
				} else if($attributes['lbtax_include'][$key]==1){
					
					$ln_total   = $attributes['lbcost'][$key] * $attributes['lbquantity'][$key];
					$lbtax_total  = $ln_total *  $attributes['lbline_vat'][$key] / (100 +  $attributes['lbline_vat'][$key]);
					$lbitem_total = $ln_total - $lbtax_total;
					
				} else {
					$tax        = ($attributes['lbcost'][$key] * $attributes['lbline_vat'][$key]) / 100;
					$lbitem_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
					$lbtax_total  = round($tax * $attributes['lbquantity'][$key],2);
					$lbline_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
				}
				
				$type = 'tax_exclude';
				if($attributes['lbtax_include'][$key]==1 ) {
					$vatPlus = 100 + $attributes['lbline_vat'][$key];
					$total = $attributes['lbcost'][$key] * $attributes['lbquantity'][$key];
					$type = 'tax_include';
				} else {
					$vatPlus = 100;
					$total = $attributes['lbline_total'][$key];
					$type = 'tax_exclude';
				}
				
				if($discount > 0) {
					$discountAmt = round( (($total / $lineTotal) * $discount),2 );
					$amountTotal = $total - $discountAmt;
					$vatLine = round( (($amountTotal * $attributes['lbline_vat'][$key]) / $vatPlus),2 );
					$lbtax_total = $vatLine; 
				}
				
				$quotationSalesItem->quotation_id = $this->quotation->id;
				$quotationSalesItem->item_id    		= $value;
				$quotationSalesItem->item_name  		= $attributes['lbitem_name'][$key];
				$quotationSalesItem->unit_id 			= $attributes['lbunit_id'][$key];
				$quotationSalesItem->quantity   		= $attributes['lbquantity'][$key];
				$quotationSalesItem->unit_price 		= (isset($attributes['is_fc']))?$attributes['lbcost'][$key]*$attributes['currency_rate']:$attributes['lbcost'][$key];
				$quotationSalesItem->vat		    	= $attributes['lbline_vat'][$key];
				$quotationSalesItem->vat_amount 		= $lbtax_total;
				$quotationSalesItem->discount   		= $attributes['lbline_discount'][$key];
				$quotationSalesItem->line_total 		= $lbline_total;
				$quotationSalesItem->tax_code 		= $attributes['lbtax_code'][$key];
				$quotationSalesItem->tax_include 		= $attributes['lbtax_include'][$key];
				$quotationSalesItem->item_total 		= $lbitem_total;
				$quotationSalesItem->item_type = 1;
				$quotationSalesItem->status = 1;
				
				$itemObj = $this->quotation->quotationItem()->save($quotationSalesItem);
				
				$line_total += $lbline_total;
				$tax_total += $lbtax_total;
				$item_total += $lbitem_total;
			}
			
			$vat = $attributes['lbline_vat'][$key];
		}
		return array('line_total' => $line_total, 'tax_total' => $tax_total, 'item_total' => $item_total, 'type' => $type, 'vat' => $vat );
		//return array('line_total' => $line_total, 'tax_total' => $tax_total, 'item_total' => $item_total);	
	}
	
	
	public function create($attributes)
	{
		//echo '<pre>';print_r($attributes);exit;
		if($this->isValid($attributes)) {
			DB::beginTransaction();
			try {
				
				/* $qs = DB::table('voucher_no')->where('voucher_type', 'QS')->where('status',1)->select('no AS voucher_no')->first();
				$attributes['voucher_no'] = $qs->voucher_no; */

				
				if($this->setInputValue($attributes)) {
					$this->quotation->status 	   = 1;
					$this->quotation->created_at = now();
					$this->quotation->created_by = 1;
					$this->quotation->fill($attributes)->save();
					
					//check workshop version active...
					if($this->module->is_active==1 && $this->quotation->id) {
						$this->setJobdetails($attributes);
					}
				}
				
				$line_total = 0; $tax_total = 0; $total = $item_total = 0; $taxtype = '';
				$discount = (isset($attributes['discount']))?$attributes['discount']:0;
				
				//quotation sales items insert
				if($this->quotation->id && !empty( array_filter($attributes['item_id']))) {
					
					
					//calculate total amount....2
					if($discount > 0) 
						$total = $this->calculateTotalAmount($attributes);
					
					foreach($attributes['item_id'] as $key => $value) { 
						$purchaseOrderItem 		   = new QuotationItem();
						$vat = $attributes['line_vat'][$key];
						$arrResult 			  	   = $this->setItemInputValue($attributes, $purchaseOrderItem, $key, $value, $total);
						
						//if($arrResult['line_total']) {
							$line_total				  += $arrResult['line_total'];
						//	$tax_total      		  += $arrResult['tax_total'];
							$taxtype				  = $arrResult['type'];
							$item_total				 += $arrResult['item_total'];
								
							$purchaseOrderItem->status = 1;
							$itemObj = $this->quotation->quotationItemAdd()->save($purchaseOrderItem);
							//echo '<pre>';print_r($itemObj );exit;
							$this->setTransferStatusItem($attributes, $key);
							
							//item description section....
							if(isset($attributes['itemdesc'][$key])) {
								foreach($attributes['itemdesc'][$key] as $descrow) {
									if($descrow != '') {
										$itemDescription = new ItemDescription();
										$itemDescription->invoice_type = 'QS';
										$itemDescription->item_detail_id = $itemObj->id;
										$itemDescription->description = $descrow;
										$itemDescription->status = 1;
										$itemDescription->save();
									}
								}
							}
					//	}
						
					}
				 }
					//Check material service module..........
					if($this->matservice->is_active==1) {
						
						$arrResult = $this->addService($attributes);
						
						$line_total			     += $arrResult['line_total'];
						$tax_total      	     += $arrResult['tax_total'];
						$item_total				 += $arrResult['item_total'];
						$taxtype				  = $arrResult['type'];//SEP25
						$vat					  = $arrResult['vat'];//SEP25
					}
					
					
					/*CHG*/
					//echo $line_total.' - '.$discount;
				//	$discounts = (isset($attributes['discount']))?$attributes['discount']:'';
					
				//	$subtotal = $line_total - $discounts;
				$subtotal = $line_total;
				
					if($taxtype=='tax_include' && $attributes['discount'] == 0) {
					  
					  $net_amount = $subtotal;
					  $tax_total = ($subtotal * $vat) / (100 + $vat);
					  $subtotal = $subtotal - $tax_total;
					  
					} elseif($taxtype=='tax_include' && $attributes['discount'] > 0) { 
					
					   $tax_total = ($subtotal * $vat) / (100 + $vat);
					   $net_amount = $subtotal - $tax_total;
					} else 
						$net_amount = $subtotal + $tax_total;
					/*CHG*/
						
					if( isset($attributes['is_fc']) ) {
						$total_fc 	   = $line_total / $attributes['currency_rate'];
						$discount_fc   = $attributes['discount'] / $attributes['currency_rate'];
						$vat_fc 	   = $attributes['vat_fc'] / $attributes['currency_rate'];
						$tax_fc 	   = $tax_total / $attributes['currency_rate'];
						$net_amount_fc = $total_fc - $discount_fc + $tax_fc;
						$subtotal_fc	   = $subtotal / $attributes['currency_rate'];
					} else {
						$total_fc = $discount_fc = $tax_fc = $net_amount_fc = $vat_fc = $subtotal_fc = 0;
					}
					//VOUCHER NO INCREMENT LOGIC//
					if( $attributes['curno'] == $attributes['voucher_no'] ) {
						$cnt = 0;
						do {
							
							$jvset = DB::table('voucher_no')->where('voucher_type', 'QP')->where('status',1)->select('no AS voucher_no','prefix')->first();
							if($jvset) {
								if($jvset->prefix==0) {
									$attributes['voucher_no'] = $jvset->voucher_no + $cnt;
									$attributes['vno'] = $jvset->voucher_no + $cnt;
								} else {
									$attributes['voucher_no'] = $jvset->prefix.($jvset->voucher_no + $cnt);
									$attributes['vno'] = $jvset->voucher_no + $cnt;
								}
								$attributes['curno'] = $attributes['voucher_no'];
							}
							$inv = DB::table('quotation')->where('id','!=',$this->quotation->id)->where('voucher_no',$attributes['voucher_no'])->where('status',1)->whereNull('deleted_at')->count();
							
							$cnt++;
						} while ($inv!=0);
					} 
					//VOUCHER NO INCREMENT LOGIC//
					//update discount, total amount
					DB::table('quotation')
								->where('id', $this->quotation->id)
								->update(['voucher_no' => $attributes['voucher_no'],
									      'total'      => $line_total,
										  'discount'   => (isset($attributes['discount']))?$attributes['discount']:0,
										  'vat_amount' => $tax_total,
										  'net_amount'  => $net_amount,
										  'total_fc'   => $total_fc,
										  'discount_fc'=> $discount_fc,
										  'net_amount_fc' => $net_amount_fc,
										//  'vat_amount_fc' => $tax_fc,
										  'subtotal'	  => $subtotal,
										  'subtotal_fc'	  => $subtotal_fc,
										  'footer_text'	  => (isset($attributes['foot_description']))?$attributes['foot_description']:''
										  ]);
				//}
				
				//quotation info insert
				if($this->quotation->id && isset($attributes['title']) && !empty( array_filter($attributes['title']))) {
					foreach($attributes['title'] as $key => $value) {
						$purchaseOrderInfo 			= new QuotationInfo();
						if($this->setInfoInputValue($attributes, $purchaseOrderInfo, $key, $value)) {
							$purchaseOrderInfo->status = 1;
							$this->quotation->quotationInfoAdd()->save($purchaseOrderInfo);
						}
					}
				}
				
				$this->setTransferStatusQuote($attributes);
				
				//update voucher number
				if( ($attributes['curno']!='') && ($this->quotation->id && $attributes['autoincrement']==1) && ($attributes['curno'] == $attributes['voucher_no']) ) { 
					//update voucher number
					if($this->quotation->id) {
						if(isset($attributes['jobtype'])) {
							if($attributes['jobtype']==0) {
								 DB::table('voucher_no')
									->where('voucher_type', $attributes['voucher_type'])
									->update(['no' => DB::raw('no + 1') ]);
							}
						} else {
							DB::table('voucher_no') 
								->where('voucher_type', $attributes['voucher_type'])
								->update(['no' => DB::raw('no + 1') ]);
						}
					}
				}
				
				DB::commit();
				return $this->quotation->id;//true;
				
			} catch(\Exception $e) { 
			
				DB::rollback(); echo $e->getLine().' - '.$e->getMessage();exit;
				return false;
			}
		}
		
	}
	// public function getItemDesc($id)
	// {
	// 	return DB::table('quotation')
	// 					->join('quotation_item AS QSI', function($join) {
	// 						$join->on('QSI.quotation_id', '=', 'quotation.id');
	// 					})
	// 					->join('item_description AS D', function($join) {
	// 						$join->on('D.item_detail_id', '=', 'QSI.id');
	// 					})
	// 					->where('quotation.id', $id)
	// 					->where('D.invoice_type','QS')
	// 					->where('QSI.status',1)
	// 					->where('QSI.deleted_at','0000-00-00 00:00:00')
	// 					->where('D.status',1)
	// 					->where('D.deleted_at','0000-00-00 00:00:00')
	// 					->select('D.*')
	// 					->get();
	// }
	public function getQuotationItems($id)
	{
		$query = $this->quotation->where('quotation.id',$id);
		
		return $query->join('quotation_item AS qi', function($join) {
							$join->on('qi.quotation_id','=','quotation.id');
						} )
					  ->join('units AS u', function($join){
						  $join->on('u.id','=','qi.unit_id');
					  }) 
					  ->join('itemmaster AS im', function($join){
						  $join->on('im.id','=','qi.item_id');
					  })
					  ->select('qi.*','u.unit_name','im.item_code')->get();
	}
	public function findQuotation($id)
	{
		$query = $this->quotation->where('quotation.id', $id);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','quotation.supplier_id');
						} )
					->leftJoin('header_footer AS h',function($join) {
						$join->on('h.id','=','quotation.header_id');
					})
					->leftJoin('header_footer AS f',function($join) {
						$join->on('f.id','=','quotation.footer_id');
					})
					->leftJoin('jobmaster AS J',function($join) {
						$join->on('J.id','=','quotation.job_id');
					})
					->select('quotation.*','am.master_name AS supplier','h.title AS header','f.title AS footer','J.code')
					->orderBY('quotation.id', 'ASC')
					->first();
	}	
	public function update($id, $attributes)
	{
		$this->quotation = $this->find($id);
		$line_total = $tax_total = $line_total_new = $tax_total_new = $item_total = $total = 0;
		//echo '<pre>';print_r($this->quotation->id);exit;
		DB::beginTransaction();
		try {
			
			//check workshop version active...
			 if($this->module->is_active==1 && $this->quotation->id) {
			 	$this->setJobdetailsUpdate($attributes);
			 }
			
			$discount = (isset($attributes['discount']))?$attributes['discount']:0; $taxtype = '';
			$lineTotal = $this->calculateTotalAmount($attributes);
			if($this->quotation->id && !empty( array_filter($attributes['item_id']))) {
				
				foreach($attributes['item_id'] as $key => $value) { 
					
					if($attributes['order_item_id'][$key]!='') {
							$deskey = $attributes['order_item_id'][$key];
							$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['tax_code'][$key];
							
							if( isset($attributes['is_fc']) ) {
									$tax        = ( ($attributes['cost'][$key] * $attributes['line_vat'][$key]) / 100) * $attributes['currency_rate'];
									$itemtotal = ( ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $attributes['line_discount'][$key] ) * $attributes['currency_rate'];
									$taxtotal  = round($tax * $attributes['quantity'][$key],2);
									$linetotal = ($attributes['cost'][$key] * $attributes['quantity'][$key]) * $attributes['currency_rate'];
									
							} else {
								
								$linetotal = ($attributes['cost'][$key] * $attributes['quantity'][$key]);
								
								if(isset($attributes['is_export']) || $tax_code=="EX" || $tax_code=="ZR") {
									
									$tax        = 0;
									$itemtotal = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $attributes['line_discount'][$key];
									$taxtotal  = round($tax * $attributes['quantity'][$key],2);
									
								} else if($attributes['tax_include'][$key]==1){
									
									$ln_total   = $attributes['cost'][$key] * $attributes['quantity'][$key];
									$taxtotal  = $ln_total *  $attributes['line_vat'][$key] / (100 +  $attributes['line_vat'][$key]);
									$itemtotal = $ln_total - $taxtotal;
									
								} else {
									
									$tax        = ($attributes['cost'][$key] * $attributes['line_vat'][$key]) / 100;
									$itemtotal = (int)($attributes['cost'][$key] * (int)$attributes['quantity'][$key]) - (int)$attributes['line_discount'][$key];
									$taxtotal  = round($tax * $attributes['quantity'][$key],2);
								}
							}
							
							//********DISCOUNT Calculation.............
							$discount = (isset($attributes['discount']))?$attributes['discount']:0;
							$taxtype = 'tax_exclude';
								
							if($attributes['tax_include'][$key]==1 ) {
								$vatPlus = 100 + $attributes['line_vat'][$key];
								$total = $attributes['cost'][$key] * $attributes['quantity'][$key];
								$taxtype = 'tax_include';
							} else {
								$vatPlus = 100;
								$total = $attributes['line_total'][$key];
								$taxtype = 'tax_exclude';
							}
							
							if($discount > 0) {
								$discountAmt = round( (($total / $lineTotal) * $discount),2 );
								$amountTotal = $total - $discountAmt;
								$vatLine = round( (($amountTotal * $attributes['line_vat'][$key]) / $vatPlus),2 );
								$taxtotal = $vatLine; 
							} 
							
							$tax_total += $taxtotal;
							$line_total += $linetotal;
							$item_total += $itemtotal;
							
							$vat = $attributes['line_vat'][$key];
						//	$is_rental = (isset($attributes['is_rental']))?$attributes['is_rental']:''; 
										
							$quotationSalesItem = QuotationItem::find($attributes['order_item_id'][$key]);
							$items['item_name'] = $attributes['item_name'][$key];
							$items['item_id'] = $value;
							$items['unit_id'] = $attributes['unit_id'][$key];
							$items['quantity'] = $attributes['quantity'][$key];
							$items['unit_price'] = (isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key];
							$items['vat']		 = $attributes['line_vat'][$key];
							$items['vat_amount'] = $attributes['vatline_amt'][$key];
							$items['discount'] = $attributes['line_discount'][$key];
							$items['line_total'] = $linetotal;
							$items['item_total'] = $itemtotal; //CHG
							$items['tax_code'] 	= $tax_code;
							
							$items['tax_include'] = $attributes['tax_include'][$key];
							$quotationSalesItem->update($items);
							
							//description update...
							if(isset($attributes['desc_id'])) {
								if(array_key_exists($deskey, $attributes['desc_id'])) {
									foreach($attributes['desc_id'][$deskey] as $k => $v) {
										if($v!='') {
											$itemDescription = ItemDescription::find($v);
											$desc['description'] = $attributes['itemdesc'][$deskey][$k];
											$itemDescription->update($desc);
										} else {
											//new entry.........
											$itemDescription = new ItemDescription();
											$itemDescription->invoice_type = 'QP';
											$itemDescription->item_detail_id = $deskey;
											$itemDescription->description = $attributes['itemdesc'][$deskey][$k];
											$itemDescription->status = 1;
											$itemDescription->save();
											
										}
									}
								}
							} else {
								//new entry description.........
								if(isset($attributes['itemdesc'][$key])) {
									foreach($attributes['itemdesc'][$key] as $descrow) {
										if($descrow != '') {
											$itemDescription = new ItemDescription();
											$itemDescription->invoice_type = 'QP';
											$itemDescription->item_detail_id = $deskey;
											$itemDescription->description = $descrow;
											$itemDescription->status = 1;
											$itemDescription->save();
										}
									}
								}
							}

							//manage removed item description...
							if(isset($attributes['remove_itemdesc']) && isset($attributes['remove_itemdesc'][$key]) && $attributes['remove_itemdesc'][$key]!='')
							{
								$arrids = explode(',', $attributes['remove_itemdesc'][$key]);
								foreach($arrids as $row) {
									DB::table('item_description')->where('id', $row)->update(['status' => 0,'deleted_at' => now()]);
								}
							}
							
							
						} else { //new entry...
							$item_total_new = $tax_total_new = $item_total_new = 0;
							if($discount > 0) 
								$total = $this->calculateTotalAmount($attributes);
							
							$vat = $attributes['line_vat'][$key];
							$quotationSalesItem = new QuotationItem();
							$arrResult 		= $this->setItemInputValue($attributes, $quotationSalesItem, $key, $value ,$total);//CHG
							if($arrResult['line_total']) {
								$line_total_new 		 += $arrResult['line_total'];
								$tax_total_new      	 += $arrResult['tax_total'];
								$item_total_new			 += $arrResult['item_total']; //CHG
									
								$line_total			     += $arrResult['line_total'];
								$tax_total      	     += $arrResult['tax_total'];
								$item_total 			 += $arrResult['item_total'];
								$taxtype				  = $arrResult['type'];
								$quotationSalesItem->status = 1;
								$itemObj = $this->quotation->quotationItemAdd()->save($quotationSalesItem);
								
								//new entry description.........
								if(isset($attributes['itemdesc'][$key])) {
									foreach($attributes['itemdesc'][$key] as $descrow) {
										if($descrow != '') {
											$itemDescription = new ItemDescription();
											$itemDescription->invoice_type = 'QP';
											$itemDescription->item_detail_id = $itemObj->id;
											$itemDescription->description = $descrow;
											$itemDescription->status = 1;
											$itemDescription->save();
										}
									}
								}
							}
						}
						
					}
				}
				
				
				//check workshop version active...
				if($this->matservice->is_active==1 && $this->quotation->id) {
					$arrResult = $this->updateService($attributes);
					
					$line_total	+= $arrResult['line_total'];
					$tax_total  += $arrResult['tax_total'];
					$item_total += $arrResult['item_total'];
					$taxtype				  = $arrResult['type'];//SEP25
					$vat					  = $arrResult['vat'];//SEP25
					
					//manage removed service...
					if($attributes['lbremove_item']!='')
					{
						$arrids = explode(',', $attributes['lbremove_item']);
						$remline_total = $remtax_total = 0;
						foreach($arrids as $row) {
							DB::table('quotation_item')->where('id', $row)->update(['status' => 0,'deleted_at' => now()]);
						}
					}
				}
				
				
				//manage removed items...
				if($attributes['remove_item']!='')
				{
					$arrids = explode(',', $attributes['remove_item']);
					$remline_total = $remtax_total = 0;
					foreach($arrids as $row) {
						DB::table('quotation_item')->where('id', $row)->update(['status' => 0, 'deleted_at' => now()]);
					}
				}
				
				$this->quotation->voucher_date  = ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date']));
				$this->quotation->fill($attributes)->save();
				
				/*CHG*/
				$subtotal = $line_total - $discount;
				if($taxtype=='tax_include' && $attributes['discount'] == 0) {
				  
				  $net_amount = $subtotal;
				  $tax_total = ($subtotal * $vat) / (100 + $vat);
				  $subtotal = $subtotal - $tax_total;
				  
				} elseif($taxtype=='tax_include' && $attributes['discount'] > 0) { 
				
				   $tax_total = ($subtotal * $vat) / (100 + $vat);
				   $net_amount = $subtotal - $tax_total;
				} else 
					$net_amount = $subtotal + $tax_total;
				/*CHG*/
					
				if( isset($attributes['is_fc']) ) {
					$total_fc 	   = $line_total / $attributes['currency_rate'];
					$discount_fc   = $attributes['discount'] / $attributes['currency_rate'];
					$vat_fc 	   = $attributes['vat_fc'] / $attributes['currency_rate'];
					$tax_fc 	   = $tax_total / $attributes['currency_rate'];
					$net_amount_fc = $total_fc - $discount_fc + $tax_fc;
					$subtotal_fc	   = $subtotal / $attributes['currency_rate']; //CHG
				} else {
					$total_fc = 0; $discount_fc = 0; $tax_fc = 0; $net_amount_fc = 0; $vat_fc = $subtotal_fc = 0;
				}
				
				//update discount, total amount
				DB::table('quotation')
							->where('id', $this->quotation->id)
							->update(['total'    	  => $line_total,
									  'discount' 	  => $attributes['discount'],
									  'vat_amount'	  => $tax_total,
									  'net_amount'	  => $net_amount,
									  'total_fc' 	  => $total_fc,
									  'discount_fc'   => $discount_fc,
									//  'vat_amount_fc' => $tax_fc,
									  'net_amount_fc'  => $net_amount_fc,
									  'modify_at' 	  => now(),
									  'subtotal'	  => $subtotal, //CHG
									  'subtotal_fc'	  => $subtotal_fc,
									  'footer_text'	  => isset($attributes['foot_description'])?$attributes['foot_description']:'',
									//  'doc_status' 	  => (isset($attributes['doc_status']))?$attributes['doc_status']:'',
								//	  'comment'		  => (isset($attributes['comment']))?$attributes['comment']:((isset($attributes['comment_hd']))?$attributes['comment_hd']:'')
									  ]); //CHG
									  
				
										  
			DB::commit();
			return true;
			
		} catch(\Exception $e) {
			
			DB::rollback(); echo $e->getLine().' - '.$e->getMessage();exit;
			return false;
		}
	}
	
	
	public function delete($id)
	{
		$this->quotation = $this->quotation->find($id);
		DB::table('quotation')->where('id', $id)
									  ->update(['status' => 0, 'deleted_at' => now(),'deleted_by' => Auth::User()->id ]);
		$this->quotation->delete();
	}
	
	public function quotationSalesList()
	{
		$query = $this->quotation->where('quotation.status',1);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','quotation.supplier_id');
						} )
					->leftJoin('vehicle AS V', function($join) {
							$join->on('V.id','=','quotation.vehicle_id');
						} )
					->select('quotation.*','am.master_name AS supplier','V.reg_no','V.name AS vehicle')
					->orderBY('quotation.id', 'DESC')
					->get();
	}
	
	public function getCustomerQuotation($supplier_id=null)
	{
		 $qry = $this->quotation
							 ->where('quotation.status', 1);
							 
				if($supplier_id)
					$qry->where('quotation.supplier_id', $supplier_id);
					
				return	$qry->where('quotation.is_transfer', 0)
							 ->select('quotation.id','quotation.voucher_no','quotation.voucher_date','quotation.prefix','quotation.net_amount')
							 ->get();
		
	}
	
		
	public function findQuoteData($id)
	{
		$query = $this->quotation->where('quotation.id', $id)->where('quotation.is_transfer', 0);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','quotation.supplier_id');
						} )
					->leftJoin('header_footer AS h',function($join) {
						$join->on('h.id','=','quotation.header_id');
					})
					->leftJoin('header_footer AS f',function($join) {
						$join->on('f.id','=','quotation.footer_id');
					})
					->leftJoin('salesman AS S', function($join) {
						$join->on('S.id','=','am.salesman_id');
					} )
					->select('quotation.*','am.master_name AS supplier','h.title AS header','f.title AS footer','S.name AS salesman','S.id AS salesman_id')
					->orderBY('quotation.id', 'ASC')
					->first();
	}
	
	public function activeQuotationSalesList()
	{
		return $this->quotation->select('id','name')->where('status', 1)->orderBy('name', 'ASC')->get()->toArray();
	}
	
	public function check_reference_no($refno, $id = null) { 
		
		if($id)
			return $this->quotation->where('reference_no',$refno)->where('id', '!=', $id)->count();
		else
			return $this->quotation->where('reference_no',$refno)->count();
	}
		
	public function getQuotationReport($attributes) 
	{
		$result = array();
		
		if($attributes['date_from']!=null && $attributes['date_to']!=null) {
			$date_from = (isset($attributes['date_from']))?date('Y-m-d', strtotime($attributes['date_from'])):'';
			$date_to = (isset($attributes['date_to']))?date('Y-m-d', strtotime($attributes['date_to'])):'';
			
			$result = $this->quotation->where('quotation.status',1)
								    ->join('account_master AS AM', function($join) {
									   $join->on('AM.id','=','quotation.supplier_id');
								   })
								   ->leftJoin('jobmaster AS JM', function($join) {
									   $join->on('JM.id','=','quotation.job_id');
								   })
								   ->whereBetween('voucher_date', array($date_from, $date_to))
								   ->select('AM.master_name AS supplier','quotation.*','JM.name AS job')
								   ->orderBY('id', 'ASC')
								   ->get();
		} else {
			$result = $this->quotation->where('quotation.status',1)
								   ->join('account_master AS AM', function($join) {
									   $join->on('AM.id','=','quotation.supplier_id');
								   })
								   ->leftJoin('jobmaster AS JM', function($join) {
									   $join->on('JM.id','=','quotation.job_id');
								   })
								   ->select('AM.master_name AS supplier','quotation.*','JM.name AS job')
								   ->orderBY('quotation.id', 'ASC')
								   ->get();
		}
		
		return $result; 
	}
	
	public function getQuotation($attributes)
	{
		$order = $this->quotation->where('quotation.id', $attributes['document_id'])
								   ->join('account_master AS AM', function($join) {
									   $join->on('AM.id','=','quotation.supplier_id');
								   })
								   ->leftJoin('currency AS C', function($join) {
									   $join->on('C.id','=','quotation.currency_id');
								   })
								   ->leftJoin('header_footer AS F', function($join) {
									   $join->on('F.id','=','quotation.footer_id');
								   })
								   ->leftJoin('header_footer AS H', function($join) {
									   $join->on('H.id','=','quotation.header_id');
								   })
								   ->leftJoin('vehicle AS V', function($join) {
									   $join->on('V.id','=','quotation.vehicle_id');
								   })
								    ->leftJoin('salesman AS SL', function($join) {
									   $join->on('SL.id','=','quotation.salesman_id');
								   })
								   ->leftJoin('terms AS T', function($join) {
									   $join->on('T.id','=','quotation.terms_id');
								   })
								   ->select('AM.account_id','AM.master_name AS supplier','quotation.*','AM.address','AM.city','H.description AS header','T.description AS terms',
											'AM.state','AM.contact_name','AM.vat_no','AM.phone AS custphone','C.name AS currency','F.description AS footer','V.*','SL.name AS salesman')
								   ->orderBY('quotation.id', 'ASC')
								   ->first();
								   
		$items = $this->quotation->where('quotation.id', $attributes['document_id'])
								   ->join('quotation_item AS PI', function($join) {
									   $join->on('PI.quotation_id','=','quotation.id');
								   })
								   ->join('itemmaster AS IM', function($join) {
									   $join->on('IM.id','=','PI.item_id');
								   })
								   ->join('units AS U', function($join) {
									   $join->on('U.id','=','PI.unit_id');
								   })
								   ->where('PI.status',1)
								   ->where('PI.deleted_at','0000-00-00 00:00:00')
								   ->select('PI.*','IM.item_code','U.unit_name')
								   ->orderBY('PI.id')
								   ->get();
								   
		return $result = ['details' => $order, 'items' => $items];
	}
	public function findPOdata($id)
	{
		$query = $this->quotation->where('quotation.id', $id);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','quotation.supplier_id');
						} )
						->leftJoin('jobmaster AS J', function($join){
						  $join->on('J.id','=','quotation.job_id');
						})
					->leftJoin('header_footer AS h',function($join) {
						$join->on('h.id','=','quotation.header_id');
					})
					->leftJoin('header_footer AS f',function($join) {
						$join->on('f.id','=','quotation.footer_id');
					})
					->leftJoin('salesman AS S',function($join) {
						$join->on('S.id','=','quotation.salesman_id');
					})
					->leftJoin('vehicle AS V',function($join) {
						$join->on('V.id','=','quotation.vehicle_id');
					})
				
					->select('quotation.*','am.master_name AS supplier','h.title AS header','V.make','V.model','am.email','J.name',
							 'f.description AS footer','S.name AS salesman','h.id AS hid','f.id AS fid','V.name AS vehicle','V.reg_no')
					->first();
	}
	
	public function findPOdataold($id)
	{
		$query = $this->quotation_sales->where('quotation_sales.id', $id);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','quotation_sales.customer_id');
						} )
					->leftJoin('header_footer AS h',function($join) {
						$join->on('h.id','=','quotation_sales.header_id');
					})
					->leftJoin('header_footer AS f',function($join) {
						$join->on('f.id','=','quotation_sales.footer_id');
					})
					->leftJoin('salesman AS S',function($join) {
						$join->on('S.id','=','quotation_sales.salesman_id');
					})
					->leftJoin('vehicle AS V',function($join) {
						$join->on('V.id','=','quotation_sales.vehicle_id');
					})
					->select('quotation_sales.*','am.master_name AS customer','h.title AS header','V.make','V.model','am.email',
							 'f.description AS footer','S.name AS salesman','h.id AS hid','f.id AS fid','V.name AS vehicle','V.reg_no')
					->first();
	}
	
	public function getItems($id,$mod=null)
	{
		$query = $this->quotation->where('quotation.id',$id);
		
		$query->join('quotation_item AS poi', function($join) {
							$join->on('poi.quotation_id','=','quotation.id');
						} )
					  ->join('units AS u', function($join){
						  $join->on('u.id','=','poi.unit_id');
					  }) 
					  ->join('itemmaster AS im', function($join){
						  $join->on('im.id','=','poi.item_id');
					  })
					  ->join('item_unit AS iu', function($join){
						  $join->on('iu.itemmaster_id','=','im.id');
					  })
					  ->where('poi.status',1);
					  
					  if($mod) {
						$val = ($mod=='ser')?2:1;
						$query->where('im.class_id',$val);
					  }
					  
		return $query->where('poi.deleted_at','0000-00-00 00:00:00')
					  ->select('poi.*','u.unit_name','im.item_code','iu.is_baseqty')
					  ->groupBy('poi.id')
					  ->orderBY('poi.id')
					  ->get();
	}
	
	public function getQSItems($id)
	{
		$query = $this->quotation->whereIn('quotation_sales.id',$id);
		
		return $query->join('quotation_item AS poi', function($join) {
							$join->on('poi.quotation_id','=','quotation.id');
						} )
					  ->join('units AS u', function($join){
						  $join->on('u.id','=','poi.unit_id');
					  }) 
					  ->join('itemmaster AS im', function($join){
						  $join->on('im.id','=','poi.item_id');
					  })
					  ->join('item_unit AS iu', function($join){
						  $join->on('iu.itemmaster_id','=','im.id');
						  $join->on('iu.unit_id','=','poi.unit_id');
					  })
					  ->where('poi.status',1)
					  ->whereIn('poi.is_transfer',[0,2])
					  ->where('poi.deleted_at','0000-00-00 00:00:00')
					  ->select('poi.*','u.unit_name','im.item_code','iu.is_baseqty','iu.packing','iu.pkno')
					  ->orderBY('poi.id')->groupBy('poi.id')
					  ->get();
					  
		
	}
	
	public function getItemDesc($id)
	{
		return DB::table('quotation')
						->join('quotation_item AS QSI', function($join) {
							$join->on('QSI.quotation_id', '=', 'quotation.id');
						})
						->join('item_description AS D', function($join) {
							$join->on('D.item_detail_id', '=', 'QSI.id');
						})
						->where('quotation.id', $id)
						->where('D.invoice_type','QP')
						->where('QSI.status',1)
						->where('QSI.deleted_at','0000-00-00 00:00:00')
						->where('D.status',1)
						->where('D.deleted_at','0000-00-00 00:00:00')
						->select('D.*')
						->get();
	}
	public function getPendingReportrent($attributes)
	{
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		
		switch($attributes['search_type']) {
			case 'summary':
				$query = $this->quotation_sales->where('is_rental',1)
								->join('quotation_sales_item AS QSI', function($join) {
									$join->on('QSI.quotation_sales_id','=','quotation_sales.id');
								})
								->join('itemmaster AS IM', function($join) {
									$join->on('IM.id','=','QSI.item_id');
								})
								->join('account_master AS AM', function($join) {
									$join->on('AM.id','=','quotation_sales.customer_id');
								})
								->leftJoin('salesman AS S', function($join) {
									$join->on('S.id','=','quotation_sales.salesman_id');
								})
								->where('QSI.status',1);
								
						if( $date_from!='' && $date_to!='' ) { 
							$query->whereBetween('quotation_sales.voucher_date', array($date_from, $date_to));
						}
						
						if($attributes['salesman']!='') { 
							$query->where('quotation_sales.salesman_id', $attributes['salesman']);
						}
						 
				return $query->select('quotation_sales.voucher_no','quotation_sales.reference_no','quotation_sales.total','quotation_sales.vat_amount','S.name AS salesman',
									  'QSI.quantity','QSI.balance_quantity','QSI.unit_price','AM.master_name','quotation_sales.net_total','quotation_sales.discount')
								->groupBy('quotation_sales.id')->get();
				break;
				
			case 'summary_pending':
				$query = $this->quotation_sales->where('QSI.is_transfer','!=',1)->where('is_rental',1)
								->join('quotation_sales_item AS QSI', function($join) {
									$join->on('QSI.quotation_sales_id','=','quotation_sales.id');
								})
								->join('itemmaster AS IM', function($join) {
									$join->on('IM.id','=','QSI.item_id');
								})
								->join('account_master AS AM', function($join) {
									$join->on('AM.id','=','quotation_sales.customer_id');
								})
								->leftJoin('salesman AS S', function($join) {
									$join->on('S.id','=','quotation_sales.salesman_id');
								})
								->where('QSI.status',1);
								
						if( $date_from!='' && $date_to!='' ) { 
							$query->whereBetween('quotation_sales.voucher_date', array($date_from, $date_to));
						}
						
						if($attributes['salesman']!='') { 
							$query->where('quotation_sales.salesman_id', $attributes['salesman']);
						}
						 
				return $query->select('quotation_sales.voucher_no','quotation_sales.reference_no','quotation_sales.total','quotation_sales.vat_amount','quotation_sales.discount',
									  'QSI.quantity','QSI.balance_quantity','QSI.unit_price','AM.master_name','quotation_sales.net_total','S.name AS salesman','QSI.vat_amount AS unit_vat')
								->get(); //->groupBy('quotation_sales.id')
								
				break;
				
			case 'detail':
				$query = $this->quotation_sales->where('is_rental',1)
								->join('quotation_sales_item AS QSI', function($join) {
									$join->on('QSI.quotation_sales_id','=','quotation_sales.id');
								})
								->join('account_master AS AM', function($join) {
									$join->on('AM.id','=','quotation_sales.customer_id');
								})
								->join('itemmaster AS IM', function($join) {
									$join->on('IM.id','=','QSI.item_id');
								})
								->leftJoin('salesman AS S', function($join) {
									$join->on('S.id','=','quotation_sales.salesman_id');
								})
								->where('QSI.status',1);
								
						if( $date_from!='' && $date_to!='' ) { 
							$query->whereBetween('quotation_sales.voucher_date', array($date_from, $date_to));
						}
						
						if($attributes['salesman']!='') { 
							$query->where('quotation_sales.salesman_id', $attributes['salesman']);
						}
						
				return $query->select('quotation_sales.voucher_no','quotation_sales.reference_no','IM.item_code','IM.description','S.name AS salesman','QSI.vat_amount AS unit_vat',
									  'QSI.quantity','QSI.unit_price','QSI.line_total','AM.master_name','quotation_sales.net_total','quotation_sales.discount')
								->get();
				break;
				
			case 'detail_pending':
				$query = $this->quotation_sales->where('QSI.is_transfer','!=',1)->where('is_rental',1)
								->join('quotation_sales_item AS QSI', function($join) {
									$join->on('QSI.quotation_sales_id','=','quotation_sales.id');
								})
								->join('account_master AS AM', function($join) {
									$join->on('AM.id','=','quotation_sales.customer_id');
								})
								->join('itemmaster AS IM', function($join) {
									$join->on('IM.id','=','QSI.item_id');
								})
								->leftJoin('salesman AS S', function($join) {
									$join->on('S.id','=','quotation_sales.salesman_id');
								})
								->where('QSI.status',1);
								
						if( $date_from!='' && $date_to!='' ) { 
							$query->whereBetween('quotation_sales.voucher_date', array($date_from, $date_to));
						}
						
						if($attributes['salesman']!='') { 
							$query->where('quotation_sales.salesman_id', $attributes['salesman']);
						}
						
				return $query->select('quotation_sales.voucher_no','quotation_sales.reference_no','IM.item_code','IM.description','quotation_sales.total','quotation_sales.vat_amount',
									  'QSI.quantity','QSI.balance_quantity','QSI.unit_price','QSI.line_total','AM.master_name','quotation_sales.net_total','S.name AS salesman','quotation_sales.discount')
								->get();
				break;
		}
	}	

	public function getPendingReport($attributes)
	{
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		
		switch($attributes['search_type']) {
			case 'summary':
				$query = $this->quotation
								->join('quotation_item AS QSI', function($join) {
									$join->on('QSI.quotation_id','=','quotation.id');
								})
								->join('itemmaster AS IM', function($join) {
									$join->on('IM.id','=','QSI.item_id');
								})
								->join('account_master AS AM', function($join) {
									$join->on('AM.id','=','quotation.supplier_id');
								})
								->leftJoin('jobmaster AS J', function($join) {
									$join->on('J.id','=','quotation.job_id');
								})
								->where('QSI.status',1);
								
						if( $date_from!='' && $date_to!='' ) { 
							$query->whereBetween('quotation.voucher_date', array($date_from, $date_to));
						}
						
						if(isset($attributes['job_id']))
							$query->whereIn('quotation.job_id', $attributes['job_id']);
							if(isset($attributes['supplier_id']) && $attributes['supplier_id']!=''){
							$query->where('quotation.supplier_id', $attributes['supplier_id']);
							}
				return $query->select('quotation.voucher_no','quotation.reference_no','quotation.total','quotation.vat_amount','J.code AS jobcode',
									  'QSI.quantity','QSI.balance_quantity','QSI.unit_price','AM.master_name','quotation.net_amount','quotation.discount')
								->groupBy('quotation.id')->get();
				break;
				
			case 'summary_pending':
				$query = $this->quotation->where('quotation.is_transfer','!=',1)
								->join('quotation_item AS QSI', function($join) {
									$join->on('QSI.quotation_id','=','quotation.id');
								})
								->join('itemmaster AS IM', function($join) {
									$join->on('IM.id','=','QSI.item_id');
								})
								->join('account_master AS AM', function($join) {
									$join->on('AM.id','=','quotation.supplier_id');
								})
								->leftJoin('jobmaster AS J', function($join) {
									$join->on('J.id','=','quotation.job_id');
								})
								->where('QSI.status',1);
								
						if( $date_from!='' && $date_to!='' ) { 
							$query->whereBetween('quotation.voucher_date', array($date_from, $date_to));
						}

						if(isset($attributes['supplier_id']) && $attributes['supplier_id']!=''){
							$query->where('quotation.supplier_id', $attributes['supplier_id']);
							}
						
						if(isset($attributes['job_id']))
							$query->whereIn('quotation.job_id', $attributes['job_id']);
						 
				return $query->select('quotation.voucher_no','quotation.reference_no','quotation.total','quotation.vat_amount','quotation.discount','J.code AS jobcode',
									  'QSI.quantity','QSI.balance_quantity','QSI.unit_price','AM.master_name','quotation.net_amount','QSI.vat_amount AS unit_vat')
								->get(); //
								
				break;
				
			case 'detail':
				$query = $this->quotation
								->join('quotation_item AS QSI', function($join) {
									$join->on('QSI.quotation_id','=','quotation.id');
								})
								->join('account_master AS AM', function($join) {
									$join->on('AM.id','=','quotation.supplier_id');
								})
								->join('itemmaster AS IM', function($join) {
									$join->on('IM.id','=','QSI.item_id');
								})
								->leftJoin('jobmaster AS J', function($join) {
									$join->on('J.id','=','quotation.job_id');
								})
								->where('QSI.status',1);
								
						if( $date_from!='' && $date_to!='' ) { 
							$query->whereBetween('quotation.voucher_date', array($date_from, $date_to));
						}
						if(isset($attributes['supplier_id']) && $attributes['supplier_id']!=''){
							$query->where('quotation.supplier_id', $attributes['supplier_id']);
							}
						if(isset($attributes['job_id']))
							$query->whereIn('quotation.job_id', $attributes['job_id']);
						
				return $query->select('quotation.voucher_no','quotation.voucher_date','quotation.reference_no','IM.item_code','IM.description','QSI.vat_amount AS unit_vat','J.code AS jobcode',
									  'QSI.quantity','QSI.unit_price','QSI.line_total','AM.master_name','quotation.net_amount','quotation.discount')
								->get();
				break;
				
			case 'detail_pending'||'qty_report':
				$query = $this->quotation->where('quotation.is_transfer','!=',1)
								->join('quotation_item AS QSI', function($join) {
									$join->on('QSI.quotation_id','=','quotation.id');
								})
								->join('account_master AS AM', function($join) {
									$join->on('AM.id','=','quotation.supplier_id');
								})
								->join('itemmaster AS IM', function($join) {
									$join->on('IM.id','=','QSI.item_id');
								})
								->leftJoin('jobmaster AS J', function($join) {
									$join->on('J.id','=','quotation.job_id');
								})
								->where('QSI.status',1);
								
						if( $date_from!='' && $date_to!='' ) { 
							$query->whereBetween('quotation.voucher_date', array($date_from, $date_to));
						}
						if(isset($attributes['supplier_id']) && $attributes['supplier_id']!=''){
							$query->where('quotation.supplier_id', $attributes['supplier_id']);
							}
						if(isset($attributes['job_id']))
							$query->whereIn('quotation.job_id', $attributes['job_id']);
						
				return $query->select('quotation.voucher_no','quotation.voucher_date','quotation.reference_no','IM.item_code','IM.description','quotation.total','quotation.vat_amount','J.code AS jobcode',
									  'QSI.quantity','QSI.balance_quantity','QSI.unit_price','QSI.line_total','AM.master_name','quotation.net_amount','quotation.discount')
								->get();
				break;
		}
	}
	
	public function check_voucher_no($refno, $id = null) { 
		
		if($id)
			return $this->quotation->where('voucher_no',$refno)->where('id', '!=', $id)->count();
		else
			return $this->quotation->where('voucher_no',$refno)->count();
	}
	
	public function getjobDescription($id)
	{
		return DB::table('jobestimate_details')->where('jobestimate_id',$id)->where('status',1)->whereNull('deleted_at')->get();
	}
	
	public function salesEstimateListCount()
	{
		$query = $this->quotation->where('quotation.status',1);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','quotation.supplier_id');
						} )
					->count();
	}

	public function salesEstimateList($type,$start,$limit,$order,$dir,$search)
	{
		$query = $this->quotation->where('quotation.status',1)
						->join('account_master AS am', function($join) {
							$join->on('am.id','=','quotation.supplier_id');
						} );
						// ->leftJoin('vehicle AS V', function($join) {
						// 	$join->on('V.id','=','quotation_sales.vehicle_id');
						// } );
						
				if($search) {
					$query->where('quotation.voucher_no','LIKE',"%{$search}%")
                          ->orWhere('am.master_name', 'LIKE',"%{$search}%");
				}
				
				$query->select('quotation.*','am.master_name AS supplier')
					->offset($start)
                    ->limit($limit)
                    ->orderBy($order,$dir);
					
				if($type=='get')
					return $query->get();
				else
					return $query->count();
	}
	
//SELECT supplier_do.voucher_no,supplier_do.reference_no,supplier_do.voucher_date,supplier_do.total,supplier_do.vat_amount AS total_vat,supplier_do.discount,supplier_do.net_total,supplier_do.subtotal,account_master.account_id,account_master.master_name,account_master.address,account_master.phone,account_master.vat_no,supplier_do_item.item_name,supplier_do_item.quantity,supplier_do_item.unit_price,supplier_do_item.vat,supplier_do_item.vat_amount,supplier_do_item.total_price,supplier_do_item.tax_include,supplier_do_item.item_total,itemmaster.item_code,units.unit_name FROM supplier_do JOIN account_master ON(account_master.id=supplier_do.supplier_id) JOIN supplier_do_item ON(supplier_do_item.supplier_do_id=supplier_do.id) JOIN itemmaster ON(itemmaster.id=supplier_do_item.item_id) JOIN units ON(units.id=supplier_do_item.unit_id) WHERE supplier_do_item.status=1 AND supplier_do_item.deleted_at='0000-00-00 00:00:00' AND supplier_do.id=3

}
