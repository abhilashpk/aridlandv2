<?php
declare(strict_types=1);
namespace App\Repositories\SalesReturn;

use App\Models\SalesReturn;
use App\Models\SalesReturnItem;
use App\Models\AccountTransaction;
use App\Models\ItemStock;
use App\Models\SalesInvoice;
use App\Models\ItemLocationSI;
use App\Models\ConLocationSR;
use App\Models\SalesInvoiceItem;
use App\Models\ItemLocationSR;
use App\Repositories\AbstractValidator;
use App\Exceptions\Validation\ValidationException;
use App\Repositories\UpdateUtility;

use Config;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Session;
use Auth;
use Curl;

class SalesReturnRepository extends AbstractValidator implements SalesReturnInterface {
	
	public $objUtility;
	
	protected $sales_return;
	
	protected static $rules = [];
	
	public function __construct(SalesReturn $sales_return) {
		$this->sales_return = $sales_return;
		$config = Config::get('siteconfig');
		$this->api_url = $config['modules']['api_url'];
		$this->objUtility = new UpdateUtility();
	}
	
	public function all()
	{
		return $this->sales_return->get();
	}
	
	public function find($id)
	{
		return $this->sales_return->where('id', $id)->first();
	}
	
	//set input fields values
	private function setInputValue($attributes)
	{
		$this->sales_return->voucher_id    = $attributes['voucher_id'];
		$this->sales_return->voucher_no    = $attributes['voucher_no'];
		$this->sales_return->reference_no    = $attributes['reference_no'];
		$this->sales_return->sales_invoice_id  = ($attributes['is_prior'])?0:$attributes['sales_invoice_id'];
		$this->sales_return->voucher_date  = ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date']));
		$this->sales_return->customer_id   = $attributes['customer_id'];
		$this->sales_return->dr_account_id = $attributes['dr_account_id'];
		$this->sales_return->cr_account_id = $attributes['cr_account_id'];
		$this->sales_return->job_id 		= $attributes['job_id'];
		$this->sales_return->description   = $attributes['description'];
		$this->sales_return->is_fc 		= isset($attributes['is_fc'])?1:0;
		$this->sales_return->currency_id   = (isset($attributes['currency_id']))?$attributes['currency_id']:'';
		$this->sales_return->currency_rate = (isset($attributes['currency_rate']))?$attributes['currency_rate']:'';
		$this->sales_return->sales_invoice_no  = ($attributes['is_prior'])?$attributes['sales_invoice_id']:$attributes['sales_invoice_no'];
		$this->sales_return->location_id = $attributes['location_id'];
		$this->sales_return->is_prior  = $attributes['is_prior']; //JN23
		$this->sales_return->foot_description = (isset($attributes['foot_description']))?$attributes['foot_description']:'';
		
		
		return true;
	}
	
	
	private function setSalesInvoiceInvoiceItemInputValue($attributes, $salesInvoiceItem, $key, $value, $sales_invoice_id,$lineTotal)
	{
		/*CHG*/
		if( isset($attributes['is_fc']) ) {
			$tax        = ( ($attributes['cost'][$key] * $attributes['line_vat'][$key]) / 100) * $attributes['currency_rate'];
			$item_total = ( ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $attributes['line_discount'][$key] ) * $attributes['currency_rate'];
			$tax_total  = round($tax * $attributes['quantity'][$key],2);
			$line_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]) * $attributes['currency_rate'];
			
		} else {
			
			$line_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]);
			
			$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['tax_code'][$key];
						
			if(isset($attributes['is_export']) || $tax_code=="EX" || $tax_code=="ZR") {
				
				$tax        = 0;
				$item_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $attributes['line_discount'][$key];
				$tax_total  = round($tax * $attributes['quantity'][$key],2);
				
			} else if($attributes['tax_include'][$key]==1){
				
				$ln_total   = $attributes['cost'][$key] * $attributes['quantity'][$key];
				$tax_total  = $ln_total *  $attributes['line_vat'][$key] / (100 +  $attributes['line_vat'][$key]);
				$item_total = $ln_total - $tax_total;
				
			} else {
				
				$tax        = ($attributes['cost'][$key] * $attributes['line_vat'][$key]) / 100;
				$item_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $attributes['line_discount'][$key];
				$tax_total  = round($tax * $attributes['quantity'][$key],2);
			}
		}
		
		//********DISCOUNT Calculation.............
		$discount = (isset($attributes['discount']))?$attributes['discount']:0;
		$type = 'tax_exclude';
			
		if($attributes['tax_include'][$key]==1 ) {
			$vatPlus = 100 + $attributes['line_vat'][$key];
			$total = $attributes['cost'][$key] * $attributes['quantity'][$key];
			$type = 'tax_include';
		} else {
			$vatPlus = 100;
			$total = $attributes['line_total'][$key];
			$type = 'tax_exclude';
		}
		
		if($discount > 0) {
			$discountAmt = round( (($total / $lineTotal) * $discount),2 );
			$amountTotal = $total - $discountAmt;
			$vatLine = round( (($amountTotal * $attributes['line_vat'][$key]) / $vatPlus),2 );
			//$line_total = $amountTotal;
			$tax_total = $vatLine; 
		} 
		/*CHG*/
		
		$salesInvoiceItem->sales_invoice_id = $sales_invoice_id;
		$salesInvoiceItem->item_id    		= $value;
		$salesInvoiceItem->item_name  		= $attributes['item_name'][$key];
		$salesInvoiceItem->unit_id 			= $attributes['unit_id'][$key];
		$salesInvoiceItem->quantity   		= $attributes['quantity'][$key];
		$salesInvoiceItem->unit_price 		= (isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key];
		$salesInvoiceItem->vat		    	= $attributes['line_vat'][$key];
		$salesInvoiceItem->vat_amount 		= $tax_total;
		$salesInvoiceItem->discount   		= $attributes['line_discount'][$key];
		$salesInvoiceItem->line_total 		= $line_total;
		$salesInvoiceItem->tax_code 		= $tax_code;
		$salesInvoiceItem->tax_include 		= $attributes['tax_include'][$key];
		$salesInvoiceItem->item_total 		= $item_total; //CHG
		
		
		
		$cost_value = 0;
		if(Session::get('cost_accounting')==1) {
			$item = DB::table('item_unit')->where('itemmaster_id', $attributes['item_id'][$key])
										  ->where('unit_id', $attributes['unit_id'][$key])
										  ->first();
			$cost_avg = ($item->cost_avg==0)?$item->last_purchase_cost:$item->cost_avg;
			$cost_value = $cost_avg * $attributes['quantity'][$key];
		}
		return array('line_total' => $line_total, 'tax_total' => $tax_total, 'cost_value' => $cost_value, 'type' => $type, 'item_total' => $item_total);//CHG
	}
	
		
	private function setAccountTransactionUpdate($attributes, $amount, $voucher_id, $type, $amount_type)
	{
		$cr_acnt_id = $dr_acnt_id = '';
		if($amount_type=='VAT') {
			$vatrow = $this->getVatAccounts((isset($attributes['department_id']))?$attributes['department_id']:null); //DB::table('vat_master')->where('status', 1)->whereNull('deleted_at')->first();//VAT OUTPUT
			if($vatrow) {
				$dr_acnt_id = $account_id = $vatrow->payment_account;
			}
		} else if($amount_type == 'LNTOTAL') {
			$dr_acnt_id = $account_id = $attributes['dr_account_id'];
		} else if($amount_type == 'NTAMT') {
			$cr_acnt_id = $account_id = $attributes['cr_account_id'];
		} else if($amount_type == 'STOCK') {
			$dr_acnt_id = $account_id = Session::get('stock');
		} else if($amount_type == 'COSTOFSALE') {
			$cr_acnt_id = $account_id = Session::get('cost_of_sale');
		} else if($amount_type == 'DIS') {
			if(Session::get('cost_accounting')==1 && Session::get('department')==1) { 
				$vatrow = DB::table('department_accounts')->where('department_id', $attributes['department_id'])->select('saledis_acid')->first();
				if($vatrow)
					$cr_acnt_id = $vatrow->saledis_acid;
				else {
					$vatrow = DB::table('other_account_setting')->where('account_setting_name', 'Discount in Sales')->where('status', 1)->first();
					$cr_acnt_id = $vatrow->account_id;
				}
			} else {
				$vatrow = DB::table('other_account_setting')->where('account_setting_name', 'Discount in Sales')->where('status', 1)->first();
				$cr_acnt_id = $account_id = $vatrow->account_id;
			}
		}
		//echo $voucher_id.' '.$account_id.' '.$amount;exit;
		DB::table('account_transaction')
				->where('voucher_type_id', $voucher_id)
				->where('account_master_id', $account_id) //CHNG
				->where('voucher_type', 'SR')
				->update([  'amount'   			=> $amount,  //JUL9
							'modify_at' 		=> now(),
							'modify_by' 		=> Auth::User()->id,
							'reference'			=> $attributes['voucher_no'],
							'invoice_date'		=> ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
							'reference_from'	=> $attributes['sales_invoice_no'],
							'fc_amount'			=> (isset($attributes['is_fc']))?($amount/$attributes['currency_rate']):$amount,
							'department_id'		=> (isset($attributes['department_id']))?$attributes['department_id']:''
						]);
		
		$this->objUtility->tallyClosingBalance(($type=='Cr')?$cr_acnt_id:$dr_acnt_id);
		
		/* if($type=='Cr') {	
			DB::table('account_master')
							->where('id', $cr_acnt_id)
							->update(['cl_balance' => DB::raw('cl_balance - '.$amount)]);
		} else {
			DB::table('account_master')
							->where('id', $dr_acnt_id)
							->update(['cl_balance' => DB::raw('cl_balance + '.$amount)]);
		} */
							
		return true;
	}
	
		
	private function setItemInputValue($attributes, $salesReturnItem, $key, $value, $lineTotal) 
	{
		if( isset($attributes['is_fc']) ) {
			$tax        = ( ($attributes['cost'][$key] * $attributes['line_vat'][$key]) / 100) * $attributes['currency_rate'];
			$item_total = ( ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $attributes['line_discount'][$key] ) * $attributes['currency_rate'];
			$tax_total  = round($tax * $attributes['quantity'][$key],2);
			$line_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]) * $attributes['currency_rate'];
			
			$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['tax_code'][$key];
			$rate = $attributes['cost'][$key]*$attributes['currency_rate']; //14JN24
		} else {
			
			$line_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]);
			
			$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['tax_code'][$key];
						
			if(isset($attributes['is_export']) || $tax_code=="EX" || $tax_code=="ZR") {
				$idiscount = ($attributes['line_discount'][$key]!='')?$attributes['line_discount'][$key]:0;
				$tax        = 0;
				$item_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $idiscount;
				$tax_total  = round($tax * $attributes['quantity'][$key],2);
				$rate = $attributes['cost'][$key];//14JN24
				
			} else if($attributes['tax_include'][$key]==1){
				
				$ln_total   = $attributes['cost'][$key] * $attributes['quantity'][$key];
				$tax_total  = $ln_total *  $attributes['line_vat'][$key] / (100 +  $attributes['line_vat'][$key]);
				$item_total = $ln_total - $tax_total;
				
				//14JN24
				if((float)$attributes['line_discount'][$key] > 0) {
					$rate = $attributes['cost'][$key] - (float)$attributes['line_discount'][$key];
					$row_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]);//14JN24
				} else {
					$vatPlus = 100 + $attributes['line_vat'][$key];
					$vatLine = round( (($attributes['cost'][$key] * $attributes['line_vat'][$key]) / $vatPlus),2 );
					$rate = $attributes['cost'][$key] - $vatLine;
					$row_total = ($rate * $attributes['quantity'][$key]);//14JN24
				}
				
			} else {
				$idiscount = ($attributes['line_discount'][$key]!='')?$attributes['line_discount'][$key]:0;
				$tax        = ($attributes['cost'][$key] * $attributes['line_vat'][$key]) / 100;
				$item_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $idiscount;
				$tax_total  = round($tax * $attributes['quantity'][$key],2);
				
				//14LN24
				$rate = $attributes['cost'][$key] - (float)$attributes['line_discount'][$key];//31MY
				$row_total = ($rate * $attributes['quantity'][$key]);//31MY
			}
		}
		
		//********DISCOUNT Calculation.............
		$discount = (isset($attributes['discount']))?$attributes['discount']:0;
		$type = 'tax_exclude';
			
		if($attributes['tax_include'][$key]==1 ) {
			$vatPlus = 100 + $attributes['line_vat'][$key];
			$total = $attributes['cost'][$key] * $attributes['quantity'][$key];
			$type = 'tax_include';
		} else {
			$vatPlus = 100;
			$total = $attributes['line_total'][$key];
			$type = 'tax_exclude';
		}
		
		if($discount > 0) {
			$discountAmt = round( (($total / $lineTotal) * $discount),2 );
			$amountTotal = $total - $discountAmt;
			$vatLine = round( (($amountTotal * $attributes['line_vat'][$key]) / $vatPlus),2 );
			//$line_total = $amountTotal;
			$tax_total = $vatLine; 
			
			//14JN24
			$vat_exc = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - (float)$attributes['line_discount'][$key];
			$rate = $vat_exc / $attributes['quantity'][$key];
		} else { //31MY
			if($attributes['tax_include'][$key]==1 ) {
				$vatLine = round( (($total * $attributes['line_vat'][$key]) / $vatPlus),2 );
				$vat_exc = $total - $vatLine;
				//$row_total = $vat_exc + $tax_total;
			} else {
				$vat_exc = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - (float)$attributes['line_discount'][$key];
				 
			}
		}
		
		
		$salesReturnItem->sales_return_id = $this->sales_return->id;
		$salesReturnItem->item_id    		= $value;
		$salesReturnItem->item_name  		= $attributes['item_name'][$key];
		$salesReturnItem->unit_id 			= $attributes['unit_id'][$key];
		$salesReturnItem->quantity   		= $attributes['quantity'][$key];
		$salesReturnItem->unit_price 		= (isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key];
		$salesReturnItem->vat		    	= $attributes['line_vat'][$key];
		$salesReturnItem->vat_amount 		= $tax_total;
		$salesReturnItem->discount   		= $attributes['line_discount'][$key];
		$salesReturnItem->total_price 		= $line_total;
		$salesReturnItem->tax_code 			= $tax_code;
		$salesReturnItem->tax_include 		= $attributes['tax_include'][$key];
		$salesReturnItem->item_total 		= $item_total; //CHG
		$salesReturnItem->item_cost 		= $attributes['item_cost'][$key];
		
		$salesReturnItem->width = isset($attributes['item_wit'][$key])?$attributes['item_wit'][$key]:0;
		$salesReturnItem->length = isset($attributes['item_lnt'][$key])?$attributes['item_lnt'][$key]:0;
		$salesReturnItem->mp_qty = isset($attributes['mpquantity'][$key])?$attributes['mpquantity'][$key]:0;
		
		$salesReturnItem->cat_id   		= isset($attributes['cat_id'][$key])?$attributes['cat_id'][$key]:'';
		
		//14JN24
		$salesReturnItem->rate 			= $rate;//29MY
		$salesReturnItem->row_total 		= $row_total;//31MY
		$salesReturnItem->vat_exc 			= $vat_exc;//31MY
		$salesReturnItem->vat_exc_fc		= (isset($attributes['is_fc']))?round(($vat_exc /  $attributes['currency_rate']),2):$vat_exc;//31MY
		
		if(isset($attributes['conloc_id'][$key]) && $attributes['conloc_id'][$key]!='') {
			$salesReturnItem->conloc_id = $attributes['conloc_id'][$key];
			$salesReturnItem->conloc_qty = $attributes['conloc_qty'][$key];
		}
		
		$cost_value = 0;
		if(Session::get('cost_accounting')==1) {
			$item = DB::table('item_unit')->where('itemmaster_id', $attributes['item_id'][$key])
										  ->where('unit_id', $attributes['unit_id'][$key])
										  ->first();
			$cost_avg = ($item->cost_avg==0)?$item->last_purchase_cost:$item->cost_avg;
			$cost_value = $cost_avg * $attributes['quantity'][$key];
		}
		
		return array('line_total' => $line_total, 'tax_total' => $tax_total, 'cost_value' => $cost_value, 'type' => $type, 'item_total' => $item_total);//CHG
		
	}
	
	private function setTransferStatusItem($attributes, $key)
	{
		//if quantity partially deliverd, update pending quantity.
		if(isset($attributes['sales_invoice_item_id'])) {
			if(isset($attributes['actual_quantity']) && ($attributes['quantity'][$key] != $attributes['actual_quantity'][$key])) {
				if( isset($attributes['sales_invoice_item_id'][$key]) ) {
					$quantity 	 = $attributes['actual_quantity'][$key] - $attributes['quantity'][$key];
					//update as partially delivered.
					DB::table('sales_invoice_item')
								->where('id', $attributes['sales_invoice_item_id'][$key])
								->update(['balance_quantity' => $quantity, 'is_transfer' => 2]);
				}
			} else {
					//update as completely delivered.
					DB::table('sales_invoice_item')
								->where('id', $attributes['sales_invoice_item_id'][$key])
								->update(['balance_quantity' => 0, 'is_transfer' => 1]);
			}
		}
	}
	
	
	private function updateItemReturnQuantity($attributes, $key)
	{
		DB::table('item_unit')
				->where('itemmaster_id', $attributes['item_id'][$key])->where('unit_id', $attributes['unit_id'][$key])
				->update(['cur_quantity' => DB::raw('cur_quantity + '.$attributes['quantity'][$key] ) ]);
		return true;
	}
	
	
	private function setAccountTransaction($attributes, $amount, $voucher_id, $type, $amount_type)
	{
		//GETTING DEPARTMENT COST ACCOUNTING DETAILS
		$this->checkAndSetCostAccountingParameters($attributes);
		
		$cr_acnt_id = $dr_acnt_id = '';
		if($amount_type=='VAT') {
			$vatrow = $this->getVatAccounts((isset($attributes['department_id']))?$attributes['department_id']:null); //DB::table('vat_master')->where('status', 1)->whereNull('deleted_at')->first();//VAT OUTPUT
			if($vatrow) {
				$dr_acnt_id = $vatrow->payment_account;
			}
		} else if($amount_type == 'LNTOTAL') {
			$dr_acnt_id = $attributes['dr_account_id'];
		} else if($amount_type == 'NTAMT') {
			$cr_acnt_id = $attributes['cr_account_id'];
		} else if($amount_type == 'STOCK') {
			$dr_acnt_id = Session::get('stock');
		} else if($amount_type == 'COSTOFSALE') {
			$cr_acnt_id = Session::get('cost_of_sale');
		} else if($amount_type == 'DIS') {
			if(Session::get('cost_accounting')==1 && Session::get('department')==1) { 
				$vatrow = DB::table('department_accounts')->where('department_id', $attributes['department_id'])->select('saledis_acid')->first();
				if($vatrow)	
					$cr_acnt_id = $vatrow->saledis_acid;
				else {
					$vatrow = DB::table('other_account_setting')->where('account_setting_name', 'Discount in Sales')->where('status', 1)->first();
					$cr_acnt_id = $vatrow->account_id;
				}
			} else {
				$vatrow = DB::table('other_account_setting')->where('account_setting_name', 'Discount in Sales')->where('status', 1)->first();
				$cr_acnt_id = $vatrow->account_id;
			}
		}
		
		DB::table('account_transaction')
				->insert([  'voucher_type' 		=> 'SR',
						    'voucher_type_id'   => $voucher_id,
							'account_master_id' => ($type=='Cr')?$cr_acnt_id:$dr_acnt_id,
							'transaction_type'  => $type,
							'amount'   			=> $amount,
							'status' 			=> 1,
							'created_at' 		=> now(),
							'created_by' 		=> Auth::User()->id,
							'reference'			=> $attributes['voucher_no'],
							'invoice_date'		=> ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
							'reference_from'	=> ($attributes['is_prior']==1)?$attributes['sales_invoice_id']:$attributes['sales_invoice_no'],
							'fc_amount'			=> (isset($attributes['is_fc']))?($amount/$attributes['currency_rate']):$amount,
							'department_id'		=> (isset($attributes['department_id']))?$attributes['department_id']:''
						]);
		
		$this->objUtility->tallyClosingBalance(($type=='Cr')?$cr_acnt_id:$dr_acnt_id);
		
		/* if($type=='Cr') {	
			DB::table('account_master')
							->where('id', $cr_acnt_id)
							->update(['cl_balance' => DB::raw('cl_balance - '.$amount)]);
		} else {
			DB::table('account_master')
							->where('id', $dr_acnt_id)
							->update(['cl_balance' => DB::raw('cl_balance + '.$amount)]);
		} */
							
		return true;
	}
	
	
	//Purchase And Sales Method function............
	private function PurchaseAndSalesMethod($attributes, $line_total, $tax_total, $net_amount, $sales_return_id, $taxtype)
	{
		$discount = ($attributes['discount']=='')?0:$attributes['discount'];
		
		if($taxtype=='tax_include' && $discount > 0) {
			$temp = $net_amount;
			$net_amount = $line_total;
			$line_total = $temp + $discount;
		} else if($taxtype=='tax_exclude' && $discount > 0) {
			$line_total = $line_total + $discount;
		}
		
		if( $this->setAccountTransaction($attributes, $net_amount, $sales_return_id, $type='Cr', $amount_type='NTAMT') ) {
			
			//Credit Sales A/c
			if( $this->setAccountTransaction($attributes, $line_total, $sales_return_id, $type='Dr', $amount_type='LNTOTAL') ) {
				
				//Credit VAT output
				if( $this->setAccountTransaction($attributes, $tax_total, $sales_return_id, $type='Dr', $amount_type='VAT') ) {
					
					$this->setAccountTransaction($attributes, $discount, $sales_return_id, $type='Cr', $amount_type='DIS');
				}
			}
		}
		
	}
	
	//Cost Accounting Method function............
	private function CostAccountingMethod($attributes, $line_total, $tax_total, $net_amount, $sales_return_id, $taxtype, $cost_value)
	{
		$discount = ($attributes['discount']=='')?0:$attributes['discount'];
		
		if($taxtype=='tax_include' && $discount > 0) {
			$temp = $net_amount;
			$net_amount = $line_total;
			$line_total = $temp + $discount;
		} else if($taxtype=='tax_exclude' && $discount > 0) {
			$line_total = $line_total + $discount;
		}
		
		//Debit Customer Account
		if($this->setAccountTransaction($attributes, $net_amount, $sales_return_id, $type='Cr', $amount_type='NTAMT')) {
		
			//Credit Sales A/c
			if($this->setAccountTransaction($attributes, $line_total, $sales_return_id, $type='Dr', $amount_type='LNTOTAL')) {
			
				//Credit VAT output
				if($this->setAccountTransaction($attributes, $tax_total, $sales_return_id, $type='Dr', $amount_type='VAT')) {
				
					//Discount..
					if($this->setAccountTransaction($attributes, $discount, $sales_return_id, $type='Cr', $amount_type='DIS')) {
					
						//Credit Stock A/c
						if($this->setAccountTransaction($attributes, $cost_value, $sales_return_id, $type='Dr', $amount_type='STOCK')) {
						
							//Debit Cost of Sales
							$this->setAccountTransaction($attributes, $cost_value, $sales_return_id, $type='Cr', $amount_type='COSTOFSALE');
						}
					}
				}
			}
		}
		
	}
	
	private function PurchaseAndSalesMethodUpdate($attributes, $line_total, $tax_total, $net_amount, $sales_return_id, $taxtype)
	{
		$discount = ($attributes['discount']=='')?0:$attributes['discount'];
		
		if($taxtype=='tax_include' && $discount > 0) {
			$temp = $net_amount;
			$net_amount = $line_total;
			$line_total = $temp + $discount;
		} else if($taxtype=='tax_exclude' && $discount > 0) {
			$line_total = $line_total + $discount;
		}
		if( $this->setAccountTransactionUpdate($attributes, $net_amount, $sales_return_id, $type='Cr', $amount_type='NTAMT') ) {
			
			//Credit Sales A/c
			if( $this->setAccountTransactionUpdate($attributes, $line_total, $sales_return_id, $type='Dr', $amount_type='LNTOTAL') ) {
				
				//Credit VAT output
				if( $this->setAccountTransactionUpdate($attributes, $tax_total, $sales_return_id, $type='Dr', $amount_type='VAT') ) {
					
					$this->setAccountTransactionUpdate($attributes, $discount, $sales_return_id, $type='Cr', $amount_type='DIS');
				}
			}
		}
		
	}
	
	
	//Cost Accounting Method function............
	private function CostAccountingMethodUpdate($attributes, $line_total, $tax_total, $net_amount, $sales_return_id, $taxtype, $cost_value)
	{
		$discount = ($attributes['discount']=='')?0:$attributes['discount'];
		
		if($taxtype=='tax_include' && $discount > 0) {
			$temp = $net_amount;
			$net_amount = $line_total;
			$line_total = $temp + $discount;
		} else if($taxtype=='tax_exclude' && $discount > 0) {
			$line_total = $line_total + $discount;
		}
		
		
		//Debit Customer Account
		if($this->setAccountTransactionUpdate($attributes, $net_amount, $sales_return_id, $type='Cr', $amount_type='NTAMT')) {
		
			//Credit Sales A/c
			if($this->setAccountTransactionUpdate($attributes, $line_total, $sales_return_id, $type='Dr', $amount_type='LNTOTAL')) {
			
				//Credit VAT output
				if($this->setAccountTransactionUpdate($attributes, $tax_total, $sales_return_id, $type='Dr', $amount_type='VAT')) {
				
					//Discount...
					if($this->setAccountTransactionUpdate($attributes, $discount, $sales_return_id, $type='Cr', $amount_type='DIS')) {
					
						//Credit Stock A/c
						if($this->setAccountTransactionUpdate($attributes, $cost_value, $sales_return_id, $type='Dr', $amount_type='STOCK')) {
						
							//Debit Cost of Sales
							$this->setAccountTransactionUpdate($attributes, $cost_value, $sales_return_id, $type='Cr', $amount_type='COSTOFSALE');
						}
					}
				}
			}
		
		}
		
	}
	
	
	private function setTransferStatusQuote($attributes)
	{
		if($attributes['sales_invoice_id']) {
			$row1 = DB::table('sales_invoice_item')->where('sales_invoice_id', $attributes['sales_invoice_id'])->count();
			$row2 = DB::table('sales_invoice_item')->where('sales_invoice_id', $attributes['sales_invoice_id'])->where('is_transfer',1)->count();
			if($row1==$row2) {
				$is_transfer = ($attributes['net_amount_hid']==$attributes['net_amount'])?1:2;
				DB::table('sales_invoice')
						->where('id', $attributes['sales_invoice_id'])
						->update(['amount_transfer' => $is_transfer, 'is_transfer' => 1,'is_editable' => 1]);
			}
		}
	}
	
	private function calculateTotalAmount($attributes) {
		
		$total = 0;
		foreach($attributes['item_id'] as $key => $value){ 
			
			$total += $attributes['quantity'][$key] * $attributes['cost'][$key];
		}
		return $total;
	}
	
	public function create($attributes)
	{ //echo '<pre>';print_r($attributes);exit;
		if($this->isValid($attributes)) {
			
			DB::beginTransaction();
			try {

					if($this->setInputValue($attributes)) {
						$this->sales_return->status = 1;
						$this->sales_return->created_at = now();
						$this->sales_return->created_by = Auth::User()->id;
						$this->sales_return->fill($attributes)->save();
					}
					
					//order items insert
					if($this->sales_return->id && !empty( array_filter($attributes['item_id']))) {
						
						$line_total = 0; $tax_total = 0; $cost_value = 0; $item_total = $total = 0;
						//calculate total amount....
						$discount = (isset($attributes['discount']))?$attributes['discount']:0;
						if($discount > 0) 
							$total = $this->calculateTotalAmount($attributes);
					
						foreach($attributes['item_id'] as $key => $value) { 
							$salesReturnItem = new SalesReturnItem();
							$vat = $attributes['line_vat'][$key]; //CHG
							$arrResult = $this->setItemInputValue($attributes, $salesReturnItem, $key, $value, $total);
							
							if($arrResult['line_total']) {
								$line_total			     += $arrResult['line_total'];
								$tax_total      	     += $arrResult['tax_total'];
								$taxtype				  = $arrResult['type'];
								$item_total				 += $arrResult['item_total']; //CHG
								$cost_value 		     += $arrResult['cost_value'];
								$salesReturnItem->status = 1;
								$itemObj = $this->sales_return->salesReturnItemAdd()->save($salesReturnItem);
								
								$CostAvg_log = $this->updateLastPurchaseCostAndCostAvg($attributes, $key);
								
								//update item transfer status...
								$this->setTransferStatusItem($attributes, $key);
								
							    $attributes['item_row_id'][$key] = $itemObj->id; //OCT24
								//stock update section............................
								$logid = $this->setPurchaseLog($attributes, $key, $this->sales_return->id, $CostAvg_log,'add');
									$this->updateItemQuantity($attributes, $key);
							}
								
							//################ Location Stock Entry ####################
							//Item Location specific add....
							$updated = false;
							if(isset($attributes['locqty'][$key])) {
								foreach($attributes['locqty'][$key] as $lk => $lq) {
									if($lq!='') {
										$updated = true;
										//$lcqty = $lq * $attributes['packing'][$key];
										$lcqty = $lq;
                                		if($attributes['packing'][$key]=="1") 
                                		    $lcqty = $lq;
                                		else {
                                		   $pkgar = explode('-', $attributes['packing'][$key]);
                                		   if($pkgar[0] > 0)
                                		        $lcqty = ($lq *  $pkgar[1]) / $pkgar[0];
                                		}
										$qtys = DB::table('item_location')->where('status',1)->where('location_id', $attributes['locid'][$key][$lk])
																	  ->where('item_id', $value)//->where('unit_id', $attributes['unit_id'][$key])
																	  ->whereNull('deleted_at')->select('id')->first();
										if($qtys) {
											DB::table('item_location')->where('id', $qtys->id)->update(['quantity' => DB::raw('quantity + '.$lcqty) ]);
										} else {
											$itemLocation = new ItemLocation();
											$itemLocation->location_id = $attributes['locid'][$key][$lk];
											$itemLocation->item_id = $value;
											$itemLocation->unit_id = $attributes['unit_id'][$key];
											$itemLocation->quantity = $lcqty;
											$itemLocation->status = 1;
											$itemLocation->save();
										}
										
										$itemLocationSR = new ItemLocationSR();
										$itemLocationSR->location_id = $attributes['locid'][$key][$lk];
										$itemLocationSR->item_id = $value;
										$itemLocationSR->unit_id = $attributes['unit_id'][$key];
										$itemLocationSR->quantity = $lcqty;
										$itemLocationSR->status = 1;
										$itemLocationSR->invoice_id = $itemObj->id;
										$itemLocationSR->logid = $logid;
										$itemLocationSR->qty_entry = $lq;
										$itemLocationSR->save();
									}
								}
							}
							
							//Item default location add...
							if(isset($attributes['default_location']) && ($attributes['default_location'] > 0) && ($updated == false)) {
									
									$qtys = DB::table('item_location')->where('status',1)->where('location_id', $attributes['default_location'])
																	  ->where('item_id', $value)//->where('unit_id', $attributes['unit_id'][$key])
																	  ->whereNull('deleted_at')->select('id')->first();
																	  
									//$lcqty = $attributes['quantity'][$key] * $attributes['packing'][$key];
									$lcqty = $attributes['quantity'][$key];
                            		if($attributes['packing'][$key]=="1") 
                            		    $lcqty = $attributes['quantity'][$key];
                            		else {
                            		   $pkgar = explode('-', $attributes['packing'][$key]);
                            		   if($pkgar[0] > 0)
                            		        $lcqty = ($attributes['quantity'][$key] *  $pkgar[1]) / $pkgar[0];
                            		}
                            		
									if($qtys) {
										DB::table('item_location')->where('id', $qtys->id)->update(['quantity' => DB::raw('quantity + '.$lcqty) ]);
									} 
									
									$itemLocationSR = new ItemLocationSR();
									$itemLocationSR->location_id = $attributes['default_location'];
									$itemLocationSR->item_id = $value;
									$itemLocationSR->unit_id = $attributes['unit_id'][$key];
									$itemLocationSR->quantity = $lcqty;
									$itemLocationSR->status = 1;
									$itemLocationSR->invoice_id = $itemObj->id;
									$itemLocationSR->logid = $logid;//DEC24
									$itemLocationSR->qty_entry = $attributes['quantity'][$key];
									$itemLocationSR->save();
									
								}
								
								
							//################ Location Stock Entry End ####################
							
							
							//MAY25 BATCH NO ENTRY............
							if(isset($attributes['batchNos'][$key]) && $attributes['batchNos'][$key]!='' && $attributes['qtyBatchs'][$key]!='') {
            				    
            				    $batchArr = explode(',', $attributes['batchNos'][$key]);
            				    $qtyArr = explode(',', $attributes['qtyBatchs'][$key]);
            				    $bthidsArr = explode(',', $attributes['batchIds'][$key]);
            				    
            				    foreach($bthidsArr as $bkey => $bval) {
    
                    			    DB::table('batch_log')
                				                ->insert([
                				                    'batch_id' => $bval,
                				                    'item_id' => $value,
                				                    'document_type' => 'SR',
                				                    'document_id' => $this->sales_return->id,
                				                    'doc_row_id' => $itemObj->id,
                				                    'quantity' => $qtyArr[$bkey],
                				                    'trtype' => 1,
                				                    'invoice_date' => ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
                				                    'log_id' => $logid,
                				                    'created_at' => now(),
                				                    'created_by' => Auth::User()->id
                				                    ]);
    
                        			DB::table('item_batch')
                        			                    ->where('id',$bval)
                        				                ->update([
                        				                    'quantity' => DB::raw('quantity + '.$qtyArr[$bkey])
                        				                ]);	                
                        				                
            				    }
            				
            				}
            				//.....END BATCH ENTRY
								
						}
						
						$subtotal = (float)$line_total - (float)$discount;
						if($taxtype=='tax_include' && $attributes['discount'] == 0) {
						  
						  $net_amount = $subtotal;
						  $tax_total = ($subtotal * $vat) / (100 + $vat);
						  $subtotal = $subtotal - $tax_total;
						  
						} elseif($taxtype=='tax_include' && $attributes['discount'] > 0) { 
						
						   $tax_total = ($subtotal * $vat) / (100 + $vat);
						   $net_amount = $subtotal - $tax_total;
						} else 
							$net_amount = $subtotal + $tax_total;
					
						if( isset($attributes['is_fc']) ) {
							$total_fc 	   = $line_total / $attributes['currency_rate'];
							$discount_fc   = $attributes['discount'] / $attributes['currency_rate'];
							$vat_fc 	   = $attributes['vat_fc'] / $attributes['currency_rate'];
							$tax_fc 	   = round($tax_total / $attributes['currency_rate'],2);
							$net_amount_fc = $total_fc - $discount_fc + $tax_fc;
							$subtotal_fc	   = $subtotal / $attributes['currency_rate'];
							
						} else {
							$total_fc = $discount_fc = $tax_fc = $net_amount_fc = $vat_fc = $subtotal_fc = 0;  
						}

						
					//VOUCHER NO INCREMENT LOGIC//
					if( $attributes['curno'] == $attributes['voucher_no'] ) {
						$attributes['rowid'] = $this->sales_return->id;
						$newattributes = $this->voucherNoGenerate($attributes);
						$attributes['voucher_no'] = $newattributes['voucher_no'];
						$attributes['vno'] = $newattributes['vno'];
						$attributes['curno'] = $newattributes['curno'];
					} 
					//VOUCHER NO INCREMENT LOGIC//
						
						//update discount, total amount, vat and other cost....
						DB::table('sales_return')
									->where('id', $this->sales_return->id)
									->update([
										     'voucher_no'	  => $attributes['voucher_no'],
										     'total'    	  => $line_total,
											  'discount' 	  => (isset($attributes['discount']))?$attributes['discount']:0,
											  'vat_amount'	  => $tax_total,
											  'net_amount'	  => $net_amount,
											  'total_fc' 	  => $total_fc,
											  'discount_fc'   => $discount_fc,
											  'vat_amount_fc' => $tax_fc,
											  'net_amount_fc' => $net_amount_fc,
											  'subtotal'	  => $subtotal, //CHG
											  'subtotal_fc'	  => $subtotal_fc ]); //CHG
							
						//update invoice  balance amount..
						$sirow = DB::table('sales_invoice')->where('id', $attributes['sales_invoice_id'])->select('balance_amount')->first();
						if($sirow) {
							if($sirow->balance_amount==0) {
								DB::table('sales_invoice')
										->where('id', $attributes['sales_invoice_id'])
										->update(['balance_amount' => DB::raw('balance_amount + net_total - '.$net_amount) ]);
							} else {
								DB::table('sales_invoice')
										->where('id', $attributes['sales_invoice_id'])
										->update(['balance_amount' => DB::raw('balance_amount - '.$net_amount) ]); //$net_amount ]); //->update(['balance_amount' => DB::raw('balance_amount + net_total - '.$net_amount) ]);
							}
						}
						
						//check whether Cost Accounting method or not.....
						if(Session::get('cost_accounting')==1) {
							$this->CostAccountingMethod($attributes, $subtotal, $tax_total, $net_amount, $this->sales_return->id, $taxtype, $cost_value);
						} else {
							$this->PurchaseAndSalesMethod($attributes, $subtotal, $tax_total, $net_amount, $this->sales_return->id, $taxtype);
						}
						
						//update purchase return transfer status....
						if(isset($attributes['sales_invoice_id'])) 
							$this->setTransferStatusQuote($attributes);	
			
						//update voucher no........
						if( ($this->sales_return->id) && ($attributes['curno'] == $attributes['voucher_no']) ) { 
							if(Session::get('department')==1) { //if dept active...
								DB::table('account_setting')
								   ->where('voucher_type_id', 4) 
								   ->where('department_id', $attributes['department_id'])
								   ->update(['voucher_no' => DB::raw('voucher_no + 1')]);
							} else {
								DB::table('account_setting')
								   ->where('voucher_type_id', 4) //->where('id', $attributes['voucher_id'])
								   ->update(['voucher_no' => DB::raw('voucher_no + 1') ]);//$this->sales_invoice->id  $voucher_no
							}
						}
						
					}
					
				
				
				DB::commit();
				return true;
				
			} catch (\Exception $e) {
			  
			  DB::rollback(); echo $e->getLine().'-'.$e->getMessage();exit;
			  return false;
			}
		}
	}
	
	private function voucherNoGenerate($attributes) {

		$cnt = 0;
		do {
			$jvset = DB::table('account_setting')->where('id', $attributes['voucher_id'])->select('prefix','is_prefix','voucher_no')->first();
			if($jvset) {
				if($jvset->is_prefix==0) {
					$newattributes['voucher_no'] = $jvset->voucher_no + $cnt;
					$newattributes['vno'] = $jvset->voucher_no + $cnt;
				} else {
					$newattributes['voucher_no'] = $jvset->prefix.($jvset->voucher_no + $cnt);
					$newattributes['vno'] = $jvset->voucher_no + $cnt;
				}
				$newattributes['curno'] = $newattributes['voucher_no'];
			}

			if(Session::get('department')==1)
				$inv = DB::table('sales_return')->where('id','!=',$attributes['rowid'])->where('voucher_no',$newattributes['voucher_no'])->where('department_id', $attributes['department_id'])->where('status',1)->whereNull('deleted_at')->count();
			else
				$inv = DB::table('sales_return')->where('id','!=',$attributes['rowid'])->where('voucher_no',$newattributes['voucher_no'])->where('status',1)->whereNull('deleted_at')->count();
			//echo $inv.' - ';
			$cnt++;
		} while ($inv!=0);

		return $newattributes;
	}

	public function update($id, $attributes)
	{	//echo '<pre>';print_r($attributes);exit;
		$this->sales_return = $this->find($id);
		$line_total = $tax_total = $cost_value = $line_total_new = $tax_total_new = $item_total = 0;
		
		DB::beginTransaction();
		try {
			
			$lineTotal = $this->calculateTotalAmount($attributes);
			if($this->sales_return->id && !empty( array_filter($attributes['item_id']))) {
				foreach($attributes['item_id'] as $key => $value) { 
					
					if($attributes['order_item_id'][$key]!='') {
						
						$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['tax_code'][$key];//CHG
						if( isset($attributes['is_fc']) ) {
							$tax        = ( ($attributes['cost'][$key] * $attributes['line_vat'][$key]) / 100) * $attributes['currency_rate'];
							$itemtotal = ( ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $attributes['line_discount'][$key] ) * $attributes['currency_rate'];
							$taxtotal  = round($tax * $attributes['quantity'][$key],2);
							$linetotal = ($attributes['cost'][$key] * $attributes['quantity'][$key]) * $attributes['currency_rate'];
							
						} else {
							
							$linetotal = ($attributes['cost'][$key] * $attributes['quantity'][$key]);
							
							if(isset($attributes['is_export']) || $tax_code=="EX" || $tax_code=="ZR") {
								$idiscount = ($attributes['line_discount'][$key]!='')?$attributes['line_discount'][$key]:0;
								$tax        = 0;
								$itemtotal = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $idiscount;
								$taxtotal  = round($tax * $attributes['quantity'][$key],2);
								
							} else if($attributes['tax_include'][$key]==1){
								
								$ln_total   = $attributes['cost'][$key] * $attributes['quantity'][$key];
								$taxtotal  = $ln_total *  $attributes['line_vat'][$key] / (100 +  $attributes['line_vat'][$key]);
								$itemtotal = $ln_total - $taxtotal;
								
							} else {
								$idiscount = ($attributes['line_discount'][$key]!='')?$attributes['line_discount'][$key]:0;
								$tax        = ($attributes['cost'][$key] * $attributes['line_vat'][$key]) / 100;
								$itemtotal = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $idiscount;
								$taxtotal  = round($tax * $attributes['quantity'][$key],2);
							}
						}
						
						//********DISCOUNT Calculation.............
						$discount = (isset($attributes['discount']))?$attributes['discount']:0;
						$taxtype = 'tax_exclude';
							
						if($attributes['tax_include'][$key]==1 ) {
							$vatPlus = 100 + $attributes['line_vat'][$key];
							$total = $attributes['cost'][$key] * $attributes['quantity'][$key];
							$taxtype = 'tax_include';
						} else {
							$vatPlus = 100;
							$total = $attributes['line_total'][$key];
							$taxtype = 'tax_exclude';
						}
						
						if($discount > 0) {
							$discountAmt = round( (($total / $lineTotal) * $discount),2 );
							$amountTotal = $total - $discountAmt;
							$vatLine = round( (($amountTotal * $attributes['line_vat'][$key]) / $vatPlus),2 );
							$taxtotal = $vatLine; 
						} 
						
						$tax_total += $taxtotal;
						$line_total += $linetotal;
						$item_total += $itemtotal;
						
						$vat = $attributes['line_vat'][$key];
						
						$salesReturnItem = SalesReturnItem::find($attributes['order_item_id'][$key]);
						$oldqty = $salesReturnItem->quantity;
						$items['item_name'] = $attributes['item_name'][$key];
						$items['item_id'] = $value;
						$items['unit_id'] = $attributes['unit_id'][$key];
						$items['quantity'] = $attributes['quantity'][$key];
						$items['unit_price'] = (isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key];
						$items['vat']		 = $attributes['line_vat'][$key];
						$items['vat_amount'] = $taxtotal;
						$items['discount'] = $attributes['line_discount'][$key];
						$items['item_total'] = $itemtotal; //CHG
						$items['tax_code'] 	= $tax_code; //CHG
						$items['tax_include'] = $attributes['tax_include'][$key];//CHG
						$items['total_price'] = $linetotal;
						$items['item_cost'] = $item_cost = $attributes['item_cost'][$key];
						
						$items['width'] = isset($attributes['item_wit'][$key])?$attributes['item_wit'][$key]:0;
						$items['length'] = isset($attributes['item_lnt'][$key])?$attributes['item_lnt'][$key]:0;
						$items['mp_qty'] = isset($attributes['mpquantity'][$key])?$attributes['mpquantity'][$key]:0;
						$items['cat_id'] = isset($attributes['cat_id'][$key])?$attributes['cat_id'][$key]:'';//CHG
						//if(Session::get('cost_accounting')==1) {
							/* $item = DB::table('item_unit')->where('itemmaster_id', $attributes['item_id'][$key])
														  ->where('unit_id', $attributes['unit_id'][$key])
														  ->first();
							$cost_avg = ($item->cost_avg==0)?$item->last_purchase_cost:$item->cost_avg;
							$item_cost = $cost_avg * $attributes['quantity'][$key]; */
						//}
						
						$salesReturnItem->update($items);
						
						$cost_value += $item_cost;
						
						$CostAvg_log = $this->objUtility->updateLastPurchaseCostAndCostAvgonEdit($attributes, $key, null, null);
								
							$logid = $this->setPurchaseLog($attributes, $key, $this->sales_return->id, $CostAvg_log,'update');
								$this->updateItemQuantityonEdit($attributes, $key);
							
						
						//################ Location Stock Entry ####################
						//Item Location specific add....
						$updated = false;
						if(isset($attributes['locqty'][$key])) {
							foreach($attributes['locqty'][$key] as $lk => $lq) {
								if($lq!='') {
									$updated = true;
									//$lcqty = $lq * $attributes['packing'][$key];
									$lcqty = $lq;
                            		if($attributes['packing'][$key]=="1") 
                            		    $lcqty = $lq;
                            		else {
                            		   $pkgar = explode('-', $attributes['packing'][$key]);
                            		   if($pkgar[0] > 0)
                            		        $lcqty = ($lq *  $pkgar[1]) / $pkgar[0];
                            		}
                            		
									$edit = DB::table('item_location_sr')->where('id', $attributes['editid'][$key][$lk])->first();
									$idloc = DB::table('item_location')->where('status',1)->where('location_id', $attributes['locid'][$key][$lk])
																  ->where('item_id', $value)//->where('unit_id', $attributes['unit_id'][$key])
																  ->whereNull('deleted_at')->select('id')->first();
																  //echo '<pre>';print_r($edit);exit;
									if($edit) {
										
										if($edit->quantity < $lcqty) {
											$balqty = $lcqty - $edit->quantity;
											DB::table('item_location')->where('id', $idloc->id)->update(['quantity' => DB::raw('quantity + '.$balqty)]);
										} else {
											$balqty = $edit->quantity - $lcqty;
											DB::table('item_location')->where('id', $idloc->id)->update(['quantity' => DB::raw('quantity - '.$balqty)]);
										}
										
									} else {
										
										$itemLocationSR = new ItemLocationSR();
										$itemLocationSR->location_id = $attributes['locid'][$key][$lk];
										$itemLocationSR->item_id = $value;
										$itemLocationSR->unit_id = $attributes['unit_id'][$key];
										$itemLocationSR->quantity = $lcqty;
										$itemLocationSR->status = 1;
										$itemLocationSR->invoice_id = $attributes['order_item_id'][$key];
										$itemLocationSR->qty_entry = $lq;
										$itemLocationSR->save();
									}
									
									DB::table('item_location_sr')->where('id', $attributes['editid'][$key][$lk])->update(['quantity' => $lcqty, 'qty_entry' => $lq]);

								}
							}
						}
						
						//Item default location add...
						if(isset($attributes['default_location']) && ($attributes['default_location'] > 0) && ($updated == false)) {
								
								$qtys = DB::table('item_location')->where('status',1)->where('location_id', $attributes['default_location'])
																  ->where('item_id', $value)//->where('unit_id', $attributes['unit_id'][$key])
																  ->whereNull('deleted_at')->select('*')->first();
																  
								//$lcqty = $attributes['quantity'][$key] * $attributes['packing'][$key];
								$lcqty = $attributes['quantity'][$key];
                        		if($attributes['packing'][$key]=="1") 
                        		    $lcqty = $attributes['quantity'][$key];
                        		else {
                        		   $pkgar = explode('-', $attributes['packing'][$key]);
                        		   if($pkgar[0] > 0)
                        		        $lcqty = ($attributes['quantity'][$key] *  $pkgar[1]) / $pkgar[0];
                        		}
                        		
								if($qtys) {
									DB::table('item_location')->where('id', $qtys->id)->update(['quantity' => DB::raw('quantity - '.$lcqty) ]);
									DB::table('item_location_sr')->where('invoice_id', $attributes['order_item_id'][$key] )
																 ->where('location_id', $qtys->location_id)
																 ->where('item_id', $qtys->item_id)
																 ->where('unit_id', $qtys->unit_id)
																 ->update(['quantity' => DB::raw('quantity - '.$lcqty),'qty_entry' => $lq ]);
								} 
								
								$itemLocationSR = new ItemLocationSR();
								$itemLocationSR->location_id = $attributes['default_location'];
								$itemLocationSR->item_id = $value;
								$itemLocationSR->unit_id = $attributes['unit_id'][$key];
								$itemLocationSR->quantity = $lcqty;
								$itemLocationSR->status = 1;
								$itemLocationSR->invoice_id = $attributes['order_item_id'][$key];
								$itemLocationSR->qty_entry = $attributes['quantity'][$key];
								$itemLocationSR->save();
							}

							//**************** Consignment Location *********************
							if(isset($attributes['conloc_id'][$key]) && $attributes['conloc_id'][$key]!='') {
								
								$items['conloc_id'] 	= $attributes['conloc_id'][$key]; 
								$items['conloc_qty'] 	= $attributes['conloc_qty'][$key];
								if($attributes['conloc_id'][$key]!=$attributes['conloc_id_old'][$key]) {
									//SET ALL ITEMS ARE DELETED...
									$oldidarr = explode(',',$attributes['conloc_id_old'][$key]);
									$curidarr = explode(',',$attributes['conloc_id'][$key]);
									$curqty = explode(',',$attributes['conloc_qty'][$key]);
									
									DB::table('con_location_sr')->where('invoice_id', $attributes['order_item_id'][$key])
														 ->whereIn('location_id', $oldidarr)
														 ->update(['status' => 0, 'deleted_at' => now()]);
														 
									foreach($curidarr as $ky => $rw) {					 
										DB::table('con_location_sr')->where('invoice_id', $attributes['order_item_id'][$key])
														 ->where('location_id', $rw)
														 ->update(['quantity' => $curqty[$ky],'status' => 1, 'deleted_at' => '0000-00-00 00:00:00']);
									
									}
								}
								
							}
							//***********************************************************

							
						//################ Location Stock Entry End ####################
						
					} else { //new entry...
						
						$item_total_new = $tax_total_new = $item_total_new = $total = 0;
						if($discount > 0) 
							$total = $this->calculateTotalAmount($attributes);
					
						$vat = $attributes['line_vat'][$key];
						
						$salesReturnItem = new SalesReturnItem();
						$arrResult 		= $this->setItemInputValue($attributes, $salesReturnItem, $key, $value, $total);
						if($arrResult['line_total']) {
							$line_total_new 		 += $arrResult['line_total'];
							$tax_total_new      	 += $arrResult['tax_total'];
							$item_total_new			 += $arrResult['item_total'];
							
							$line_total			     += $arrResult['line_total'];
							$tax_total      	     += $arrResult['tax_total'];
							$item_total 			 += $arrResult['item_total'];
							$taxtype				  = $arrResult['type'];
							$cost_value 		     += $arrResult['cost_value'];

							$salesReturnItem->status = 1;
							$itemObj = $this->sales_return->salesReturnItemAdd()->save($salesReturnItem);
							
							$CostAvg_log = $this->updateLastPurchaseCostAndCostAvg($attributes, $key);
							
							$attributes['item_row_id'][$key] = $itemObj->id; //OCT24
							//update item transfer status...
							$logid = $this->setPurchaseLog($attributes, $key, $this->sales_return->id, $CostAvg_log,'add');
								$this->updateItemQuantity($attributes, $key);
								
						}
						
							//################ Location Stock Entry ####################
							//Item Location specific add....
							if(isset($attributes['locqty'][$key])) {
								foreach($attributes['locqty'][$key] as $lk => $lq) {
									if($lq!='') {
										$updated = true;
										//$lcqty = $lq * $attributes['packing'][$key];
										$lcqty = $lq;
                                		if($attributes['packing'][$key]=="1") 
                                		    $lcqty = $lq;
                                		else {
                                		   $pkgar = explode('-', $attributes['packing'][$key]);
                                		   if($pkgar[0] > 0)
                                		        $lcqty = ($lq *  $pkgar[1]) / $pkgar[0];
                                		}
										$qtys = DB::table('item_location')->where('status',1)->where('location_id', $attributes['locid'][$key][$lk])
																	  ->where('item_id', $value)//->where('unit_id', $attributes['unit_id'][$key])
																	  ->whereNull('deleted_at')->select('id')->first();
										if($qtys) {
											DB::table('item_location')->where('id', $qtys->id)->update(['quantity' => DB::raw('quantity + '.$lcqty) ]);
										} else {
											$itemLocation = new ItemLocation();
											$itemLocation->location_id = $attributes['locid'][$key][$lk];
											$itemLocation->item_id = $value;
											$itemLocation->unit_id = $attributes['unit_id'][$key];
											$itemLocation->quantity = $lcqty;
											$itemLocation->status = 1;
											$itemLocation->save();
										}
										
										$itemLocationSR = new ItemLocationSR();
										$itemLocationSR->location_id = $attributes['locid'][$key][$lk];
										$itemLocationSR->item_id = $value;
										$itemLocationSR->unit_id = $attributes['unit_id'][$key];
										$itemLocationSR->quantity = $lcqty;
										$itemLocationSR->status = 1;
										$itemLocationSR->invoice_id = $itemObj->id;
										$itemLocationSR->logid = $logid;//DEC24
										$itemLocationSR->qty_entry = $lq;
										$itemLocationSR->save();
									}
								}
							}
							
							//Item default location add...
							if(isset($attributes['default_location']) && ($attributes['default_location'] > 0) && ($updated == false)) {
									
								$qtys = DB::table('item_location')->where('status',1)->where('location_id', $attributes['default_location'])
																  ->where('item_id', $value)//->where('unit_id', $attributes['unit_id'][$key])
																  ->whereNull('deleted_at')->select('id')->first();
																  
								//$lcqty = $attributes['quantity'][$key] * $attributes['packing'][$key];
								$lcqty = $attributes['quantity'][$key];
                        		if($attributes['packing'][$key]=="1") 
                        		    $lcqty = $attributes['quantity'][$key];
                        		else {
                        		   $pkgar = explode('-', $attributes['packing'][$key]);
                        		   if($pkgar[0] > 0)
                        		        $lcqty = ($attributes['quantity'][$key] *  $pkgar[1]) / $pkgar[0];
                        		}
                        		
								if($qtys) {
									DB::table('item_location')->where('id', $qtys->id)->update(['quantity' => DB::raw('quantity + '.$lcqty) ]);
								} 
								
								$itemLocationSR = new ItemLocationSR();
								$itemLocationSR->location_id = $attributes['default_location'];
								$itemLocationSR->item_id = $value;
								$itemLocationSR->unit_id = $attributes['unit_id'][$key];
								$itemLocationSR->quantity = $lcqty;
								$itemLocationSR->status = 1;
								$itemLocationSR->invoice_id = $itemObj->id;
								$itemLocationSR->logid = $logid;//DEC24
								$itemLocationSR->qty_entry = $lq;
								$itemLocationSR->save();
								
							}
								

								//**************** Consignment Location *********************
								if(isset($attributes['conloc_id'][$key]) && $attributes['conloc_id'][$key]!='') {

									if(isset($attributes['conloc_qty'][$key])) {

										$locarr = explode(',',$attributes['conloc_id'][$key]);
										$qtyarr = explode(',',$attributes['conloc_qty'][$key]);

										foreach($locarr as $lk => $lq) {
											$conLocationsr = new ConLocationSR();
											$conLocationsr->location_id = $attributes['cnlocid'][$key][$lk];
											$conLocationsr->item_id = $value;
											$conLocationsr->unit_id = $attributes['unit_id'][$key];
											$conLocationsr->quantity = $lq;
											$conLocationsr->status = 1;
											$conLocationsr->invoice_id = $itemObj->id;
											$conLocationsr->save();
										}
									}

								}
								//***********************************************************

							//################ Location Stock Entry End ####################
					}
					
				}
			}
			
			//manage removed items...
			if($attributes['remove_item']!='')
			{
				$arrids = explode(',', $attributes['remove_item']);
				$remline_total = $remtax_total = 0;
				foreach($arrids as $row) {
										
					DB::table('sales_return_item')->where('id', $row)->update(['status' => 0,'deleted_at' => now() ]);
					$res = DB::table('sales_return_item')->where('id',$row)->first();
					
					//REMOVE FROM CONSIGNMENT LOCATION
					DB::table('con_location_sr')->where('invoice_id',$row)->update(['status' => 0, 'deleted_at' => now()]);
						
					//$this->objUtility->updateLastPurchaseCostAndCostAvgonDelete($res, $attributes['sales_invoice_id']);
					//update item unit quantity..
					
					 
				}
			}
			
			if($this->setInputValue($attributes)) {
				$this->sales_return->modify_at = now();
				$this->sales_return->modify_by = 1;
				$this->sales_return->fill($attributes)->save();
			}
			$this->sales_return->fill($attributes)->save();
			
			$subtotal = $line_total - $discount;
			if($taxtype=='tax_include' && $attributes['discount'] == 0) {
			  
			  $net_amount = $subtotal;
			  $tax_total = ($subtotal * $vat) / (100 + $vat);
			  $subtotal = $subtotal - $tax_total;
			  
			} elseif($taxtype=='tax_include' && $attributes['discount'] > 0) { 
			
			   $tax_total = ($subtotal * $vat) / (100 + $vat);
			   $net_amount = $subtotal - $tax_total;
			} else 
				$net_amount = $subtotal + $tax_total;
			
			if( isset($attributes['is_fc']) ) {
				$total_fc 	   = $line_total / $attributes['currency_rate'];
				$discount_fc   = $attributes['discount'] / $attributes['currency_rate'];
				$vat_fc 	   = $attributes['vat_fc'] / $attributes['currency_rate'];
				$tax_fc 	   = $tax_total / $attributes['currency_rate'];
				$net_amount_fc = $total_fc - $discount_fc + $tax_fc;
				$subtotal_fc   = $subtotal / $attributes['currency_rate'];
			} else {
				$total_fc = 0; $discount_fc = 0; $tax_fc = 0; $net_amount_fc = 0; $vat_fc = $subtotal_fc = 0;
			}
			
			//update discount, total amount
			DB::table('sales_return')
					->where('id', $this->sales_return->id)
					->update(['total'    	  => $line_total,
							  'discount' 	  => $attributes['discount'],
							  'vat_amount'	  => $tax_total,
							  'net_amount'	  => $net_amount,
							  'total_fc' 	  => $total_fc,
							  'discount_fc'   => $discount_fc,
							  'vat_amount_fc' => $tax_fc,
							  'net_amount_fc'  => $net_amount_fc,
							  'subtotal'	  => $subtotal, //CHG
							  'subtotal_fc'	  => $subtotal_fc ]); //CHG

			//update invoice  balance amount.. JUL9
			DB::table('sales_invoice')
					->where('id', $attributes['sales_invoice_id'])
					->update(['balance_amount' => $net_amount ]); //->update(['balance_amount' => DB::raw('balance_amount + net_total - '.$net_amount) ]);
			
			if(Session::get('cost_accounting')==1) {
				$this->CostAccountingMethodUpdate($attributes, $subtotal, $tax_total, $net_amount, $this->sales_return->id, $taxtype, $cost_value);
			} else {
				$this->PurchaseAndSalesMethodUpdate($attributes, $subtotal, $tax_total, $net_amount, $this->sales_return->id, $taxtype);
			}
						
			DB::commit();
			return true;
			
		} catch(\Exception $e) {
			
			DB::rollback();  echo $e->getLine().'-'.$e->getMessage();exit;
			return false;
		}
	}
	
	public function suppliersDOList()
	{
		$query = $this->sales_return->where('sales_return.status',1);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_return.supplier_id');
						} )
					->select('sales_return.*','am.master_name AS supplier')
					->orderBY('sales_return.id', 'DESC')
					->get();
	}
	
	public function getSDOdata($supplier_id = null)
	{
		if($supplier_id)
			$query = $this->sales_return->where('sales_return.status',1)->where('sales_return.is_transfer',0)->where('sales_return.supplier_id',$supplier_id);
		else
			$query = $this->sales_return->where('sales_return.status',1)->where('sales_return.is_transfer',0);
		
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_return.supplier_id');
						} )
					->select('sales_return.*','am.master_name AS supplier')
					->orderBY('sales_return.id', 'ASC')
					->get();
	}
	
	public function findSDOdata($id)
	{
		$query = $this->sales_return->where('sales_return.id', $id);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_return.supplier_id');
						} )
					->select('sales_return.*','am.master_name AS supplier')
					->orderBY('sales_return.id', 'ASC')
					->first();
	}
	
	public function findSRdata($id)
	{
	    
		$query = $this->sales_return->where('sales_return.id', $id);
		return $query->leftjoin('account_master AS am', function($join) {
							$join->on('am.id','=','sales_return.dr_account_id');
						} )
					->leftjoin('account_master AS am2', function($join){
						  $join->on('am2.id','=','sales_return.cr_account_id');
					  }) 
					  	->leftJoin('jobmaster AS J', function($join){
					  $join->on('J.id','=','sales_return.job_id');
					})
					/*->leftJoin('header_footer AS f',function($join) {
						$join->on('f.id','=','sales_return.footer_id');
					})
					 ->leftJoin('salesman AS S',function($join) {
						$join->on('S.id','=','sales_return.salesman_id');
					}) */
					->select('sales_return.*','am.master_name AS account','am2.master_name AS customer','J.code')//'S.name AS salesman'
					->orderBY('sales_return.id', 'ASC')
					->first();
	}
	
	public function getItems($id) //JUL9
	{
		$query = $this->sales_return->where('sales_return.id',$id);
		
		return $query->join('sales_return_item AS poi', function($join) {
							$join->on('poi.sales_return_id','=','sales_return.id');
						} )
					  ->join('units AS u', function($join){
						  $join->on('u.id','=','poi.unit_id');
					  }) 
					  ->join('item_unit AS iu', function($join){
						  $join->on('iu.unit_id','=','poi.unit_id')
							   ->on('iu.itemmaster_id','=','poi.item_id');
					  })
					  ->join('itemmaster AS im', function($join){
						  $join->on('im.id','=','poi.item_id');
					  })
					  ->where('poi.status',1)
					  ->select('poi.*','u.unit_name','im.item_code','iu.packing','iu.is_baseqty','iu.pkno')
					  ->groupBy('poi.id')->get();
	}
	
	public function salesReturnListCount()
	{
		$query = $this->sales_return->where('sales_return.status',1);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_return.customer_id');
						} )
					->count();
	}
	
	public function salesReturnList($type,$start,$limit,$order,$dir,$search)
	{
		$query = $this->sales_return->where('sales_return.status',1)
						->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_return.customer_id');
						} );
						
				if($search) {
					$query->where('sales_return.voucher_no','LIKE',"%{$search}%")
                          ->orWhere('am.master_name', 'LIKE',"%{$search}%");
				}
				
				$query->select('sales_return.*','am.master_name AS customer')
					->offset($start)
                    ->limit($limit)
                    ->orderBy($order,$dir);
					
				if($type=='get')
					return $query->get();
				else
					return $query->count();
	}
	
	public function salesReturnList2()
	{
		$query = $this->sales_return->where('sales_return.status',1);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_return.customer_id');
						} )
					->join('sales_invoice AS pi', function($join) {
							$join->on('pi.id','=','sales_return.sales_invoice_id');
						} )
					->select('sales_return.*','am.master_name AS supplier')
					->orderBY('sales_return.id', 'DESC')
					->get();
	}
	
	public function activeSalesReturnList()
	{
		return $this->sales_return->select('id','name')->where('status', 1)->orderBy('name', 'ASC')->get()->toArray();
	}
	
	public function check_reference_no($refno, $id = null) { 
		
		if($id)
			return $this->sales_return->where('reference_no',$refno)->where('id', '!=', $id)->count();
		else
			return $this->sales_return->where('reference_no',$refno)->count();
	}
	
	public function getPidata()
	{
		$query = $this->sales_return->where('sales_return.status',1);
		
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_return.supplier_id');
						} )
					->select('sales_return.*','am.master_name AS supplier')
					->orderBY('sales_return.id', 'ASC')
					->get();
	}
		
	public function getSDOitems($id)
	{
		$query = $this->sales_return->where('sales_return.id',$id);
		
		return $query->join('sales_return_item AS poi', function($join) {
							$join->on('poi.sales_return_id','=','sales_return.id');
						} )
					  ->join('units AS u', function($join){
						  $join->on('u.id','=','poi.unit_id');
					  }) 
						->select('poi.*','u.unit_name')->get();
		//return $this->itemmaster->where('status', 1)->orderBy('description','ASC')->select('id','item_code','description')->get();
	}
	
	public function getReturnReport($attributes) 
	{
		$result = array();
		
		if($attributes['date_from']!=null && $attributes['date_to']!=null) {
			$date_from = (isset($attributes['date_from']))?date('Y-m-d', strtotime($attributes['date_from'])):'';
			$date_to = (isset($attributes['date_to']))?date('Y-m-d', strtotime($attributes['date_to'])):'';
			
			$result = $this->sales_return->where('sales_return.status',1)
								    ->join('account_master AS AM', function($join) {
									   $join->on('AM.id','=','sales_return.customer_id');
								   })
								   ->leftJoin('jobmaster AS JM', function($join) {
									   $join->on('JM.id','=','sales_return.job_id');
								   })
								   ->whereBetween('voucher_date', array($date_from, $date_to))
								   ->select('AM.master_name AS supplier','sales_return.*','JM.name AS job','sales_return.net_amount AS net_total')
								   ->orderBY('id', 'ASC')
								   ->get();
		} else {
			$result = $this->sales_return->where('sales_return.status',1)
								   ->join('account_master AS AM', function($join) {
									   $join->on('AM.id','=','sales_return.customer_id');
								   })
								   ->leftJoin('jobmaster AS JM', function($join) {
									   $join->on('JM.id','=','sales_return.job_id');
								   })
								   ->select('AM.master_name AS supplier','sales_return.*','JM.name AS job','sales_return.net_amount AS net_total')
								   ->orderBY('sales_return.id', 'ASC')
								   ->get();
		}
		
		return $result; 
	}
	
	public function getReturn($attributes)
	{
		$order = $this->sales_return->where('sales_return.id', $attributes['document_id'])
								   ->join('account_master AS AM', function($join) {
									   $join->on('AM.id','=','sales_return.customer_id');
								   })
								   ->join('sales_invoice AS SI', function($join) {
									   $join->on('SI.id','=','sales_return.sales_invoice_id');
								   })
								   ->leftJoin('terms AS TR', function($join) {
									   $join->on('TR.id','=','SI.terms_id');
								   })
								   ->leftJoin('salesman AS SL', function($join) {
									   $join->on('SL.id','=','SI.salesman_id');
								   })
								   ->select('AM.account_id','AM.master_name AS supplier','sales_return.*','AM.address','AM.city','SL.name AS salesman',
								   'AM.state','AM.contact_name','AM.vat_no','AM.phone AS custphone','SI.lpo_no','TR.description AS terms','SI.description')
								   ->orderBY('sales_return.id', 'ASC')
								   ->first();
		

		$items = $this->sales_return->where('sales_return.id', $attributes['document_id'])
								   ->join('sales_return_item AS PI', function($join) {
									   $join->on('PI.sales_return_id','=','sales_return.id');
								   })
								   ->join('itemmaster AS IM', function($join) {
									   $join->on('IM.id','=','PI.item_id');
								   })
								   ->join('units AS U', function($join) {
									   $join->on('U.id','=','PI.unit_id');
								   })
								   ->select('PI.*','sales_return.*','IM.item_code','U.unit_name','sales_return.net_amount AS net_total')
								   ->get();
								   
		return $result = ['details' => $order, 'items' => $items];
	}
	
	public function check_voucher_no($refno, $id = null) { 
		
		if($id)
			return $this->sales_return->where('voucher_no',$refno)->where('id', '!=', $id)->count();
		else{
			$query =  $this->sales_return->where('voucher_no',$refno);
			return $result = isset($deptid)?$query->where('department_id', $deptid)->count():$query->count();

		}
	}
	public function getReportsales($attributes)
	{
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		
		$query = DB::table('sales_return')//$this->sales_invoice deleted_at
						->join('sales_return_item AS POI', function($join) {
							$join->on('POI.sales_return_id','=','sales_return.id');
						})
						->join('itemmaster AS IM', function($join) {
							$join->on('IM.id','=','POI.item_id');
						})
						->join('account_master AS AM', function($join) {
							$join->on('AM.id','=','sales_return.customer_id');
						})
						->join('account_setting AS AST', function($join) {
							$join->on('AST.id','=','sales_return.voucher_id');
						})
						// ->leftJoin('salesman AS S', function($join) {
						// 	$join->on('S.id','=','sales_return.salesman_id');
						// })
						// ->leftJoin('department AS D', function($join) {
						// 	$join->on('D.id','=','sales_return.department_id');
								 //->where('sales_invoice.department_id','>',0);
					//	})
						->leftJoin('groupcat AS GP', function($join) {
							$join->on('GP.id','=','IM.group_id');
						})
						->leftJoin('groupcat AS SGP', function($join) {
							$join->on('GP.id','=','IM.subgroup_id');
						})
						->leftJoin('category AS CAT', function($join) {
							$join->on('CAT.id','=','IM.category_id');
						})
						->leftJoin('category AS SCAT', function($join) {
							$join->on('CAT.id','=','IM.subcategory_id');
						})
						// ->leftJoin('vehicle AS V', function($join) {
						// 	$join->on('V.id','=','sales_invoice.vehicle_id');
						// })
						->where('POI.status',1)
						->where('POI.deleted_at','0000-00-00 00:00-00')
						->where('sales_return.status',1)
						->where('sales_return.deleted_at','0000-00-00 00:00-00');
				if(isset($attributes['job_id']))
					$query->whereIn('sales_return.job_id', $attributes['job_id']);		
				if(isset($attributes['group_id']))
					$query->whereIn('IM.group_id', $attributes['group_id']);
				
				if(isset($attributes['subgroup_id']))
					$query->whereIn('IM.subgroup_id', $attributes['subgroup_id']);
				
				if(isset($attributes['category_id']))
					$query->whereIn('IM.category_id', $attributes['category_id']);
				
				if(isset($attributes['subcategory_id']))
					$query->whereIn('IM.subcategory_id', $attributes['subcategory_id']);
						
				if( $date_from!='' && $date_to!='' ) { 
					$query->whereBetween('sales_return.voucher_date', array($date_from, $date_to));
				}
				if(isset($attributes['customer_iid']) && $attributes['customer_iid']!=''){
					$query->where('sales_return.customer_id', $attributes['customer_iid']);	
				} 
				if( $attributes['search_type']=='daily' ) { 
					$query->whereBetween( 'sales_return.voucher_date', array(date('Y-m-d'), date('Y-m-d')) );
				}
				
				/*if($attributes['salesman']!='') { 
					$query->where('sales_invoice.salesman_id', $attributes['salesman']);
				}*/
				// if($attributes['salesman']!='') { 
				// 	$query->where('sales_return.salesman_id', $attributes['salesman']);
				// }
				
				// if( $attributes['search_type']=='department') { 
				// 	$query->where('sales_return.department_id','!=',0);
			//	}
		if(isset($attributes['customer_id']) && $attributes['customer_id']!='')
				$query->whereIn('sales_return.customer_id', $attributes['customer_id']);		
			

		if(isset($attributes['item_id']) && $attributes['item_id']!='')
					$query->whereIn('POI.item_id', $attributes['item_id']);	
				// if($attributes['vehicle_no']!='') { 
				// 	$query->where('V.reg_no', $attributes['vehicle_no']);//voucher_id subtotal
				// 'V.reg_no',}
				
		 $query->select('sales_return.voucher_no','AM.master_name AS customer','sales_return.reference_no','sales_return.customer_id','sales_return.total','sales_return.vat_amount','sales_return.subtotal',
							  'sales_return.amount_transfer','sales_return.discount AS total_discount','AST.is_cash_voucher',
							  'POI.total_price','POI.item_total','POI.vat_amount','POI.item_name','POI.unit_price','sales_return.vat_amount','POI.discount','IM.description','sales_return.voucher_date','POI.item_id',
							  'POI.quantity','POI.vat_amount AS item_vat','POI.tax_include','AM.account_id','AM.master_name','AM.vat_no',
							  'sales_return.net_amount','POI.tax_code',
							  'POI.tax_include','IM.item_code','GP.group_name AS group','SGP.group_name AS subgroup','AST.voucher_name',
							  'CAT.category_name AS category','SCAT.category_name AS subcategory','sales_return.voucher_id');
								  
		//if(isset($attributes['type']))
		//	return $query->groupBy('sales_return.id')->get()->toArray();
		//else
		if($attributes['search_type']=='summary')
			return $query->groupBy('sales_return.id')->get();
		else
		return $query->get();
	}
	// public function getReport($attributes)
	// {
	// 	$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
	// 	$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		
	// 	switch($attributes['search_type']) {
	// 		case 'summary':
	// 			$query = $this->sales_return
	// 							->join('sales_return_item AS POI', function($join) {
	// 								$join->on('POI.sales_return_id','=','sales_return.id');
	// 							})
	// 							->join('account_master AS AM', function($join) {
	// 								$join->on('AM.id','=','sales_return.customer_id');
	// 							})
	// 							/* ->leftJoin('salesman AS S', function($join) {
	// 								$join->on('S.id','=','sales_return.salesman_id');
	// 							}) */
	// 							->where('POI.status',1);
								
	// 					if( $date_from!='' && $date_to!='' ) { 
	// 						$query->whereBetween('sales_return.voucher_date', array($date_from, $date_to));
	// 					}
						
	// 					/* if($attributes['salesman']!='') { 
	// 						$query->where('sales_return.salesman_id', $attributes['salesman']);
	// 					} */
						 
	// 			return $query->select('sales_return.voucher_no','sales_return.reference_no','sales_return.total','sales_return.vat_amount','sales_return.discount',
	// 								  'sales_return.voucher_date','POI.quantity','POI.unit_price','AM.account_id','AM.master_name','AM.vat_no','sales_return.net_amount')
	// 							->groupBy('sales_return.id')->get();
	// 		break;
			
	// 		case 'detail':
	// 			$query = $this->sales_return
	// 							->join('sales_return_item AS SOI', function($join) {
	// 								$join->on('SOI.sales_return_id','=','sales_return.id');
	// 							})
	// 							->join('account_master AS AM', function($join) {
	// 								$join->on('AM.id','=','sales_return.customer_id');
	// 							})
	// 							->join('itemmaster AS IM', function($join) {
	// 								$join->on('IM.id','=','SOI.item_id');
	// 							})
	// 							->where('SOI.status',1);
								
	// 					if( $date_from!='' && $date_to!='' ) { 
	// 						$query->whereBetween('sales_return.voucher_date', array($date_from, $date_to));
	// 					}
						
						
	// 			return $query->select('sales_return.voucher_no','sales_return.reference_no','IM.item_code','IM.description','sales_return.discount',
	// 								  'SOI.quantity','SOI.unit_price','SOI.total_price','AM.master_name','sales_return.net_amount')
	// 							->get();
	// 			break;
	// 	}
	// }
	
	public function check_order($id)
	{
		$row = $this->sales_return->find($id);
		
		//$count = DB::table('receipt_voucher_tr')->where('sales_invoice_id', $row->sales_invoice_id)->count();
		if($row)
			return true;
		else
			return false;
	}
	
	public function delete($id)
	{
		
		$this->sales_return = $this->sales_return->find($id);
		DB::beginTransaction();
		try {
			if($this->sales_return->sales_invoice_id!='') {
				DB::table('sales_invoice')
							->where('id', $this->sales_return->sales_invoice_id)
							->update(['is_transfer' => 0,'is_editable' => 0,'amount_transfer' => 0, 'balance_amount' => 0]);
			}
			
			//inventory update...
			$items = DB::table('sales_return_item')->where('sales_return_id', $id)->select('id','item_id','unit_id','quantity')->get();
			$this->updateLastPurchaseCostAndCostAvgonDelete($items, $id);
			
			//REMOVE FROM CONSIGNMENT LOCATION
			foreach($items as $item) {
				DB::table('con_location_sr')->where('invoice_id',$item->id)->update(['status' => 0, 'deleted_at' => now()]);
			}	
			/* foreach($items as $item) {
				DB::table('item_unit')->where('itemmaster_id', $item->item_id)->where('unit_id',$item->unit_id)
									  ->update(['cur_quantity' => DB::raw('cur_quantity - '.$item->quantity)]);
									  
				DB::table('item_location')->where('item_id', $item->item_id)->where('unit_id', $item->unit_id)
										  ->where('location_id', $this->sales_return->location_id)
										  ->update(['quantity' => DB::raw('quantity - '.$item->quantity) ]);
			} */
			
			//Transaction update....
			DB::table('account_transaction')->where('voucher_type', 'SR')->where('voucher_type_id',$id)->update(['status' => 0,'deleted_at' => now(),'deleted_by' => Auth::User()->id ]);
			
			//DB::table('account_master')->where('id', $this->sales_return->dr_account_id)->update(['cl_balance' => DB::raw('cl_balance + '.$this->sales_return->net_amount)]);
			$this->objUtility->tallyClosingBalance($this->sales_return->dr_account_id);
			
			//DB::table('account_master')->where('id', $this->sales_return->cr_account_id)->update(['cl_balance' => DB::raw('cl_balance + '.$this->sales_return->total)]);
			$this->objUtility->tallyClosingBalance($this->sales_return->cr_account_id);
			
			$vatrow = $this->getVatAccounts((isset($attributes['department_id']))?$attributes['department_id']:null); //DB::table('vat_master')->where('status', 1)->whereNull('deleted_at')->first();
			if($vatrow) {
				//DB::table('account_master')->where('id', $vatrow->payment_account)->update(['cl_balance' => DB::raw('cl_balance + '.$this->sales_return->vat_amount)]);
				$this->objUtility->tallyClosingBalance($vatrow->payment_account);
			}
			
			//update transfer status...
			/* DB::table('sales_invoice')->where('id', $this->sales_return->sales_invoice_id)
									  ->update(['is_transfer' => 0]); */
			DB::table('sales_return')->where('id', $id)
									  ->update(['status' => 0, 'deleted_at' => now(),'deleted_by' => Auth::User()->id ]);	
						  
			$this->sales_return->delete();
			
			DB::commit();
			return true;
			
		} catch(\Exception $e) {
			
			DB::rollback();
			return false;
		}
	}
	
	//CLOSING BALANCE UPDATE...
	public function tallyClosingBalance($id)
	{
		$this->updateAccountTally( $this->groupAccount($this->updateUtilityById($id)) );
	}
	
	public function updateUtilityById($id)
	{
		$date = DB::table('parameter1')->select('from_date','to_date')->first();
		
		return $query = DB::table('account_master')->where('account_master.status',1)
						->where('account_master.id', $id)
						->join('account_transaction', 'account_transaction.account_master_id', '=', 'account_master.id')
						->where('account_transaction.voucher_type','!=','OBD')
						->where('account_transaction.status',1)
						->where('account_transaction.deleted_at','0000-00-00 00:00:00')
						->where('account_master.status',1)
						->where('account_master.deleted_at','0000-00-00 00:00:00')
						->where('account_transaction.deleted_at','0000-00-00 00:00:00')
						->whereBetween('account_transaction.invoice_date',[$date->from_date, $date->to_date])
						->select('account_master.id','account_master.master_name','account_master.cl_balance','account_master.category',
								 'account_transaction.transaction_type','account_transaction.amount','account_master.op_balance','account_transaction.invoice_date')
						->orderBy('account_master.id','ASC')
						->get();
			
	}
	
	protected function groupAccount($result)
	{
		$childs = array();
		foreach($result as $item)
			$childs[$item->id][] = $item;

		return $childs;
	}
	
	protected function updateAccountTally($results)
	{
		$arrSummarry = array();
		foreach($results as $result)
		{
			$arraccount = array(); 
			$dramount = $cramount = 0;
			foreach($result as $row) {
				$cl_balance = $row->cl_balance;
				$account_id = $row->id;
				if($row->transaction_type=='Dr') {
					$amountD = ($row->amount < 0)?(-1*$row->amount):$row->amount;
					$dramount += $amountD;
				} else {
					$amountC = ($row->amount < 0)?(-1*$row->amount):$row->amount;
					$cramount += $amountC;
				}
			}
			
			$amount = $dramount - $cramount;
			//$amount = ($amount < 0)?(-1*$amount):$amount;
			if($amount != $cl_balance) {
				//update the closing balance as amount.....
				$this->updateClosingBalance($account_id, $amount);
			}
				
		}
		return true;
	}
	
	public function updateClosingBalance($account_id, $amount)
	{
		 DB::table('account_master')
					->where('id', $account_id)
					->update(['cl_balance' => $amount]);
	}
	
	private function updateLastPurchaseCostAndCostAvg($attributes, $key)
	{
		$sirow = DB::table('item_log')->where('document_type','SI')
							 ->where('document_id', $attributes['sales_invoice_id'])
							 ->where('item_id', $attributes['item_id'][$key])
							 ->where('unit_id', $attributes['unit_id'][$key])
							 ->where('status', 1)
							 ->whereNull('deleted_at')
							 ->select('pur_cost','sale_reference')
							 ->first();
		
		$itmlogs = DB::table('item_log')->where('item_id', $attributes['item_id'][$key])
										->where('status', 1)
										->where('trtype', 1)
										->where('cur_quantity', '>', 0)
										->whereNull('deleted_at')
										->select('cur_quantity','pur_cost')
										->get();
										
		//$itmcost = $itmqty = 0;
		if($sirow) {
			$purcost = $sirow->pur_cost;
		} else {
			$purcost = ($itmlogs)?$itmlogs[0]->pur_cost:0;
		}
		
		$itmcost = $attributes['quantity'][$key] * $purcost;
		$itmqty = $attributes['quantity'][$key];
		foreach($itmlogs as $log) {
			$itmcost += ($log->cur_quantity * $log->pur_cost);
			$itmqty += $log->cur_quantity;
		}
		
		$cost_avg = round( ($itmcost / $itmqty), 3);
		$cost = (isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key];
					
		DB::table('item_unit')
				->where('id', $attributes['item_id'][$key])
				->update(['last_purchase_cost' => $cost,
						  'pur_count' 		   => DB::raw('pur_count + 1'),
						  'cost_avg'		   => $cost_avg
						]);
							
		return $cost_avg;
		
	}
	
	private function setPurchaseLog($attributes, $key, $document_id, $cost_avg, $action)
	{
		$sirow = DB::table('item_log')->where('document_type','SI')
							 ->where('document_id', $attributes['sales_invoice_id'])
							 ->where('item_id', $attributes['item_id'][$key])
							 ->where('unit_id', $attributes['unit_id'][$key])
							 ->where('status', 1)
							 ->whereNull('deleted_at')
							 ->select('pur_cost')
							 ->first();
		
		$irow = DB::table('item_unit')->where('itemmaster_id', $attributes['item_id'][$key])->select('cur_quantity')->first();
		
		$unit_cost = (isset($attributes['is_fc']))?($attributes['cost'][$key]*$attributes['currency_rate']):($attributes['cost'][$key]);

		if($attributes['packing'][$key]=="1") 
		    $quantity = $attributes['quantity'][$key];
		else {
		   $pkgar = explode('-', $attributes['packing'][$key]);
		   $quantity = ($attributes['quantity'][$key] *  $pkgar[1]) / $pkgar[0];
		   
		   //COST...
		   $unit_cost = ($unit_cost * $pkgar[0]) / $pkgar[1];
		}
		
		if($action=='add') {
			$cur_quantity = ($irow)?$irow->cur_quantity + $attributes['quantity'][$key]:0;
			
			//-----------ITEM LOG----------------							
			$logid = DB::table('item_log')->insertGetId([
							 'document_type' => 'SR',
							 'document_id'   => $document_id,
							 'item_id' 	  => $attributes['item_id'][$key],
							 'unit_id'    => $attributes['unit_id'][$key],
							 'quantity'   => $quantity, //$attributes['quantity'][$key] * $attributes['packing'][$key],//14JN24
							 'unit_cost'  => $unit_cost,//(isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key],
							 'trtype'	  => 1,
							 'cur_quantity' => $attributes['quantity'][$key],
							 'cost_avg' => $cost_avg,
							 'pur_cost' => ($sirow)?$sirow->pur_cost:0,
							 'packing' => 1,
							 'status'     => 1,
							 'created_at' => now(),
							 'created_by' => Auth::User()->id,
							 'voucher_date' => ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
							 'sale_reference' => $cur_quantity,
							 'return_ref_id'  => ($attributes['is_prior'])?0:$attributes['sales_invoice_id'],
							 'item_row_id'	=> $attributes['item_row_id'][$key], //OCT24
							 'category_id' => isset($attributes['cat_id'][$key])?$attributes['cat_id'][$key]:''
							]);
			//-------------ITEM LOG------------------
			
		} else if($action=='update') {
			$logid = '';
			//-----------ITEM LOG----------------							
			DB::table('item_log')->where('document_type','SR')
							->where('document_id', $document_id)
							->where('item_id', $attributes['item_id'][$key])
							->where('unit_id', $attributes['unit_id'][$key])
							->where('item_row_id', $attributes['order_item_id'][$key]) //OCT24
							->update([
								 'quantity'   => $quantity, //$attributes['quantity'][$key] * $attributes['packing'][$key],//14JN24
								 'unit_cost'  => $unit_cost, //(isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key],
								 'cur_quantity' => $attributes['quantity'][$key],
								 'cost_avg' => $cost_avg,
								 'pur_cost' => ($sirow)?$sirow->pur_cost:0,
								 'voucher_date' => ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
								 'category_id' => isset($attributes['cat_id'][$key])?$attributes['cat_id'][$key]:''
							]);
			//-------------ITEM LOG------------------
		}
							
		return $logid;
	}
	
	private function updateItemQuantity($attributes, $key)
	{
		$item = DB::table('item_unit')->where('itemmaster_id', $attributes['item_id'][$key])
									  ->where('is_baseqty', 1)->first();
									  
		if($item) {
			$qty = $attributes['quantity'][$key];
			$baseqty = ($qty * $attributes['packing'][$key]);
			DB::table('item_unit')
				->where('id', $item->id)
				->update([ 'cur_quantity' => $item->cur_quantity + $baseqty,
						   'received_qty' => DB::raw('received_qty + '.$baseqty) ]);
							
		}
									  
		return true;
	}
	
	private function updateItemQuantityonEdit($attributes, $key)
	{
		if($attributes['actual_quantity'][$key] != $attributes['quantity'][$key]) {
			
			$item = DB::table('item_unit')->where('itemmaster_id', $attributes['item_id'][$key])
										  ->where('is_baseqty', 1)->first();
										  
			if($item) {
				$qty = $attributes['quantity'][$key];
				//$packing = ($item->is_baseqty==1)?1:$item->packing;
				$baseqty = ($qty * $attributes['packing'][$key]);
				$diffqty = ($attributes['actual_quantity'][$key] * $attributes['packing'][$key]) - ($qty * $attributes['packing'][$key]);
				$received_qty = $diffqty * -1;
				
				if($attributes['actual_quantity'][$key] < $qty) {
					$cur_quantity = $item->cur_quantity + $received_qty;
				} else { 
					$cur_quantity = $item->cur_quantity - $diffqty;
				}
				
				DB::table('item_unit')
					->where('itemmaster_id',  $attributes['item_id'][$key])
					->where('is_baseqty',1)
					->update([ 'cur_quantity' => $cur_quantity,
								'received_qty' => DB::raw('received_qty + '.$received_qty) ]);
					
			}

			return true;
		}
	}
	
	private function updateLastPurchaseCostAndCostAvgonDelete($items, $id) {
		//UPDATE Cost avg and stock...
		foreach($items as $item) {
									
			//COST AVG Updating on DELETE section....
			DB::table('item_log')->where('document_id', $id)->where('document_type','SR')
								 ->where('item_id',$item->item_id)->where('unit_id', $item->unit_id)
								 ->update(['status' => 0, 'deleted_at' => now()]);
			
			DB::table('item_unit')->where('itemmaster_id', $item->item_id)->where('unit_id',$item->unit_id)
								  ->update(['cur_quantity' => DB::raw('cur_quantity - '.$item->quantity)]);
									  
			/* DB::table('item_location')->where('item_id', $item->item_id)->where('unit_id', $item->unit_id)
									  ->where('location_id', $this->purchase_invoice->location_id)
									  ->update(['quantity' => DB::raw('quantity - '.$item->quantity) ]); */
									  
			$this->objUtility->autoUpdateAVGCost($item->item_id);
		}
	}
	
	
	public function getTransactionList($attributes) 
	{
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		
		$qry = $this->sales_return
								   ->join('sales_return_item AS SI', function($join) {
									   $join->on('SI.sales_return_id','=','sales_return.id');
								   })
								   ->join('itemmaster AS IM', function($join) {
									   $join->on('IM.id','=','SI.item_id');
								   })
								   ->where('SI.status',1)
								   ->where('SI.deleted_at','0000-00-00 00:00:00')
								   ->where('sales_return.status',1);
							
							if($date_from !='' && $date_to != '')	   
								$qry->whereBetween('sales_return.voucher_date',[$date_from, $date_to]);

							/*	if($attributes['search_by']=='Group')
						        $qry->where('IM.group_id','!=',0);
							
							if($attributes['search_by']=='Subgroup')
						        $qry->where('IM.subgroup_id','!=',0);
								
							if($attributes['search_by']=='Category')
						        $qry->where('IM.category_id','!=',0);

							if($attributes['search_by']=='Subcategory')
						        $qry->where('IM.subcategory_id','!=',0);*/	
					
		$result = $qry->select('sales_return.id','sales_return.voucher_no','sales_return.voucher_date',
								'IM.item_code','IM.description','SI.quantity','SI.unit_price','SI.vat_amount','SI.total_price')
								   ->orderBY('sales_return.voucher_date', 'ASC')
								   ->get();
								   
		return $result;
	}
	
	private function getVatAccounts($department_id=null) {
		
		if(Session::get('department')==1 && $department_id!=null) {
			$vatres = DB::table('vat_department')->where('department_id', $department_id)->first();
			if(!$vatres)
				$vatres = DB::table('vat_master')->where('status', 1)->whereNull('deleted_at')->first();
			return $vatres;
		} else {
			return DB::table('vat_master')->where('status', 1)->whereNull('deleted_at')->first();
		}
	}
	
	private function checkAndSetCostAccountingParameters($attributes) {
		
		if(Session::get('cost_accounting')==1 && Session::get('department')==1) { 
			$result = DB::table('department_accounts')->where('department_id', $attributes['department_id'])->select('stock_acid','cost_acid')->first();
			if($result){
				Session::put('stock', $result->stock_acid);
				Session::put('cost_of_sale', $result->cost_acid);
			}
		
		}
		
	}
}

