<?php
declare(strict_types=1);
namespace App\Repositories\SalesInvoice;

use App\Models\SalesInvoice;
use App\Models\SalesInvoiceItem;
use App\Models\AccountTransaction;
use App\Models\SalesInvoiceSellExp;
use App\Models\ItemStock;
use App\Models\ItemLocation;
use App\Models\ConLocation;
use App\Models\ItemLocationSI;
use App\Models\ItemDescription;
use App\Models\JobInvoiceDetails;
use App\Models\ItemInfo;
use App\Repositories\AbstractValidator;
use App\Exceptions\Validation\ValidationException;
use Ixudra\Curl\Facades\Curl;
use App\Repositories\UpdateUtility;

use Config;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Session;
use Auth;
use File;
use Log;

class SalesInvoiceRepository extends AbstractValidator implements SalesInvoiceInterface {
	
	public $objUtility;
	protected $mod_do_qty;
	protected $sales_invoice;
	protected $customer_receipt;
	
	protected static $rules = [];
	protected $matservice;
	protected $module;
	
	
	public function __construct(SalesInvoice $sales_invoice) {
		$config = Config::get('siteconfig');
		$this->sales_invoice = $sales_invoice;
		$this->api_url = $config['modules']['api_url'];
		$this->objUtility = new UpdateUtility();
		
		$this->matservice = DB::table('parameter2')->where('keyname', 'mod_material_service')->where('status',1)->select('is_active')->first();
		$this->module = DB::table('parameter2')->where('keyname', 'mod_workshop')->where('status',1)->select('is_active')->first();
		$this->mod_do_qty = DB::table('parameter2')->where('keyname', 'mod_do_qty_update')->where('status',1)->select('is_active')->first();
		$this->mod_location = DB::table('parameter2')->where('keyname', 'mod_location')->where('status',1)->select('is_active')->first();
		
		$this->width = $config['modules']['salesinvoice']['image_size']['width'];
        $this->height = $config['modules']['salesinvoice']['image_size']['height'];
        $this->thumbWidth = $config['modules']['salesinvoice']['thumb_size']['width'];
        $this->thumbHeight = $config['modules']['salesinvoice']['thumb_size']['height'];
        $this->imgDir = $config['modules']['salesinvoice']['image_dir'];
	}
	
	public function all()
	{
		return $this->sales_invoice->get();
	}
	
	public function find($id)
	{
		return $this->sales_invoice->where('id', $id)->first();
	}
	
	public function getItemDesc($id)
	{
		return DB::table('sales_invoice')
						->join('sales_invoice_item AS QSI', function($join) {
							$join->on('QSI.sales_invoice_id', '=', 'sales_invoice.id');
						})
						->join('item_description AS D', function($join) {
							$join->on('D.item_detail_id', '=', 'QSI.id');
						})
						->where('sales_invoice.id', $id)
						->where('D.invoice_type','SI')
						->where('QSI.status',1)
						->where('QSI.deleted_at','0000-00-00 00:00:00')
						->where('D.status',1)
						->where('D.deleted_at','0000-00-00 00:00:00')
						->select('D.*')
						->get();
	}
	
	private function jobmasterClose($attributes) {
		
		if(($this->matservice->is_active==1)  && $attributes['job_id']!='') {
			//update jobmaster as close....
			DB::table('jobmaster')->where('id', $attributes['job_id'])->update(['is_close' => 1]);
		}
	}
	
	//set input fields values
	private function setInputValue($attributes) 
	{
		//echo '<pre>';print_r($attributes);exit; 
		isset($attributes['voucher_id'])?Session::flash('voucher_id', $attributes['voucher_id']):'';
		isset($attributes['sales_account'])?Session::flash('sales_account', $attributes['sales_account']):'';
		isset($attributes['cr_account_id'])?Session::flash('cr_account_id', $attributes['cr_account_id']):'';
		isset($attributes['customer_name'])?Session::flash('customer_name', $attributes['customer_name']):'';
		isset($attributes['customer_id'])?Session::flash('customer_id', $attributes['customer_id']):'';
		isset($attributes['dr_account_id'])?Session::flash('dr_account_id', $attributes['dr_account_id']):'';
		isset($attributes['is_cash'])?Session::flash('is_cash', $attributes['is_cash']):'';
		
		$this->sales_invoice->voucher_id    = $attributes['voucher_id'];
		$this->sales_invoice->voucher_no    = $attributes['voucher_no'];
		$this->sales_invoice->reference_no  = $attributes['reference_no'];
		$this->sales_invoice->voucher_date  = ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date']));
		$this->sales_invoice->lpo_date 		= ($attributes['lpo_date']!='')?date('Y-m-d', strtotime($attributes['lpo_date'])):'';
        $this->sales_invoice->document_type = ($attributes['document_type']=='')?'SI':$attributes['document_type'];//Purchase Invoice type

		$this->sales_invoice->customer_id   = $attributes['customer_id'];
		$this->sales_invoice->dr_account_id = $attributes['dr_account_id'];
		$this->sales_invoice->cr_account_id = isset($attributes['cr_account_id'])?$attributes['cr_account_id']:'';
		$this->sales_invoice->document_id   = isset($attributes['document_id'])?$attributes['document_id']:'';
		$this->sales_invoice->job_id 		= isset($attributes['job_id'])?$attributes['job_id']:'';
		$this->sales_invoice->terms_id 		= isset($attributes['terms_id'])?$attributes['terms_id']:'';
		$this->sales_invoice->description   = isset($attributes['description'])?$attributes['description']:'';
		$this->sales_invoice->is_fc 		= isset($attributes['is_fc'])?1:0;
		$this->sales_invoice->currency_id   = (isset($attributes['currency_id']))?$attributes['currency_id']:'';
		$this->sales_invoice->currency_rate = (isset($attributes['currency_rate']))?$attributes['currency_rate']:'';
		
		$this->sales_invoice->customer_name	= isset($attributes['customername'])?$attributes['customername']:'';
		$this->sales_invoice->customer_phone= isset($attributes['customer_phone'])?$attributes['customer_phone']:'';
		$this->sales_invoice->lpo_no 		= $attributes['lpo_no'];
		$this->sales_invoice->salesman_id   = (isset($attributes['salesman_id']))?$attributes['salesman_id']:'';
		$this->sales_invoice->is_export		= isset($attributes['is_export'])?1:0;
		$this->sales_invoice->location_id   = isset($attributes['location_id'])?$attributes['location_id']:'';
		$this->sales_invoice->department_id   = isset($attributes['department_id'])?$attributes['department_id']:'';
		$this->sales_invoice->items_description   = isset($attributes['items_description'])?$attributes['items_description']:'';
		$this->sales_invoice->vehicle_id   = isset($attributes['vehicle_id'])?$attributes['vehicle_id']:'';
		
		$this->sales_invoice->customer_trn	= isset($attributes['customer_trn'])?$attributes['customer_trn']:'';
		$this->sales_invoice->is_rventry	= isset($attributes['is_rv'])?$attributes['is_rv']:0;
		$this->sales_invoice->advance		= isset($attributes['advance'])?$attributes['advance']:0;
		$this->sales_invoice->balance		= isset($attributes['balance'])?$attributes['balance']:0;
		$this->sales_invoice->kilometer		= isset($attributes['kilometer'])?$attributes['kilometer']:'';
		$this->sales_invoice->job_type		= isset($attributes['job_type'])?$attributes['job_type']:'';
		
		$this->sales_invoice->jobnature		= isset($attributes['jobnature'])?$attributes['jobnature']:'';
		$this->sales_invoice->fabrication	= isset($attributes['fabrication'])?$attributes['fabrication']:'';
		$this->sales_invoice->less_amount	= isset($attributes['less_amount'])?$attributes['less_amount']:'';
		$this->sales_invoice->less_description	= isset($attributes['less_description'])?$attributes['less_description']:'';
		$this->sales_invoice->previnv_amount	= isset($attributes['previnv_amount'])?$attributes['previnv_amount']:'';
		$this->sales_invoice->previnv_description = isset($attributes['previnv_description'])?$attributes['previnv_description']:'';
		
		$this->sales_invoice->less_amount2	    = isset($attributes['less_amount2'])?$attributes['less_amount2']:'';
		$this->sales_invoice->less_description2 = isset($attributes['less_description2'])?$attributes['less_description2']:'';
		$this->sales_invoice->less_amount3	    = isset($attributes['less_amount3'])?$attributes['less_amount3']:'';
		$this->sales_invoice->less_description3 = isset($attributes['less_description3'])?$attributes['less_description3']:'';
		
		$this->sales_invoice->vehicle_no = isset($attributes['vehicle_no'])?$attributes['vehicle_no']:'';
		$this->sales_invoice->less_description = isset($attributes['vehicle_model'])?$attributes['vehicle_model']:'';
		$this->sales_invoice->less_description2 = isset($attributes['vehicle_make'])?$attributes['vehicle_make']:'';
		$this->sales_invoice->less_description3 = isset($attributes['next_service'])?$attributes['next_service']:'';
		$this->sales_invoice->so_no = (isset($attributes['so_no']))?$attributes['so_no']:'';
		$this->sales_invoice->previnv_description = isset($attributes['serviced_by'])?$attributes['serviced_by']:'';$this->jobmasterClose($attributes);
		
		$this->sales_invoice->other_cost = isset($attributes['other_cost'])?$attributes['other_cost']:'';
		
		$this->sales_invoice->is_rental	= isset($attributes['is_rental'])?$attributes['is_rental']:0;
		$this->sales_invoice->foot_description = (isset($attributes['foot_description']))?$attributes['foot_description']:'';
		$this->sales_invoice->doc_nos = isset($attributes['document'])?$attributes['document']:''; //AUG24
		$this->sales_invoice->metre_in = (isset($attributes['metre_in']))?$attributes['metre_in']:'';
		$this->sales_invoice->metre_out = (isset($attributes['metre_out']))?$attributes['metre_out']:'';
		$this->sales_invoice->duedays = (isset($attributes['duedays']))?$attributes['duedays']:'';
		$this->sales_invoice->due_date = (isset($attributes['due_date']))?date('Y-m-d', strtotime($attributes['due_date'])):'';

		
		$this->sales_invoice->is_editable  = (isset($attributes['document_id']) && $attributes['document_id']!='')?2:0; //APR25
		
			
		return true;
	}
	
	
	private function setJobdetails($attributes) {
							
		if(isset($attributes['opr_description']) && !empty( array_filter($attributes['opr_description'])) ) {
			
			foreach($attributes['opr_description'] as $key => $value){ 
				if($value != '') {
					$jobInvoiceDetails = new JobInvoiceDetails();
					$jobInvoiceDetails->jobinvoice_id = $this->sales_invoice->id;
					$jobInvoiceDetails->description = $value;
					$jobInvoiceDetails->comment = $attributes['opr_comment'][$key];
					$jobInvoiceDetails->status = 1;
					$jobInvoiceDetails->save();
				}
			}
		}
		
	}
	
	private function setJobdetailsUpdate($attributes) {
		
		if(isset($attributes['opr_description']) && !empty( array_filter($attributes['opr_description'])) ) {
			foreach($attributes['opr_description'] as $key => $value) { 
			
				if(isset($attributes['jobdetail_id'][$key]) && $attributes['jobdetail_id'][$key]!='') {
					
					$jobInvoiceDetails = JobInvoiceDetails::find($attributes['jobdetail_id'][$key]);
					$items['description'] = $value;
					$items['comment'] = $attributes['opr_comment'][$key];
					$jobInvoiceDetails->update($items);
					
				} else { //new entry.....
					
					if($value != '') {
						$jobInvoiceDetails = new JobInvoiceDetails();
						$jobInvoiceDetails->jobinvoice_id = $this->sales_invoice->id;
						$jobInvoiceDetails->description = $value;
						$jobInvoiceDetails->comment = $attributes['opr_comment'][$key];
						$jobInvoiceDetails->status = 1;
						$jobInvoiceDetails->save();
					}
				}
			}
		}
		
		//manage removed items...
		if(isset($attributes['opr_description']) && $attributes['remove_desc']!='')
		{
			$arrids = explode(',', $attributes['remove_desc']);
			$remline_total = $remtax_total = 0;
			foreach($arrids as $row) {
				DB::table('jobinvoice_details')->where('id', $row)->update(['status' => 0, 'deleted_at' => now()]);
			}
		}
	}
	
	private function setItemInputValue($attributes, $salesInvoiceItem, $key, $value, $lineTotal) 
	{
		/*CHG*/
		$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['tax_code'][$key];
		if( isset($attributes['is_fc']) ) {
			$tax        = ( ($attributes['cost'][$key] * $attributes['line_vat'][$key]) / 100);// MR19 * $attributes['currency_rate'];
			//VAT CHNG every quantity field should multiply with packing...
			$item_total = ( ($attributes['cost'][$key] * $attributes['quantity'][$key]) - (float)$attributes['line_discount'][$key] ) * $attributes['currency_rate']; 
			$tax_total  = round($tax * $attributes['quantity'][$key],2);
			$line_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]) * $attributes['currency_rate'];
			$rate = $attributes['cost'][$key]*$attributes['currency_rate']; //29MY
			
		} else {
			
			$line_total = round($attributes['cost'][$key] * $attributes['quantity'][$key],2);// echo $line_total;exit;
			//$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['tax_code'][$key];
						
			if(isset($attributes['is_export']) || $tax_code=="EX" || $tax_code=="ZR") {
				
				$tax        = 0;
				$item_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - (float)$attributes['line_discount'][$key];
				$tax_total  = round($tax * $attributes['quantity'][$key],2);
				$rate = $attributes['cost'][$key];//29MY
				
			} else if($attributes['tax_include'][$key]==1){
				
				$ln_total   = round($attributes['cost'][$key] * $attributes['quantity'][$key],2);
				$tax_total  = $ln_total *  $attributes['line_vat'][$key] / (100 +  $attributes['line_vat'][$key]);
				$item_total = $ln_total - $tax_total;
				//$rate = $attributes['cost'][$key] - (float)$attributes['line_discount'][$key];
				//echo 'rd '.round(50.015,2).'  '.$ln_total;exit;
				
				///31MY
				if((float)$attributes['line_discount'][$key] > 0) {
					$rate = $attributes['cost'][$key] - (float)$attributes['line_discount'][$key];
					$row_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]);//14JN24
				} else {
					$vatPlus = 100 + $attributes['line_vat'][$key];
					$vatLine = round( (($attributes['cost'][$key] * $attributes['line_vat'][$key]) / $vatPlus),2 );
					$rate = $attributes['cost'][$key] - $vatLine;
					$row_total = ($rate * $attributes['quantity'][$key]);//14JN24
				}
				
			} else {
				
				$tax        = ($attributes['cost'][$key] * $attributes['line_vat'][$key]) / 100;
				$item_total = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - (float)$attributes['line_discount'][$key];
				$tax_total  = round($tax * $attributes['quantity'][$key],2);
				$rate = $attributes['cost'][$key] - (float)$attributes['line_discount'][$key];//31MY
				$row_total = ($rate * $attributes['quantity'][$key]);//31MY
			}
		}
		
		//********DISCOUNT Calculation.............
		$discount = (isset($attributes['discount']))?$attributes['discount']:0;
		$type = 'tax_exclude';
			
		if($attributes['tax_include'][$key]==1 ) {
			$vatPlus = 100 + $attributes['line_vat'][$key];
			$total = $attributes['cost'][$key] * $attributes['quantity'][$key];
			$type = 'tax_include';
		} else {
			$vatPlus = 100;
			$total = $attributes['line_total'][$key];
			$type = 'tax_exclude';
		}
		
		if($discount > 0) {
			$discountAmt = round( (($total / $lineTotal) * $discount),2 );
			$amountTotal = $total - $discountAmt;
			$vatLine = round( (($amountTotal * $attributes['line_vat'][$key]) / $vatPlus),2 );
			//$line_total = $amountTotal;
			$tax_total = (isset($attributes['is_fc']))?($vatLine * $attributes['currency_rate']):$vatLine; //MR19
			
			//14JN24
			$vat_exc = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - (float)$attributes['line_discount'][$key];//31MY
			/*if($attributes['tax_include'][$key]==1 ) {
				$itmtotl = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - $tax_total;
			} else {
				$itmtotl = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - (float)$attributes['line_discount'][$key];//31MY
			}*/
			$rate = $vat_exc / $attributes['quantity'][$key];
		} else { //31MY
			if($attributes['tax_include'][$key]==1 ) {
				$vatLine = round( (($total * $attributes['line_vat'][$key]) / $vatPlus),2 );
				$vat_exc = $total - $vatLine;
				//$row_total = $vat_exc + $tax_total;
			} else {
				$vat_exc = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - (float)$attributes['line_discount'][$key];
				 
			}
		}
		/*CHG*/
		
		$row_total = $vat_exc + $tax_total;
		
		//SO auto transfer settings...........
		if(isset($attributes['so_no']) && $attributes['so_no']!='') {
			$SO = DB::table('sales_order')->where('sales_order.voucher_no', $attributes['so_no'])->where('sales_order.status',1)
											 ->join('sales_order_item', 'sales_order_item.sales_order_id', '=', 'sales_order.id')
											 ->where('sales_order_item.item_id', $attributes['item_id'][$key])
											 ->where('sales_order_item.unit_id',$attributes['unit_id'][$key])
											 ->where('sales_order_item.deleted_at','0000-00-00 00:00:00')
											 ->where('sales_order_item.status',1)
											 ->where('sales_order.deleted_at','0000-00-00 00:00:00')
											 ->whereIn('sales_order.is_transfer',[0,2])
											 ->whereIn('sales_order_item.is_transfer',[0,2])
											 ->select('sales_order.id','sales_order_item.id AS pid','sales_order_item.quantity','sales_order_item.balance_quantity','sales_order_item.is_transfer')->first();
			if($SO) {
				if($SO->balance_quantity==0) {
					$balqty = $SO->quantity - $attributes['quantity'][$key];
					$st = ($balqty==0)?1:2;
					DB::table('sales_order_item')->where('id', $SO->pid)
									->update(['balance_quantity' => $balqty, 'is_transfer' => $st]);
				} else {
					$balqty = $SO->balance_quantity - $attributes['quantity'][$key];
					$st = ($balqty==0)?1:2;
					DB::table('sales_order_item')->where('id', $SO->pid)
									->update(['balance_quantity' => $balqty, 'is_transfer' => $st]);
				}
			}
		}
		
		
		$pay_pcntg = 100; $pay_amount = $line_total; $pay_pcntg_desc = '';
		if(isset($attributes['per'][$key]) && $attributes['per'][$key]!='' && $attributes['per'][$key] > 0) {
			$pay_pcntg = $attributes['per'][$key];
			$pay_amount = ($line_total * $pay_pcntg) / 100;
			$pay_pcntg_desc = $attributes['perdesc'][$key];
		}
		
		
		//LPO auto transfer settings...........
		if(isset($attributes['lpo_no']) && $attributes['lpo_no']!='') {
			$arlpo = explode(',', $attributes['lpo_no']);
			foreach($arlpo as $lpo) {
				$LPO = DB::table('sales_order')->where('sales_order.reference_no', $lpo)->where('sales_order.status',1)
											 ->join('sales_order_item', 'sales_order_item.sales_order_id', '=', 'sales_order.id')
											 ->where('sales_order_item.item_id', $attributes['item_id'][$key])
											 ->where('sales_order_item.unit_id',$attributes['unit_id'][$key])
											 ->where('sales_order_item.deleted_at','0000-00-00 00:00:00')
											 ->where('sales_order_item.status',1)
											 ->where('sales_order.deleted_at','0000-00-00 00:00:00')
											 ->whereIn('sales_order.is_transfer',[0,2])
											 ->whereIn('sales_order_item.is_transfer',[0,2])
											 ->select('sales_order.id','sales_order_item.id AS soid','sales_order_item.quantity',
													  'sales_order_item.balance_quantity','sales_order_item.is_transfer')
											->first();
											
				if($LPO) {
					if($LPO->balance_quantity==0) {
						$balqty = $LPO->quantity - $attributes['quantity'][$key];
						$st = ($balqty==0)?1:2;
						DB::table('sales_order_item')->where('id', $LPO->soid)
										->update(['balance_quantity' => $balqty, 'is_transfer' => $st]);
					} else {
						$balqty = $LPO->balance_quantity - $attributes['quantity'][$key];
						$st = ($balqty==0)?1:2;
						DB::table('sales_order_item')->where('id', $LPO->soid)
										->update(['balance_quantity' => $balqty, 'is_transfer' => $st]);
					}
				}
			}
			
		}
		//...........LPO auto transfer settings
		
		
		$salesInvoiceItem->sales_invoice_id = $this->sales_invoice->id;
		$salesInvoiceItem->item_id    		= $value;
		$salesInvoiceItem->item_name  		= $attributes['item_name'][$key];
		$salesInvoiceItem->unit_id 			= $attributes['unit_id'][$key];
		$salesInvoiceItem->quantity   		= $attributes['quantity'][$key];
		$salesInvoiceItem->unit_price 		= (isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key];
		$salesInvoiceItem->vat		    	= $attributes['line_vat'][$key];
		$salesInvoiceItem->vat_amount 		= $tax_total;
		$salesInvoiceItem->discount   		= $attributes['line_discount'][$key];
		$salesInvoiceItem->line_total 		= $line_total;
		$salesInvoiceItem->tax_code 		= $tax_code;
		$salesInvoiceItem->tax_include 		= $attributes['tax_include'][$key];
		$salesInvoiceItem->item_total 		= $item_total;
		$salesInvoiceItem->rate 			= $rate;//29MY
		
		$salesInvoiceItem->row_total 		= $row_total;//31MY
		$salesInvoiceItem->vat_exc 			= $vat_exc;//31MY
		$salesInvoiceItem->vat_exc_fc		= (isset($attributes['is_fc']))?round(($vat_exc /  $attributes['currency_rate']),2):$vat_exc;//31MY
		
		//CHNG SEP 17
		$salesInvoiceItem->pay_pcntg 		= $pay_pcntg;
		$salesInvoiceItem->pay_amount 		= $pay_amount;
		$salesInvoiceItem->pay_pcntg_desc 		= $pay_pcntg_desc;
		
		if(isset($attributes['assembly_items'][$key]) && $attributes['assembly_items'][$key]!='') {
			$salesInvoiceItem->assembly_items = $attributes['assembly_items'][$key];
			$salesInvoiceItem->assembly_items_qty = $attributes['assembly_items_qty'][$key];
			$this->setSalesLogAssemblyItem($attributes['assembly_items'][$key], $attributes['assembly_items_qty'][$key], $attributes,'add');
		}

		$cost_value = 0;
		//if(Session::get('cost_accounting')==1) {
			$item = DB::table('item_unit')->where('itemmaster_id', $attributes['item_id'][$key])
										  ->where('unit_id', $attributes['unit_id'][$key])
										  ->first();
			if($item)	{						  
			$cost_avg = ($item->cost_avg==0)?$item->last_purchase_cost:$item->cost_avg;
			$cost_value = $cost_avg * $attributes['quantity'][$key] * $attributes['packing'][$key];
		}
		
		$salesInvoiceItem->item_cost 		= $cost_value;
		
		//MAR19
		$salesInvoiceItem->unit_price_fc = $attributes['cost'][$key];
		$salesInvoiceItem->vat_amount_fc = (isset($attributes['is_fc']))?round(($tax_total /  $attributes['currency_rate']),2):$tax_total;
		$salesInvoiceItem->total_price_fc = (isset($attributes['is_fc']))?round(($line_total /  $attributes['currency_rate']),2):$line_total;
		$salesInvoiceItem->item_total_fc = (isset($attributes['is_fc']))?round(($item_total /  $attributes['currency_rate']),2):$item_total;
		$salesInvoiceItem->rate_fc = (isset($attributes['is_fc']))?round(($rate /  $attributes['currency_rate']),2):$rate;//29MY
		$salesInvoiceItem->row_total_fc = (isset($attributes['is_fc']))?round(($row_total /  $attributes['currency_rate']),2):$row_total;//31MY
		
		$salesInvoiceItem->width = isset($attributes['item_wit'][$key])?$attributes['item_wit'][$key]:0;
		$salesInvoiceItem->length = isset($attributes['item_lnt'][$key])?$attributes['item_lnt'][$key]:0;
		$salesInvoiceItem->mp_qty = isset($attributes['mpquantity'][$key])?$attributes['mpquantity'][$key]:0;

		if(isset($attributes['conloc_id'][$key]) && $attributes['conloc_id'][$key]!='') {
			$salesInvoiceItem->conloc_id = $attributes['conloc_id'][$key];
			$salesInvoiceItem->conloc_qty = $attributes['conloc_qty'][$key];
		}
		
		$salesInvoiceItem->doc_row_id = isset($attributes['customer_do_item_id'][$key])?$attributes['customer_do_item_id'][$key]:0; //APR25
		
		return array('line_total' => $line_total, 'tax_total' => $tax_total, 'cost_value' => $cost_value, 'type' => $type,'item_total' => $item_total );
	}
	
	private function setTransferStatusItem($attributes, $key, $doctype, $mode=null)
	{
		//if quantity partially deliverd, update pending quantity.
		if($doctype=='SQ') {
			if(isset($attributes['quote_sales_item_id'])) {
				if(isset($attributes['actual_quantity']) && ($attributes['quantity'][$key] != $attributes['actual_quantity'][$key])) {
					if( isset($attributes['quote_sales_item_id'][$key]) ) {
						$quantity 	 = $attributes['actual_quantity'][$key] - $attributes['quantity'][$key];
						//update as partially delivered.
						DB::table('quotation_sales_item')
									->where('id', $attributes['quote_sales_item_id'][$key])
									->update(['balance_quantity' => $quantity, 'is_transfer' => 2]);
					}
				} else {
						//update as completely delivered.
						DB::table('quotation_sales_item')
									->where('id', $attributes['quote_sales_item_id'][$key])
									->update(['balance_quantity' => 0, 'is_transfer' => 1]);
				}
			}
		} else if($doctype=='SO') {
			if(isset($attributes['sales_order_item_id'])) {
				if(isset($attributes['actual_quantity']) && ($attributes['quantity'][$key] != $attributes['actual_quantity'][$key])) {
					if( isset($attributes['sales_order_item_id'][$key]) ) {
						//$quantity 	 = $attributes['actual_quantity'][$key] - $attributes['quantity'][$key];
						$quantity 	 = $attributes['actual_quantity'][$key] - $attributes['quantity'][$key];
						//update as partially delivered.
						DB::table('sales_order_item')
									->where('id', $attributes['sales_order_item_id'][$key])
									->update(['balance_quantity' => $quantity, 'is_transfer' => 2]);
					}
				} else {
						//update as completely delivered.
						DB::table('sales_order_item')
									->where('id', $attributes['sales_order_item_id'][$key])
									->update(['balance_quantity' => 0, 'is_transfer' => 1]);
				}
			}
		}
		else if($doctype=='CDO') {
		    
		    //QUANTIITY CROSS CHECK WI DO .....MY22
			/*if($attributes['document_id']!='') {
				$cdorow = DB::table('customer_do_item')->where('customer_do_id',$attributes['document_id'])->where('item_id',$attributes['item_id'][$key])
											 ->where('unit_id',$attributes['unit_id'][$key])->where('status',1)->whereNull('deleted_at')
											 ->first(); 
				if($cdorow) {
					$attributes['customer_do_item_id'][$key] = $cdorow->id;
					$attributes['actual_quantity'][$key] = ($cdorow->is_transfer==2)?$cdorow->balance_quantity:$cdorow->quantity;
				}
			}*/
			if($mode=='edit') { //exit;
			    
    				if(isset($attributes['quantity_old']) && ($attributes['quantity'][$key] != $attributes['quantity_old'][$key])) {
    					if($attributes['doc_row_id'][$key] > 0 && ($attributes['quantity_old'][$key] != $attributes['quantity'][$key]) ) {
    						$quantity 	 = ($attributes['quantity_old'][$key] > $attributes['quantity'][$key])?($attributes['quantity_old'][$key] - $attributes['quantity'][$key]):($attributes['quantity'][$key] > $attributes['quantity_old'][$key]);
    						
    						$DOqtyarr = DB::table('sales_invoice_item')->where('doc_row_id', $attributes['doc_row_id'][$key])->where('id','!=', $attributes['order_item_id'][$key])
    						                            ->select('id', DB::raw('SUM(quantity) AS quantity'))->groupBY('item_id')->get();
    						$DOqty = ((isset($DOqtyarr[0]))?$DOqtyarr[0]->quantity:0) + $attributes['quantity'][$key];          
    						//update as partially delivered.
    						
    						$DOrow = DB::table('customer_do_item')->where('id', $attributes['doc_row_id'][$key])->select('quantity')->first();
    						if($DOrow->quantity==$DOqty) {
    						    DB::table('customer_do_item')
    									->where('id', $attributes['doc_row_id'][$key])
    									->update(['balance_quantity' => DB::raw('quantity - '.$DOqty), 'is_transfer' => 1]); 
    						} else {
    						    DB::table('customer_do_item')
    									->where('id', $attributes['doc_row_id'][$key])
    									->update(['balance_quantity' => DB::raw('quantity - '.$DOqty), 'is_transfer' => 2]);
    						}
    									
        				} elseif($attributes['doc_row_id'][$key] > 0 && ($attributes['quantity_old'][$key] == $attributes['quantity'][$key])) {
        						//update as completely delivered.
        						DB::table('customer_do_item')
        									->where('id', $attributes['doc_row_id'][$key])
        									->update(['balance_quantity' => 0, 'is_transfer' => 1]);
        				}
			        }

			} else {
			    
    			if(isset($attributes['customer_do_item_id'])) {
    				if(isset($attributes['actual_quantity']) && ($attributes['quantity'][$key] != $attributes['actual_quantity'][$key])) {
    					if( isset($attributes['customer_do_item_id'][$key]) ) {
    						$quantity 	 = $attributes['actual_quantity'][$key] - $attributes['quantity'][$key];
    						//update as partially delivered.
    						DB::table('customer_do_item')
    									->where('id', $attributes['customer_do_item_id'][$key])
    									->update(['balance_quantity' => $quantity, 'is_transfer' => 2]);
    					}
    				} else {
    						//update as completely delivered.
    						DB::table('customer_do_item')
    									->where('id', $attributes['customer_do_item_id'][$key])
    									->update(['balance_quantity' => 0, 'is_transfer' => 1]);
    				}
    			}
			}
		}
	}
	
	private function setTransferStatusService($attributes, $key, $doctype)
	{
		//if quantity partially deliverd, update pending quantity.
		if($doctype=='SQ') {
			if(isset($attributes['lbquote_sales_item_id'][$key])) {
				if(isset($attributes['lbactual_quantity']) && ($attributes['lbquantity'][$key] != $attributes['lbactual_quantity'][$key])) {
					if( isset($attributes['lbquote_sales_item_id'][$key]) ) {
						$quantity 	 = $attributes['lbactual_quantity'][$key] - $attributes['lbquantity'][$key];
						//update as partially delivered.
						DB::table('quotation_sales_item')
									->where('id', $attributes['lbquote_sales_item_id'][$key])
									->update(['balance_quantity' => $quantity, 'is_transfer' => 2]);
					}
				} else {
						//update as completely delivered.
						DB::table('quotation_sales_item')
									->where('id', $attributes['lbquote_sales_item_id'][$key])
									->update(['balance_quantity' => 0, 'is_transfer' => 1]);
				}
			}
		} else if($doctype=='SO') {
			if(isset($attributes['lbsales_order_item_id'][$key])) {
				if(isset($attributes['lbactual_quantity']) && ($attributes['lbquantity'][$key] != $attributes['lbactual_quantity'][$key])) {
					if( isset($attributes['lbsales_order_item_id'][$key]) ) {
						$quantity 	 = $attributes['lbactual_quantity'][$key] - $attributes['lbquantity'][$key];
						//update as partially delivered.
						DB::table('sales_order_item')
									->where('id', $attributes['lbsales_order_item_id'][$key])
									->update(['balance_quantity' => $quantity, 'is_transfer' => 2]);
					}
				} else {
						//update as completely delivered.
						DB::table('sales_order_item')
									->where('id', $attributes['lbsales_order_item_id'][$key])
									->update(['balance_quantity' => 0, 'is_transfer' => 1]);
				}
			}
		}
		
	}
	
	private function setTransferStatusQuote($attributes)
	{
		if($this->matservice->is_active==1) {
			
			$idarr = explode(',',$attributes['document_id']);
			if($idarr) {
				foreach($idarr as $id) {
					if($attributes['document_type']=='SQ') {
						DB::table('quotation_sales')->where('id', $id)->update(['is_editable' => 1, 'is_transfer' => 1]);
							
					} else if($attributes['document_type']=='SO') {
						DB::table('sales_order')->where('id', $id)->update(['is_editable' => 1, 'is_transfer' => 1]);
					} 
				}
			}
			
		} else {
			//update purchase order transfer status....
			$idarr = explode(',',$attributes['document_id']);
			if($idarr) {
				foreach($idarr as $id) {
					if($attributes['document_type']=='SQ') {
						DB::table('quotation_sales')->where('id', $id)->update(['is_editable' => 1]);
						$row1 = DB::table('quotation_sales_item')->where('quotation_sales_id', $id)->count();
						$row2 = DB::table('quotation_sales_item')->where('quotation_sales_id', $id)->where('is_transfer',1)->count();
						if($row1==$row2) {
							DB::table('quotation_sales')
									->where('id', $id)
									->update(['is_transfer' => 1]);
						}
					} else if($attributes['document_type']=='SO') {
						DB::table('sales_order')->where('id', $id)->update(['is_editable' => 1]);
						$row1 = DB::table('sales_order_item')->where('sales_order_id', $id)->count();
						$row2 = DB::table('sales_order_item')->where('sales_order_id', $id)->where('is_transfer',1)->count();
						if($row1==$row2) {
							DB::table('sales_order')
									->where('id', $id)
									->update(['is_transfer' => 1]);
						}
					} else if($attributes['document_type']=='CDO') {
						DB::table('customer_do')->where('id', $id)->update(['is_editable' => 1]);
						$row1 = DB::table('customer_do_item')->join('itemmaster','itemmaster.id','=','customer_do_item.item_id')->where('itemmaster.class_id',1)->where('customer_do_item.customer_do_id', $id)->count();
						$row2 = DB::table('customer_do_item')->join('itemmaster','itemmaster.id','=','customer_do_item.item_id')->where('itemmaster.class_id',1)->where('customer_do_item.customer_do_id', $id)->where('customer_do_item.is_transfer',1)->count();
						if($row1==$row2) {
							DB::table('customer_do')->where('id', $id)->update(['is_transfer' => 1]);
						} else 
						    DB::table('customer_do')->where('id', $id)->update(['is_transfer' => 0]);
					}
				}
			}
		}
	}
	
	
	private function setSaleLog($attributes, $key, $document_id, $cost_avg, $sale_cost, $action, $item=null) //DEC 23 UPDATE..
	{
		//CHECK ITEM UNIT QUANTITY AS 0
		$irow = DB::table('item_unit')->where('itemmaster_id', $attributes['item_id'][$key])->select('cur_quantity')->first();
		if($irow->cur_quantity == 0) {
			$stocks = DB::table('item_log')->where('item_id',$attributes['item_id'][$key])
								   ->where('trtype', 1)
								   ->where('status',1)->whereNull('deleted_at')
								   ->select('pur_cost','cur_quantity','unit_cost')
								   ->orderBy('id','DESC')->first();
								   
			$cost_avg = ($stocks->pur_cost==0)?$stocks->unit_cost:$stocks->pur_cost;
		}
		//echo '<pre>';print_r($attributes);exit;
	//	if ($attributes['is_rental'] == 1) {
      //     $document = 'SRL';
	//	}else{
		//	$document = 'SI';     
			
		//}
		
		$unit_cost = (isset($attributes['is_fc']))?($attributes['cost'][$key]*$attributes['currency_rate']):($attributes['cost'][$key]);

		if($attributes['packing'][$key]=="1") 
		    $quantity = $attributes['quantity'][$key];
		else {
		   $pkgar = explode('-', $attributes['packing'][$key]);
		   $quantity = ($attributes['quantity'][$key] *  $pkgar[1]) / $pkgar[0];
		   
		   //COST...
		   /*if($pkgar[0] > 1)
		        $unit_cost = ($unit_cost * $pkgar[1]) / $pkgar[0];
		   else*/
		        $unit_cost = ($unit_cost * $pkgar[0]) / $pkgar[1];
		}
		
		if($action=='add') {
			$cur_quantity = ($irow)?$irow->cur_quantity:0;			
			$logid = DB::table('item_log')->insertGetId([
							 'document_type' => 'SI',
							 'document_id'   => $document_id,
							 'item_id' 	  => $attributes['item_id'][$key],
							 'unit_id'    => $attributes['unit_id'][$key],
							 'quantity'   => $quantity, //($attributes['quantity'][$key] * $attributes['packing'][$key]), //14JN24  ($attributes['unit_id'][$key]==1||$attributes['unit_id'][$key]==2)?($attributes['quantity'][$key]/$attributes['packing'][$key]): 
							 'unit_cost'  => $unit_cost, //(isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key],
							 'trtype'	  => 0,
							 'cost_avg' => $cost_avg,
							 'pur_cost' => $sale_cost,
							 'sale_cost' => $sale_cost,
							 'packing' => 1,
							 'status'     => 1,
							 'created_at' => now(),
							 'created_by' => Auth::User()->id,
							 'voucher_date' => ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
							 'sale_reference' => $cur_quantity,
							 'item_row_id'	=> $attributes['item_row_id'][$key] //OCT24
							]);
			
		} else if($action=='update') { 
		    
		    //MAY25
		    $slog = DB::table('item_log')->where('document_type','SI')->where('document_id', $document_id)->where('item_id', $item->item_id)->where('unit_id', $item->unit_id)->where('item_row_id', $attributes['order_item_id'][$key])
		                ->select('id')->first();
			$logid = $slog->id;
			
			//echo $item->item_id.' '.$attributes['item_id'][$key];exit;
			//if($item_id!=$attributes['item_id'][$key]) {
				DB::table('item_log')->where('document_type','SI')
								->where('document_id', $document_id)
								->where('item_id', $item->item_id)
								->where('unit_id', $item->unit_id)
								->where('item_row_id', $attributes['order_item_id'][$key]) //OCT24
								->update(['item_id' => $attributes['item_id'][$key],
									 'unit_id' => $attributes['unit_id'][$key],
									 'quantity'   => $quantity, //$attributes['quantity'][$key] * $attributes['packing'][$key],//14JN24 ($attributes['unit_id'][$key]==1||$attributes['unit_id'][$key]==2)?($attributes['quantity'][$key]/$attributes['packing'][$key]):
									 'unit_cost'  => $unit_cost, //(isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key],
									 'cur_quantity' => $attributes['quantity'][$key],
									 'cost_avg' => $cost_avg,
									 'pur_cost' => $sale_cost,
									 'sale_cost' => $sale_cost,
									 'voucher_date' => ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date']))
								]);
			/* } else { 					
				DB::table('item_log')->where('document_type','SI')
								->where('document_id', $document_id)
								->where('item_id', $attributes['item_id'][$key])
								->where('unit_id', $attributes['unit_id'][$key])
								->update([
									 'quantity'   => $attributes['quantity'][$key],
									 'unit_cost'  => (isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key],
									 'cur_quantity' => $attributes['quantity'][$key],
									 'cost_avg' => $cost_avg,
									 'pur_cost' => $sale_cost,
									 'sale_cost' => $sale_cost,
									 'voucher_date' => ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date']))
								]);
			} */
			
		}
		
		return $logid;
	}
	
		
	private function updateItemQuantity($attributes, $key, $bquantity=null)
	{
		$item = DB::table('item_unit')->where('itemmaster_id', $attributes['item_id'][$key])
									  ->where('unit_id', $attributes['unit_id'][$key])
									  ->first(); //echo '<pre>';print_r($item);
		if($item) {
			
			$qty = ($bquantity!=null)?$bquantity:$attributes['quantity'][$key];
			$baseqty = ($qty * $attributes['packing'][$key]);
			DB::table('item_unit')
				->where('itemmaster_id',  $attributes['item_id'][$key])
				->where('is_baseqty',1)
				->update([ 'cur_quantity' => DB::raw('cur_quantity - '.$baseqty),
							'issued_qty' => DB::raw('issued_qty + '.$baseqty) ]);
							
			if($item->is_baseqty==0){ 
				DB::table('item_unit')
						->where('id', $item->id)
						->update([ 'cur_quantity' => $item->cur_quantity - $qty,
									'issued_qty' => DB::raw('issued_qty + '.$qty) ]);
			}
			return true;		
		}
	}
	

								
	private function setAccountTransaction($attributes, $amount, $voucher_id, $type, $amount_type, $key=null, $objOC=null)
	{
		//GETTING DEPARTMENT COST ACCOUNTING DETAILS
		$this->checkAndSetCostAccountingParameters($attributes);
		
		$cr_acnt_id = $dr_acnt_id = '';
		if($amount_type=='VAT') {
			$vatrow = $this->getVatAccounts((isset($attributes['department_id']))?$attributes['department_id']:null); //VAT OUTPUT
			if($vatrow) {
				$cr_acnt_id = $vatrow->payment_account;
			}
		} else if($amount_type == 'LNTOTAL') {
			$cr_acnt_id = isset($attributes['cr_account_id'])?$attributes['cr_account_id']:'';
			$amount = (isset($attributes['roundoff']))?($amount - $attributes['roundoff']):$amount;
		} else if($amount_type == 'NTAMT') {
			$dr_acnt_id = $attributes['dr_account_id'];
			$amount = (isset($attributes['roundoff']))?($amount - $attributes['roundoff']):$amount;
		} else if($amount_type == 'STOCK') {
			$cr_acnt_id = Session::get('stock');
		} else if($amount_type == 'COSTOFSALE') {
			$dr_acnt_id = Session::get('cost_of_sale');
		} else if($amount_type == 'OC') {
			$cr_acnt_id = $attributes['cr_acnt_id'][$key];
			$dr_acnt_id = $attributes['dr_acnt_id'][$key];
		} else if($amount_type == 'DIS') {
			if(Session::get('cost_accounting')==1 && Session::get('department')==1) { 
				$vatrow = DB::table('department_accounts')->where('department_id', $attributes['department_id'])->select('saledis_acid')->first();
				if($vatrow)
					$dr_acnt_id = $vatrow->saledis_acid;
				else {
					$vatrow = DB::table('other_account_setting')->where('account_setting_name', 'Discount in Sales')->where('status', 1)->first();
					$dr_acnt_id = $vatrow->account_id;
				}
				
			} else {
				$vatrow = DB::table('other_account_setting')->where('account_setting_name', 'Discount in Sales')->where('status', 1)->first();
				$dr_acnt_id = $vatrow->account_id;
			}
		}
		
		$trfor = ($amount_type=='OC' || $amount_type=='VATOC')?$objOC->id:0;
		
		if( ($cr_acnt_id!='' || $cr_acnt_id!=0) || ($dr_acnt_id!='' || $dr_acnt_id!=0) ) {
		
			$isrental = isset($attributes['is_rental'])?$attributes['is_rental']:null;
			$voucher_type = ($isrental)?'SRL':'SI';
				
			DB::table('account_transaction')
					->insert([  
						        'voucher_type' 		=> $voucher_type, //'SI',
								'voucher_type_id'   => $voucher_id,
								'account_master_id' => ($type=='Cr')?$cr_acnt_id:$dr_acnt_id,
								'transaction_type'  => $type,
								'amount'   			=> $amount,
								'status' 			=> 1,
								'created_at' 		=> now(),
								'created_by' 		=> Auth::User()->id,
								'description' 		=> ($amount_type=='OC')?$attributes['oc_description'][$key]:$attributes['description'].' '.$attributes['sales_account'],
								'reference'			=> ($amount_type=='OC')?$attributes['oc_reference'][$key]:$attributes['voucher_no'],
								'invoice_date'		=> ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
								'tr_for'			=> $trfor,
								'fc_amount'			=> (isset($attributes['is_fc']))?($amount/$attributes['currency_rate']):$amount,
								'is_fc'				=> isset($attributes['is_fc'])?1:0,
								'department_id'		=> (isset($attributes['department_id']))?$attributes['department_id']:'',
								'salesman_id'		=> (isset($attributes['salesman_id']))?$attributes['salesman_id']:'',
								'due_date'          =>(isset($attributes['due_date']))?date('Y-m-d', strtotime($attributes['due_date'])):''
								]);
								
			$this->objUtility->tallyClosingBalance(($type=='Cr')?$cr_acnt_id:$dr_acnt_id);

		}
							
		return true;
	}
	
	
	//Purchase and Sales Method function............
	private function PurchaseAndSalesMethod($attributes, $line_total, $tax_total, $net_amount, $sales_invoice_id, $taxtype)
	{
		$discount = ($attributes['discount']=='')?((isset($attributes['roundoff']))?$attributes['roundoff']:0):$attributes['discount'];
		
		if($taxtype=='tax_include' && $discount > 0) {
			$temp = $net_amount;
			//$net_amount = $line_total;
			//$line_total = $temp + $discount - $tax_total;
			$line_total = $line_total + $discount;
		} else if($taxtype=='tax_exclude' && $discount > 0) {
			$line_total = $line_total + $discount;
		}
		
		//Debit Customer Account
		if( $this->setAccountTransaction($attributes, $net_amount, $sales_invoice_id, $type='Dr', $amount_type='NTAMT') ) {
			
			//Credit Sales A/c
			if( $this->setAccountTransaction($attributes, $line_total, $sales_invoice_id, $type='Cr', $amount_type='LNTOTAL') ) {
				
				//Credit VAT output
				if( $this->setAccountTransaction($attributes, $tax_total, $sales_invoice_id, $type='Cr', $amount_type='VAT') ) {
					
					//Discount 
					$this->setAccountTransaction($attributes, $discount, $sales_invoice_id, $type='Dr', $amount_type='DIS');
				}
			}
		}
		
	}	
	
	
	//Cost Accounting Method function............
	private function CostAccountingMethod($attributes, $line_total, $tax_total, $net_amount, $sales_invoice_id, $taxtype, $cost_value)
	{
		
		//$discount = ($attributes['discount']=='')?0:$attributes['discount'];
		$discount = ($attributes['discount']=='')?((isset($attributes['roundoff']))?$attributes['roundoff']:0):$attributes['discount'];
		
		if($taxtype=='tax_include' && $discount > 0) {
			$temp = $net_amount;
			//$net_amount = $line_total;
			//$line_total = $temp + $discount - $tax_total;
			$line_total = $line_total + $discount;
		} else if($taxtype=='tax_exclude' && $discount > 0) {
			$line_total = $line_total + $discount;
		}
		
		//Debit Customer Account
		if($this->setAccountTransaction($attributes, $net_amount, $sales_invoice_id, $type='Dr', $amount_type='NTAMT')) {
		
			//Credit Sales A/c
			if($this->setAccountTransaction($attributes, $line_total, $sales_invoice_id, $type='Cr', $amount_type='LNTOTAL')) {
			
				//Credit VAT output
				if($this->setAccountTransaction($attributes, $tax_total, $sales_invoice_id, $type='Cr', $amount_type='VAT')) {
				
					//Discount 
					if($this->setAccountTransaction($attributes, $discount, $sales_invoice_id, $type='Dr', $amount_type='DIS')) {
					
						//Credit Stock A/c
						if($this->setAccountTransaction($attributes, $cost_value, $sales_invoice_id, $type='Cr', $amount_type='STOCK')) {
					
							//Debit Cost of Sales
							$this->setAccountTransaction($attributes, $cost_value, $sales_invoice_id, $type='Dr', $amount_type='COSTOFSALE');
						}
					}
				}
			}
		}
		
	}
	
	
	//Purchase and Sales Method update function............
	private function PurchaseAndSalesMethodUpdate($attributes, $line_total, $tax_total, $net_amount, $sales_invoice_id, $taxtype)
	{
		//$discount = ($attributes['discount']=='')?0:$attributes['discount'];
		$discount = ($attributes['discount']=='')?((isset($attributes['roundoff']))?$attributes['roundoff']:0):$attributes['discount'];
		
		if($taxtype=='tax_include' && $discount > 0) {
			/*$temp = $net_amount;
			$net_amount = $line_total;
			$line_total = $temp + $discount;*/

			$temp = $net_amount;
			//$net_amount = $line_total;
			//$line_total = $temp + $discount - $tax_total;
			$line_total = $line_total + $discount;
		} else if($taxtype=='tax_exclude' && $discount > 0) {
			$line_total = $line_total + $discount;
		}
		
		//Debit Customer Account
		if( $this->setAccountTransactionUpdate($attributes, $net_amount, $sales_invoice_id, $type='Dr', $amount_type='NTAMT') ) {
		
			//Credit Sales A/c
			if( $this->setAccountTransactionUpdate($attributes, $line_total, $sales_invoice_id, $type='Cr', $amount_type='LNTOTAL') ) {
				
				//Credit VAT output
					if($this->setAccountTransactionUpdate($attributes, $tax_total, $sales_invoice_id, $type='Cr', $amount_type='VAT')){
						//Dr Discount if discount given
						$this->setAccountTransactionUpdate($attributes, $discount, $sales_invoice_id, $type='Dr', $amount_type='DIS');
				}
			}
		}
	}	
	
	
	
	//Cost Accounting Method function............
	private function CostAccountingMethodUpdate($attributes, $line_total, $tax_total, $net_amount, $sales_invoice_id, $taxtype, $cost_value)
	{
		//$discount = ($attributes['discount']=='')?0:$attributes['discount'];
		$discount = ($attributes['discount']=='')?((isset($attributes['roundoff']))?$attributes['roundoff']:0):$attributes['discount'];
		
		if($taxtype=='tax_include' && $discount > 0) {
			/*$temp = $net_amount;
			$net_amount = $line_total;
			$line_total = $temp + $discount;*/

			$temp = $net_amount;
			//$net_amount = $line_total;
			//$line_total = $temp + $discount - $tax_total;
			$line_total = $line_total + $discount;
		} else if($taxtype=='tax_exclude' && $discount > 0) {
			$line_total = $line_total + $discount;
		}
		
		
		//Debit Customer Account
		if($this->setAccountTransactionUpdate($attributes, $net_amount, $sales_invoice_id, $type='Dr', $amount_type='NTAMT')) {
		
			//Credit Sales A/c
			if($this->setAccountTransactionUpdate($attributes, $line_total, $sales_invoice_id, $type='Cr', $amount_type='LNTOTAL')) {
			
				//Credit VAT output
				if($this->setAccountTransactionUpdate($attributes, $tax_total, $sales_invoice_id, $type='Cr', $amount_type='VAT')) {
				
					//Discount...
					if($this->setAccountTransactionUpdate($attributes, $discount, $sales_invoice_id, $type='Dr', $amount_type='DIS')) {
					
						//Credit Stock A/c
						if($this->setAccountTransactionUpdate($attributes, $cost_value, $sales_invoice_id, $type='Cr', $amount_type='STOCK')) {
						
							//Debit Cost of Sales
							$this->setAccountTransactionUpdate($attributes, $cost_value, $sales_invoice_id, $type='Dr', $amount_type='COSTOFSALE');
						}
					}
				}
			}
		
		}
		
	}
	

	private function setAccountTransactionUpdate($attributes, $amount, $voucher_id, $type, $amount_type, $key=null)
	{	
		//GETTING DEPARTMENT COST ACCOUNTING DETAILS
		$this->checkAndSetCostAccountingParameters($attributes);
		
		$cr_acnt_id = $dr_acnt_id = '';
		if($amount_type=='VAT') {
			$vatrow = $this->getVatAccounts((isset($attributes['department_id']))?$attributes['department_id']:null); //DB::table('vat_master')->where('status', 1)->whereNull('deleted_at')->first();//DB::table('account_master')->where('master_name', 'VAT OUTPUT')->where('status', 1)->first();
			if($vatrow) {
				$cr_acnt_id = $account_id = $account_id_old = $vatrow->payment_account;
			}
		} else if($amount_type == 'LNTOTAL') { 
			$cr_acnt_id = $account_id = $attributes['cr_account_id']; $account_id_old = $attributes['cr_account_id_old'];
		 	$amount = (isset($attributes['roundoff']))?($amount - $attributes['roundoff']):$amount; 
		} else if($amount_type == 'NTAMT') {
			$dr_acnt_id = $account_id = $attributes['dr_account_id']; $account_id_old = $attributes['dr_account_id_old'];
			$amount = (isset($attributes['roundoff']))?($amount - $attributes['roundoff']):$amount;
			if($attributes['customer_id'] != $attributes['old_customer_id']) {
			
				$isrental = isset($attributes['is_rental'])?$attributes['is_rental']:null;
				$voucher_type = ($isrental)?'SRL':'SI';
				
				DB::table('account_transaction')
						->where('voucher_type_id', $voucher_id)
						->where('voucher_type', $voucher_type) //'SI'
						->where('account_master_id', $attributes['old_customer_id'])
						->update( ['account_master_id' => $attributes['customer_id'], 'amount' => $amount ]);
						
				$this->objUtility->tallyClosingBalance($attributes['old_customer_id']);
				
			}

			
			
		} else if($amount_type == 'STOCK') {
			$cr_acnt_id = $account_id = $account_id_old = Session::get('stock');
		} else if($amount_type == 'COSTOFSALE') {
			$dr_acnt_id = $account_id = $account_id_old = Session::get('cost_of_sale');
		} else if($amount_type == 'DIS') {
			if(Session::get('cost_accounting')==1 && Session::get('department')==1) { 
				$vatrow = DB::table('department_accounts')->where('department_id', $attributes['department_id'])->select('saledis_acid')->first();
				if($vatrow)
					$dr_acnt_id = $account_id = $account_id_old = $vatrow->saledis_acid;
				else {
					$vatrow = DB::table('other_account_setting')->where('account_setting_name', 'Discount in Sales')->where('status', 1)->first();
					$dr_acnt_id = $account_id = $account_id_old = $vatrow->account_id;
				}
				
			} else {
				$vatrow = DB::table('other_account_setting')->where('account_setting_name', 'Discount in Sales')->where('status', 1)->first();
				$dr_acnt_id = $account_id = $account_id_old = $vatrow->account_id;
			}
		} else if($amount_type == 'OC') {
			if($type=='Cr') {
				$cr_acnt_id = $account_id = $account_id_old = $attributes['cr_acnt_id'][$key];
				$cur_account_id = $attributes['cur_cr_acnt_id'][$key];
			} else {
				$dr_acnt_id = $account_id = $account_id_old = $attributes['dr_acnt_id'][$key];
				$cur_account_id = $attributes['cur_dr_acnt_id'][$key];
			}
		}
		
		$trfor = ($amount_type=='OC')?$attributes['oc_id'][$key]:0;
		
		$isrental = isset($attributes['is_rental'])?$attributes['is_rental']:null;
		$voucher_type = ($isrental)?'SRL':'SI';
				
	//	Log::info('Ab '.$amount_type.' '.$voucher_id.' '.$account_id_old.' '.$account_id.' '.$amount.' '.$trfor);	
				
		DB::table('account_transaction')
				->where('voucher_type_id', $voucher_id)
				->where('account_master_id', $account_id_old) //CHNG
				->where('voucher_type', $voucher_type) //'SI'
				->where('tr_for', $trfor)
				->update([  'account_master_id' => $account_id,
							'amount'   			=> $amount,
							'modify_at' 		=> now(),
							'modify_by' 		=> Auth::User()->id,
							'description' 		=> ($amount_type=='OC')?$attributes['oc_description'][$key]:$attributes['description'],
							'reference'			=> ($amount_type=='OC')?$attributes['oc_reference'][$key]:$attributes['voucher_no'],
							'invoice_date'		=> ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
							'fc_amount'			=> (isset($attributes['is_fc']))?($amount/$attributes['currency_rate']):$amount,
							'department_id'		=> (isset($attributes['department_id']))?$attributes['department_id']:'',
							'due_date'          =>(isset($attributes['due_date']))?date('Y-m-d', strtotime($attributes['due_date'])):''
						]);
		//exit;	
		$this->objUtility->tallyClosingBalance(($type=='Cr')?$cr_acnt_id:$dr_acnt_id);
								
		return true;
	}
												
	private function setAccountTransactionUpdateOld($attributes, $amount, $voucher_id, $type, $amount_type, $key=null)
	{	
		//GETTING DEPARTMENT COST ACCOUNTING DETAILS
		$this->checkAndSetCostAccountingParameters($attributes);
		
		$cr_acnt_id = $dr_acnt_id = '';
		if($amount_type=='VAT') {
			$vatrow = $this->getVatAccounts((isset($attributes['department_id']))?$attributes['department_id']:null); //DB::table('vat_master')->where('status', 1)->whereNull('deleted_at')->first();//DB::table('account_master')->where('master_name', 'VAT OUTPUT')->where('status', 1)->first();
			if($vatrow) {
				$cr_acnt_id = $account_id = $vatrow->payment_account;
			}
		} else if($amount_type == 'LNTOTAL') {
			$cr_acnt_id = $account_id = $attributes['cr_account_id'];
			$amount = (isset($attributes['roundoff']))?($amount - $attributes['roundoff']):$amount;
		} else if($amount_type == 'NTAMT') {
			$dr_acnt_id = $account_id = $attributes['dr_account_id'];
			$amount = (isset($attributes['roundoff']))?($amount - $attributes['roundoff']):$amount;
			if($attributes['customer_id'] != $attributes['old_customer_id']) {
			
				$isrental = isset($attributes['is_rental'])?$attributes['is_rental']:null;
				$voucher_type = ($isrental)?'SRL':'SI';
				
				DB::table('account_transaction')
						->where('voucher_type_id', $voucher_id)
						->where('voucher_type', $voucher_type) //'SI'
						->where('account_master_id', $attributes['old_customer_id'])
						->update( ['account_master_id' => $attributes['customer_id'] ]);
						
				$this->objUtility->tallyClosingBalance($attributes['old_customer_id']);
				
			}
			
		} else if($amount_type == 'STOCK') {
			$cr_acnt_id = $account_id = Session::get('stock');
		} else if($amount_type == 'COSTOFSALE') {
			$dr_acnt_id = $account_id = Session::get('cost_of_sale');
		} else if($amount_type == 'DIS') {
			if(Session::get('cost_accounting')==1 && Session::get('department')==1) { 
				$vatrow = DB::table('department_accounts')->where('department_id', $attributes['department_id'])->select('saledis_acid')->first();
				if($vatrow)
					$dr_acnt_id = $account_id = $vatrow->saledis_acid;
				else {
					$vatrow = DB::table('other_account_setting')->where('account_setting_name', 'Discount in Sales')->where('status', 1)->first();
					$dr_acnt_id = $account_id = $vatrow->account_id;
				}
				
			} else {
				$vatrow = DB::table('other_account_setting')->where('account_setting_name', 'Discount in Sales')->where('status', 1)->first();
				$dr_acnt_id = $account_id = $vatrow->account_id;
			}
		} else if($amount_type == 'OC') {
			if($type=='Cr') {
				$cr_acnt_id = $account_id = $attributes['cr_acnt_id'][$key];
				$cur_account_id = $attributes['cur_cr_acnt_id'][$key];
			} else {
				$dr_acnt_id = $account_id = $attributes['dr_acnt_id'][$key];
				$cur_account_id = $attributes['cur_dr_acnt_id'][$key];
			}
		}
		
		$trfor = ($amount_type=='OC')?$attributes['oc_id'][$key]:0;
		
		$isrental = isset($attributes['is_rental'])?$attributes['is_rental']:null;
		$voucher_type = ($isrental)?'SRL':'SI';
				
		DB::table('account_transaction')
				->where('voucher_type_id', $voucher_id)
				->where('account_master_id', $account_id) //CHNG
				->where('voucher_type', $voucher_type) //'SI'
				->where('tr_for', $trfor)
				->update([  'amount'   			=> $amount,
							'modify_at' 		=> now(),
							'modify_by' 		=> Auth::User()->id,
							'description' 		=> ($amount_type=='OC')?$attributes['oc_description'][$key]:$attributes['description'],
							'reference'			=> ($amount_type=='OC')?$attributes['oc_reference'][$key]:$attributes['voucher_no'],
							'invoice_date'		=> ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
							'fc_amount'			=> (isset($attributes['is_fc']))?($amount/$attributes['currency_rate']):$amount,
							'department_id'		=> (isset($attributes['department_id']))?$attributes['department_id']:'',
							'salesman_id'		=> (isset($attributes['salesman_id']))?$attributes['salesman_id']:''
						]);
		//exit;	
		$this->objUtility->tallyClosingBalance(($type=='Cr')?$cr_acnt_id:$dr_acnt_id);
								
		return true;
	}
	
		
	private function calculateTotalAmount($attributes) {
		
		$total = 0;
		if(isset($attributes['item_id'])) {
			foreach($attributes['item_id'] as $key => $value){ 
				
				$total += $attributes['quantity'][$key] * $attributes['cost'][$key];
			}
		}
		
		if(isset($attributes['lbitem_id'])) {
			foreach($attributes['lbitem_id'] as $key => $value){ 
				
				$total += $attributes['lbquantity'][$key] * $attributes['lbcost'][$key];
			}
		}
		
		return $total;
	}
	
	protected function addService($attributes) {
		
		$linetotal = $taxtotal = $itemtotal = $lbtax_total = 0; $type = 'tax_exclude'; $vat = 0;
		$discount = (isset($attributes['discount']))?$attributes['discount']:0;
		if($discount > 0)
			$lineTotal = $this->calculateTotalAmount($attributes);
		
			foreach($attributes['lbitem_id'] as $key => $value){ 
			
				$salesInvoiceItem = new SalesInvoiceItem();
				
				$lbline_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);	
				$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['lbtax_code'][$key];
				if(isset($attributes['is_export']) || $tax_code=="EX" || $tax_code=="ZR") {
					
					$tax        = 0;
					$lbitem_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
					$lbtax_total  = round($tax * $attributes['lbquantity'][$key],2);
					
				} else if($attributes['lbtax_include'][$key]==1){
					
					$ln_total   = $attributes['lbcost'][$key] * $attributes['lbquantity'][$key];
					$lbtax_total  = $ln_total *  $attributes['lbline_vat'][$key] / (100 +  $attributes['lbline_vat'][$key]);
					$lbitem_total = $ln_total - $lbtax_total;
					
				} else {
				
					$tax        = ($attributes['lbcost'][$key] * $attributes['lbline_vat'][$key]) / 100;
					$lbitem_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
					$lbtax_total  = round($tax * $attributes['lbquantity'][$key],2);
					
				}
				
				$type = 'tax_exclude'; //SEP25
				if($attributes['lbtax_include'][$key]==1 ) {
					$vatPlus = 100 + $attributes['lbline_vat'][$key];
					$total = $attributes['lbcost'][$key] * $attributes['lbquantity'][$key];
					$type = 'tax_include';
				} else {
					$vatPlus = 100;
					$total = $attributes['lbline_total'][$key];
					$type = 'tax_exclude';
				}
				
				if($discount > 0) {
					$discountAmt = round( (($total / $lineTotal) * $discount),2 );
					$amountTotal = $total - $discountAmt;
					$vatLine = round( (($amountTotal * $attributes['lbline_vat'][$key]) / $vatPlus),2 );
					$lbtax_total = $vatLine; 
				}
					
				$salesInvoiceItem->sales_invoice_id = $this->sales_invoice->id;
				$salesInvoiceItem->item_id    		= $value;
				$salesInvoiceItem->item_name  		= $attributes['lbitem_name'][$key];
				$salesInvoiceItem->unit_id 			= $attributes['lbunit_id'][$key];
				$salesInvoiceItem->quantity   		= $attributes['lbquantity'][$key];
				$salesInvoiceItem->unit_price 		= (isset($attributes['is_fc']))?$attributes['lbcost'][$key]*$attributes['currency_rate']:$attributes['lbcost'][$key];
				$salesInvoiceItem->vat		    	= $attributes['lbline_vat'][$key];
				$salesInvoiceItem->vat_amount 		= $lbtax_total;
				$salesInvoiceItem->discount   		= $attributes['lbline_discount'][$key];
				$salesInvoiceItem->line_total 		= $lbline_total;
				$salesInvoiceItem->tax_code 		= $attributes['lbtax_code'][$key];
				$salesInvoiceItem->tax_include 		= $attributes['lbtax_include'][$key];
				$salesInvoiceItem->item_total 		= $lbitem_total;
				$salesInvoiceItem->item_type = 1;
				$salesInvoiceItem->status = 1;
				$itemObj = $this->sales_invoice->salesInvoiceItemAdd()->save($salesInvoiceItem);
				
				$linetotal += $lbline_total;
				$taxtotal += $lbtax_total;
				$itemtotal += $lbitem_total;
				$vat = $attributes['lbline_vat'][$key]; //SEP25
			}
		
		return array('line_total' => $linetotal, 'tax_total' => $taxtotal, 'item_total' => $itemtotal, 'type' => $type, 'vat' => $vat );//SEP25		
	}
	
	protected function updateService($attributes)
	{
		$line_total = $tax_total = $item_total = $lbtax_total = 0;
		$discount = (isset($attributes['discount']))?$attributes['discount']:0;
		if($discount > 0)
			$lineTotal = $this->calculateTotalAmount($attributes);
		
		foreach($attributes['lbitem_id'] as $key => $value) { 
					
			if($attributes['lborder_item_id'][$key]!='') {
				
				$linetotal = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
				$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['lbtax_code'][$key];
				if(isset($attributes['is_export']) || $tax_code=="EX" || $tax_code=="ZR") {
					
					$tax        = 0;
					$itemtotal = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
					$lbtax_total  = round($tax * $attributes['lbquantity'][$key], 2);
					
				} else if($attributes['lbtax_include'][$key]==1){
					
					$ln_total   = $attributes['lbcost'][$key] * $attributes['lbquantity'][$key];
					$lbtax_total  = $ln_total *  $attributes['lbline_vat'][$key] / (100 +  $attributes['lbline_vat'][$key]);
					$itemtotal = $ln_total - $lbtax_total;
					
				} else {
					
					$tax        = ($attributes['lbcost'][$key] * $attributes['lbline_vat'][$key]) / 100;
					$itemtotal = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
					$lbtax_total  = round($tax * $attributes['lbquantity'][$key], 2);
					$linetotal = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
				}
				
				$type = 'tax_exclude';
				if($attributes['lbtax_include'][$key]==1 ) {
					$vatPlus = 100 + $attributes['lbline_vat'][$key];
					$total = $attributes['lbcost'][$key] * $attributes['lbquantity'][$key];
					$type = 'tax_include';
				} else {
					$vatPlus = 100;
					$total = $attributes['lbline_total'][$key];
					$type = 'tax_exclude';
				}
				
				if($discount > 0) {
					$discountAmt = round( (($total / $lineTotal) * $discount),2 );
					$amountTotal = $total - $discountAmt;
					$vatLine = round( (($amountTotal * $attributes['lbline_vat'][$key]) / $vatPlus),2 );
					$lbtax_total = $vatLine; 
				}
				
				$salesInvoiceItem = SalesInvoiceItem::find($attributes['lborder_item_id'][$key]);
				$oldqty = $salesInvoiceItem->quantity;
				$items['item_name'] = $attributes['lbitem_name'][$key];
				$items['item_id'] = $value;
				$items['unit_id'] = $attributes['lbunit_id'][$key];
				$items['quantity'] = $attributes['lbquantity'][$key];
				$items['unit_price'] = (isset($attributes['is_fc']))?$attributes['lbcost'][$key]*$attributes['currency_rate']:$attributes['lbcost'][$key];
				$items['vat']		 = $attributes['lbline_vat'][$key];
				$items['vat_amount'] = $lbtax_total;
				$items['discount'] = $attributes['lbline_discount'][$key];
				$items['line_total'] = $linetotal;
				$items['item_total'] = $itemtotal;
				$items['tax_code'] 	= $attributes['lbtax_code'][$key];
				$items['tax_include'] = $attributes['lbtax_include'][$key];//CHG
				$exi_quantity = $salesInvoiceItem->quantity;
				$salesInvoiceItem->update($items);
				
				$tax_total += $lbtax_total;
				$line_total += $linetotal;
				$item_total += $itemtotal;
				
			} else { //add new service
				
				$salesInvoiceItem = new SalesInvoiceItem();
				
				$lbline_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);	
				if(isset($attributes['is_export']) || $tax_code=="EX" || $tax_code=="ZR") {
					
					$tax        = 0;
					$lbitem_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
					$lbtax_total  = round($tax * $attributes['lbquantity'][$key],2);
					
				} else if($attributes['lbtax_include'][$key]==1){
					
					$ln_total   = $attributes['lbcost'][$key] * $attributes['lbquantity'][$key];
					$lbtax_total  = $ln_total *  $attributes['lbline_vat'][$key] / (100 +  $attributes['lbline_vat'][$key]);
					$lbitem_total = $ln_total - $lbtax_total;
					
				} else {
				
					$tax        = ($attributes['lbcost'][$key] * $attributes['lbline_vat'][$key]) / 100;
					$lbitem_total = ($attributes['lbcost'][$key] * $attributes['lbquantity'][$key]);
					$lbtax_total  = round($tax * $attributes['lbquantity'][$key],2);
					
				}
				
				$type = 'tax_exclude';
				if($attributes['lbtax_include'][$key]==1 ) {
					$vatPlus = 100 + $attributes['lbline_vat'][$key];
					$total = $attributes['lbcost'][$key] * $attributes['lbquantity'][$key];
					$type = 'tax_include';
				} else {
					$vatPlus = 100;
					$total = $attributes['lbline_total'][$key];
					$type = 'tax_exclude';
				}
				
				if($discount > 0) {
					$discountAmt = round( (($total / $lineTotal) * $discount),2 );
					$amountTotal = $total - $discountAmt;
					$vatLine = round( (($amountTotal * $attributes['lbline_vat'][$key]) / $vatPlus),2 );
					$lbtax_total = $vatLine; 
				}
				
				$salesInvoiceItem->sales_invoice_id = $this->sales_invoice->id;
				$salesInvoiceItem->item_id    		= $value;
				$salesInvoiceItem->item_name  		= $attributes['lbitem_name'][$key];
				$salesInvoiceItem->unit_id 			= $attributes['lbunit_id'][$key];
				$salesInvoiceItem->quantity   		= $attributes['lbquantity'][$key];
				$salesInvoiceItem->unit_price 		= (isset($attributes['is_fc']))?$attributes['lbcost'][$key]*$attributes['currency_rate']:$attributes['lbcost'][$key];
				$salesInvoiceItem->vat		    	= $attributes['lbline_vat'][$key];
				$salesInvoiceItem->vat_amount 		= $lbtax_total;
				$salesInvoiceItem->discount   		= $attributes['lbline_discount'][$key];
				$salesInvoiceItem->line_total 		= $lbline_total;
				$salesInvoiceItem->tax_code 		= $attributes['lbtax_code'][$key];
				$salesInvoiceItem->tax_include 		= $attributes['lbtax_include'][$key];
				$salesInvoiceItem->item_total 		= $lbitem_total;
				$salesInvoiceItem->item_type = 1;
				$salesInvoiceItem->status = 1;
				
				$itemObj = $this->sales_invoice->salesInvoiceItemAdd()->save($salesInvoiceItem);
				
				$line_total += $lbline_total;
				$tax_total += $lbtax_total;
				$item_total += $lbitem_total;
			}
			$vat = $attributes['lbline_vat'][$key]; //SEP25
		}
		return array('line_total' => $line_total, 'tax_total' => $tax_total, 'item_total' => $item_total, 'type' => $type, 'vat' => $vat );
		//return array('line_total' => $line_total, 'tax_total' => $tax_total, 'item_total' => $item_total);	
	}
	
	
	private function setSellExpInputValue($attributes, $salesInvoiceSE, $key)
	{
		$salesInvoiceSE->sales_invoice_id = $this->sales_invoice->id;
		$salesInvoiceSE->dr_account_id = $attributes['dr_acnt_id'][$key];
		$salesInvoiceSE->se_reference = $attributes['oc_reference'][$key];
		$salesInvoiceSE->se_description = $attributes['oc_description'][$key];
		$salesInvoiceSE->cr_account_id = $attributes['cr_acnt_id'][$key];
		$salesInvoiceSE->se_amount = $attributes['oc_amount'][$key];
		
		return array('se_amount' => $attributes['oc_amount'][$key]);
	}
	
	
	public function create($attributes)
	{ 	
		//echo '<pre>';print_r($attributes);exit;
		//echo $this->customer_receipt->testFun();exit;
		
		//NOV24
		$locqty = isset($attributes['locqty'])?array_values($attributes['locqty']):''; 
	    $locid = isset($attributes['locid'])?array_values($attributes['locid']):'';
	    
		if($this->isValid($attributes)) {
			DB::beginTransaction();
			try {
				//echo $attributes['voucher_no'];exit;
				
				Session::put('SI_deptid', isset($attributes['department_id'])?$attributes['department_id']:null);
				Session::put('SI_vchrid', $attributes['voucher_id']);
				/* Session::put('SI_vchrno', $attributes['voucher_no']);
				Session::put('SI_curno', $attributes['curno']); */
				Session::put('SI_salesac', $attributes['sales_account']);
				Session::put('SI_cracid', isset($attributes['cr_account_id'])?$attributes['cr_account_id']:null);
				
				if($this->setInputValue($attributes)) {
					$this->sales_invoice->status = 1;
					$this->sales_invoice->created_at = now();
					$this->sales_invoice->created_by = Auth::User()->id;
					$this->sales_invoice->fill($attributes)->save();
					
					//check workshop version active...
					if($this->module->is_active==1 && $this->sales_invoice->id) {
						$this->setJobdetails($attributes);
					}
					
				}
				
				$line_total = 0; $tax_total = 0; $cost_value = 0; $total = $item_total = 0;$taxtype = '';
				//MR19
				if( isset($attributes['is_fc']) ) 
					$discount = (isset($attributes['discount']))?((float)$attributes['discount']* (float)$attributes['currency_rate']):0;
				else
					$discount = (isset($attributes['discount']))?(($attributes['discount']!='')?$attributes['discount']:0):0;
				
				//$discount = (isset($attributes['discount']))?(($attributes['discount']!='')?$attributes['discount']:0):0;
				//order items insert
				if($this->sales_invoice->id && isset($attributes['item_id']) && !empty( array_filter($attributes['item_id']))) {
					
					//calculate total amount....
					if($discount > 0) 
						$total = $this->calculateTotalAmount($attributes);
					
					foreach($attributes['item_id'] as $key => $value){ 
						$salesInvoiceItem = new SalesInvoiceItem();
						$vat = $attributes['line_vat'][$key]; //CHG
						$arrResult 		= $this->setItemInputValue($attributes, $salesInvoiceItem, $key, $value, $total);
					
						//if($arrResult['line_total']) {
							$line_total			     += $arrResult['line_total'];
							$tax_total      	     += $arrResult['tax_total'];
							//$cost_value 			 += $arrResult['cost_value'];
							$taxtype				  = $arrResult['type'];
							$item_total				 += $arrResult['item_total'];
							
							$salesInvoiceItem->status = 1;
							$itemObj = $this->sales_invoice->salesInvoiceItemAdd()->save($salesInvoiceItem);
							//echo '<pre>';print_r($itemObj);exit;
							//UPDATE ITEM COST LOGS....
							//$this->objUtility->reEvaluateItemCostQuantity($value); 
							
							//item description section....
							if(isset($attributes['itemdesc'][$key])) {
								foreach($attributes['itemdesc'][$key] as $descrow) {
									if($descrow != '') {
										$itemDescription = new ItemDescription();
										$itemDescription->invoice_type = 'SI';
										$itemDescription->item_detail_id = $itemObj->id;
										$itemDescription->description = $descrow;
										$itemDescription->status = 1;
										$itemDescription->save(); 
									}
								}
							}
							
							//VAT calculate from subtotal...
							if(!isset($attributes['vatfrm_subtotal'])) {
								//update item transfer status...
								$this->setTransferStatusItem($attributes, $key, $attributes['document_type'],'add');
							}
							
							//update service item....
							if($this->matservice->is_active==1) {
								$this->setTransferStatusService($attributes, $key, $attributes['document_type']);
							}
							
							//stock update section............................
							//CHECK WHEATHER Update Quantity by CDO
							$attributes['item_row_id'][$key] = $itemObj->id; //OCT24
							if($this->mod_do_qty->is_active==1) {
								$sale_cost = $this->objUtility->updateItemQuantitySales($attributes, $key);
								$DOlogs = $this->checkCDOLogs($attributes, $key);//APR25
								if(!$DOlogs) { //CHECK CDO LOG INSERTED IN LOG TABLE OR NOT...
									//update last purchase cost and cost average....
									$CostAvg_log = $this->objUtility->updateLastPurchaseCostAndCostAvg($attributes, $key, 0); 
									$logid = $this->setSaleLog($attributes, $key, $this->sales_invoice->id, $CostAvg_log, $sale_cost, 'add' );
									$cost_value += $sale_cost * $attributes['quantity'][$key];
									
								} else {
									//APR25
									$CostAvg_log = $this->updateLastPurchaseCostOnTransfer($attributes, $key, 0, $DOlogs);
									$logid = $this->setSaleLog($attributes, $key, $this->sales_invoice->id, $CostAvg_log, $sale_cost, 'add' );
									$cost_value += $sale_cost * $attributes['quantity'][$key];
									
								}
							} else {
								 $sale_cost = $this->objUtility->updateItemQuantitySales($attributes, $key);///echo '<pre>';print_r($sale_cost);exit;
								 $CostAvg_log = $this->objUtility->updateLastPurchaseCostAndCostAvg($attributes, $key, 0);
								 $logid = $this->setSaleLog($attributes, $key, $this->sales_invoice->id, $CostAvg_log, $sale_cost, 'add' );
								 $cost_value += $sale_cost * $attributes['quantity'][$key];	
							}
							//}
						//}
						
						//################ Location Stock Entry ####################
						//Item Location specific add....
						$updated = $locdata = false; $loctext = $qtytext = $bintext = '';
						if(isset($attributes['locqty'][$key])) {
							foreach($attributes['locqty'][$key] as $lk => $lq) {
								if($lq!='') {
									$updated = true;
									//$lcqty = $lq * $attributes['packing'][$key];
									$lcqty = $lq;
                            		if($attributes['packing'][$key]=="1") 
                            		    $lcqty = $lq;
                            		else {
                            		   $pkgar = explode('-', $attributes['packing'][$key]);
                            		   if($pkgar[0] > 0)
                            		        $lcqty = ($lq *  $pkgar[1]) / $pkgar[0];
                            		}
									$qtys = DB::table('item_location')->where('status',1)->where('location_id', $attributes['locid'][$key][$lk])
																  ->where('item_id', $value)//->where('unit_id', $attributes['unit_id'][$key])
																  ->whereNull('deleted_at')->select('id')->first();
									if($qtys) {
										DB::table('item_location')->where('id', $qtys->id)->update(['quantity' => DB::raw('quantity - '.$lcqty) ]);
										
										//$loctext .= ($loctext!='')?'<br/>'.$attributes['locnm'][$key][$lk].': '.$lq:$attributes['locnm'][$key][$lk].': '.$lcqty;
    									//$bintext .= ($bintext!='')?'<br/>'.$attributes['locbn'][$key][$lk]:$attributes['locbn'][$key][$lk];
    									$locdata = true;
									
									} else {
										$itemLocation = new ItemLocation();
										$itemLocation->location_id = $attributes['locid'][$key][$lk];
										$itemLocation->item_id = $value;
										$itemLocation->unit_id = $attributes['unit_id'][$key];
										$itemLocation->quantity = $lcqty;
										$itemLocation->status = 1;
										$itemLocation->save();
									}
									
									
									$itemLocationSI = new ItemLocationSI();
									$itemLocationSI->location_id = $attributes['locid'][$key][$lk];
									$itemLocationSI->item_id = $value;
									$itemLocationSI->unit_id = $attributes['unit_id'][$key];
									$itemLocationSI->quantity = $lcqty;
									$itemLocationSI->status = 1;
									$itemLocationSI->invoice_id = $itemObj->id;
									$itemLocationSI->logid = $logid;
									$itemLocationSI->qty_entry = $lq;
									$itemLocationSI->save();
								}
							}
						}

						

						//Item default location add...
						if($this->mod_location->is_active==1 && ($updated == false)) {
                            $loctext = $qtytext = $bintext = '';
							$lcrow = DB::table('default_loc')->first();
							if($lcrow)
								$sales_loc = $lcrow->sales_loc;
							else
								$sales_loc = Session::get('location_id');

							$qtys = DB::table('item_location')
							              ->leftJoin('bin_location','bin_location.id','=','item_location.bin_id')
							              ->leftJoin('location','location.id','=','item_location.location_id')
		                                  ->where('item_location.status',1)->where('item_location.location_id', $sales_loc)
										  ->where('item_location.item_id', $value)//->where('item_location.unit_id', $attributes['unit_id'][$key])
										  ->where('item_location.deleted_at', '0000-00-00 00:00:00')->select('item_location.id','location.code','bin_location.code AS bin')->first();
										  
							$lcqty = $attributes['quantity'][$key] * $attributes['packing'][$key];
							
							if($qtys) {
								DB::table('item_location')->where('id', $qtys->id)->update(['quantity' => DB::raw('quantity - '.$lcqty) ]);
								
								$loctext .= ($loctext!='')?'<br/>'.$qtys->code.': '.$lcqty:$qtys->code.': '.$lcqty;
						    	$bintext .= ($bintext!='')?'<br/>'.$qtys->bin:$qtys->bin;
							    $locdata = true;
							
							} else {
									$itemLocation = new ItemLocation();
									$itemLocation->location_id = $sales_loc;
									$itemLocation->item_id = $value;
									$itemLocation->unit_id = $attributes['unit_id'][$key];
									$itemLocation->quantity = $lcqty;
									$itemLocation->status = 1;
									$itemLocation->save();
								}
							
							
							
							$itemLocationSI = new ItemLocationSI();
							$itemLocationSI->location_id = $sales_loc;
							$itemLocationSI->item_id = $value;
							$itemLocationSI->unit_id = $attributes['unit_id'][$key];
							$itemLocationSI->quantity = $lcqty;
							$itemLocationSI->status = 1;
							$itemLocationSI->invoice_id = $itemObj->id;
							$itemLocationSI->logid = $logid;
							$itemLocationSI->qty_entry = $attributes['quantity'][$key];
							$itemLocationSI->save();
							$updated = true;
							
						}
						
						
						if($locdata) {
						    DB::table('sales_invoice_item')->where('id',$itemObj->id)->update(['assembly_items' => $loctext, 'assembly_items_qty' => $bintext]);
						}
						
						//Item user's default location add...
						if(isset($attributes['default_location']) && ($attributes['default_location'] > 0) && ($updated == false)) {
								
								$qtys = DB::table('item_location')->where('status',1)->where('location_id', $attributes['default_location'])
																  ->where('item_id', $value)//->where('unit_id', $attributes['unit_id'][$key])
																  ->whereNull('deleted_at')->select('id')->first();
																  
								//$lcqty = $attributes['quantity'][$key] * $attributes['packing'][$key];
								$lcqty = $attributes['quantity'][$key];
                        		if($attributes['packing'][$key]=="1") 
                        		    $lcqty = $attributes['quantity'][$key];
                        		else {
                        		   $pkgar = explode('-', $attributes['packing'][$key]);
                        		   if($pkgar[0] > 0)
                        		        $lcqty = ($attributes['quantity'][$key] *  $pkgar[1]) / $pkgar[0];
                        		}
                        		
								if($qtys) {
									DB::table('item_location')->where('id', $qtys->id)->update(['quantity' => DB::raw('quantity - '.$lcqty) ]);
								} else {
										$itemLocation = new ItemLocation();
										$itemLocation->location_id = $attributes['default_location'];
										$itemLocation->item_id = $value;
										$itemLocation->unit_id = $attributes['unit_id'][$key];
										$itemLocation->quantity = $lcqty;
										$itemLocation->status = 1;
										$itemLocation->save();
									}
									
								$itemLocationSI = new ItemLocationSI();
								$itemLocationSI->location_id = $attributes['default_location'];
								$itemLocationSI->item_id = $value;
								$itemLocationSI->unit_id = $attributes['unit_id'][$key];
								$itemLocationSI->quantity = $lcqty;
								$itemLocationSI->status = 1;
								$itemLocationSI->invoice_id = $itemObj->id;
								$itemLocationSI->logid = $logid;
								$itemLocationSI->qty_entry = $attributes['quantity'][$key];
								$itemLocationSI->save();
								
							}
							
							
							//MAY25 BATCH NO ENTRY............
							//if(isset($attributes['is_rental']) && $attributes['is_rental'] !=2){
            				if(isset($attributes['batchNos'][$key]) && $attributes['batchNos'][$key]!='' && $attributes['qtyBatchs'][$key]!='') {
            				    
            				    $batchArr = explode(',', $attributes['batchNos'][$key]);
            				    $qtyArr = explode(',', $attributes['qtyBatchs'][$key]);
            				    
            				    foreach($batchArr as $bkey => $bval) {
    
                    			    DB::table('batch_log')
                				                ->insert([
                				                    'batch_id' => $bval,
                				                    'item_id' => $value,
                				                    'document_type' => 'SI',
                				                    'document_id' => $this->sales_invoice->id,
                				                    'doc_row_id' => $itemObj->id,
                				                    'quantity' => $qtyArr[$bkey],
                				                    'trtype' => 0,
                				                    'invoice_date' => ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
                				                    'log_id' => $logid,
                				                    'created_at' => now(),
                				                    'created_by' => Auth::User()->id
                				                    ]);
    
                        			DB::table('item_batch')
                        			                    ->where('id',$bval)
                        				                ->update([
                        				                    'quantity' => DB::raw('quantity - '.$qtyArr[$bkey])
                        				                ]);	                
                        				                
            				    }
            				
            				}
						//	}
            				//.....END BATCH ENTRY
        				
							
							#####----MINUS QTY LOCATION ENTRY-----#####
    						if(isset($attributes['mq_loc']) && ($attributes['mq_loc'] > 0) && ($attributes['curqty'][$key] < $attributes['quantity'][$key]) ) {
    							
    							$mnsqty = $attributes['quantity'][$key]-$attributes['curqty'][$key];
    							$mnsloc = DB::table('location')->where('status',1)->whereNull('deleted_at')->where('is_minus_qty',1)->select('id')->first();
    							if(!$mnsloc) {
    								$mlocid = DB::table('location')->insertGetId(['code'=>'-QTY','name'=>'Mins Qty','is_default'=>0,'status'=>1,
    														'deleted_at'=>'0000-00-00 00:00:00','is_conloc'=>0,'customer_id'=>0,'is_minus_qty'=>1]);
    							} else
    								$mlocid = $mnsloc->id;
    							
    							$itemLocationSI = new ItemLocationSI();
    							$itemLocationSI->location_id = $mlocid;
    							$itemLocationSI->item_id = $value;
    							$itemLocationSI->unit_id = $attributes['unit_id'][$key];
    							$itemLocationSI->quantity = $mnsqty;
    							$itemLocationSI->status = 1;
    							$itemLocationSI->invoice_id = $itemObj->id;
    							$itemLocationSI->logid = $logid;
    							$itemLocationSI->save();
    							
    						}
    						#####----MINUS QTY LOCATION ENTRY-----#####
							
							//PURCHASE STOCK ENTRY...
							if(isset($attributes['sales_type']) && $attributes['sales_type']=='ltol') {
								DB::table('item_location')->where('location_id', $attributes['sales_location'])
														  ->where('item_id', $value)->where('unit_id', $attributes['unit_id'][$key])
														  ->update(['quantity' => DB::raw('quantity + '.$attributes['quantity'][$key]) ]);
							}

							//**************** Consignment Location *********************
							if(isset($attributes['conloc_id'][$key]) && $attributes['conloc_id'][$key]!='') {

								if(isset($attributes['conloc_qty'][$key])) {

									$locarr = explode(',',$attributes['conloc_id'][$key]);
									$qtyarr = explode(',',$attributes['conloc_qty'][$key]);

									foreach($locarr as $lk => $loc) {
										
										//QUANTITY DECREASE FROM CON LOCATION....
										$qtys = DB::table('item_location')->where('status',1)->where('location_id', $loc)
																  ->where('item_id', $value)->where('unit_id', $attributes['unit_id'][$key])
																  ->whereNull('deleted_at')->select('id')->first();
										if($qtys) {
											DB::table('item_location')->where('id', $qtys->id)->update(['quantity' => DB::raw('quantity - '.$qtyarr[$lk]) ]);
										} else {
											$itemLocation = new ItemLocation();
											$itemLocation->location_id = $loc;
											$itemLocation->item_id = $value;
											$itemLocation->unit_id = $attributes['unit_id'][$key];
											$itemLocation->quantity = $qtyarr[$lk];
											$itemLocation->status = 1;
											$itemLocation->save();
										}
										
										$itemLocationSI = new ItemLocationSI();
										$itemLocationSI->location_id = $loc;
										$itemLocationSI->item_id = $value;
										$itemLocationSI->unit_id = $attributes['unit_id'][$key];
										$itemLocationSI->quantity = $qtyarr[$lk];
										$itemLocationSI->status = 1;
										$itemLocationSI->invoice_id = $itemObj->id;
										$itemLocationSI->logid = $logid;
										$itemLocationSI->save();
									
									}
								}

							}
							//***********************************************************

						//################ Location Stock Entry End ####################
						
					}
				  }
					
					//Check material service module..........
					if($this->matservice->is_active==1 && isset($attributes['lbitem_id'])) {
						
						$arrResult = $this->addService($attributes);
						$line_total			     += $arrResult['line_total'];
						$tax_total      	     += $arrResult['tax_total'];
						$item_total				 += $arrResult['item_total']; //CHG
						$taxtype				  = $arrResult['type'];//SEP25
						$vat					  = $arrResult['vat'];//SEP25
					}
					
					
					/*CHG*/
					$subtotal = $line_total - $discount; //echo $subtotal; exit;
					if($taxtype=='tax_include' && $attributes['discount'] == 0) {
					  
					  $net_amount = $subtotal;
					  $tax_total = ($subtotal * $vat) / (100 + $vat);
					  $subtotal = $subtotal - $tax_total;
					  
					} elseif($taxtype=='tax_include' && $attributes['discount'] > 0) { 
					
					   $tax_total = ($subtotal * $vat) / (100 + $vat);
					   //$tax_total = ($line_total * $vat) / (100 + $vat);
					   //$net_amount = $subtotal - $tax_total;

					   $subtotal = $subtotal - $tax_total;
					   $net_amount = $line_total - $discount;
					   
					} else 
						$net_amount = $subtotal + $tax_total;
					/*CHG*/
					
					$net_total_pay = 0;
					//VAT calculate from subtotal...
					if(isset($attributes['vatfrm_subtotal'])) {

						$less_amount = (isset($attributes['less_amount']))?$attributes['less_amount']:0;
						$previnv_amount = (isset($attributes['previnv_amount']))?$attributes['previnv_amount']:0;
						$less_amount2 = (isset($attributes['less_amount2']))?$attributes['less_amount2']:0;
						$less_amount3 = (isset($attributes['less_amount3']))?$attributes['less_amount3']:0;
						$line_total = $attributes['total']; //CHNG SEP 17
						$subtotal = $line_total - $less_amount - $less_amount2 - $less_amount3 - $previnv_amount;
						
						$tax_total = $attributes['vat'];
						$net_amount = $net_total_pay = $attributes['net_amount']; //CHNG SEP 17
					}
					
					//MR19
					if( isset($attributes['is_fc']) ) { 
						$total_fc 	   = $line_total / $attributes['currency_rate'];
						$discount_fc   = $attributes['discount'];// * $attributes['currency_rate']; 
						$vat_fc 	   = $attributes['vat_fc'] / $attributes['currency_rate'];
						$tax_fc 	   = round($tax_total / $attributes['currency_rate'],2);
						$net_amount_fc = (float)$total_fc - (float)$discount_fc + (float)$tax_fc;
						$subtotal_fc   = $subtotal / $attributes['currency_rate'];
						$discount      = (float)$attributes['discount'] * (float)$attributes['currency_rate']; 
					} else {
						$total_fc = 0; $discount_fc = 0; $tax_fc = 0; $net_amount_fc = 0; $vat_fc = 0; $subtotal_fc = 0;
						$discount      = (isset($attributes['discount']))?$attributes['discount']:0;
					}
				
					/* if( isset($attributes['is_fc']) ) {
						$total_fc 	   = $line_total / $attributes['currency_rate'];
						$discount_fc   = $attributes['discount'] / $attributes['currency_rate'];
						$vat_fc 	   = $attributes['vat_fc'] / $attributes['currency_rate'];
						$tax_fc 	   = round($tax_total / $attributes['currency_rate'],2);
						$net_amount_fc = $total_fc - $discount_fc + $tax_fc;
						$subtotal_fc	   = $subtotal / $attributes['currency_rate'];
						
					} else 
						$total_fc = $discount_fc = $tax_fc = $net_amount_fc = $vat_fc = $subtotal_fc = 0;  */
					
					$roundoff = (isset($attributes['roundoff']))?(($attributes['roundoff']!='')?$attributes['roundoff']:0):0;
					//update discount, total amount

					//VOUCHER NO INCREMENT LOGIC//
					if( $attributes['curno'] == $attributes['voucher_no'] ) {
						$attributes['rowid'] = $this->sales_invoice->id;
						$newattributes = $this->voucherNoGenerate($attributes);
						$attributes['voucher_no'] = $newattributes['voucher_no'];
						$attributes['vno'] = $newattributes['vno'];
						$attributes['curno'] = $newattributes['curno'];
					} 
					//VOUCHER NO INCREMENT LOGIC//

					DB::table('sales_invoice')
								->where('id', $this->sales_invoice->id)
								->update([
										  'voucher_no'	  => $attributes['voucher_no'],
										  'total'    	  => $line_total,
										  'discount' 	  => $discount, //MR19
										  'vat_amount'	  => $tax_total,
										  'net_total'	  => $net_amount,
										  'total_fc' 	  => $total_fc,
										  'is_rental'     => (isset($attributes['is_rental']))?$attributes['is_rental']:'', 
										  'discount_fc'   => $discount_fc,
										  'vat_amount_fc' => $tax_fc,
										  'net_total_fc'  => $net_amount_fc,
										  'subtotal'	  => $subtotal, //CHG
										  'subtotal_fc'	  => $subtotal_fc,
										  'net_total_pay' => $net_total_pay,
										  'roundoff'	  => $roundoff,
										  'total_roundoff' => $net_amount - $roundoff
										 ]); //CHNG SEP 17
										 if(isset($attributes['footer_id']) && isset($attributes['footermsg']))	{	
										 DB::table('header_footer')
										 ->where('id', $attributes['footer_id'])
										 ->update(['description' => $attributes['footermsg']]);
										 }
					//RECHECK VOUCHER NO AGAIN DUPLICATE OR NOT
					/*if(Session::get('department')==1)
						$invcount = DB::table('sales_invoice')->where('voucher_no',$attributes['voucher_no'])->where('department_id', $attributes['department_id'])->where('status',1)->where('id','!=',$this->sales_invoice->id)->whereNull('deleted_at')->count();
					else
						$invcount = DB::table('sales_invoice')->where('voucher_no',$attributes['voucher_no'])->where('status',1)->whereNull('deleted_at')->where('id','!=',$this->sales_invoice->id)->count();
					
					if($invcount > 1) {
						$newattributes = $this->voucherNoGenerate($attributes);
						$attributes['voucher_no'] = $newattributes['voucher_no'];
						$attributes['vno'] = $newattributes['vno'];
						$attributes['curno'] = $newattributes['curno'];

						DB::table('sales_invoice')
								->where('id', $this->sales_invoice->id)
								->update(['voucher_no'	  => $attributes['voucher_no'] ]);
					}*/
					//RECHECK VOUCHER NO AGAIN DUPLICATE OR NOT

					if(isset($attributes['tempid'])) {
						DB::table('crm_info_si')->where('doc_id',$this->sales_invoice->id)->delete();
						foreach($attributes['tempid'] as $key => $row) {
							DB::table('crm_info_si')->insert(['temp_id' => $row, 'textval' => $attributes['crmtext'][$key],'doc_id' => $this->sales_invoice->id, 'textval2' => (isset($attributes['crmtext2'][$key]))?$attributes['crmtext2'][$key]:'']);
						}
					}
				
					//check whether Cost Accounting method or not.....
					if(Session::get('cost_accounting')==1) {
						$this->CostAccountingMethod($attributes, $subtotal, $tax_total, $net_amount, $this->sales_invoice->id, $taxtype, $cost_value);
					} else {
						$this->PurchaseAndSalesMethod($attributes, $subtotal, $tax_total, $net_amount, $this->sales_invoice->id, $taxtype);//CHG
					}
					
					//other cost action...
					if( isset($attributes['other_cost']) && $attributes['other_cost'] != 0 && $attributes['other_cost'] > 0) {
						foreach($attributes['dr_acnt'] as $key => $value){ 
							$salesInvoiceSE = new SalesInvoiceSellExp();
							$arrSE = $this->setSellExpInputValue($attributes, $salesInvoiceSE, $key);
							$salesInvoiceSE->status = 1;
							$objSE = $this->sales_invoice->doOtherSellExp()->save($salesInvoiceSE);
							if($objSE) {
								//set account Cr/Dr amount transaction....
								if($this->setAccountTransaction($attributes, $arrSE['se_amount'], $this->sales_invoice->id, $type='Cr', 'OC', $key, $objSE)) {
									$this->setAccountTransaction($attributes, $arrSE['se_amount'], $this->sales_invoice->id, $type='Dr', 'OC', $key, $objSE);
								}
							}
						}
					}
					
					//update purchase order transfer status....
					if(isset($attributes['document_id'])) 
						$this->setTransferStatusQuote($attributes);
					
					//VOUCHER NO INCREMENT LOGIC//
					if( ($this->sales_invoice->id) && ($attributes['curno'] == $attributes['voucher_no']) ) { 
						 /*$x=1;
						 do {
								$voucher_no = $attributes['voucher_no'] + $x; $x++;
								if(Session::get('department')==1)
									$inv = DB::table('sales_invoice')->where('voucher_no',$voucher_no)->where('department_id', $attributes['department_id'])->where('status',1)->whereNull('deleted_at')->count();
								else
									$inv = DB::table('sales_invoice')->where('voucher_no',$voucher_no)->where('status',1)->whereNull('deleted_at')->count();
							} while ($inv!=0);
						 */
						 if(Session::get('department')==1) { //if dept active...
							 DB::table('account_setting')
								->where('voucher_type_id', 3) 
								->where('department_id', $attributes['department_id'])
								->update(['voucher_no' => DB::raw('voucher_no + 1')]);
						 } else {
							 DB::table('account_setting')
								->where('voucher_type_id', 3) //->where('id', $attributes['voucher_id'])
								->update(['voucher_no' => DB::raw('voucher_no + 1') ]);//$this->sales_invoice->id  $voucher_no
						 }
					}
					//VOUCHER NO INCREMENT LOGIC//
					
					if($this->sales_invoice->id && isset($attributes['photo_name'])) {
						
						if($attributes['photo_name']!='') {
							foreach($attributes['photo_name'] as $key => $val) {
								if($val!='') {
									DB::table('si_photos')
											->insert(['invoice_id' => $this->sales_invoice->id, 
													  'photo' => $val,
													  'description'	=> $attributes['imgdesc'][$key]
													]);
								}
							}
						}
					}
					
				
				//TRN no update....
				if($attributes['vat_no']!='') {
					 DB::table('account_master')
							->where('id', $attributes['customer_id'])
							->update(['vat_no' => $attributes['vat_no'] ]);
				}

				
				DB::commit();
				return $this->sales_invoice->id;
				
			 } catch(\Exception $e) { 
			
				DB::rollback(); echo $e->getLine().'-'.$e->getMessage().' '.$e->getFile();exit;
				return false;
			}
		}
		
	}

	private function voucherNoGenerate($attributes) {

		$cnt = 0;
		do {
			$jvset = DB::table('account_setting')->where('id', $attributes['voucher_id'])->select('prefix','is_prefix','voucher_no')->first();
			if($jvset) {
				if($jvset->is_prefix==0) {
					$newattributes['voucher_no'] = $jvset->voucher_no + $cnt;
					$newattributes['vno'] = $jvset->voucher_no + $cnt;
				} else {
					$newattributes['voucher_no'] = $jvset->prefix.($jvset->voucher_no + $cnt);
					$newattributes['vno'] = $jvset->voucher_no + $cnt;
				}
				$newattributes['curno'] = $newattributes['voucher_no'];
			}

			if(Session::get('department')==1)
				$inv = DB::table('sales_invoice')->where('id','!=',$attributes['rowid'])->where('voucher_no',$newattributes['voucher_no'])->where('department_id', $attributes['department_id'])->where('status',1)->whereNull('deleted_at')->count();
			else
				$inv = DB::table('sales_invoice')->where('id','!=',$attributes['rowid'])->where('voucher_no',$newattributes['voucher_no'])->where('status',1)->whereNull('deleted_at')->count();
			//echo $inv.' - ';
			$cnt++;
		} while ($inv!=0);

		return $newattributes;
	}
	
	public function update($id, $attributes)
	{ 
	    	//$ids = explode(',', $attributes['document_id']);
	    //echo '<pre>';print_r($ids);exit;
		$this->sales_invoice = $this->find($id);
		$line_total = $tax_total = $cost_value = $line_total_new = $tax_total_new = $item_total = $total = 0;//CHG
		
		DB::beginTransaction();
		try {
			
			//check workshop version active...
			if($this->module->is_active==1 && $this->sales_invoice->id) {
				$this->setJobdetailsUpdate($attributes);
			}
			
			$discount = (isset($attributes['discount']))?(($attributes['discount']!='')?$attributes['discount']:0):0; $taxtype = '';
			$lineTotal = $this->calculateTotalAmount($attributes);//CHG
			if($this->sales_invoice->id && !empty( array_filter($attributes['item_id']))) {
				foreach($attributes['item_id'] as $key => $value) { 
					
					if($attributes['order_item_id'][$key]!='') {
						/*CHG*/
						$deskey = $attributes['order_item_id'][$key];
						$tax_code = (isset($attributes['is_export']))?"ZR":$attributes['tax_code'][$key];//CHG
						
						if( isset($attributes['is_fc']) ) {
							$tax        = ( ($attributes['cost'][$key] * $attributes['line_vat'][$key]) / 100) * $attributes['currency_rate'];
							$itemtotal = ( ($attributes['cost'][$key] * $attributes['quantity'][$key]) - (float)$attributes['line_discount'][$key] ) * $attributes['currency_rate'];
							$taxtotal  = round($tax * $attributes['quantity'][$key], 2);
							$linetotal = ($attributes['cost'][$key] * $attributes['quantity'][$key]) * $attributes['currency_rate'];
							$rate = $attributes['cost'][$key]*$attributes['currency_rate']; //29MY
							
						} else {
							
							$linetotal = round($attributes['cost'][$key] * $attributes['quantity'][$key],2);
							
							if(isset($attributes['is_export']) || $tax_code=="EX" || $tax_code=="ZR") {
								
								$tax        = 0;
								$itemtotal = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - (float)$attributes['line_discount'][$key];
								$taxtotal  = round($tax * $attributes['quantity'][$key], 2);
								$rate = $attributes['cost'][$key];//29MY
								
							} else if($attributes['tax_include'][$key]==1){
								
								$ln_total   = round($attributes['cost'][$key] * $attributes['quantity'][$key],2);
								$taxtotal  = $ln_total *  $attributes['line_vat'][$key] / (100 +  $attributes['line_vat'][$key]);
								$itemtotal = $ln_total - $taxtotal;
								$rate = $attributes['cost'][$key] - (float)$attributes['line_discount'][$key];
								
								//31MY
								if((float)$attributes['line_discount'][$key] > 0) {
									$rate = $attributes['cost'][$key] - (float)$attributes['line_discount'][$key];
								} else {
									$vatPlus = 100 + $attributes['line_vat'][$key];
									$vatLine = round( (($attributes['cost'][$key] * $attributes['line_vat'][$key]) / $vatPlus),2 );
									$rate = $attributes['cost'][$key] - $vatLine;
								}
								$row_total = ($rate * $attributes['quantity'][$key]);//31MY
								
							} else {
								
								$tax        = ($attributes['cost'][$key] * $attributes['line_vat'][$key]) / 100;
								$itemtotal = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - (float)$attributes['line_discount'][$key];
								$taxtotal  = round($tax * $attributes['quantity'][$key], 2);
								
								$rate = $attributes['cost'][$key] - (float)$attributes['line_discount'][$key];//31MY
								$row_total = ($rate * $attributes['quantity'][$key]);//31MY
							}
						}
						
						//********DISCOUNT Calculation.............
						$discount = (isset($attributes['discount']))?(($attributes['discount']!='')?$attributes['discount']:0):0;
						$taxtype = 'tax_exclude';
							
						if($attributes['tax_include'][$key]==1 ) {
							$vatPlus = 100 + $attributes['line_vat'][$key];
							$total = $attributes['cost'][$key] * $attributes['quantity'][$key];
							$taxtype = 'tax_include';
						} else {
							$vatPlus = 100;
							$total = $attributes['line_total'][$key];
							$taxtype = 'tax_exclude';
						}
						
						if($discount > 0) {
							$discountAmt = round( (($total / $lineTotal) * $discount),2 );
							$amountTotal = $total - $discountAmt;
							$vatLine = round( (($amountTotal * $attributes['line_vat'][$key]) / $vatPlus),2 );
							$taxtotal = $vatLine; 
							
							$vat_exc = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - (float)$attributes['line_discount'][$key];//31MY
						} else { //31MY
							if($attributes['tax_include'][$key]==1 ) {
								$vatLine = round( (($total * $attributes['line_vat'][$key]) / $vatPlus),2 );
								$vat_exc = $total - $vatLine;
							} else {
								$vat_exc = ($attributes['cost'][$key] * $attributes['quantity'][$key]) - (float)$attributes['line_discount'][$key];
							}
						}
						
						$tax_total += $taxtotal;
						$line_total += $linetotal;
						$item_total += $itemtotal;
						
						$vat = $attributes['line_vat'][$key];
						
						$row_total = $vat_exc + $tax_total;//31MY
						
						$salesInvoiceItem = SalesInvoiceItem::find($attributes['order_item_id'][$key]); 
						$oldqty = $salesInvoiceItem->quantity;
						$item_cost = $salesInvoiceItem->item_cost;
						$items['item_name'] = $attributes['item_name'][$key];
						$items['item_id'] = $value;
						$items['unit_id'] = $attributes['unit_id'][$key];
						$items['quantity'] = $attributes['quantity'][$key];
						$items['unit_price'] = (isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key];
						$items['vat']		 = $attributes['line_vat'][$key];
						$items['vat_amount'] = $taxtotal;
						$items['discount'] = $attributes['line_discount'][$key];
						$items['line_total'] = $linetotal;
						$items['item_total'] = $itemtotal; 
						$items['tax_code'] 	= $tax_code; 
						$items['tax_include'] = $attributes['tax_include'][$key];
						
						//31MY
						$items['rate'] 	= $rate; 
						$items['row_total'] 	= $row_total; 
						$items['vat_exc'] 	= $vat_exc; 
						$items['vat_exc_fc'] 	= (isset($attributes['is_fc']))?round(($vat_exc /  $attributes['currency_rate']),2):$vat_exc;
						$items['rate_fc'] 	= (isset($attributes['is_fc']))?round(($rate /  $attributes['currency_rate']),2):$rate;
						$items['row_total_fc'] 	= (isset($attributes['is_fc']))?round(($row_total /  $attributes['currency_rate']),2):$row_total;

						$items['width'] = isset($attributes['item_wit'][$key])?$attributes['item_wit'][$key]:0;
						$items['length'] = isset($attributes['item_lnt'][$key])?$attributes['item_lnt'][$key]:0;
						$items['mp_qty'] = isset($attributes['mpquantity'][$key])?$attributes['mpquantity'][$key]:0;

						$exi_quantity = $salesInvoiceItem->quantity;
						
						//MAR19
						$items['unit_price_fc'] = $attributes['cost'][$key];
						$items['vat_amount_fc'] = (isset($attributes['is_fc']))?round(($taxtotal / $attributes['currency_rate']),2):$taxtotal;
						$items['total_price_fc'] = (isset($attributes['is_fc']))?round(($linetotal / $attributes['currency_rate']),2):$linetotal;
						$items['item_total_fc'] = (isset($attributes['is_fc']))?round(($itemtotal / $attributes['currency_rate']),2):$itemtotal;
						$items['rate_fc'] 	= (isset($attributes['is_fc']))?round(($rate /  $attributes['currency_rate']),2):$rate;//29MY
						
						$exi_item_id = $salesInvoiceItem->item_id;
						$exi_unit_id = $salesInvoiceItem->unit_id;
						$itemsobj = (object)['item_id' => $exi_item_id, 'unit_id' => $exi_unit_id];
						
						
						$pay_pcntg = 100; $pay_amount = $line_total; $pay_pcntg_desc = '';
						if(isset($attributes['per'][$key]) && $attributes['per'][$key]!='' && $attributes['per'][$key] > 0) {
							$pay_pcntg = $attributes['per'][$key];
							$pay_amount = ($linetotal * $pay_pcntg) / 100;
							$pay_pcntg_desc = $attributes['perdesc'][$key];
						}
						$items['pay_pcntg'] = $pay_pcntg;
						$items['pay_amount'] = $pay_amount;
						$items['pay_pcntg_desc'] = $pay_pcntg_desc;
						
						
						//ASSEMBLY ITEMS............  //JAN25
						$is_update_flg = false;
						if(isset($attributes['assembly_items'][$key]) && $attributes['assembly_items'][$key]!='') {
							
							$items['assembly_items'] 	= $attributes['assembly_items'][$key]; 
							$items['assembly_items_qty'] 	= $attributes['assembly_items_qty'][$key];
							if($attributes['assembly_items'][$key]!=$attributes['assembly_items_old'][$key]) {
								//SET ALL ITEMS ARE DELETED...
								$oldidarr = explode(',',$attributes['assembly_items_old'][$key]);
								DB::table('item_log')->where('document_type','SI')->whereIn('item_id',$oldidarr)
													 ->where('document_id',$this->sales_invoice->id)
													 ->update(['status' => 0, 'deleted_at' => now()]);
								
								$this->setSalesLogAssemblyItem($attributes['assembly_items'][$key], $attributes['assembly_items_qty'][$key], $attributes,'add');
							}
							
							if($attributes['assembly_items_qty'][$key]!=$attributes['assembly_items_qty_old'][$key]) {
							    $this->setSalesLogAssemblyItem($attributes['assembly_items'][$key], $attributes['assembly_items_qty'][$key], $attributes,'update');
							}
							$is_update_flg = true;
						}
						
						
						if(isset($attributes['assembly_items_old'][$key]) && $attributes['assembly_items_old'][$key]!='' && $is_update_flg==false) {
							
							$items['assembly_items'] 	= $attributes['assembly_items'][$key]; 
							$items['assembly_items_qty'] 	= $attributes['assembly_items_qty'][$key];
							if($attributes['assembly_items'][$key]!=$attributes['assembly_items_old'][$key]) {
								//SET ALL ITEMS ARE DELETED...
								$oldidarr = explode(',',$attributes['assembly_items_old'][$key]);
								DB::table('item_log')->where('document_type','SI')->whereIn('item_id',$oldidarr)
													 ->where('document_id',$this->sales_invoice->id)
													 ->update(['status' => 0, 'deleted_at' => now()]);
								
								$this->setSalesLogAssemblyItem($attributes['assembly_items'][$key], $attributes['assembly_items_qty'][$key], $attributes,'add');
							}
							
							if($attributes['assembly_items_qty'][$key]!=$attributes['assembly_items_qty_old'][$key]) {
							    $this->setSalesLogAssemblyItem($attributes['assembly_items'][$key], $attributes['assembly_items_qty'][$key], $attributes,'update');
							}
							
						}
						
						
						
						
						//if(Session::get('cost_accounting')==1) {
							if($oldqty!=$attributes['quantity'][$key]) {
								$item = DB::table('item_unit')->where('itemmaster_id', $attributes['item_id'][$key])
															  ->where('unit_id', $attributes['unit_id'][$key])
															  ->first();
								$cost_avg = ($item->cost_avg==0)?$item->last_purchase_cost:$item->cost_avg;
								$item_cost = $cost_avg * $attributes['quantity'][$key] * $attributes['packing'][$key];
							}
						//}
						
						$items['item_cost'] = $item_cost;
						
						$salesInvoiceItem->update($items);
						
						//update item transfer status... MY22
						$this->setTransferStatusItem($attributes, $key, $attributes['document_type'],'edit');
						
						//$cost_value += $item_cost; APR1
						
						
						//################ Location Stock Entry ####################
						//Item Location specific add....
						//NOV24
						$updated = false;
						if(isset($attributes['locqty'][$key])) {
							foreach($attributes['locqty'][$key] as $lk => $lq) {
								if($lq!='') {
									$updated = true;
									//$lcqty = $lq * $attributes['packing'][$key]; //MAY25
									
									$lcqty = $lq;
                            		if($attributes['packing'][$key]=="1") 
                            		    $lcqty = $lq;
                            		else {
                            		   $pkgar = explode('-', $attributes['packing'][$key]);
                            		   if($pkgar[0] > 0)
                            		        $lcqty = ($lq *  $pkgar[1]) / $pkgar[0];
                            		}
									
									$edit = DB::table('item_location_si')->where('id', $attributes['editid'][$key][$lk])->where('is_do',0)->first();
									$idloc = DB::table('item_location')->where('status',1)->where('location_id', $attributes['locid'][$key][$lk])
																  ->where('item_id', $value)//->where('unit_id', $attributes['unit_id'][$key])
																  ->whereNull('deleted_at')->select('id')->first();
																  //echo '<pre>';print_r($edit);exit;
									if($edit && $attributes['document_type']!='CDO') { 
										
										if($edit->quantity < $lcqty) {
											$balqty = $lcqty - $edit->quantity;
											DB::table('item_location')->where('id', $idloc->id)->update(['quantity' => DB::raw('quantity - '.$balqty)]);
										} else {
											$balqty = $edit->quantity - $lcqty;
											DB::table('item_location')->where('id', $idloc->id)->update(['quantity' => DB::raw('quantity + '.$balqty)]);
										}
										
									} else {
										//NOV24
										if($attributes['document_type']!='CDO')
											DB::table('item_location')->where('id', $idloc->id)->update(['quantity' => DB::raw('quantity + '.$lcqty) ]);

										$dolog = DB::table('item_location_si')->where('item_id',$value)->where('unit_id',$attributes['unit_id'][$key])->where('invoice_id', $attributes['order_item_id'][$key])->where('is_do',0)->first();
//print_r($dolog);exit;
										$itemLocationSI = new ItemLocationSI();
										$itemLocationSI->location_id = $attributes['locid'][$key][$lk];
										$itemLocationSI->item_id = $value;
										$itemLocationSI->unit_id = $attributes['unit_id'][$key];
										$itemLocationSI->quantity = $lcqty;
										$itemLocationSI->status = 1;
										$itemLocationSI->invoice_id = $attributes['order_item_id'][$key];
										$itemLocationSI->logid = ($dolog)?$dolog->logid:0;
										$itemLocationSI->qty_entry = $lq;
										$itemLocationSI->save();
									}
									
									DB::table('item_location_si')->where('id', $attributes['editid'][$key][$lk])->update(['quantity' => $lcqty,'status' => 1, 'deleted_at' => '0000-00-00 00:00:00', 'qty_entry' => $lq]);

								} else { //NOV24
									DB::table('item_location_si')->where('id', $attributes['editid'][$key][$lk])->update(['quantity' => $lcqty,'status' => 0, 'deleted_at' => now(), 'qty_entry' => $lq]);
								}
							}
						}
						
						//Item default location add...
						if(isset($attributes['default_location']) && ($attributes['default_location'] > 0) && ($updated == false)) {
								
							$qtys = DB::table('item_location')->where('status',1)->where('location_id', $attributes['default_location'])
																->where('item_id', $value)//->where('unit_id', $attributes['unit_id'][$key])
																->whereNull('deleted_at')->select('*')->first();
																
							//$lcqty = $attributes['quantity'][$key] * $attributes['packing'][$key]; //MAY25
							$lcqty = $attributes['quantity'][$key];
                    		if($attributes['packing'][$key]=="1") 
                    		    $lcqty = $attributes['quantity'][$key];
                    		else {
                    		   $pkgar = explode('-', $attributes['packing'][$key]);
                    		   if($pkgar[0] > 0)
                    		        $lcqty = ($attributes['quantity'][$key] *  $pkgar[1]) / $pkgar[0];
                    		}
							
							if($qtys) {
								DB::table('item_location')->where('id', $qtys->id)->update(['quantity' => DB::raw('quantity - '.$attributes['quantity'][$key]) ]);
								DB::table('item_location_si')->where('invoice_id', $attributes['order_item_id'][$key] )
																->where('location_id', $qtys->location_id)
																->where('item_id', $qtys->item_id)
																//->where('unit_id', $qtys->unit_id)
																->update(['quantity' => DB::raw('quantity - '.$lcqty), 'qty_entry' => DB::raw('quantity - '.$attributes['quantity'][$key]) ]);
							} 
							
							$itemLocationSI = new ItemLocationSI();
							$itemLocationSI->location_id = $attributes['default_location'];
							$itemLocationSI->item_id = $value;
							$itemLocationSI->unit_id = $attributes['unit_id'][$key];
							$itemLocationSI->quantity = $lcqty;
							$itemLocationSI->status = 1;
							$itemLocationSI->invoice_id = $attributes['order_item_id'][$key];
							$itemLocationSI->qty_entry = $attributes['quantity'][$key];
							$itemLocationSI->save();
						}
                        
                        	

						//####....MINUS QTY LOC....####
						if(isset($attributes['mq_loc']) && ($attributes['mq_loc'] > 0) && ($attributes['curqty'][$key] < $attributes['quantity'][$key]) ) {
							$mnsqty = $attributes['quantity'][$key]-$attributes['curqty'][$key];
							$mnsloc = DB::table('location')->where('status',1)->whereNull('deleted_at')->where('is_minus_qty',1)->select('id')->first();
							if(!$mnsloc) {
								$mlocid = DB::table('location')->insertGetId(['code'=>'-QTY','name'=>'Mins Qty','is_default'=>0,'status'=>1,
														'deleted_at'=>'0000-00-00 00:00:00','is_conloc'=>0,'customer_id'=>0,'is_minus_qty'=>1]);
							} else
								$mlocid = $mnsloc->id;

								if($attributes['quantity_old'][$key] < $attributes['quantity'][$key]) {
									$dif = $attributes['quantity_old'][$key] - $attributes['quantity'][$key];
								} else {
									$dif = $attributes['quantity'][$key] - $attributes['quantity_old'][$key];
								}
								DB::table('item_location_si')->where('invoice_id', $attributes['order_item_id'][$key] )
																->where('location_id', $mlocid)
																->where('item_id', $value)
																->where('unit_id', $attributes['unit_id'][$key])
																->update(['quantity' => DB::raw('quantity - '.$dif) ]);
							 
							
							
						}
						//####....MINUS QTY LOC....####
							

							//**************** Consignment Location *********************
							if(isset($attributes['conloc_id'][$key]) && $attributes['conloc_id'][$key]!='') {
								
								$items['conloc_id'] 	= $attributes['conloc_id'][$key]; 
								$items['conloc_qty'] 	= $attributes['conloc_qty'][$key];
								if($attributes['conloc_id'][$key]!=$attributes['conloc_id_old'][$key]) {
									//SET ALL ITEMS ARE DELETED...
									$oldidarr = explode(',',$attributes['conloc_id_old'][$key]);
									$curidarr = explode(',',$attributes['conloc_id'][$key]);
									$curqty = explode(',',$attributes['conloc_qty'][$key]);
									
									DB::table('con_location')->where('is_do',0)->where('invoice_id', $attributes['order_item_id'][$key])
														 ->whereIn('location_id', $oldidarr)
														 ->update(['status' => 0, 'deleted_at' => now()]);
														 
									foreach($curidarr as $ky => $rw) {					 
										DB::table('con_location')->where('is_do',0)->where('invoice_id', $attributes['order_item_id'][$key])
														 ->where('location_id', $rw)
														 ->update(['quantity' => $curqty[$ky],'status' => 1, 'deleted_at' => '0000-00-00 00:00:00']);
									
									}
								}
								
							}
							//***********************************************************

						//################ Location Stock Entry End ####################
						
						//stock update section............................
						//if($attributes['document_type']!='CDO' && ($exi_quantity!=$attributes['quantity'][$key])) {
						
						//DEC 23 UPDATE...
						//if( ($exi_quantity!=$attributes['quantity'][$key]) || ($value!=$itemsobj->item_id) || ($itemsobj->unit_id!=$attributes['unit_id'][$key]) ) {
							$bquantity = $attributes['quantity'][$key] - $exi_quantity;
							
							//APR25
							if($this->mod_do_qty->is_active==1) {
							    
							  $sale_cost = $this->objUtility->updateItemQuantitySales($attributes, $key, $bquantity);//exit;
							  $DOlogs = $this->checkCDOLogsOnUpdate($attributes, $key);//echo '<pre>';print_r($DOlogs);exit;
							  if(!$DOlogs) { //CHECK CDO LOG INSERTED IN LOG TABLE OR NOT...
    							  $CostAvg_log = $this->objUtility->updateLastPurchaseCostAndCostAvgonEdit($attributes, $key, 0);
    							  $logid = $this->setSaleLog($attributes, $key, $this->sales_invoice->id, $CostAvg_log, $sale_cost, 'update', $itemsobj); 
    							  $cost_value += ($sale_cost* $attributes['quantity'][$key]);//$sale_cost;
							  } else {
							      $CostAvg_log = $this->updateLastPurchaseCostOnTransferUpdate($attributes, $key, 0, $DOlogs);
							      $logid = $this->setSaleLog($attributes, $key, $this->sales_invoice->id, $CostAvg_log, $sale_cost, 'update', $itemsobj); 
							      $cost_value += ($sale_cost* $attributes['quantity'][$key]);//$sale_cost;
							  }
							  
							} else {
							  $sale_cost = $this->objUtility->updateItemQuantitySales($attributes, $key, $bquantity);//exit;
							  $CostAvg_log = $this->objUtility->updateLastPurchaseCostAndCostAvgonEdit($attributes, $key, 0);
							  $logid = $this->setSaleLog($attributes, $key, $this->sales_invoice->id, $CostAvg_log, $sale_cost, 'update', $itemsobj); 
							  $cost_value += ($sale_cost* $attributes['quantity'][$key]);//$sale_cost;
							}
						//} 
						/* else if() { 
							$bquantity = $attributes['quantity'][$key] - $exi_quantity;
							
							  $sale_cost = $this->objUtility->updateItemQuantitySales($attributes, $key, $bquantity);
									$CostAvg_log = $this->objUtility->updateLastPurchaseCostAndCostAvgonEdit($attributes, $key, 0);
										$this->setSaleLog($attributes, $key, $this->sales_invoice->id, $CostAvg_log, $sale_cost, 'update', $itemsobj);
						} */
					    
					    
					    //BATCH NO ENTRY............
            				if(isset($attributes['batchNos'][$key]) && $attributes['batchNos'][$key]!='' && $attributes['qtyBatchs'][$key]!='') {
            				    
            				    $batchArr = explode(',', $attributes['batchNos'][$key]);
            				    $qtyArr = explode(',', $attributes['qtyBatchs'][$key]);
            				    $bthidsArr = explode(',', $attributes['batchIds'][$key]);
			                    $remArr = explode(',', $attributes['batchRem'][$key]);
            				    
            				    foreach($bthidsArr as $bkey => $bval) {
            				        
            				        $batch_log = DB::table('batch_log')
                				                        ->where('batch_id', $bval)
                        				                ->where('document_type','SI')
                        				                ->where('document_id', $this->sales_invoice->id)
                        				                ->where('doc_row_id', $attributes['order_item_id'][$key])
                        				                ->whereNull('deleted_at')
                        				                ->select('id','quantity')->first();
                        				                
            				        if($batch_log) { //UPDATE...
            				            
            				            DB::table('batch_log')
                    				                ->where('id', $batch_log->id)
                    				                ->update([
                    				                    'quantity' => $qtyArr[$bkey],
                    				                    'invoice_date' => ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
                    				                    'modify_at' => now(),
        				                                'modify_by' => Auth::User()->id
                    				                    ]);
                    				                    
                    				    if($batch_log->quantity!=$qtyArr[$bkey]) {
                        				    $brow = DB::table('item_batch')->where('id',$bval)->whereNull('deleted_at')->select('quantity')->first();
                        				    //$bquantity 	 = $qtyArr[$bkey] - $brow->quantity;//($brow->quantity > $qtyArr[$bkey])?($brow->quantity - $qtyArr[$bkey]):($qtyArr[$bkey] - $brow->quantity);
                        				    
                        				    if(($batch_log->quantity > $qtyArr[$bkey])) {
                        				        $bquantity 	 = $batch_log->quantity - $qtyArr[$bkey];
                        				        DB::table('item_batch')
                                			                    ->where('id',$bval)
                                				                ->update([
                                				                    'quantity' => DB::raw('quantity + '.$bquantity)
                                				                ]);
                        				    } else if(($batch_log->quantity < $qtyArr[$bkey])) {
                        				        $bquantity 	 = $qtyArr[$bkey] - $batch_log->quantity;
                        				        DB::table('item_batch')
                                			                    ->where('id',$bval)
                                				                ->update([
                                				                    'quantity' => DB::raw('quantity - '.$bquantity)
                                				                ]);
                        				        
                        				    }
                        				    
                    				    }
            				        } else {
    
                        			    DB::table('batch_log')
                    				                ->insert([
                    				                    'batch_id' => $bval,
                    				                    'item_id' => $value,
                    				                    'document_type' => 'SI',
                    				                    'document_id' => $this->sales_invoice->id,
                    				                    'doc_row_id' => $attributes['order_item_id'][$key],
                    				                    'quantity' => $qtyArr[$bkey],
                    				                    'trtype' => 0,
                    				                    'invoice_date' => ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
                    				                    'log_id' => $logid,
                    				                    'created_at' => now(),
                    				                    'created_by' => Auth::User()->id
                    				                    ]);
        
                            			DB::table('item_batch')
                            			                    ->where('id',$bval)
                            				                ->update([
                            				                    'quantity' => DB::raw('quantity - '.$qtyArr[$bkey])
                            				                ]);	  
                        				                
            				        }
                        				                
            				    }
            				    
            				    //DELETE...
                			    foreach($remArr as $rem) {
                			        
                			        $batch_log = DB::table('batch_log')
                				                        ->where('batch_id', $rem)->where('document_type','SI')->where('document_id', $this->sales_invoice->id)
                        				                ->where('doc_row_id', $attributes['order_item_id'][$key])->whereNull('deleted_at')
                        				                ->select('id','quantity')->first();
                			        if($batch_log) {
                    			        DB::table('batch_log')->where('id',$batch_log->id)->update(['deleted_at' => now(), 'deleted_by' => Auth::User()->id]);
                    			                                        
                    			        DB::table('item_batch')->where('id',$rem)->update(['quantity' => DB::raw('quantity + '.$batch_log->quantity) ]);
                			        }
                			    }
            				
            				}
            				//.....END BATCH ENTRY
            				
						//description update...
						if(isset($attributes['desc_id'])) {
							if(array_key_exists($deskey, $attributes['desc_id'])) {
								foreach($attributes['desc_id'][$deskey] as $k => $v) {
									if($v!='') {
										$itemDescription = ItemDescription::find($v);
										$desc['description'] = $attributes['itemdesc'][$deskey][$k];
										$itemDescription->update($desc);
									} else {
										//new entry.........
										$itemDescription = new ItemDescription();
										$itemDescription->invoice_type = 'SI';
										$itemDescription->item_detail_id = $deskey;
										$itemDescription->description = $attributes['itemdesc'][$deskey][$k];
										$itemDescription->status = 1;
										$itemDescription->save();
										
									}
								}
							}
							
						} else {
								
								//new entry description.........
								if(isset($attributes['itemdesc']) && isset($attributes['itemdesc'][$key])) {
									foreach($attributes['itemdesc'][$key] as $descrow) {
										if($descrow != '') {
											$itemDescription = new ItemDescription();
											$itemDescription->invoice_type = 'SI';
											$itemDescription->item_detail_id = $deskey;
											$itemDescription->description = $descrow;
											$itemDescription->status = 1;
											$itemDescription->save();
										}
									}
								}
						}
						
						//manage removed item description...
						if(isset($attributes['remove_itemdesc']) && isset($attributes['remove_itemdesc'][$key]) && $attributes['remove_itemdesc'][$key]!='')
						{
							$arrids = explode(',', $attributes['remove_itemdesc'][$key]);
							foreach($arrids as $row) {
								DB::table('item_description')->where('id', $row)->update(['status' => 0,'deleted_at' => now()]);
							}
						}
							
					} else { 
					
						//new entry... CHG
						$item_total_new = $tax_total_new = 0; $total = 0;
						if($discount > 0) 
							$total = $this->calculateTotalAmount($attributes);
					
						$vat = $attributes['line_vat'][$key];/*CHG*/
						$salesInvoiceItem = new SalesInvoiceItem();
						$arrResult 		= $this->setItemInputValue($attributes, $salesInvoiceItem, $key, $value, $total);
						//if($arrResult['line_total']) {
							$line_total_new 		 += $arrResult['line_total'];
							$tax_total_new      	 += $arrResult['tax_total'];
							$item_total_new			 += $arrResult['item_total']; //CHG
							//$cost_value 			 += $arrResult['cost_value'];
							
							$line_total			     += $arrResult['line_total'];
							$tax_total      	     += $arrResult['tax_total'];
							$item_total 			 += $arrResult['item_total'];
							$taxtype				  = $arrResult['type'];
							
							$salesInvoiceItem->status = 1;
							$itemObj = $this->sales_invoice->salesInvoiceItemAdd()->save($salesInvoiceItem);
							
							$this->setTransferStatusItem($attributes, $key, $attributes['document_type'],'add');
							
							//new entry description.........
							if(isset($attributes['itemdesc'][$key])) {
								foreach($attributes['itemdesc'][$key] as $descrow) {
									if($descrow != '') {
										$itemDescription = new ItemDescription();
										$itemDescription->invoice_type = 'SI';
										$itemDescription->item_detail_id = $itemObj->id;
										$itemDescription->description = $descrow;
										$itemDescription->status = 1;
										$itemDescription->save();
									}
								}
							}
								
							///new section........................
							//stock update section............................
							$attributes['item_row_id'][$key] = $itemObj->id; //OCT24
							//if($attributes['document_type']!='CDO') {
								$sale_cost = $this->objUtility->updateItemQuantitySales($attributes, $key);//exit;
									$CostAvg_log = $this->objUtility->updateLastPurchaseCostAndCostAvg($attributes, $key, 0);
										$logid = $this->setSaleLog($attributes, $key, $this->sales_invoice->id, $CostAvg_log, $sale_cost, 'add' );
								$cost_value += ($sale_cost* $attributes['quantity'][$key]);//$sale_cost;
								
							//}
							
							////////new section end....................
					//	}
						
						//################ Location Stock Entry ####################
						//Item Location specific add....
						$updated = $locdata = false; $loctext = $qtytext = $bintext = '';
						if(isset($attributes['locqty'][$key])) {
							foreach($attributes['locqty'][$key] as $lk => $lq) {
								if($lq!='') {
									$updated = true;
									//$lcqty = $lq * $attributes['packing'][$key];
									$lcqty = $lq;
                            		if($attributes['packing'][$key]=="1") 
                            		    $lcqty = $lq;
                            		else {
                            		   $pkgar = explode('-', $attributes['packing'][$key]);
                            		   if($pkgar[0] > 0)
                            		        $lcqty = ($lq *  $pkgar[1]) / $pkgar[0];
                            		}
                            		
									$qtys = DB::table('item_location')->where('status',1)->where('location_id', $attributes['locid'][$key][$lk])
																  ->where('item_id', $value)//->where('unit_id', $attributes['unit_id'][$key])
																  ->whereNull('deleted_at')->select('id')->first();
									if($qtys) {
										DB::table('item_location')->where('id', $qtys->id)->update(['quantity' => DB::raw('quantity - '.$lcqty) ]);
										
    									$locdata = true;
									
									} else {
										$itemLocation = new ItemLocation();
										$itemLocation->location_id = $attributes['locid'][$key][$lk];
										$itemLocation->item_id = $value;
										$itemLocation->unit_id = $attributes['unit_id'][$key];
										$itemLocation->quantity = $lcqty;
										$itemLocation->status = 1;
										$itemLocation->save();
									}
									
									
									$itemLocationSI = new ItemLocationSI();
									$itemLocationSI->location_id = $attributes['locid'][$key][$lk];
									$itemLocationSI->item_id = $value;
									$itemLocationSI->unit_id = $attributes['unit_id'][$key];
									$itemLocationSI->quantity = $lcqty;
									$itemLocationSI->status = 1;
									$itemLocationSI->invoice_id = $itemObj->id;
									$itemLocationSI->logid = $logid;
									$itemLocationSI->qty_entry = $lq;
									$itemLocationSI->save();
								}
							}
						}
						
						//Item user's default location add...
						if(isset($attributes['default_location']) && ($attributes['default_location'] > 0) && ($updated == false)) {
								
								$qtys = DB::table('item_location')->where('status',1)->where('location_id', $attributes['default_location'])
																  ->where('item_id', $value)//->where('unit_id', $attributes['unit_id'][$key])
																  ->whereNull('deleted_at')->select('id')->first();
																  
								//$lcqty = $attributes['quantity'][$key] * $attributes['packing'][$key];
								$lcqty = $attributes['quantity'][$key];
                        		if($attributes['packing'][$key]=="1") 
                        		    $lcqty = $attributes['quantity'][$key];
                        		else {
                        		   $pkgar = explode('-', $attributes['packing'][$key]);
                        		   if($pkgar[0] > 0)
                        		        $lcqty = ($attributes['quantity'][$key] *  $pkgar[1]) / $pkgar[0];
                        		}
                        		
								if($qtys) {
									DB::table('item_location')->where('id', $qtys->id)->update(['quantity' => DB::raw('quantity - '.$lcqty) ]);
								} else {
										$itemLocation = new ItemLocation();
										$itemLocation->location_id = $attributes['default_location'];
										$itemLocation->item_id = $value;
										$itemLocation->unit_id = $attributes['unit_id'][$key];
										$itemLocation->quantity = $lcqty;
										$itemLocation->status = 1;
										$itemLocation->save();
									}
									
								$itemLocationSI = new ItemLocationSI();
								$itemLocationSI->location_id = $attributes['default_location'];
								$itemLocationSI->item_id = $value;
								$itemLocationSI->unit_id = $attributes['unit_id'][$key];
								$itemLocationSI->quantity = $lcqty;
								$itemLocationSI->status = 1;
								$itemLocationSI->invoice_id = $itemObj->id;
								$itemLocationSI->logid = $logid;
								$itemLocationSI->qty_entry = $attributes['quantity'][$key];
								$itemLocationSI->save();
								
							}

							//**************** Consignment Location *********************
							if(isset($attributes['conloc_id'][$key]) && $attributes['conloc_id'][$key]!='') {

								if(isset($attributes['conloc_qty'][$key])) {

									$locarr = explode(',',$attributes['conloc_id'][$key]);
									$qtyarr = explode(',',$attributes['conloc_qty'][$key]);

									foreach($locarr as $lk => $lq) {
										$conLocation = new ConLocation();
										$conLocation->location_id = $lq;
										$conLocation->item_id = $value;
										$conLocation->unit_id = $attributes['unit_id'][$key];
										$conLocation->quantity = $qtyarr[$lk];
										$conLocation->status = 1;
										$conLocation->invoice_id = $itemObj->id;
										$conLocation->is_do = 0;
										$conLocation->logid = $logid;
										$conLocation->save();
									}
								}

							}
							//***********************************************************
							
						//################ Location Stock Entry End ####################
					}
					
				}
			}
			
			//check workshop version active...
			if($this->matservice->is_active==1 && $this->sales_invoice->id) {
				$arrResult = $this->updateService($attributes);
				
				$line_total	+= $arrResult['line_total'];
				$tax_total  += $arrResult['tax_total'];
				$item_total += $arrResult['item_total'];
				$taxtype				  = $arrResult['type'];//SEP25
				$vat					  = $arrResult['vat'];//SEP25
				
				//manage removed service...
				if($attributes['lbremove_item']!='')
				{
					$arrids = explode(',', $attributes['lbremove_item']);
					$remline_total = $remtax_total = 0;
					foreach($arrids as $row) {
						DB::table('sales_invoice_item')->where('id', $row)->update(['status' => 0,'deleted_at' => now()]);
					}
				}
			}
			
			//update purchase order transfer status....
			if(isset($attributes['document_id'])) 
				$this->setTransferStatusQuote($attributes);
					
					
			//exit;
			//manage removed items...
			if($attributes['remove_item']!='')
			{
				$arrids = explode(',', $attributes['remove_item']);
				$remline_total = $remtax_total = 0;
				//echo '<pre>';print_r($arrids);exit;
				foreach($arrids as $row) {
					//delete item
					DB::table('sales_invoice_item')->where('id', $row)->update(['status' => 0,'deleted_at' => now()]);
					
					$res = DB::table('sales_invoice_item')->where('id',$row)->first();
					
					$this->objUtility->updateLastPurchaseCostAndCostAvgonDelete($res, $attributes['sales_invoice_id']);
					
					//update item unit quantity..
					DB::table('item_unit')->where('itemmaster_id', $res->item_id)->where('unit_id',$res->unit_id)
										  ->update(['cur_quantity' => DB::raw('cur_quantity - '.($res->quantity*-1)),
											        'issued_qty' => DB::raw('cur_quantity - '.($res->quantity*-1) )]);
					
					$sirow = DB::table('item_location_si')->where('invoice_id',$row)->where('is_do',0)->get();
					//echo '<pre>';print_r($sirow);exit;
					DB::table('con_location')->where('invoice_id',$row)->where('is_do',0)->update(['status'=>0,'deleted_at'=>now()]);
					foreach($sirow as $srow) {
						DB::table('item_location_si')->where('id',$srow->id)->update(['status'=>0,'deleted_at'=>now()]);
						
						DB::table('item_location')->where('location_id', $srow->location_id)->where('item_id',$srow->item_id)->where('unit_id',$srow->unit_id)
									->update(['quantity' => DB::raw('quantity + '.$srow->quantity) ]);
									
						//REMOVE FROM CONSIGNMENT LOCATION
						DB::table('con_location')->where('invoice_id',$row)->where('is_do',0)->update(['status' => 0, 'deleted_at' => now()]);
					}
					
					//MAY25 BATCH REMOVE..
        			$batch_log = DB::table('batch_log')
        		                        ->where('document_type','SI')
        		                        ->where('document_id', $id)
        		                        ->where('doc_row_id', $row)
        				                ->whereNull('deleted_at')
        				                ->select('id','quantity','item_id','batch_id','doc_row_id')->get();
        				                
        			foreach($batch_log as $blog) {	                
        				DB::table('batch_log')->where('id', $blog->id)->update(['deleted_at' => now(), 'deleted_by' => Auth::User()->id]);
        				
        				DB::table('item_batch')->where('id', $blog->batch_id)->update(['quantity' => DB::raw('quantity + '.$blog->quantity) ]);
        				
        			}
					
					/* if(isset($attributes['location_id'])) {
						DB::table('item_location')->where('item_id', $res->item_id)
									->where('location_id', $attributes['location_id'])
									->where('unit_id', $res->unit_id)
									->update(['quantity' => DB::raw('quantity + '.$res->quantity) ]);
									
						DB::table('item_location_si')->where('item_id', $res->item_id)
									->where('invoice_id', $row)
									->where('location_id', $attributes['location_id'])
									->where('unit_id', $res->unit_id)
									->update(['status' => 1, 'deleted_at' => now() ]);
					} */
				}
			}
			
			if($this->setInputValue($attributes)) {
				$this->sales_invoice->modify_at = now();
				$this->sales_invoice->modify_by = Auth::User()->id;
				$this->sales_invoice->fill($attributes)->save();
			}
			
			$this->sales_invoice->voucher_date  = ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date']));
			$this->sales_invoice->fill($attributes)->save();
			
			if(isset($attributes['tempid'])) {
				DB::table('crm_info_si')->where('doc_id',$this->sales_invoice->id)->delete();
				foreach($attributes['tempid'] as $key => $row) {
					DB::table('crm_info_si')->insert(['temp_id' => $row, 'textval' => $attributes['crmtext'][$key],'doc_id' => $this->sales_invoice->id, 'textval2' => (isset($attributes['crmtext2'][$key]))?$attributes['crmtext2'][$key]:'']);
				}
			}
			
			/*CHG*/
			$subtotal = $line_total - $discount;
			if($taxtype=='tax_include' && $attributes['discount'] == 0) {
			  
			  $net_amount = $subtotal;
			  $tax_total = ($subtotal * $vat) / (100 + $vat);
			  $subtotal = $subtotal - $tax_total;
			  
			} elseif($taxtype=='tax_include' && $attributes['discount'] > 0) { 
				//$tax_total = ($line_total * $vat) / (100 + $vat);
				$tax_total = ($subtotal * $vat) / (100 + $vat);
				$subtotal = $subtotal - $tax_total;
				$net_amount = $line_total - $discount;

			   /*$tax_total = ($subtotal * $vat) / (100 + $vat);
			   $subtotal = $subtotal - $tax_total;
			   $net_amount = $line_total - $discount;*/
			} else 
				$net_amount = $subtotal + $tax_total;
			/*CHG*/
			
			//VAT calculate from subtotal...
			$net_total_pay = 0;
			if(isset($attributes['vatfrm_subtotal'])) {
				
				$less_amount = (isset($attributes['less_amount']))?$attributes['less_amount']:0;
				$previnv_amount = (isset($attributes['previnv_amount']))?$attributes['previnv_amount']:0;
				$less_amount2 = (isset($attributes['less_amount2']))?$attributes['less_amount2']:0;
				$less_amount3 = (isset($attributes['less_amount3']))?$attributes['less_amount3']:0;
				$line_total = $attributes['total']; //CHNG SEP 17
				$subtotal = $line_total - $less_amount - $less_amount2 - $less_amount3 - $previnv_amount;
						
				$tax_total = $attributes['vat'];
				$net_amount = $net_total_pay = $attributes['net_amount'];
			}
			
			if( isset($attributes['is_fc']) ) {
				$total_fc 	   = $line_total / $attributes['currency_rate'];
				$discount_fc   = $attributes['discount'];
				$vat_fc 	   = $attributes['vat_fc'] / $attributes['currency_rate'];
				$tax_fc 	   = round($tax_total / $attributes['currency_rate'],2);
				$net_amount_fc = $total_fc - $discount_fc + $tax_fc;
				$subtotal_fc   = $subtotal / $attributes['currency_rate']; 
				$discount      = $attributes['discount'] * $attributes['currency_rate'];
			} else {
				$total_fc = 0; $discount_fc = 0; $tax_fc = 0; $net_amount_fc = 0; $vat_fc = $subtotal_fc = 0;
				$discount = (isset($attributes['discount']))?$attributes['discount']:0; //M14
			}
			
			/* if( isset($attributes['is_fc']) ) {
				$total_fc 	   = $line_total / $attributes['currency_rate'];
				$discount_fc   = $attributes['discount'] / $attributes['currency_rate'];
				$vat_fc 	   = $attributes['vat_fc'] / $attributes['currency_rate'];
				$tax_fc 	   = round($tax_total / $attributes['currency_rate'],2);
				$net_amount_fc = $total_fc - $discount_fc + $tax_fc;
				$subtotal_fc	   = $subtotal / $attributes['currency_rate']; 
				
			} else 
				$total_fc = $discount_fc = $tax_fc = $net_amount_fc = $vat_fc = $subtotal_fc = 0;  */
			
			$roundoff = (isset($attributes['roundoff']))?$attributes['roundoff']:0;
			//update discount, total amount
			DB::table('sales_invoice')
						->where('id', $this->sales_invoice->id)
						->update(['total'    	  => $line_total,
								  'discount' 	  => $attributes['discount'],
								  'vat_amount'	  => $tax_total,
								  'net_total'	  => $net_amount,
								  'total_fc' 	  => $total_fc,
								  'discount_fc'   => $discount_fc,
								  'vat_amount_fc' => $tax_fc,
								  'net_total_fc'  => $net_amount_fc,
								  'subtotal'	  => $subtotal, //CHG
								  'subtotal_fc'	  => $subtotal_fc,
								  //'advance' => $attributes['advance_pd'] + $attributes['advance'],
								  'balance' => $attributes['balance'],
								  'net_total_pay' => $net_total_pay,
								  'doc_status' 	  => (isset($attributes['doc_status']))?$attributes['doc_status']:'',
								  'comment'		  => (isset($attributes['comment']))?$attributes['comment']:((isset($attributes['comment_hd']))?$attributes['comment_hd']:''),
								  'metre_in'	  => isset($attributes['metre_in'])?$attributes['metre_in']:'',
								   'metre_out'	  => isset($attributes['metre_out'])?$attributes['metre_out']:'',
								  'roundoff'	  => $roundoff,
								  'total_roundoff' => $net_amount - $roundoff
							  ]); //CHNG SEP 17
		if(isset($attributes['footer_id']) && isset($attributes['footer']))	{					  
			DB::table('header_footer')
						->where('id', $attributes['footer_id'])
						->update(['description'    	  => $attributes['footer']]);
		}
			//check whether Cost Accounting method or not.....
			if(Session::get('cost_accounting')==1) {
				$this->CostAccountingMethodUpdate($attributes, $subtotal, $tax_total, $net_amount, $this->sales_invoice->id, $taxtype, $cost_value);
			} else {
				$this->PurchaseAndSalesMethodUpdate($attributes, $subtotal, $tax_total, $net_amount, $this->sales_invoice->id, $taxtype);
			}
			
			if(isset($attributes['photo_id'])) {
					
				foreach($attributes['photo_id'] as $key => $val) {
					
					//UPDATE...
					if($val!='') {
						DB::table('si_photos')
							->where('id', $val)
							->update(['photo' =>  $attributes['photo_name'][$key],
									  'description'	=> $attributes['imgdesc'][$key]
									]);
									
					} else { 
						//ADD NEW..
						DB::table('si_photos')
							->insert(['invoice_id' => $this->sales_invoice->id, 
									  'photo' => $attributes['photo_name'][$key],
									  'description'	=> $attributes['imgdesc'][$key]
									]);
					}
				}
			}
			
				else{
			    
			    if(isset($attributes['photo_name']) && $attributes['photo_name']!='') {
							foreach($attributes['photo_name'] as $key => $val) {
								if($val!='') {
									DB::table('si_photos')
											->insert(['invoice_id' => $this->sales_invoice->id, 
													  'photo' => $val,
													  'description'	=> $attributes['imgdesc'][$key]
													]);
								}
							}
						}
			}
			
			//Remove photos
			if(isset($attributes['rem_photo_id']) && $attributes['rem_photo_id']!='') {
				$rem_photos = explode(',',$attributes['rem_photo_id']);
				foreach($rem_photos as $id) {
					$rec = DB::table('si_photos')->find($id);
					DB::table('si_photos')->where('id', $id)->delete();
					
					if($rec->photo!='') {			
						$fPath = public_path() . $this->imgDir.'/'.$rec->photo;
						File::delete($fPath);
					}
				}
			}
				
				
			//other cost action...
			if( isset($attributes['other_cost']) && $attributes['other_cost'] != 0 && $attributes['other_cost'] > 0) {
				
				foreach($attributes['dr_acnt'] as $key => $value){ 
				
				  if($attributes['oc_id'][$key]!='') {
					$salesInvoiceOC = SalesInvoiceSellExp::find($attributes['oc_id'][$key]);
					
					$cost['dr_account_id'] = $attributes['dr_acnt_id'][$key];
					$cost['se_reference'] = $attributes['oc_reference'][$key];
					$cost['se_description'] = $attributes['oc_description'][$key];
					$cost['cr_account_id'] = $attributes['cr_acnt_id'][$key];
					$cost['se_amount']		 = $attributes['oc_amount'][$key];
					$salesInvoiceOC->update($cost);
						
					//set account Cr/Dr amount transaction....
					if($this->setAccountTransactionUpdate($attributes, $attributes['oc_amount'][$key], $this->sales_invoice->id, $type='Dr', 'OC', $key)) { 
					
						$this->setAccountTransactionUpdate($attributes, $attributes['oc_amount'][$key], $this->sales_invoice->id, $type='Cr', 'OC', $key);
					}
					
					//.............
				 } else {
						$salesInvoiceOC = new SalesInvoiceSellExp();
						$arrOC = $this->setSellExpInputValue($attributes, $salesInvoiceOC, $key);
						$salesInvoiceOC->status = 1;
						$objOC = $this->sales_invoice->doOtherSellExp()->save($salesInvoiceOC);
						if($objOC) {	
							//set account Cr/Dr amount transaction....
							if($this->setAccountTransaction($attributes, $arrOC['se_amount'], $this->sales_invoice->id, $type='Cr', 'OC', $key, $objOC)) {
								$this->setAccountTransaction($attributes, $arrOC['se_amount'], $this->sales_invoice->id, $type='Dr', 'OC', $key, $objOC);						}
						}
					}

				}
			}
			
			
			//UPDATED REMOVE OTHER COST...
			if(isset($attributes['remove_oc']) && $attributes['remove_oc']!='')
			{
				$arrids = explode(',', $attributes['remove_oc']);
				
				foreach($arrids as $row) {
					DB::table('si_selling_exp')->where('id', $row)->update(['status' => 0, 'deleted_at' => now()]);
					
					DB::table('account_transaction')->where('voucher_type', 'SI')->where('voucher_type_id', $this->sales_invoice->id)
								->where('tr_for', $row)->where('other_type','OC')
								->update(['status' => 0, 'deleted_at' => now()]);
					
				}
			}
			//...UPDATED MAR 30 REMOVE OTHER COST
			
			//AUG24.....  DISCONNECT FROM DO/SO/QS....
			if(isset($attributes['is_clear']) && $attributes['is_clear']==1) {
				$ids = explode(',', $attributes['document_id']);
				if($attributes['document_type']=='CDO') {
					DB::table('customer_do')->whereIn('id',$ids)->update(['is_transfer' => 0, 'is_editable' => 0]);
					DB::table('customer_do_item')->whereIn('customer_do_id',$ids)->update(['is_transfer' => 0]);
				} elseif($attributes['document_type']=='SO') {
					DB::table('sales_order')->whereIn('id',$ids)->update(['is_transfer' => 0, 'is_editable' => 0]);
					DB::table('sales_order_item')->whereIn('sales_order_id',$ids)->update(['is_transfer' => 0]);
				} elseif($attributes['document_type']=='QS') {
					DB::table('quotation_sales')->whereIn('id',$ids)->update(['is_transfer' => 0, 'is_editable' => 0]);
					DB::table('quotation_sales_item')->whereIn('quotation_sales_id',$ids)->update(['is_transfer' => 0]);
				}
			}
			
			DB::commit();
			return true;
			
		} catch(\Exception $e) {
			
			DB::rollback(); echo $e->getLine().' '.$e->getMessage();exit;
			return false;
		}
	}
	
	
	public function delete($id)
	{
		
		$this->sales_invoice = $this->sales_invoice->find($id);
		DB::beginTransaction();
		try {
			
			//Update control of SQ,SO,CDO...  //APR25
			if($this->sales_invoice->document_id > 0) {
				if($this->sales_invoice->document_type=='SQ') {
					DB::table('quotation_sales')->where('id', $this->sales_invoice->document_id)->update(['is_transfer' => 0, 'is_editable' => 0]);
					DB::table('quotation_sales_item')->where('quotation_sales_id', $this->sales_invoice->document_id)->update(['is_transfer' => 0]);

				} else if($this->sales_invoice->document_type=='SO') {
					DB::table('sales_order')->where('id', $this->sales_invoice->document_id)->update(['is_transfer' => 0, 'is_editable' => 0]);

					DB::table('sales_order_item')->where('sales_order_id', $this->sales_invoice->document_id)->update(['is_transfer' => 0]);

				} else if($this->sales_invoice->document_type=='CDO') { 
				    //APR25
				    $ids = explode(',', $this->sales_invoice->document_id);
				    
				    //$sicount = DB::table('sales_invoice')->where('id','!=',$id)->where('document_id', $this->sales_invoice->document_id)->where('status',1)->whereNull('deleted_at')->count();
				   // if($sicount==0) {
					    DB::table('customer_do')->whereIn('id', $ids)->update(['is_transfer' => 0, 'is_editable' => 0]);

					    DB::table('customer_do_item')->whereIn('customer_do_id', $ids)->update(['is_transfer' => 0]);
					    
					    foreach($ids as $idd) {
					        $dorow = DB::table('item_log')->join('customer_do_item','customer_do_item.id','=','item_log.item_row_id')
					                    ->where('item_log.document_type','CDO')->where('item_log.document_id',$idd)
					                    ->select('customer_do_item.quantity','customer_do_item.balance_quantity')->first();
					        if($dorow)
					            DB::table('item_log')->where('document_type','CDO')->where('document_id',$idd)->update(['quantity' => $dorow->quantity, 'status' => 1,'deleted_at' => '0000-00-00 00:00:00']); //($dorow->balance_quantity > 0)?$dorow->balance_quantity:
					    }
				    //}
				    
				    
				}
			}
			
			//inventory update...
			$items = DB::table('sales_invoice_item')->where('sales_invoice_id', $id)->select('id','item_id','unit_id','quantity')->get();
			//echo '<pre>';print_r($items);exit;
			foreach($items as $item) {
				$this->objUtility->updateLastPurchaseCostAndCostAvgonDelete($item,$id);

				DB::table('con_location')->where('invoice_id',$item->id)->where('is_do',0)->update(['status'=>0,'deleted_at'=>now()]);
			}
			DB::table('sales_invoice_item')->where('sales_invoice_id', $id)->update(['status' => 0, 'deleted_at' => now()]);
			
			//Transaction update....
			if($this->sales_invoice->is_rental == 1) {         
				DB::table('account_transaction')->where('voucher_type', 'SRL')->where('voucher_type_id',$id)->update(['status' => 0,'deleted_at' => now(),'deleted_by' => Auth::User()->id ]);
			}else{
			    DB::table('account_transaction')->where('voucher_type', 'SI')->where('voucher_type_id',$id)->update(['status' => 0,'deleted_at' => now(),'deleted_by' => Auth::User()->id ]);
			}
			
			//DB::table('account_master')->where('id', $this->sales_invoice->dr_account_id)->update(['cl_balance' => DB::raw('cl_balance - '.$this->sales_invoice->net_total)]);
			$this->objUtility->tallyClosingBalance($this->sales_invoice->dr_account_id);
			
			//DB::table('account_master')->where('id', $this->sales_invoice->cr_account_id)->update(['cl_balance' => DB::raw('cl_balance - '.$this->sales_invoice->total)]);
			$this->objUtility->tallyClosingBalance($this->sales_invoice->cr_account_id);
			
			$vatrow = $this->getVatAccounts((isset($attributes['department_id']))?$attributes['department_id']:null); //DB::table('vat_master')->where('status', 1)->whereNull('deleted_at')->first();//DB::table('account_master')->where('master_name', 'VAT OUTPUT')->where('status', 1)->first();
			if($vatrow) {
				//DB::table('account_master')->where('id', $vatrow->payment_account)->update(['cl_balance' => DB::raw('cl_balance - '.$this->sales_invoice->vat_amount)]);
				//$this->objUtility->tallyClosingBalance($vatrow->payment_account);
				$this->objUtility->tallyClosingBalance($vatrow->collection_account);
			}
			
			//Quotatio/Sales order unlock....
			/*if($this->sales_invoice->document_type=='SO') {
				DB::table('sales_order')->where('id',$this->sales_invoice->document_id)->update(['is_transfer' => 0, 'is_editable' => 0]);
			} else if($this->sales_invoice->document_type=='SO') {
				DB::table('quotation_sales')->where('id',$this->sales_invoice->document_id)->update(['is_transfer' => 0, 'is_editable' => 0]);
			}*/
			
			//Jobmaster unlock...
			if($this->matservice->is_active==1)
				DB::table('jobmaster')->where('id',$this->sales_invoice->job_id)->update(['is_close' => 0]);
			
			foreach($items as $item) {
				$sirow = DB::table('item_location_si')->where('invoice_id',$item->id)->where('is_do',0)->get();
				
				foreach($sirow as $prow) {
					DB::table('item_location_si')->where('id',$prow->id)->update(['status'=>0,'deleted_at'=>now()]);
					
					DB::table('item_location')->where('location_id', $prow->location_id)->where('item_id',$prow->item_id)->where('unit_id',$prow->unit_id)
								->update(['quantity' => DB::raw('quantity + '.$prow->quantity) ]);
								
				}
				//REMOVE FROM CONSIGNMENT LOCATION
				DB::table('con_location')->where('invoice_id',$item->id)->where('is_do',0)->update(['status' => 0, 'deleted_at' => now()]);
			}
			DB::table('sales_invoice')->where('id', $id)
									  ->update(['deleted_by' => Auth::User()->id ]);	
            
            
            //MAY25 BATCH REMOVE..
			$batch_log = DB::table('batch_log')
		                        ->where('document_type','SI')
		                        ->where('document_id', $id)
				                ->whereNull('deleted_at')
				                ->select('id','quantity','item_id','batch_id','doc_row_id')->get();
				                
			foreach($batch_log as $blog) {	                
				DB::table('batch_log')->where('id', $blog->id)->update(['deleted_at' => now(), 'deleted_by' => Auth::User()->id]);
				
				DB::table('item_batch')->where('id', $blog->batch_id)->update(['quantity' => DB::raw('quantity + '.$blog->quantity) ]);
				
			}
			
			
			$this->sales_invoice->delete();
			
			DB::commit();
			return true; 
		} catch(\Exception $e) {
			
			DB::rollback(); echo $e->getLine().'-'.$e->getMessage().' '.$e->getFile();exit;
			return false;
		}
	}
	
	public function suppliersDOList()
	{
		$query = $this->sales_invoice->where('sales_invoice.status',1);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.supplier_id');
						} )
					->select('sales_invoice.*','am.master_name AS supplier')
					->orderBY('sales_invoice.id', 'DESC')
					->get();
	}
	
	public function getSDOdata($supplier_id = null)
	{
		if($supplier_id)
			$query = $this->sales_invoice->where('sales_invoice.status',1)->where('sales_invoice.is_transfer',0)->where('sales_invoice.supplier_id',$supplier_id);
		else
			$query = $this->sales_invoice->where('sales_invoice.status',1)->where('sales_invoice.is_transfer',0);
		
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.supplier_id');
						} )
					->select('sales_invoice.*','am.master_name AS supplier')
					->orderBY('sales_invoice.id', 'ASC')
					->get();
	}
	
	public function findInvoiceData($id)
	{
		$query = $this->sales_invoice->where('sales_invoice.id', $id);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.customer_id');
						} )
						->leftJoin('jobmaster AS J', function($join){
					  $join->on('J.id','=','sales_invoice.job_id');
					})
					->select('sales_invoice.*','am.master_name AS customer','J.code')
					->orderBY('sales_invoice.id', 'ASC')
					->first();
	}
	
	public function salesInvoiceListCount()
	{
		//CHECK DEPARTMENT.......
		$deptid = (Session::get('department')==1)?Auth::user()->department_id:0;
		
		$query = $this->sales_invoice->where('sales_invoice.status',1)->where('sales_invoice.is_rental',0);
			if($deptid!=0)
				$query->where('sales_invoice.department_id', $deptid);
			
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.customer_id');
						} )
					->count();
	}

	public function salesInvoiceList($type,$start,$limit,$order,$dir,$search,$dept=null)
	{
		//CHECK DEPARTMENT.......
		$deptid = (Session::get('department')==1)?Auth::user()->department_id:0;
		
		$query = $this->sales_invoice->where('sales_invoice.status',1)->where('sales_invoice.is_rental',0) //->where('sales_invoice.department_id','!=',4)
						->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.customer_id');
						} )
						->leftJoin('sales_order AS SO', function($join) {
							$join->on('SO.id','=','sales_invoice.document_id');
						} )
				->leftJoin('jobmaster AS JM', function($join) {
							$join->on('JM.id','=','sales_invoice.job_id');
						})
						->leftJoin('vehicle AS V', function($join) {
							$join->on('V.id','=','sales_invoice.vehicle_id');
						} );
				
				if($deptid!=0) //dept chk
					$query->where('sales_invoice.department_id', $deptid);
				else {
					if($dept!='' && $dept!=0) {
						$query->where('sales_invoice.department_id', $dept);
					}
				}
			
				if($search) {
					
					$query->where(function($qry) use($search) {
						$date = date('Y-m-d', strtotime($search));
						$qry->where('sales_invoice.voucher_no','LIKE',"%{$search}%")
							->orWhere('am.master_name', 'LIKE',"%{$search}%")
							->orWhere('sales_invoice.voucher_date','LIKE',"%{$search}%")
							->orWhere('sales_invoice.reference_no','LIKE',"%{$search}%")
							->orWhere('JM.name', 'LIKE',"%{$search}%")
							->orWhere('sales_invoice.customer_name','LIKE',"%{$search}%")
							->orWhere('sales_invoice.customer_phone','LIKE',"%{$search}%")
							->orWhere('sales_invoice.vehicle_no','LIKE',"%{$search}%");
					});
				}
				
				$query->select('sales_invoice.*','am.master_name AS customer','V.reg_no','JM.name AS job','sales_invoice.vehicle_no AS vehicle','SO.voucher_no AS jo_no')
					->offset($start)
                    ->limit($limit)
                    ->orderBy($order,$dir);
					
				if($type=='get')
					return $query->get();
				else
					return $query->count();
	}
	
	public function jobInvoiceListCount()
	{
		//CHECK DEPARTMENT.......
		$deptid = (Session::get('department')==1)?Auth::user()->department_id:0;
		
		$query = $this->sales_invoice->where('sales_invoice.status',1)->where('sales_invoice.is_rental',2);
			if($deptid!=0)
				$query->where('sales_invoice.department_id', $deptid);
			
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.customer_id');
						} )
					->count();
	}

	public function jobInvoiceList($type,$start,$limit,$order,$dir,$search,$dept=null)
	{
		//CHECK DEPARTMENT.......
		$deptid = (Session::get('department')==1)?Auth::user()->department_id:0;
		
		$query = $this->sales_invoice->where('sales_invoice.status',1)->where('sales_invoice.is_rental',2)->where('sales_invoice.department_id','!=',4)
						->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.customer_id');
						} )
						->leftJoin('sales_order AS SO', function($join) {
							$join->on('SO.id','=','sales_invoice.document_id');
						} )
						->leftJoin('vehicle AS V', function($join) {
							$join->on('V.id','=','sales_invoice.vehicle_id');
						} );
				
				if($deptid!=0) //dept chk
					$query->where('sales_invoice.department_id', $deptid);
				else {
					if($dept!='' && $dept!=0) {
						$query->where('sales_invoice.department_id', $dept);
					}
				}
			
				if($search) {
					
					$query->where(function($qry) use($search) {
						$date = date('Y-m-d', strtotime($search));
						$qry->where('sales_invoice.voucher_no','LIKE',"%{$search}%")
							->orWhere('am.master_name', 'LIKE',"%{$search}%")
							->orWhere('sales_invoice.voucher_date','LIKE',"%{$search}%")
							->orWhere('sales_invoice.reference_no','LIKE',"%{$search}%")
							->orWhere('V.reg_no', 'LIKE',"%{$search}%")
							->orWhere('V.name', 'LIKE',"%{$search}%")
							->orWhere('sales_invoice.customer_name','LIKE',"%{$search}%")
							->orWhere('am.phone','LIKE',"%{$search}%")
							->orWhere('sales_invoice.vehicle_no','LIKE',"%{$search}%")
							->orWhere('SO.voucher_no','LIKE',"%{$search}%");
					});
				}
				
				$query->select('sales_invoice.*','am.master_name AS customer','V.reg_no','V.name AS vehicle','V.chasis_no','SO.voucher_no AS jo_no')
					->offset($start)
                    ->limit($limit)
                    ->orderBy($order,$dir);
					
				if($type=='get')
					return $query->get();
				else
					return $query->count();
	}
	
	public function getLastId() {
		
		return $this->sales_invoice->where('sales_invoice.status',1)
					->join('account_setting', function($join){
						$join->on('account_setting.id','=','sales_invoice.voucher_id');
					})
					->select('sales_invoice.id','account_setting.is_cash_voucher')
					->orderBY('sales_invoice.id', 'DESC')
					->first();

	}
	
	public function activeSalesInvoiceList()
	{
		return $this->sales_invoice->select('id','name')->where('status', 1)->orderBy('name', 'ASC')->get()->toArray();
	}
	
	public function check_reference_no($refno, $id = null) { 
		
		if($id)
			return $this->sales_invoice->where('reference_no',$refno)->where('id', '!=', $id)->count();
		else
			return $this->sales_invoice->where('reference_no',$refno)->count();
	}
	
	public function check_invoice_id($invoice_id) { 
		
		return $this->sales_invoice->where('id', $invoice_id)->count();
	}
	
	public function getInvoice()
	{
		$query = $this->sales_invoice->where('sales_invoice.status',1);
		
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.customer_id');
						} )
					->select('sales_invoice.*','am.master_name AS customer')
					->where('is_transfer',0)
					->orderBY('sales_invoice.id', 'ASC')
					->get();
	}
		
	public function getInvoiceItems($id)
	{
		$query = $this->sales_invoice->where('sales_invoice.id',$id);
		
		return $query->join('sales_invoice_item AS poi', function($join) {
							$join->on('poi.sales_invoice_id','=','sales_invoice.id');
						} )
					  ->join('units AS u', function($join){
						  $join->on('u.id','=','poi.unit_id');
					  })
					 ->join('item_unit AS iu', function($join){
						  $join->on('iu.unit_id','=','poi.unit_id')
							   ->on('iu.itemmaster_id','=','poi.item_id');
					  })
					  ->join('itemmaster AS im', function($join){
						  $join->on('im.id','=','poi.item_id');
					  })
					  ->where('poi.status',1)
					  ->where('poi.deleted_at', '0000-00-00 00:00:00')
					  ->select('poi.*','u.unit_name','im.item_code','im.batch_req','iu.packing','iu.is_baseqty','iu.pkno')
					  ->groupBy('poi.id')->orderBY('poi.id')
					  ->get();
						
		
		//return $this->itemmaster->where('status', 1)->orderBy('description','ASC')->select('id','item_code','description')->get();
	}
	
		
	//ED12
	public function getCustomerInvoice($customer_id, $mod=null, $rvid=null)
	{
		$arr = ($mod)?[0,1,2]:[0,2];
		if($rvid) {
			$rid = DB::table('receipt_voucher_entry')->where('id',$rvid)->select('receipt_voucher_id')->first();
			$ref = [150,151];
			return $this->sales_invoice->where('sales_invoice.status',1)
								   ->leftJoin('receipt_voucher_tr AS RV', function($join){
									   $join->on('RV.sales_invoice_id','=','sales_invoice.id');
									   $join->where('RV.deleted_at','=','0000-00-00 00:00:00');
									   $join->where('RV.status','=',1);
									  
								   }) 
								   ->leftJoin('receipt_voucher_entry AS R', function($join){
									   $join->on('R.id','=','RV.receipt_voucher_entry_id');
									   //$join->where('R.receipt_voucher_id','!=',$rid->receipt_voucher_id);
									   //$join->whereIn('sales_invoice.amount_transfer',[0,2]);
								   }) 
								    ->where('sales_invoice.customer_id', $customer_id)
								   /*->where(function ($query) use ($ref,$arr) {
										//$query->whereNotIn('R.reference',$ref);
										$query->whereIn('sales_invoice.amount_transfer',$arr);
									}) */
								   //->whereIn('sales_invoice.amount_transfer',$arr)
								   ->where('sales_invoice.status',1)
								   ->where('sales_invoice.is_rventry',0)
								   ->select('sales_invoice.*','RV.assign_amount')
								   ->orderBY('sales_invoice.voucher_date', 'ASC')->orderBY('id', 'ASC')
								   ->groupBy('sales_invoice.id')
								   ->get();
		} else {
			return $this->sales_invoice
								   ->where('customer_id', $customer_id)
								   ->whereIn('amount_transfer',$arr)
								   ->where('status',1)
								   ->where('sales_invoice.is_rventry',0)
								   ->orderBY('voucher_date', 'ASC')->orderBY('id', 'ASC')
								   ->get();
		}
	}
	
	//ED12
	public function getSINbills($customer_id,$mod=null,$rvid=null)
	{
		$arr = ($mod)?[0,1,2]:[0,2];
		if($rvid) {
			
			return DB::table('journal')->where('journal.status',1)
								->join('journal_entry AS JE', function($join) {
									$join->on('JE.journal_id','=','journal.id');
								})
							 ->leftJoin('receipt_voucher_tr AS RV', function($join){
								   $join->on('RV.sales_invoice_id','=','journal.id');
								   $join->where('RV.deleted_at','=','0000-00-00 00:00:00');
								   $join->where('RV.status','=',1);
							   }) 
								//->where('JE.entry_type','Dr')
								->where('journal.deleted_at','=','0000-00-00 00:00:00')
								->where('journal.voucher_type','SIN')
								->where('JE.account_id',$customer_id)
								->whereIn('journal.is_transfer',$arr)
								->select('journal.*','RV.assign_amount','JE.amount')
								->orderBY('journal.voucher_date', 'ASC')
								->get();
								
		} else {
			return DB::table('journal')->where('journal.status',1)
								->join('journal_entry AS JE', function($join) {
									$join->on('JE.journal_id','=','journal.id');
								})
								//->where('JE.entry_type','Dr')
								->where('journal.deleted_at','=','0000-00-00 00:00:00')
								->where('journal.voucher_type','SIN')
								->where('JE.account_id',$customer_id)
								->whereIn('journal.is_transfer',$arr)
								->orderBY('journal.voucher_date', 'ASC')
								->get();
		}

	}
	
	public function getSplitBills($customer_id) {
		
		$arr = [0,2];
		
		return DB::table('sales_split')
						   ->where('customer_id', $customer_id)
						   ->whereIn('amount_transfer',$arr)
						   ->where('status',1)
						   ->whereNull('deleted_at')
						   ->orderBY('voucher_date', 'ASC')
						   ->orderBY('id', 'ASC')
						   ->get();
								   
	}
	
	
	//May 15.....
	public function getOthrBills($customer_id,$mod=null,$rvid=null)
	{
		$arr = ($mod)?[0,1,2]:[0,2];
	
		/* $rid = DB::table('receipt_voucher_entry')->where('id',$rvid)->select('receipt_voucher_id')->first();
		
		if($rid) {
			return DB::table('other_voucher_tr')->where('account_master_id', $customer_id)
										 ->where('voucher_type','RV')->where('voucher_id', $rid->receipt_voucher_id)
										 ->whereIn('amount_transfer', $arr)
										 ->where('status',1)->whereNull('deleted_at')
										 ->get();
		} else { */
			return DB::table('other_voucher_tr')->where('account_master_id', $customer_id)
										 //->where('voucher_type','RV')
										 ->whereIn('amount_transfer', $arr)
										 ->where('status',1)->whereNull('deleted_at')
										 ->get();
		//}
		
	} //......May 15
	
	//ED12
	public function getOpenBalances($customer_id,$mod=null)
	{
		$arr = ($mod)?[0,1,2]:[0,2];
		return DB::table('opening_balance_tr')
								   //->where('tr_type','Dr')
								   ->where('account_master_id', $customer_id)
								   ->whereIn('amount_transfer',$arr)
								   ->where('status',1)
								   ->where('amount','>',0)
								   ->whereNull('deleted_at')
								   ->orderBY('tr_date', 'ASC')
								   ->select('*','amount AS net_total')
								   ->get();
	}
	
	public function getAdvance($customer_id)
	{
		$qry1 = DB::table('receipt_voucher_entry')
								   ->join('receipt_voucher', 'receipt_voucher.id', '=', 'receipt_voucher_entry.receipt_voucher_id')
								   ->where('receipt_voucher_entry.entry_type','Cr')
								   ->where('receipt_voucher_entry.status',1)
								   ->where('receipt_voucher_entry.account_id', $customer_id)
								   ->whereIn('receipt_voucher_entry.amount_transfer',[0,2])
								   ->where('receipt_voucher_entry.is_onaccount',1)
								   ->orderBY('receipt_voucher_entry.id', 'ASC')
								   ->select('receipt_voucher_entry.entry_type','receipt_voucher_entry.id','receipt_voucher_entry.balance_amount','receipt_voucher_entry.reference',
											'receipt_voucher.voucher_no','receipt_voucher.voucher_date','receipt_voucher_entry.amount AS net_total',DB::raw('"RV" AS type'));
											
		$qry2 = DB::table('journal_entry')
								   ->join('journal', 'journal.id', '=', 'journal_entry.journal_id')
								   ->where('journal_entry.entry_type','Cr')
								   ->where('journal_entry.status',1)
								   ->where('journal_entry.account_id', $customer_id)
								   ->whereIn('journal_entry.amount_transfer',[0,2])
								   ->where('journal_entry.is_onaccount',1)
								   ->orderBY('journal_entry.id', 'ASC')
								   ->select('journal_entry.entry_type','journal_entry.id','journal_entry.balance_amount','journal_entry.reference',
											'journal.voucher_no','journal.voucher_date','journal_entry.amount AS net_total',DB::raw('"JV" AS type'));
								   
		return $qry1->union($qry2)->get();
	}
	
	//JN23
	public function getSRbills($customer_id)
	{
		return DB::table('sales_return')
					   ->where('customer_id', $customer_id)
					   ->where('is_prior', 1)
					   ->whereIn('amount_transfer', [0,2]) //JN23 amount_transfer,balance_amount fields added in sales_return table
					   ->where('status',1)
					   ->whereNull('deleted_at')
					   ->orderBY('voucher_date', 'ASC')->orderBY('id', 'ASC')
					   ->get();
		
	}
	
	
	public function getInvoiceReport($attributes) 
	{
		$result = array();
		
		if($attributes['date_from']!=null && $attributes['date_to']!=null) {
			$date_from = (isset($attributes['date_from']))?date('Y-m-d', strtotime($attributes['date_from'])):'';
			$date_to = (isset($attributes['date_to']))?date('Y-m-d', strtotime($attributes['date_to'])):'';
			
			$result = $this->sales_invoice->where('sales_invoice.status',1)
								   ->join('account_master AS AM', function($join) {
									   $join->on('AM.id','=','sales_invoice.customer_id');
								   })
								   ->leftJoin('jobmaster AS JM', function($join) {
									   $join->on('JM.id','=','sales_invoice.job_id');
								   })
								   ->whereBetween('voucher_date', array($date_from, $date_to))
								    ->select('AM.master_name AS supplier','AM.vat_no','sales_invoice.*','JM.name AS job')
								   ->orderBY('id', 'ASC')
								   ->get();
		} else {
			$result = $this->sales_invoice->where('sales_invoice.status',1)
								   ->join('account_master AS AM', function($join) {
									   $join->on('AM.id','=','sales_invoice.customer_id');
								   })
								   ->leftJoin('jobmaster AS JM', function($join) {
									   $join->on('JM.id','=','sales_invoice.job_id');
								   })
								   ->select('AM.master_name AS supplier','AM.vat_no','sales_invoice.*','JM.name AS job')
								   ->orderBY('sales_invoice.id', 'ASC')
								   ->get();
		}
		
		return $result; 
	}
	
	public function getInvoiceById($attributes)
	{
		$invoice = $this->sales_invoice->where('sales_invoice.id', $attributes['document_id'])
								   ->join('account_master AS AM', function($join) {
									   $join->on('AM.id','=','sales_invoice.customer_id');
								   })
								   ->leftJoin('currency AS C', function($join) {
									   $join->on('C.id','=','sales_invoice.currency_id');
								   })
								   ->leftJoin('jobmaster AS J', function($join) {
									   $join->on('J.id','=','sales_invoice.job_id');
								   })
								    ->leftJoin('vehicle AS V', function($join) {
									   $join->on('V.id','=','J.vehicle_id');
								   })
								   ->leftJoin('vehicle AS V1', function($join) {
									   $join->on('V1.id','=','sales_invoice.vehicle_id');
								   })
								   ->leftJoin('header_footer AS F', function($join) {
									   $join->on('F.id','=','sales_invoice.footer_id');
								   })
								   ->leftJoin('salesman AS SL', function($join) {
									   $join->on('SL.id','=','sales_invoice.salesman_id');
								   })
								   ->leftJoin('customer_do AS DO', function($join) {
									   $join->on('DO.id','=','sales_invoice.document_id');
								   })
								   ->leftJoin('terms AS TR', function($join) {
									   $join->on('TR.id','=','sales_invoice.terms_id');
								   })
								   ->leftJoin('users AS U', function($join) {
									   $join->on('U.id','=','sales_invoice.created_by');
								   })
								   ->leftJoin('users AS U2', function($join) {
									   $join->on('U2.id','=','sales_invoice.modify_by');
								   })
								   ->select('AM.master_name AS supplier','sales_invoice.*','AM.address','AM.city','AM.state','F.description AS hf_description','SL.name AS salesman','TR.description AS terms','U2.name AS musername',
											'AM.pin','AM.vat_no','AM.phone AS custphone','C.name AS currency','V.*','V1.*','sales_invoice.customer_name AS cash_customer','DO.voucher_no AS do_no','U.name AS cusername',
											'J.code AS jobcode','J.start_date AS jobdate','AM.account_id')
								   ->orderBY('sales_invoice.id', 'ASC')
								   ->first();
								   
		$items = $this->sales_invoice->where('sales_invoice.id', $attributes['document_id'])
								   ->join('sales_invoice_item AS PI', function($join) {
									   $join->on('PI.sales_invoice_id','=','sales_invoice.id');
								   })
								   ->join('itemmaster AS IM', function($join) {
									   $join->on('IM.id','=','PI.item_id');
								   })
								   ->join('units AS U', function($join) {
									   $join->on('U.id','=','PI.unit_id');
								   })
								   ->where('PI.status', 1)
								   ->where('PI.deleted_at', '0000-00-00 00:00:00')
								   ->select('PI.*','IM.item_code','U.unit_name')//'sales_invoice.id',
								   //->groupBY('IM.id')
								   ->get();
								   
		return $result = ['details' => $invoice, 'items' => $items];
	}
	
	
	public function getProfitSummary($attributes) 
	{ //echo '<pre>';print_r($attributes);exit;
		$result = array();
		//echo '<pre>';print_r($result);exit;
		
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		$invoice_from =(isset($attributes['invoice_from']))?$attributes['invoice_from']:'';	
		$invoice_to = (isset($attributes['invoice_to']))?$attributes['invoice_to']:'';	
		$department_id = (isset($attributes['department_id']))?$attributes['department_id']:'';	
		$cos = DB::table('other_account_setting')->where('account_setting_name', 'Cost of Sales')->select('account_id')->first();
		$query = $this->sales_invoice->where('sales_invoice.status',1)
								   ->join('account_master AS AM', function($join) {
									   $join->on('AM.id','=','sales_invoice.customer_id');
								   })
								->join('account_transaction AS AC', function($join) use($cos) {
										$join->on('AC.voucher_type_id','=','sales_invoice.id');
										$join->where('AC.voucher_type','=','SI');
										$join->where('AC.account_master_id','=',$cos->account_id);//COST OF SALE A/C
									})
								   ->leftJoin('salesman AS SM', function($join) {
									   $join->on('SM.id','=','sales_invoice.salesman_id');
								   })
								   ->join('sales_invoice_item AS SI', function($join) {
									   $join->on('SI.sales_invoice_id','=','sales_invoice.id');
								   })
								   ->join('item_log AS IS', function($join) {
									   $join->on('IS.item_id','=', 'SI.item_id');
									   $join->on('IS.document_id','=', 'sales_invoice.id');
									   $join->on('IS.doc_row_id','=', 'SI.id');
								   })
								   ->join('itemmaster AS IM', function($join) {
									   $join->on('IM.id','=','SI.item_id');
								   })
								   ->leftJoin('groupcat AS GP', function($join) {
									$join->on('GP.id','=','IM.group_id');
								})
								->leftJoin('groupcat AS SGP', function($join) {
									$join->on('GP.id','=','IM.subgroup_id');
								})
								->leftJoin('category AS CAT', function($join) {
									$join->on('CAT.id','=','IM.category_id');
								})
								->leftJoin('category AS SCAT', function($join) {
									$join->on('CAT.id','=','IM.subcategory_id');
								})
								 ->where('SI.status',1)
								 ->where('SI.deleted_at','0000-00-00 00:00:00')
								 ->where('IS.document_type','=', 'SI')
								 ->where('IS.status',1)
								 ->where('IS.deleted_at','0000-00-00 00:00:00');
												   
			if(isset($attributes['customer_id']) && $attributes['customer_id']!='')
				$query->whereIn('sales_invoice.customer_id', $attributes['customer_id']);

			
			
			if(isset($attributes['salesman_id']) && $attributes['salesman_id']!='')
				$query->whereIn('sales_invoice.salesman_id', $attributes['salesman_id']);
		if(isset($attributes['group_id']))
				$query->whereIn('IM.group_id', $attributes['group_id']);
			
			if(isset($attributes['subgroup_id']))
				$query->whereIn('IM.subgroup_id', $attributes['subgroup_id']);
			
			if(isset($attributes['category_id']))
				$query->whereIn('IM.category_id', $attributes['category_id']);
			
			if(isset($attributes['subcategory_id']))
				$query->whereIn('IM.subcategory_id', $attributes['subcategory_id']);
					
			
			if(isset($attributes['item_id']) && $attributes['item_id']!='')
				$query->whereIn('SI.item_id', $attributes['item_id']);
			
			if(($date_from!='') && ($date_to!=''))
				$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));

			if(($invoice_from!='') && ($invoice_to!=''))
			{
				$query->whereBetween('sales_invoice.voucher_no', array($invoice_from, $invoice_to));
			}
			else if(($invoice_from!='') && ($invoice_to=='')) {
				$invoice_to=$invoice_from;
				$query->whereBetween('sales_invoice.voucher_no', array($invoice_from, $invoice_to));
			}
			
			if($department_id!='')
				$query->where('sales_invoice.department_id', $department_id);
			//JAN25
			$result = $query->select('AM.master_name AS supplier','sales_invoice.id','sales_invoice.voucher_no','sales_invoice.voucher_date','IM.class_id','SM.name AS salesman',
							   'SI.quantity AS squantity','SI.unit_price AS sunit_price','SI.item_id','SI.id AS sid','SI.discount','AM.account_id','SI.item_cost','SM.id AS smid','SI.assembly_items_cost',
							   'IS.quantity AS pquantity','IS.cost_avg AS punit_price1','IM.item_code','IM.description','AM.id AS cid','IM.id AS itid','AC.amount as sale_cost','SI.assembly_items')
							   ->groupBy('SI.id')
							   ->orderBY('SI.id', 'ASC')
							   ->get()->toArray();
			return $result; 
	}
	
	public function getProfitSummaryBkpJL25($attributes) 
	{ //echo '<pre>';print_r($attributes);exit;
		$result = array();
		//echo '<pre>';print_r($result);exit;
		
		$acs = DB::table('voucher_account')->get();
		$cost_ac = ($acs)?$acs[1]->account_id:'';
		
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		$invoice_from =(isset($attributes['invoice_from']))?$attributes['invoice_from']:'';	
		$invoice_to = (isset($attributes['invoice_to']))?$attributes['invoice_to']:'';	
		$department_id = (isset($attributes['department_id']))?$attributes['department_id']:'';	

		$query = $this->sales_invoice->where('sales_invoice.status',1)
								   ->join('account_master AS AM', function($join) {
									   $join->on('AM.id','=','sales_invoice.customer_id');
								   })
								->join('account_transaction AS AC', function($join) use($cost_ac) {
										$join->on('AC.voucher_type_id','=','sales_invoice.id');
										$join->where('AC.voucher_type','=','SI');
										$join->where('AC.account_master_id','=', $cost_ac);//COST OF SALE A/C
									})
								   ->leftJoin('salesman AS SM', function($join) {
									   $join->on('SM.id','=','sales_invoice.salesman_id');
								   })
								   ->join('sales_invoice_item AS SI', function($join) {
									   $join->on('SI.sales_invoice_id','=','sales_invoice.id');
								   })
								   ->join('item_log AS IS', function($join) {
									   $join->on('IS.item_id','=', 'SI.item_id');
									   $join->on('IS.document_id','=', 'sales_invoice.id');
								   })
								   ->join('itemmaster AS IM', function($join) {
									   $join->on('IM.id','=','SI.item_id');
								   })
								   ->leftJoin('groupcat AS GP', function($join) {
									$join->on('GP.id','=','IM.group_id');
								})
								->leftJoin('groupcat AS SGP', function($join) {
									$join->on('GP.id','=','IM.subgroup_id');
								})
								->leftJoin('category AS CAT', function($join) {
									$join->on('CAT.id','=','IM.category_id');
								})
								->leftJoin('category AS SCAT', function($join) {
									$join->on('CAT.id','=','IM.subcategory_id');
								})
								 ->where('SI.status',1)
								 ->where('SI.deleted_at','0000-00-00 00:00:00')
								 ->where('IS.document_type','=', 'SI')
								 ->where('IS.status',1)
								 ->where('IS.deleted_at','0000-00-00 00:00:00');
												   
			if(isset($attributes['customer_id']) && $attributes['customer_id']!='')
				$query->whereIn('sales_invoice.customer_id', $attributes['customer_id']);

			
			
			if(isset($attributes['salesman_id']) && $attributes['salesman_id']!='')
				$query->whereIn('sales_invoice.salesman_id', $attributes['salesman_id']);
		if(isset($attributes['group_id']))
				$query->whereIn('IM.group_id', $attributes['group_id']);
			
			if(isset($attributes['subgroup_id']))
				$query->whereIn('IM.subgroup_id', $attributes['subgroup_id']);
			
			if(isset($attributes['category_id']))
				$query->whereIn('IM.category_id', $attributes['category_id']);
			
			if(isset($attributes['subcategory_id']))
				$query->whereIn('IM.subcategory_id', $attributes['subcategory_id']);
					
			
			if(isset($attributes['item_id']) && $attributes['item_id']!='')
				$query->whereIn('SI.item_id', $attributes['item_id']);
			
			if(($date_from!='') && ($date_to!=''))
				$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));

			if(($invoice_from!='') && ($invoice_to!=''))
			{
				$query->whereBetween('sales_invoice.voucher_no', array($invoice_from, $invoice_to));
			}
			else if(($invoice_from!='') && ($invoice_to=='')) {
				$invoice_to=$invoice_from;
				$query->whereBetween('sales_invoice.voucher_no', array($invoice_from, $invoice_to));
			}
			
			if($department_id!='')
				$query->where('sales_invoice.department_id', $department_id);
			//JAN25
			$result = $query->select('AM.master_name AS supplier','sales_invoice.id','sales_invoice.voucher_no','sales_invoice.voucher_date','IM.class_id','SM.name AS salesman',
							   'SI.quantity AS squantity','SI.unit_price AS sunit_price','SI.item_id','SI.id AS sid','SI.discount','AM.account_id','SI.item_cost','SM.id AS smid','SI.assembly_items_cost',
							   'IS.quantity AS pquantity','IS.cost_avg AS punit_price1','IM.item_code','IM.description','AM.id AS cid','IM.id AS itid','AC.amount as sale_cost','SI.assembly_items')
							   ->groupBy('SI.id')
							   ->orderBY('SI.id', 'ASC')
							   ->get()->toArray();
			return $result; 
	}
	
	
	public function getProfitSummaryBkp3($attributes) 
	{ //echo '<pre>';print_r($attributes);exit;
		$result = array();
		//echo '<pre>';print_r($result);exit;
		
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		$invoice_from =(isset($attributes['invoice_from']))?$attributes['invoice_from']:'';	
		$invoice_to = (isset($attributes['invoice_to']))?$attributes['invoice_to']:'';	
		$department_id = (isset($attributes['department_id']))?$attributes['department_id']:'';	

		$query = $this->sales_invoice->where('sales_invoice.status',1)
								   ->join('account_master AS AM', function($join) {
									   $join->on('AM.id','=','sales_invoice.customer_id');
								   })
								   ->leftJoin('salesman AS SM', function($join) {
									   $join->on('SM.id','=','sales_invoice.salesman_id');
								   })
								   ->join('sales_invoice_item AS SI', function($join) {
									   $join->on('SI.sales_invoice_id','=','sales_invoice.id');
								   })
								   ->join('item_log AS IS', function($join) {
									   $join->on('IS.item_id','=', 'SI.item_id');
									   $join->on('IS.document_id','=', 'sales_invoice.id');
								   })
								   ->join('itemmaster AS IM', function($join) {
									   $join->on('IM.id','=','SI.item_id');
								   })
								   ->leftJoin('groupcat AS GP', function($join) {
									$join->on('GP.id','=','IM.group_id');
								})
								->leftJoin('groupcat AS SGP', function($join) {
									$join->on('GP.id','=','IM.subgroup_id');
								})
								->leftJoin('category AS CAT', function($join) {
									$join->on('CAT.id','=','IM.category_id');
								})
								->leftJoin('category AS SCAT', function($join) {
									$join->on('CAT.id','=','IM.subcategory_id');
								})
								 ->where('SI.status',1)
								 ->where('SI.deleted_at','0000-00-00 00:00:00')
								 ->where('IS.document_type','=', 'SI')
								 ->where('IS.status',1)
								 ->where('IS.deleted_at','0000-00-00 00:00:00');
												   
			if(isset($attributes['customer_id']) && $attributes['customer_id']!='')
				$query->whereIn('sales_invoice.customer_id', $attributes['customer_id']);

			
			
			if(isset($attributes['salesman_id']) && $attributes['salesman_id']!='')
				$query->whereIn('sales_invoice.salesman_id', $attributes['salesman_id']);
		if(isset($attributes['group_id']))
				$query->whereIn('IM.group_id', $attributes['group_id']);
			
			if(isset($attributes['subgroup_id']))
				$query->whereIn('IM.subgroup_id', $attributes['subgroup_id']);
			
			if(isset($attributes['category_id']))
				$query->whereIn('IM.category_id', $attributes['category_id']);
			
			if(isset($attributes['subcategory_id']))
				$query->whereIn('IM.subcategory_id', $attributes['subcategory_id']);
					
			
			if(isset($attributes['item_id']) && $attributes['item_id']!='')
				$query->whereIn('SI.item_id', $attributes['item_id']);
			
			if(($date_from!='') && ($date_to!=''))
				$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));

			if(($invoice_from!='') && ($invoice_to!=''))
			{
				$query->whereBetween('sales_invoice.voucher_no', array($invoice_from, $invoice_to));
			}
			else if(($invoice_from!='') && ($invoice_to=='')) {
				$invoice_to=$invoice_from;
				$query->whereBetween('sales_invoice.voucher_no', array($invoice_from, $invoice_to));
			}
			
			if($department_id!='')
				$query->where('sales_invoice.department_id', $department_id);
			
			$result = $query->select('AM.master_name AS supplier','sales_invoice.id','sales_invoice.voucher_no','sales_invoice.voucher_date','IM.class_id','SM.name AS salesman',
							   'SI.quantity AS squantity','SI.unit_price AS sunit_price','SI.item_id','SI.id AS sid','SI.discount','AM.account_id','SI.item_cost','SM.id AS smid',
							   'IS.quantity AS pquantity','IS.cost_avg AS punit_price1','IM.item_code','IM.description','AM.id AS cid','IM.id AS itid','IS.sale_cost')
							   ->groupBy('SI.id')
							   ->orderBY('sales_invoice.id', 'ASC')
							   ->get()->toArray();
			return $result; 
	}
	public function item_update($id, $attributes)
	{
	
			
	foreach($attributes['item_id'] as $key => $value) { 
					
		if($attributes['order_item_id'][$key]!='') {
			//if($attributes['item_info'][$key]!= 1) {
                       DB::table('item_info')
							->insert([
										'si_no'=> $id,
										'si_date'=> date('Y-m-d', strtotime($attributes['voucher_date'])),
										'customer_id'=> $attributes['customer_id'],
										'item_id' => $value,
										'item_code' =>$attributes['item_code'][$key] ,
										'item_description'	=> $attributes['item_name'][$key] ,
										'unit' => $attributes['unit_id'][$key],
										'quantity' =>  $attributes['quantity'][$key],
										'in_out'=>$attributes['item_info'][$key],
										 'created_at' => now(),
										 'is_open' => 1

										]);

		//  }  
		}
					}		
					return true;

	}
	public function findPOdata($id)
	{
		$query = $this->sales_invoice->where('sales_invoice.id', $id);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.customer_id');
						} )
					->leftjoin('account_master AS am2', function($join){
						  $join->on('am2.id','=','sales_invoice.cr_account_id');
					  }) 
					->leftJoin('jobmaster AS J', function($join){
					  $join->on('J.id','=','sales_invoice.job_id');
					})
					->leftJoin('header_footer AS f',function($join) {
						$join->on('f.id','=','sales_invoice.footer_id');
					})
					->leftJoin('salesman AS S',function($join) {
						$join->on('S.id','=','sales_invoice.salesman_id');
					})
					->leftJoin('vehicle AS V',function($join) {
						$join->on('V.id','=','sales_invoice.vehicle_id');
					})
					->leftJoin('sales_order AS SO',function($join) {
						$join->on('SO.id','=','sales_invoice.document_id');
					})
					->select('sales_invoice.*','am.master_name AS customer','f.description AS footer','am2.master_name AS account','am.email',
							 'S.name AS salesman','V.name AS vehicle','V.reg_no','V.model','V.make','V.issue_plate','V.code_plate','V.chasis_no','SO.voucher_no AS doc_no','J.code')
					->orderBY('sales_invoice.id', 'ASC')
					->first();
	}	
	public function findPOdataold($id)
	{
		$query = $this->sales_invoice->where('sales_invoice.id', $id);
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.customer_id');
						} )
					->join('account_master AS am2', function($join){
						  $join->on('am2.id','=','sales_invoice.cr_account_id');
					  }) 
					->leftJoin('header_footer AS f',function($join) {
						$join->on('f.id','=','sales_invoice.footer_id');
					})
					->leftJoin('salesman AS S',function($join) {
						$join->on('S.id','=','sales_invoice.salesman_id');
					})
					->leftJoin('vehicle AS V',function($join) {
						$join->on('V.id','=','sales_invoice.vehicle_id');
					})
					->leftJoin('sales_order AS SO',function($join) {
						$join->on('SO.id','=','sales_invoice.document_id');
					})
					->select('sales_invoice.*','am.master_name AS customer','f.description AS footer','am2.master_name AS account','am.email',
							 'S.name AS salesman','V.name AS vehicle','V.reg_no','V.model','V.make','V.issue_plate','V.code_plate','SO.voucher_no AS doc_no')
					->orderBY('sales_invoice.id', 'ASC')
					->first();
	}
	
	public function getItems($id,$mod=null)
	{
		$query = $this->sales_invoice->where('sales_invoice.id',$id);
		
		$query->join('sales_invoice_item AS poi', function($join) {
							$join->on('poi.sales_invoice_id','=','sales_invoice.id');
						})
					  ->join('units AS u', function($join){
						  $join->on('u.id','=','poi.unit_id');
					  }) 
					   ->leftjoin('item_unit AS iu', function($join){
						  $join->on('iu.unit_id','=','poi.unit_id')
							   ->on('iu.itemmaster_id','=','poi.item_id');
					  })
					  ->join('itemmaster AS im', function($join){
						  $join->on('im.id','=','poi.item_id');
					  })
					  ->leftjoin('customer_do_item AS ci', function($join){
						  $join->on('ci.id','=','poi.doc_row_id');
					  })
					  ->where('poi.status',1);
					  
					  if($mod) {
						$val = ($mod=='ser')?2:1;
						$query->where('im.class_id',$val);
					  }
						
		return $query->select('poi.*','u.unit_name','im.item_code','iu.packing','iu.is_baseqty','iu.cur_quantity','iu.pkno','ci.balance_quantity as do_balance_quantity')
		                ->groupBy('poi.id')->orderBY('poi.id')->get();
					  //->groupBY('im.id')
					  
	}
	
	public function getOrderHistory($customer_id)
	{
		$query = $this->sales_invoice->where('sales_invoice.customer_id',$customer_id)->where('sales_invoice.status',1);
		
		return $query->join('sales_invoice_item AS poi', function($join) {
							$join->on('poi.sales_invoice_id','=','sales_invoice.id');
						} )
					  ->join('units AS u', function($join){
						  $join->on('u.id','=','poi.unit_id');
					  }) 
					  ->join('itemmaster AS im', function($join){
						  $join->on('im.id','=','poi.item_id');
					  })
					  ->where('poi.status',1)
					  ->select('poi.*','u.unit_name','im.item_code','sales_invoice.voucher_date','sales_invoice.voucher_no','sales_invoice.reference_no')->get();
	}
	
	public function check_voucher_no($refno, $deptid, $id = null) { 
		
		if($id)
			return $this->sales_invoice->where('voucher_no',$refno)->where('id', '!=', $id)->count();
		else {
			//return $this->sales_invoice->where('voucher_no',$refno)->count();
			$query = $this->sales_invoice->where('voucher_no',$refno); 
			return $result = ($deptid)?$query->where('department_id', $deptid)->count():$query->count();
		}
	}
	
	public function check_invoice($id)
	{
		$count = DB::table('sales_invoice')->where('id', $id)->where('is_editable',1)->count();
		if($count > 0)
			return false;
		else {
			$count = DB::table('sales_return')->where('sales_invoice_id', $id)->where('status',1)->whereNull('deleted_at')->count();
			if($count > 0)
				return false;
			else {
				return true;
				/* $count = DB::table('receipt_voucher_tr')->where('sales_invoice_id', $id)->where('status',1)->whereNull('deleted_at')->count();
				if($count > 0)
					return false;
				else
					return true; */
			}
		}	
	}
	
	public function getReport($attributes)
	{
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		$department = (Session::get('department')==1)?$attributes['department_id']:null;
			
		if($attributes['search_type']=='summary' || $attributes['search_type']=='customer_wise') {
			$query = $this->sales_invoice
							->join('sales_invoice_item AS POI', function($join) {
								$join->on('POI.sales_invoice_id','=','sales_invoice.id');
							})
							->join('account_master AS AM', function($join) {
								$join->on('AM.id','=','sales_invoice.customer_id');
							})
							->leftJoin('salesman AS S', function($join) {
								$join->on('S.id','=','sales_invoice.salesman_id');
							})
							->leftJoin('jobmaster AS J', function($join) {
								$join->on('J.id','=','sales_invoice.job_id');
							})
							->where('POI.status',1);
							
					if( $date_from!='' && $date_to!='' ) { 
						$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
					}
					
					if($attributes['salesman']!='') { 
						$query->where('sales_invoice.salesman_id', $attributes['salesman']);
					}
					
				$orderby = ($attributes['search_type']=='jobwise')?'jobcode':'master_name';
				return $query->select('sales_invoice.voucher_no','sales_invoice.reference_no','sales_invoice.total','sales_invoice.vat_amount',
								'sales_invoice.amount_transfer','S.name AS salesman','sales_invoice.discount',
								'sales_invoice.voucher_date','POI.quantity','POI.balance_quantity','POI.unit_price','AM.account_id','AM.master_name',
								'AM.vat_no','sales_invoice.net_total','POI.tax_code','J.code AS jobcode','sales_invoice.less_amount','sales_invoice.less_amount2','sales_invoice.less_amount3',
								DB::raw("(SELECT SUM(SI.quantity) FROM sales_invoice_item SI WHERE (SI.sales_invoice_id=sales_invoice.id) AND (SI.status=1) AND (SI.deleted_at='0000-00-00 00:00:00')
								)AS quantity") )
								->groupBy('sales_invoice.id')
								->orderBY('sales_invoice.voucher_date','ASC')
								->get();
								
		} else if($attributes['search_type']=='itemwise') {
			
				$query = $this->sales_invoice
								->join('sales_invoice_item AS POI', function($join) {
									$join->on('POI.sales_invoice_id','=','sales_invoice.id');
								})
								->join('account_master AS AM', function($join) {
									$join->on('AM.id','=','sales_invoice.customer_id');
								})
								->join('itemmaster AS M', function($join) {
									$join->on('M.id','=','POI.item_id');
								})
								->where('POI.status',1);
								
						if( $date_from!='' && $date_to!='' ) { 
							$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
						}
						
						if($department)
							$query->where('sales_invoice.department_id', $department);
						
				return $query->select('sales_invoice.voucher_no','sales_invoice.reference_no','sales_invoice.total','sales_invoice.vat_amount','sales_invoice.amount_transfer','sales_invoice.discount',
									  'sales_invoice.voucher_date','POI.quantity','POI.balance_quantity','POI.unit_price','AM.account_id','AM.master_name','AM.vat_no','sales_invoice.net_total','POI.tax_code',
									  'sales_invoice.subtotal','POI.item_name','M.item_code','POI.item_total','POI.vat_amount')
								->get()->toArray();
							
		} else {
			$query = $this->sales_invoice
							->join('sales_invoice_item AS POI', function($join) {
								$join->on('POI.sales_invoice_id','=','sales_invoice.id');
							})
							->join('account_master AS AM', function($join) {
								$join->on('AM.id','=','sales_invoice.customer_id');
							})
							->leftJoin('salesman AS S', function($join) {
								$join->on('S.id','=','sales_invoice.salesman_id');
							})
							->where('POI.status',1);
							
					if( $date_from!='' && $date_to!='' ) { 
						$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
					}
					
					if($attributes['salesman']!='') { 
						$query->where('sales_invoice.salesman_id', $attributes['salesman']);
					}
					
					if( $attributes['search_type']=='cash' ) { 
						$query->where('sales_invoice.voucher_id', 9);
					}
					
					if( $attributes['search_type']=='credit' ) { 
						$query->where('sales_invoice.voucher_id', 4);
					}
					
					if($department)
						$query->where('sales_invoice.department_id', $department);
					
			return $query->select('sales_invoice.voucher_no','sales_invoice.reference_no','sales_invoice.total','sales_invoice.vat_amount','sales_invoice.amount_transfer','S.name AS salesman','sales_invoice.discount',
								  'sales_invoice.voucher_date','POI.balance_quantity','POI.unit_price','AM.account_id','AM.master_name','AM.vat_no','sales_invoice.net_total','POI.tax_code',
								  'sales_invoice.subtotal',DB::raw('SUM(POI.item_total) AS item_total'),DB::raw('SUM(POI.vat_amount) AS item_vat'),
								  DB::raw("(SELECT SUM(SI.quantity) FROM sales_invoice_item SI WHERE (SI.sales_invoice_id=sales_invoice.id) AND (SI.status=1) AND (SI.deleted_at='0000-00-00 00:00:00')
								)AS quantity"))
							->groupBy('sales_invoice.id')->get();
		}
	}
	public function getReportExcel($attributes)
	{
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		$department = (Session::get('department')==1)?$attributes['department_id']:null;
			
		if($attributes['search_type']=='jobwise' || $attributes['search_type']=='customer_wise') {
			$query = $this->sales_invoice
							->join('sales_invoice_item AS POI', function($join) {
								$join->on('POI.sales_invoice_id','=','sales_invoice.id');
							})
							->join('account_master AS AM', function($join) {
								$join->on('AM.id','=','sales_invoice.customer_id');
							})
							->leftJoin('salesman AS S', function($join) {
								$join->on('S.id','=','sales_invoice.salesman_id');
							})
							->leftJoin('jobmaster AS J', function($join) {
								$join->on('J.id','=','sales_invoice.job_id');
							})
							->where('POI.status',1);
							
					if( $date_from!='' && $date_to!='' ) { 
						$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
					}
					
					if($attributes['salesman']!='') { 
						$query->where('sales_invoice.salesman_id', $attributes['salesman']);
					}
					
				$orderby = ($attributes['search_type']=='jobwise')?'jobcode':'master_name';
				return $query->select('sales_invoice.voucher_no','sales_invoice.reference_no','sales_invoice.total','sales_invoice.vat_amount',
								'sales_invoice.amount_transfer','S.name AS salesman','sales_invoice.discount',
								'sales_invoice.voucher_date','POI.quantity','POI.balance_quantity','POI.unit_price','AM.account_id','AM.master_name',
								'AM.vat_no','sales_invoice.net_total','POI.tax_code','J.code AS jobcode','sales_invoice.less_amount','sales_invoice.less_amount2','sales_invoice.less_amount3',
								DB::raw("(SELECT SUM(SI.quantity) FROM sales_invoice_item SI WHERE (SI.sales_invoice_id=sales_invoice.id) AND (SI.status=1) AND (SI.deleted_at='0000-00-00 00:00:00')
								)AS quantity") )
								->groupBy('sales_invoice.id')
								->orderBY('sales_invoice.voucher_date','ASC')
								->get();
								
		} else if($attributes['search_type']=='itemwise') {
			
				$query = $this->sales_invoice
								->join('sales_invoice_item AS POI', function($join) {
									$join->on('POI.sales_invoice_id','=','sales_invoice.id');
								})
								->join('account_master AS AM', function($join) {
									$join->on('AM.id','=','sales_invoice.customer_id');
								})
								->join('itemmaster AS M', function($join) {
									$join->on('M.id','=','POI.item_id');
								})
								->where('POI.status',1);
								
						if( $date_from!='' && $date_to!='' ) { 
							$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
						}
						
						if($department)
							$query->where('sales_invoice.department_id', $department);
						
				return $query->select('sales_invoice.voucher_no','sales_invoice.reference_no','sales_invoice.total','sales_invoice.vat_amount','sales_invoice.amount_transfer','sales_invoice.discount',
									  'sales_invoice.voucher_date','POI.quantity','POI.balance_quantity','POI.item_name','POI.unit_price','AM.account_id','AM.master_name','AM.vat_no','sales_invoice.net_total','POI.tax_code',
									  'sales_invoice.subtotal','POI.item_name','M.item_code','POI.item_total','POI.vat_amount')
								->get()->toArray();
							
		} else {
			$query = $this->sales_invoice
							->join('sales_invoice_item AS POI', function($join) {
								$join->on('POI.sales_invoice_id','=','sales_invoice.id');
							})
							->join('account_master AS AM', function($join) {
								$join->on('AM.id','=','sales_invoice.customer_id');
							})
							->leftJoin('salesman AS S', function($join) {
								$join->on('S.id','=','sales_invoice.salesman_id');
							})
							->where('POI.status',1);
							
					if( $date_from!='' && $date_to!='' ) { 
						$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
					}
					
					if($attributes['salesman']!='') { 
						$query->where('sales_invoice.salesman_id', $attributes['salesman']);
					}
					
					if( $attributes['search_type']=='cash' ) { 
						$query->where('sales_invoice.voucher_id', 9);
					}
					
					if( $attributes['search_type']=='credit' ) { 
						$query->where('sales_invoice.voucher_id', 4);
					}
					
					if($department)
						$query->where('sales_invoice.department_id', $department);
					
			return $query->select('sales_invoice.voucher_no','sales_invoice.reference_no','sales_invoice.total','sales_invoice.vat_amount','sales_invoice.amount_transfer','S.name AS salesman','sales_invoice.discount',
								  'sales_invoice.voucher_date','POI.balance_quantity','POI.unit_price','POI.item_name','AM.account_id','AM.master_name','AM.vat_no','sales_invoice.net_total','POI.tax_code',
								  'sales_invoice.subtotal',DB::raw('SUM(POI.item_total) AS item_total'),DB::raw('SUM(POI.vat_amount) AS item_vat'),
								  DB::raw("(SELECT SUM(SI.quantity) FROM sales_invoice_item SI WHERE (SI.sales_invoice_id=sales_invoice.id) AND (SI.status=1) AND (SI.deleted_at='0000-00-00 00:00:00')
								)AS quantity"))
							->groupBy('sales_invoice.id')->get();
		}
	}
		
	public function findforAPI($id)
	{
		$invoice = $this->sales_invoice->find($id);
		$items = SalesInvoiceItem::where('sales_invoice_id', $id)->get();
		return json_encode( ['invoice' => $invoice, 'items' => $items] );
	}
	
	public function InvoiceLogProcess()
	{
		//API ...
		$location = DB::table('location')->where('is_default',1)->where('status',1)->whereNull('deleted_at')->select('id')->first();
		$response = Curl::to($this->api_url.'pilog-process.php')
					->withData( array('id' => $location->id))
					->get();
					
		if($response) {
			$data = json_decode($response, true);
			//echo '<pre>';print_r($data);exit;
			if(isset($data['invoice'])) {
				
				foreach($data['invoice'] as $inv) {
					$res = $this->createByLogProcess($inv,$location->id);
				}
				return true;
			} 
		} 
	}
	
	private function createByLogProcess($attributes,$location_id) 
	{
		//GET PI voucher...
		$voucher = DB::table('account_setting')->where('status',1)->where('voucher_type_id',3)->select('id','voucher_no','cr_account_master_id')->first();
		
		//GET CUSTOMER ID
		//$customer = DB::table('parameter3')->where('location_id',$attributes['invoice']['location_id'])->select('account_id')->first();
		$customer = DB::table('parameter3')->where('location_id',$location_id)->select('account_id')->first();
		//print_r($customer);exit;
		
		$this->sales_invoice->voucher_id = $voucher->id;
		$this->sales_invoice->voucher_no = $voucher->voucher_no;
		$this->sales_invoice->reference_no = $attributes['invoice']['reference_no'] = $voucher->voucher_no;
		$this->sales_invoice->voucher_date = $attributes['invoice']['voucher_date'];
		$this->sales_invoice->document_type = 'PI';
		$this->sales_invoice->customer_id = $customer->account_id;
		$this->sales_invoice->dr_account_id = $customer->account_id;
		$this->sales_invoice->cr_account_id = $attributes['invoice']['supplier_id'];
		$this->sales_invoice->description = $attributes['invoice']['description'];
		$this->sales_invoice->total = $attributes['invoice']['total'];
		$this->sales_invoice->vat_amount = $attributes['invoice']['vat_amount'];
		$this->sales_invoice->net_total = $attributes['invoice']['net_total'];
		$this->sales_invoice->status = 1;
		$this->sales_invoice->created_at = now();
		$this->sales_invoice->subtotal = $attributes['invoice']['subtotal'];
		$this->sales_invoice->location_id = $location_id;
		$this->sales_invoice->fill($attributes)->save(); //fill($attributes)
		$sales_invoice_id = $this->sales_invoice->id;
		
		if($sales_invoice_id) {
			
			foreach($attributes['items'] as $row){
				
				$salesInvoiceItem = new SalesInvoiceItem();
				$salesInvoiceItem->sales_invoice_id = $sales_invoice_id;
				$salesInvoiceItem->item_id = $row['item_id'];
				$salesInvoiceItem->item_name = $row['item_name'];
				$salesInvoiceItem->unit_id = $row['unit_id'];
				$salesInvoiceItem->quantity = $row['quantity'];
				$salesInvoiceItem->unit_price = $row['unit_price'];
				$salesInvoiceItem->vat = $row['vat'];
				$salesInvoiceItem->vat_amount = $row['vat_amount'];
				$salesInvoiceItem->line_total = $row['line_total'];
				$salesInvoiceItem->status = 1;
				$salesInvoiceItem->tax_code = 'SR';
				$salesInvoiceItem->item_total = $row['item_total'];
				$this->sales_invoice->salesInvoiceItemAdd()->save($salesInvoiceItem);
				
				//UPDATE ITEM QUANTITY....
				$item = DB::table('item_unit')->where('itemmaster_id', $row['item_id'])
									  ->where('unit_id', $row['unit_id'])
									  ->first();
									  
				if($item) {
					$qty = $row['quantity'];
						$packing = ($item->is_baseqty==1)?1:$item->packing;
						$baseqty = ($qty * $packing);
						DB::table('item_unit')
							->where('itemmaster_id',  $row['item_id'])
							->where('is_baseqty',1)
							->update([ 'cur_quantity' => $item->cur_quantity - $baseqty,
										'issued_qty' => DB::raw('issued_qty + '.$baseqty) ]);
										
					if($item->is_baseqty==0){ 
						DB::table('item_unit')
								->where('id', $item->id)
								->update([ 'cur_quantity' => $item->cur_quantity - $qty,
											'issued_qty' => DB::raw('issued_qty + '.$qty) ]);
					}
						
				}
				//UPDATE ITEM QUANTITY END....
				
				//################ Location Stock Entry ####################
					$updated = false;
					//Item default location add...
					if(($location_id!='') && ($updated == false)) {
							
							$qtys = DB::table('item_location')->where('status',1)->where('location_id', $location_id)
															  ->where('item_id', $row['item_id'])->where('unit_id', $row['unit_id'])
													          ->whereNull('deleted_at')->select('id')->first();
							if($qtys) {
								DB::table('item_location')->where('id', $qtys->id)->update(['quantity' => DB::raw('quantity - '.$row['quantity']) ]);
							} else {
									$itemLocation = new ItemLocation();
									$itemLocation->location_id = $location_id;
									$itemLocation->item_id = $row['item_id'];
									$itemLocation->unit_id = $row['unit_id'];
									$itemLocation->quantity = $row['quantity'];
									$itemLocation->status = 1;
									$itemLocation->save();
								}
								
							$itemLocationSI = new ItemLocationSI();
							$itemLocationSI->location_id = $location_id;
							$itemLocationSI->item_id = $row['item_id'];
							$itemLocationSI->unit_id = $row['unit_id'];
							$itemLocationSI->quantity = $row['quantity'];
							$itemLocationSI->status = 1;
							$itemLocationSI->invoice_id = $sales_invoice_id;
							$itemLocationSI->save();
							
						}
					//################ Location Stock Entry End ####################
				}
				
			//ACCOUNT TRANSACTIONS....
			$invoice_id = $attributes['invoice_id'];
			$attributes = $attributes['invoice'];
			$attributes['dr_account_id'] = $customer->account_id;
			$attributes['voucher_no'] = $voucher->voucher_no;
			$attributes['cr_account_id'] = $attributes['supplier_id'];
			
			//Debit Customer Account
			if( $this->setAccountTransaction($attributes, $attributes['net_total'], $sales_invoice_id, $type='Dr', $amount_type='NTAMT') ) {
				
				//Credit Sales A/c
				if( $this->setAccountTransaction($attributes, $attributes['subtotal'], $sales_invoice_id, $type='Cr', $amount_type='LNTOTAL') ) {
					
					//Credit VAT output
					if( $this->setAccountTransaction($attributes, $attributes['vat_amount'], $sales_invoice_id, $type='Cr', $amount_type='VAT') ) {
						
						//Discount 
						$this->setAccountTransaction($attributes, $discount=0, $sales_invoice_id, $type='Dr', $amount_type='DIS');
					}
				}
			}
		
			
			//update voucher no........
			 DB::table('account_setting')
				->where('id', $voucher->id)
				->update(['voucher_no' => $voucher->voucher_no + 1 ]);
			
			//UPDATE STATUS...
			$response = Curl::to($this->api_url.'pilog-process.php')
						->withData( array('id' => $invoice_id,'location_id' => $location_id))
						->asJson()
						->put();
				
		}
		
		return true;
		
	}
	
	
	public function get_trnno($name)
	{
		$result = $this->sales_invoice->where('customer_name', $name)->select('customer_trn','customer_phone')->first();
		
		if(!$result) {
			$result = DB::table('account_master')->where('master_name', $name)->select('vat_no AS customer_trn','phone AS customer_phone')->first();
		}
		
		return $result;
	}
	
	public function getCustHistory($customer)
	{
		$query = $this->sales_invoice->where('sales_invoice.customer_name',$customer)->where('sales_invoice.status',1);
		
		return $query->join('sales_invoice_item AS poi', function($join) {
							$join->on('poi.sales_invoice_id','=','sales_invoice.id');
						} )
					  ->join('units AS u', function($join){
						  $join->on('u.id','=','poi.unit_id');
					  }) 
					  ->join('itemmaster AS im', function($join){
						  $join->on('im.id','=','poi.item_id');
					  })
					  ->where('poi.status',1)
					  ->select('poi.*','u.unit_name','im.item_code','sales_invoice.voucher_date','sales_invoice.voucher_no','sales_invoice.reference_no')->get();
	}
	
	public function getCustomerSearch($search)
	{
		$qry1 = DB::table('account_master')->where('category', 'CUSTOMER')
								   ->where('master_name','LIKE','%'.$search.'%')
								   ->where('status',1)->whereNull('deleted_at')
								   ->select('master_name AS customer','vat_no AS trnno','phone AS phone');
								   
		$qry2 = DB::table('sales_invoice')->where('customer_name','LIKE','%'.$search.'%')
					->where('status',1)->whereNull('deleted_at')
					->select('customer_name AS customer','customer_trn AS trnno','customer_phone AS phone');
					
		return $qry1->union($qry2)->get();
	}
	
	private function updateClosingBalance($account_id, $amount, $type, $voucher_type=null)
	{
		if($type=='Dr') {
			
			$this->objUtility->tallyClosingBalance($account_id);
			/* DB::table('account_master')
						->where('id', $account_id)
						->update(['cl_balance' => DB::raw('cl_balance + '.$amount)
						]); */
						
		} else if($type=='Cr') {
			
			$this->objUtility->tallyClosingBalance($account_id);
			
			if($voucher_type=='PDCR') {
				DB::table('account_master')
							->where('id', $account_id)
							->update([//'cl_balance' => DB::raw('cl_balance - '.$amount),
									  'pdc_amount' => DB::raw('pdc_amount + '.$amount)
							]);
			} 
		}
		
		
		return true;
	}
	
	private function setAccountTransactionRV($attributes, $voucher_id, $type, $key=null)
	{ 
		
			if($type=='Cr') {
				$account_master_id = $attributes['dr_account_id'];
				$amount = $attributes['rv_amount_cr'];
				$referencefrm = $attributes['voucher_no'];
				
			} else {
				$account_master_id = $attributes['rv_dr_account_id'][$key];
				$amount = $attributes['rv_amount'][$key];
				$referencefrm = $attributes['voucher_no'];
			}
			
			DB::table('account_transaction')
					->insert([  'voucher_type' 		=> 'RV',
								'voucher_type_id'   => $voucher_id,
								'account_master_id' => $account_master_id,
								'transaction_type'  => $type,
								'amount'   			=> $amount,
								'status' 			=> 1,
								'created_at' 		=> now(),
								'created_by' 		=> Auth::User()->id,
								'description' 		=> (isset($attributes['description']))?$attributes['description']:'',
								'reference'			=> $attributes['rv_voucherno'],
								'invoice_date'		=> ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
								'reference_from'	=> $referencefrm
							]);
			
		
		return true;
	}
	
	private function setAccountTransactionRVUpdate($attributes, $voucher_id, $type, $key=null)
	{ 
		
			if($type=='Cr') {
				$account_master_id = $attributes['dr_account_id'];
				$amount = $attributes['rv_amount'];
				$referencefrm = $attributes['voucher_no'];
				
			} else {
				$account_master_id = $attributes['rv_dr_account_id'];
				$amount = $attributes['rv_amount'];
				$referencefrm = $attributes['voucher_no'];
			}
			
			DB::table('account_transaction')
					->where('voucher_type', 'RV')
					->where('voucher_type_id', $voucher_id)
					->where('account_master_id', $account_master_id)
					->where('transaction_type', $type)
					->update([  'amount'   			=> $amount,
								'modify_at' 		=> now(),
								'modify_by' 		=> Auth::User()->id,
								'description' 		=> (isset($attributes['description']))?$attributes['description']:'',
								'reference'			=> $attributes['rv_voucher_no'],
								'invoice_date'		=> ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
								'reference_from'	=> $referencefrm
							]);
			
		
		return true;
	}
	
	private function setAccountTransactionRVDelete($attributes, $voucher_id, $type, $key=null)
	{ 
		
			if($type=='Cr') {
				$account_master_id = $attributes['dr_account_id'];
				$amount = $attributes['rv_amount'];
				$referencefrm = $attributes['voucher_no'];
				
			} else {
				$account_master_id = $attributes['rv_dr_account_id'];
				$amount = $attributes['rv_amount'];
				$referencefrm = $attributes['voucher_no'];
			}
			
			DB::table('account_transaction')
					->where('voucher_type', 'RV')
					->where('voucher_type_id', $voucher_id)
					->where('account_master_id', $account_master_id)
					->where('transaction_type', $type)
					->update([  'status' => 0,
								'deleted_at' => now()
							]);
			
		
		return true;
	}
	
	public function getCustHistoryPhone($phone)
	{
		$query = $this->sales_invoice->where('sales_invoice.customer_phone',$phone)->where('sales_invoice.status',1);
		
		return $query->join('sales_invoice_item AS poi', function($join) {
							$join->on('poi.sales_invoice_id','=','sales_invoice.id');
						} )
					  ->join('units AS u', function($join){
						  $join->on('u.id','=','poi.unit_id');
					  }) 
					  ->join('itemmaster AS im', function($join){
						  $join->on('im.id','=','poi.item_id');
					  })
					  ->where('poi.status',1)
					  ->select('poi.*','u.unit_name','im.item_code','sales_invoice.voucher_date','sales_invoice.voucher_no','sales_invoice.reference_no')->get();
	}
	
	public function getjobDescription($id)
	{
		return DB::table('jobinvoice_details')->where('jobinvoice_id',$id)->where('status',1)->whereNull('deleted_at')->get();
	}
	
	public function getVehHistory($vehicle_id)
	{
		$query = $this->sales_invoice->where('sales_invoice.vehicle_id',$vehicle_id)->where('sales_invoice.status',1);
		
		return $query->join('sales_invoice_item AS poi', function($join) {
							$join->on('poi.sales_invoice_id','=','sales_invoice.id');
						} )
					  ->join('units AS u', function($join){
						  $join->on('u.id','=','poi.unit_id');
					  }) 
					  ->join('itemmaster AS im', function($join){
						  $join->on('im.id','=','poi.item_id');
					  })
					  ->where('poi.status',1)
					  ->select('poi.*','u.unit_name','im.item_code','sales_invoice.voucher_date','sales_invoice.voucher_no','sales_invoice.kilometer')
					  ->orderBy('sales_invoice.voucher_no','DESC')->get();
	}

	public function getReportsales($attributes)
	{
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		
		$query = DB::table('sales_invoice')//$this->sales_invoice deleted_at
						->join('sales_invoice_item AS POI', function($join) {
							$join->on('POI.sales_invoice_id','=','sales_invoice.id');
						})
						->join('itemmaster AS IM', function($join) {
							$join->on('IM.id','=','POI.item_id');
						})
						->join('account_master AS AM', function($join) {
							$join->on('AM.id','=','sales_invoice.customer_id');
						})
						->join('account_setting AS AST', function($join) {
							$join->on('AST.id','=','sales_invoice.voucher_id');
						})
						->leftJoin('salesman AS S', function($join) {
							$join->on('S.id','=','sales_invoice.salesman_id');
						})
						->leftJoin('department AS D', function($join) {
							$join->on('D.id','=','sales_invoice.department_id');
								 //->where('sales_invoice.department_id','>',0);
						})
						->leftJoin('groupcat AS GP', function($join) {
							$join->on('GP.id','=','IM.group_id');
						})
						->leftJoin('groupcat AS SGP', function($join) {
							$join->on('GP.id','=','IM.subgroup_id');
						})
						->leftJoin('category AS CAT', function($join) {
							$join->on('CAT.id','=','IM.category_id');
						})
						->leftJoin('category AS SCAT', function($join) {
							$join->on('CAT.id','=','IM.subcategory_id');
						})
						->leftJoin('vehicle AS V', function($join) {
							$join->on('V.id','=','sales_invoice.vehicle_id');
						})
						->where('POI.status',1)
						->where('POI.deleted_at','0000-00-00 00:00-00')
						->where('sales_invoice.status',1)
						->where('sales_invoice.deleted_at','0000-00-00 00:00-00');
						
				if(isset($attributes['group_id']))
					$query->whereIn('IM.group_id', $attributes['group_id']);
				
				if(isset($attributes['subgroup_id']))
					$query->whereIn('IM.subgroup_id', $attributes['subgroup_id']);
				
				if(isset($attributes['category_id']))
					$query->whereIn('IM.category_id', $attributes['category_id']);
				
				if(isset($attributes['subcategory_id']))
					$query->whereIn('IM.subcategory_id', $attributes['subcategory_id']);
						
				if( $date_from!='' && $date_to!='' ) { 
					$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
				}
				
				if( $attributes['search_type']=='daily' ) { 
					$query->whereBetween( 'sales_invoice.voucher_date', array(date('Y-m-d'), date('Y-m-d')) );
				}
				
				/*if($attributes['salesman']!='') { 
					$query->where('sales_invoice.salesman_id', $attributes['salesman']);
				}*/
				if($attributes['salesman']!='') { 
					$query->where('sales_invoice.salesman_id', $attributes['salesman']);
				}
				
				if( $attributes['search_type']=='department') { 
					$query->where('sales_invoice.department_id','!=',0);
				}
		if(isset($attributes['customer_id']) && $attributes['customer_id']!='')
				$query->whereIn('sales_invoice.customer_id', $attributes['customer_id']);		
			

		if(isset($attributes['item_id']) && $attributes['item_id']!='')
					$query->whereIn('POI.item_id', $attributes['item_id']);	
				// if($attributes['vehicle_no']!='') { 
				// 	$query->where('V.reg_no', $attributes['vehicle_no']);//voucher_id subtotal
				// 'V.reg_no',}
				
		 $query->select('sales_invoice.voucher_no','AM.master_name AS customer','sales_invoice.reference_no','sales_invoice.customer_id','sales_invoice.total','sales_invoice.vat_amount','sales_invoice.subtotal',
							  'sales_invoice.amount_transfer','S.name AS salesman','sales_invoice.discount','AST.is_cash_voucher',
							  'POI.line_total','POI.item_total','POI.vat_amount','POI.item_name','POI.unit_price','POI.vat_amount','POI.discount','IM.description','sales_invoice.voucher_date','POI.item_id',
							  'POI.quantity','POI.balance_quantity','POI.unit_price','AM.account_id','AM.master_name','AM.vat_no',
							  'sales_invoice.net_total','POI.tax_code','D.name','sales_invoice.department_id','sales_invoice.document_id',
							  'POI.tax_include','IM.item_code','GP.group_name AS group','SGP.group_name AS subgroup','AST.voucher_name',
							  'CAT.category_name AS category','SCAT.category_name AS subcategory','sales_invoice.voucher_id');
								  
		if(isset($attributes['type']))
			return $query->groupBy('sales_invoice.id')->get()->toArray();
		else
			return $query->groupBy('sales_invoice.id')->get();
	}

	public function getReportsalesBkp($attributes)
	{
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		
		$query = DB::table('sales_invoice')//$this->sales_invoice deleted_at
						->join('sales_invoice_item AS POI', function($join) {
							$join->on('POI.sales_invoice_id','=','sales_invoice.id');
						})
						->join('itemmaster AS IM', function($join) {
							$join->on('IM.id','=','POI.item_id');
						})
						->join('account_master AS AM', function($join) {
							$join->on('AM.id','=','sales_invoice.customer_id');
						})
						->join('account_setting AS AST', function($join) {
							$join->on('AST.id','=','sales_invoice.voucher_id');
						})
						->leftJoin('salesman AS S', function($join) {
							$join->on('S.id','=','sales_invoice.salesman_id');
						})
						->leftJoin('department AS D', function($join) {
							$join->on('D.id','=','sales_invoice.department_id');
								 //->where('sales_invoice.department_id','>',0);
						})
						->leftJoin('groupcat AS GP', function($join) {
							$join->on('GP.id','=','IM.group_id');
						})
						->leftJoin('groupcat AS SGP', function($join) {
							$join->on('GP.id','=','IM.subgroup_id');
						})
						->leftJoin('category AS CAT', function($join) {
							$join->on('CAT.id','=','IM.category_id');
						})
						->leftJoin('category AS SCAT', function($join) {
							$join->on('CAT.id','=','IM.subcategory_id');
						})
						->leftJoin('vehicle AS V', function($join) {
							$join->on('V.id','=','sales_invoice.vehicle_id');
						})
						->where('POI.status',1)
						->where('POI.deleted_at','0000-00-00 00:00-00')
						->where('sales_invoice.status',1)
						->where('sales_invoice.deleted_at','0000-00-00 00:00-00');
						
				if(isset($attributes['group_id']))
					$query->whereIn('IM.group_id', $attributes['group_id']);
				
				if(isset($attributes['subgroup_id']))
					$query->whereIn('IM.subgroup_id', $attributes['subgroup_id']);
				
				if(isset($attributes['category_id']))
					$query->whereIn('IM.category_id', $attributes['category_id']);
				
				if(isset($attributes['subcategory_id']))
					$query->whereIn('IM.subcategory_id', $attributes['subcategory_id']);
						
				if( $date_from!='' && $date_to!='' ) { 
					$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
				}
				
				if( $attributes['search_type']=='daily' ) { 
					$query->whereBetween( 'sales_invoice.voucher_date', array(date('Y-m-d'), date('Y-m-d')) );
				}
				
				/*if($attributes['salesman']!='') { 
					$query->where('sales_invoice.salesman_id', $attributes['salesman']);
				}*/
				if($attributes['salesman']!='') { 
					$query->where('sales_invoice.salesman_id', $attributes['salesman']);
				}
				
				if( $attributes['search_type']=='department') { 
					$query->where('sales_invoice.department_id','!=',0);
				}
		if(isset($attributes['customer_id']) && $attributes['customer_id']!='')
				$query->whereIn('sales_invoice.customer_id', $attributes['customer_id']);		
			

		if(isset($attributes['item_id']) && $attributes['item_id']!='')
					$query->whereIn('POI.item_id', $attributes['item_id']);	
				// if($attributes['vehicle_no']!='') { 
				// 	$query->where('V.reg_no', $attributes['vehicle_no']);//voucher_id subtotal
				// 'V.reg_no',}
				
		 $query->select('sales_invoice.voucher_no','AM.master_name AS customer','sales_invoice.reference_no','sales_invoice.customer_id','sales_invoice.total','sales_invoice.vat_amount','sales_invoice.subtotal',
							  'sales_invoice.amount_transfer','S.name AS salesman','sales_invoice.discount','AST.is_cash_voucher',
							  'POI.line_total','POI.item_total','POI.vat_amount','POI.item_name','POI.unit_price','POI.vat_amount','POI.discount','IM.description','sales_invoice.voucher_date','POI.item_id',
							  'POI.quantity','POI.balance_quantity','POI.unit_price','AM.account_id','AM.master_name','AM.vat_no',
							  'sales_invoice.net_total','POI.tax_code','D.name','sales_invoice.department_id','sales_invoice.document_id',
							  'POI.tax_include','IM.item_code','GP.group_name AS group','SGP.group_name AS subgroup','AST.voucher_name',
							  'CAT.category_name AS category','SCAT.category_name AS subcategory','sales_invoice.voucher_id');
								  
		if(isset($attributes['type']))
			return $query->groupBy('sales_invoice.id')->get()->toArray();
		else
			return $query->groupBy('sales_invoice.id')->get();
	}

	public function getReportsalesinvo($attributes)
	{

		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		
		$query = DB::table('sales_invoice')//$this->sales_invoice deleted_at
						->join('sales_invoice_item AS POI', function($join) {
							$join->on('POI.sales_invoice_id','=','sales_invoice.id');
						})
						->join('itemmaster AS IM', function($join) {
							$join->on('IM.id','=','POI.item_id');
						})
						->join('account_master AS AM', function($join) {
							$join->on('AM.id','=','sales_invoice.customer_id');
						})
						->join('account_setting AS AST', function($join) {
							$join->on('AST.id','=','sales_invoice.voucher_id');
						})
						->leftJoin('salesman AS S', function($join) {
							$join->on('S.id','=','sales_invoice.salesman_id');
						})
						->leftJoin('department AS D', function($join) {
							$join->on('D.id','=','sales_invoice.department_id');
								 //->where('sales_invoice.department_id','>',0);
						})
						->leftJoin('groupcat AS GP', function($join) {
							$join->on('GP.id','=','IM.group_id');
						})
						->leftJoin('groupcat AS SGP', function($join) {
							$join->on('GP.id','=','IM.subgroup_id');
						})
						->leftJoin('category AS CAT', function($join) {
							$join->on('CAT.id','=','IM.category_id');
						})
						->leftJoin('category AS SCAT', function($join) {
							$join->on('CAT.id','=','IM.subcategory_id');
						})
						->leftJoin('vehicle AS V', function($join) {
							$join->on('V.id','=','sales_invoice.vehicle_id');
						})
						->where('POI.status',1)
						->where('POI.deleted_at','0000-00-00 00:00-00')
						->where('sales_invoice.status',1)
						->where('sales_invoice.is_rental',0)
						->where('sales_invoice.deleted_at','0000-00-00 00:00-00');
						
				if(isset($attributes['group_id']))
					$query->whereIn('IM.group_id', $attributes['group_id']);
				
				if(isset($attributes['subgroup_id']))
					$query->whereIn('IM.subgroup_id', $attributes['subgroup_id']);
				
				if(isset($attributes['category_id']))
					$query->whereIn('IM.category_id', $attributes['category_id']);
				
				if(isset($attributes['subcategory_id']))
					$query->whereIn('IM.subcategory_id', $attributes['subcategory_id']);
						
				if( $date_from!='' && $date_to!='' ) { 
					$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
				}
				
				if( $attributes['search_type']=='daily' ) { 
					$query->whereBetween( 'sales_invoice.voucher_date', array(date('Y-m-d'), date('Y-m-d')) );
				}
				
				if(isset($attributes['dept_id']) && $attributes['dept_id']!='') { 
					$query->whereIn('sales_invoice.department_id', $attributes['dept_id']);
				}
				if($attributes['salesman']!='') { 
					$query->where('sales_invoice.salesman_id', $attributes['salesman']);
				}
				
				if( $attributes['search_type']=='department') { 
					$query->where('sales_invoice.department_id','!=',0);
				}
		if(isset($attributes['customer_id']) && $attributes['customer_id']!='')
				$query->whereIn('sales_invoice.customer_id', $attributes['customer_id']);
				
		if(isset($attributes['job_id']) && $attributes['job_id']!='')
				$query->whereIn('sales_invoice.job_id', $attributes['job_id']);	

		if(isset($attributes['item_id']) && $attributes['item_id']!='')
					$query->whereIn('POI.item_id', $attributes['item_id']);	

					$query->select('sales_invoice.voucher_no','AM.master_name AS customer','sales_invoice.reference_no','sales_invoice.customer_id','sales_invoice.total','sales_invoice.vat_amount AS vat_total','sales_invoice.subtotal',
					'sales_invoice.amount_transfer','S.name AS salesman','sales_invoice.discount AS disc','AST.is_cash_voucher',
					'POI.line_total','POI.item_total','POI.vat_amount','POI.item_name','POI.unit_price','POI.vat_amount','POI.discount','IM.description','sales_invoice.voucher_date','POI.item_id',
					'POI.quantity','POI.balance_quantity','POI.unit_price','AM.account_id','AM.master_name','AM.vat_no',
					'sales_invoice.net_total','POI.tax_code','D.name','sales_invoice.department_id','sales_invoice.document_id',
					'POI.tax_include','IM.item_code','GP.group_name AS group','SGP.group_name AS subgroup','AST.voucher_name',
					'CAT.category_name AS category','SCAT.category_name AS subcategory','sales_invoice.voucher_id');			

	if(isset($attributes['type']))
		return $query->groupBy('sales_invoice.id')->orderBy('sales_invoice.voucher_no', 'ASC')->get()->toArray();
	elseif(isset($attributes['search_type']) && $attributes['search_type']=='detail')
		return $query->orderBy('sales_invoice.voucher_no', 'ASC')->get();
		else
		return $query->groupBy('sales_invoice.id')->orderBy('sales_invoice.voucher_no', 'ASC')->get();
}

	public function getReportsalesinvoBkp($attributes)
	{

		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		
		$query = DB::table('sales_invoice')//$this->sales_invoice deleted_at
						->join('sales_invoice_item AS POI', function($join) {
							$join->on('POI.sales_invoice_id','=','sales_invoice.id');
						})
						->join('itemmaster AS IM', function($join) {
							$join->on('IM.id','=','POI.item_id');
						})
						->join('account_master AS AM', function($join) {
							$join->on('AM.id','=','sales_invoice.customer_id');
						})
						->join('account_setting AS AST', function($join) {
							$join->on('AST.id','=','sales_invoice.voucher_id');
						})
						->leftJoin('salesman AS S', function($join) {
							$join->on('S.id','=','sales_invoice.salesman_id');
						})
						->leftJoin('department AS D', function($join) {
							$join->on('D.id','=','sales_invoice.department_id');
								 //->where('sales_invoice.department_id','>',0);
						})
						->leftJoin('groupcat AS GP', function($join) {
							$join->on('GP.id','=','IM.group_id');
						})
						->leftJoin('groupcat AS SGP', function($join) {
							$join->on('GP.id','=','IM.subgroup_id');
						})
						->leftJoin('category AS CAT', function($join) {
							$join->on('CAT.id','=','IM.category_id');
						})
						->leftJoin('category AS SCAT', function($join) {
							$join->on('CAT.id','=','IM.subcategory_id');
						})
						->leftJoin('vehicle AS V', function($join) {
							$join->on('V.id','=','sales_invoice.vehicle_id');
						})
						->where('POI.status',1)
						->where('POI.deleted_at','0000-00-00 00:00-00')
						->where('sales_invoice.status',1)
						->where('sales_invoice.deleted_at','0000-00-00 00:00-00');
						
				if(isset($attributes['group_id']))
					$query->whereIn('IM.group_id', $attributes['group_id']);
				
				if(isset($attributes['subgroup_id']))
					$query->whereIn('IM.subgroup_id', $attributes['subgroup_id']);
				
				if(isset($attributes['category_id']))
					$query->whereIn('IM.category_id', $attributes['category_id']);
				
				if(isset($attributes['subcategory_id']))
					$query->whereIn('IM.subcategory_id', $attributes['subcategory_id']);
						
				if( $date_from!='' && $date_to!='' ) { 
					$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
				}
				
				if( $attributes['search_type']=='daily' ) { 
					$query->whereBetween( 'sales_invoice.voucher_date', array(date('Y-m-d'), date('Y-m-d')) );
				}
				
				/*if($attributes['salesman']!='') { 
					$query->where('sales_invoice.salesman_id', $attributes['salesman']);
				}*/
				if($attributes['salesman']!='') { 
					$query->where('sales_invoice.salesman_id', $attributes['salesman']);
				}
				
				if( $attributes['search_type']=='department') { 
					$query->where('sales_invoice.department_id','!=',0);
				}
		if(isset($attributes['customer_id']) && $attributes['customer_id']!='')
				$query->whereIn('sales_invoice.customer_id', $attributes['customer_id']);		
			

		if(isset($attributes['item_id']) && $attributes['item_id']!='')
					$query->whereIn('POI.item_id', $attributes['item_id']);	

					$query->select('sales_invoice.voucher_no','AM.master_name AS customer','sales_invoice.reference_no','sales_invoice.customer_id','sales_invoice.total','sales_invoice.vat_amount AS vat_total','sales_invoice.subtotal',
					'sales_invoice.amount_transfer','S.name AS salesman','sales_invoice.discount AS disc','AST.is_cash_voucher',
					'POI.line_total','POI.item_total','POI.vat_amount','POI.item_name','POI.unit_price','POI.vat_amount','POI.discount','IM.description','sales_invoice.voucher_date','POI.item_id',
					'POI.quantity','POI.balance_quantity','POI.unit_price','AM.account_id','AM.master_name','AM.vat_no',
					'sales_invoice.net_total','POI.tax_code','D.name','sales_invoice.department_id','sales_invoice.document_id',
					'POI.tax_include','IM.item_code','GP.group_name AS group','SGP.group_name AS subgroup','AST.voucher_name',
					'CAT.category_name AS category','SCAT.category_name AS subcategory','sales_invoice.voucher_id');			

	if(isset($attributes['type']))
		return $query->groupBy('sales_invoice.id')->get()->toArray();
	else
		return $query->groupBy('sales_invoice.id')->get();
}
		   
 
public function getReportVehicle($attributes)
	{
		//echo '<pre>';print_r($attributes);exit;
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		
		$query = DB::table('sales_invoice')//$this->sales_invoice deleted_at
						->join('sales_invoice_item AS POI', function($join) {
							$join->on('POI.sales_invoice_id','=','sales_invoice.id');
						})
						->join('itemmaster AS IM', function($join) {
							$join->on('IM.id','=','POI.item_id');
						})
						->join('account_master AS AM', function($join) {
							$join->on('AM.id','=','sales_invoice.customer_id');
						})
						->join('account_setting AS AST', function($join) {
							$join->on('AST.id','=','sales_invoice.voucher_id');
						})
						->leftJoin('sales_order AS SO', function($join) {
							$join->on('SO.id','=','sales_invoice.document_id');
						} )
						->leftJoin('salesman AS S', function($join) {
							$join->on('S.id','=','sales_invoice.salesman_id');
						})
						->leftJoin('department AS D', function($join) {
							$join->on('D.id','=','sales_invoice.department_id');
								 //->where('sales_invoice.department_id','>',0);
						})
						->leftJoin('groupcat AS GP', function($join) {
							$join->on('GP.id','=','IM.group_id');
						})
						->leftJoin('groupcat AS SGP', function($join) {
							$join->on('GP.id','=','IM.subgroup_id');
						})
						->leftJoin('category AS CAT', function($join) {
							$join->on('CAT.id','=','IM.category_id');
						})
						->leftJoin('category AS SCAT', function($join) {
							$join->on('CAT.id','=','IM.subcategory_id');
						})
						->leftJoin('vehicle AS V', function($join) {
							$join->on('V.id','=','sales_invoice.vehicle_id');
						})
						->where('POI.status',1)
						->where('POI.deleted_at','0000-00-00 00:00-00')
						->where('sales_invoice.status',1)
						->where('sales_invoice.is_rental',2)
						->where('sales_invoice.deleted_at','0000-00-00 00:00-00');
						
				if(isset($attributes['group_id']))
					$query->whereIn('IM.group_id', $attributes['group_id']);
				
				if(isset($attributes['subgroup_id']))
					$query->whereIn('IM.subgroup_id', $attributes['subgroup_id']);
				
				if(isset($attributes['category_id']))
					$query->whereIn('IM.category_id', $attributes['category_id']);
				
				if(isset($attributes['subcategory_id']))
					$query->whereIn('IM.subcategory_id', $attributes['subcategory_id']);
						
				if( $date_from!='' && $date_to!='' ) { 
					$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
				}
				
				if( $attributes['search_type']=='daily' ) { 
					$query->whereBetween( 'sales_invoice.voucher_date', array(date('Y-m-d'), date('Y-m-d')) );
				}
				if(isset($attributes['customer_id']) && $attributes['customer_id']!='')
				$query->whereIn('sales_invoice.customer_id', $attributes['customer_id']);		
			

		if(isset($attributes['item_id']) && $attributes['item_id']!='')
					$query->whereIn('POI.item_id', $attributes['item_id']);	

		if(isset($attributes['salesman_id']) && $attributes['salesman_id']!='')
					$query->whereIn('sales_invoice.salesman_id', $attributes['salesman_id']);	
		
		 	
				
				if( $attributes['search_type']=='department') { 
					$query->where('sales_invoice.department_id','!=',0);
				}
				
				if($attributes['vehicle_no']!='') { 
					$query->where('V.reg_no', $attributes['vehicle_no']);//voucher_id subtotal
				}
		$query->select('sales_invoice.voucher_no','sales_invoice.id','sales_invoice.reference_no','AM.master_name AS customer','sales_invoice.total','sales_invoice.vat_amount','sales_invoice.subtotal',
							  'sales_invoice.amount_transfer','S.name AS salesman','sales_invoice.discount','AST.is_cash_voucher','sales_invoice.net_total',
							  'POI.line_total','POI.item_total','POI.vat_amount AS linevat ','IM.description','sales_invoice.voucher_date','POI.item_id',
							  'POI.quantity','POI.balance_quantity','POI.unit_price','AM.account_id','AM.master_name','AM.vat_no','SO.voucher_no AS jo_no' ,
							  'POI.tax_include','IM.item_code','GP.group_name AS group','SGP.group_name AS subgroup','AST.voucher_name','POI.discount as linediscount',
							  'CAT.category_name AS category','SCAT.category_name AS subcategory','V.reg_no','sales_invoice.voucher_id');
							  
		 /* $query->select('sales_invoice.voucher_no','sales_invoice.id','sales_invoice.reference_no','AM.master_name AS customer','sales_invoice.total','sales_invoice.vat_amount','sales_invoice.subtotal',
							  'sales_invoice.amount_transfer','S.name AS salesman','sales_invoice.discount','AST.is_cash_voucher','sales_invoice.net_total',
							  'POI.line_total','POI.item_total','POI.vat_amount','IM.description','sales_invoice.voucher_date','POI.item_id',
							  'POI.quantity','POI.balance_quantity','POI.unit_price','AM.account_id','AM.master_name','AM.vat_no','SO.voucher_no AS jo_no' ,
							  'POI.tax_include','IM.item_code','GP.group_name AS group','SGP.group_name AS subgroup','AST.voucher_name',
							  'CAT.category_name AS category','SCAT.category_name AS subcategory','V.reg_no','sales_invoice.voucher_id'); */
				
				
			if($attributes['search_type']=='summary'){	
			    return $query->groupBy('sales_invoice.id')->get();
			}else{
			return $query->get();//->groupBy('sales_invoice.id')
			}
		
	}
public function getPendingJobs($attributes)
	{
		//echo '<pre>';print_r($attributes);exit;
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		
		$query = DB::table('sales_invoice')//$this->sales_invoice deleted_at
		->join('sales_invoice_item AS POI', function($join) {
			$join->on('POI.sales_invoice_id','=','sales_invoice.id');
		})
		->join('itemmaster AS IM', function($join) {
			$join->on('IM.id','=','POI.item_id');
		})
		->join('account_master AS AM', function($join) {
			$join->on('AM.id','=','sales_invoice.customer_id');
		})
		->join('account_setting AS AST', function($join) {
			$join->on('AST.id','=','sales_invoice.voucher_id');
		})
		->leftJoin('salesman AS S', function($join) {
			$join->on('S.id','=','sales_invoice.salesman_id');
		})
		->leftJoin('department AS D', function($join) {
			$join->on('D.id','=','sales_invoice.department_id');
				 //->where('sales_invoice.department_id','>',0);
		})
		->leftJoin('sales_order AS SO', function($join) {
			$join->on('SO.id','=','sales_invoice.document_id');
		} )
		->leftJoin('groupcat AS GP', function($join) {
			$join->on('GP.id','=','IM.group_id');
		})
		->leftJoin('groupcat AS SGP', function($join) {
			$join->on('GP.id','=','IM.subgroup_id');
		})
		->leftJoin('category AS CAT', function($join) {
			$join->on('CAT.id','=','IM.category_id');
		})
		->leftJoin('category AS SCAT', function($join) {
			$join->on('CAT.id','=','IM.subcategory_id');
		})
		->leftJoin('vehicle AS V', function($join) {
			$join->on('V.id','=','sales_invoice.vehicle_id');
		})
		->where('POI.status',1)
		->where('POI.deleted_at','0000-00-00 00:00-00')
		->where('sales_invoice.status',1)
		->whereIn('poi.is_transfer',[0,2])
		->where('sales_invoice.deleted_at','0000-00-00 00:00-00');
		
if(isset($attributes['group_id']))
	$query->whereIn('IM.group_id', $attributes['group_id']);

if(isset($attributes['subgroup_id']))
	$query->whereIn('IM.subgroup_id', $attributes['subgroup_id']);

if(isset($attributes['category_id']))
	$query->whereIn('IM.category_id', $attributes['category_id']);

if(isset($attributes['subcategory_id']))
	$query->whereIn('IM.subcategory_id', $attributes['subcategory_id']);
		
if( $date_from!='' && $date_to!='' ) { 
	$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
}

if( $attributes['search_type']=='daily' ) { 
	$query->whereBetween( 'sales_invoice.voucher_date', array(date('Y-m-d'), date('Y-m-d')) );
}
if(isset($attributes['customer_id']) && $attributes['customer_id']!='')
$query->whereIn('sales_invoice.customer_id', $attributes['customer_id']);		

if(isset($attributes['item_id']) && $attributes['item_id']!='')
	$query->whereIn('POI.item_id', $attributes['item_id']);	
 
//if($attributes['salesman_id']!='') { 
///	$query->where('sales_invoice.salesman_id', $attributes['salesman_id']);
//}

if(isset($attributes['salesman_id']) && $attributes['salesman_id']!='')
	$query->whereIn('sales_invoice.salesman_id', $attributes['salesman_id']);	
	
if( $attributes['search_type']=='department') { 
	$query->where('sales_invoice.department_id','!=',0);
}

if($attributes['vehicle_no']!='') { 
	$query->where('V.reg_no', $attributes['vehicle_no']);//voucher_id subtotal
}
    $query->select('sales_invoice.voucher_no','sales_invoice.reference_no','AM.master_name AS customer','sales_invoice.total','sales_invoice.vat_amount','sales_invoice.subtotal',
                'sales_invoice.amount_transfer','S.name AS salesman','sales_invoice.discount','AST.is_cash_voucher','POI.is_transfer',
                'POI.line_total','POI.item_total','SO.voucher_no AS jo_no' ,'POI.vat_amount','IM.description','sales_invoice.voucher_date','POI.item_id',
                     'POI.quantity','POI.balance_quantity','POI.unit_price','AM.account_id','AM.master_name','AM.vat_no',
               'sales_invoice.net_total','POI.tax_code','D.name','sales_invoice.department_id','sales_invoice.document_id',
                'POI.tax_include','IM.item_code','GP.group_name AS group','SGP.group_name AS subgroup','AST.voucher_name',
              'CAT.category_name AS category','SCAT.category_name AS subcategory','V.reg_no','sales_invoice.voucher_id');
  if( $attributes['search_type']=='job_order' )
			 $query->groupBy('sales_invoice.id');
				
							 
			return $query->get();
		
					  
	}	
	public function getclosedJobs($attributes)
	{
		//echo '<pre>';print_r($attributes);exit;
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		
		$query = DB::table('sales_invoice')//$this->sales_invoice deleted_at
		->join('sales_invoice_item AS POI', function($join) {
			$join->on('POI.sales_invoice_id','=','sales_invoice.id');
		})
		->join('itemmaster AS IM', function($join) {
			$join->on('IM.id','=','POI.item_id');
		})
		->join('account_master AS AM', function($join) {
			$join->on('AM.id','=','sales_invoice.customer_id');
		})
		
		->join('account_setting AS AST', function($join) {
			$join->on('AST.id','=','sales_invoice.voucher_id');
		})
		->leftJoin('sales_order AS SO', function($join) {
			$join->on('SO.id','=','sales_invoice.document_id');
		} )
		->leftJoin('salesman AS S', function($join) {
			$join->on('S.id','=','sales_invoice.salesman_id');
		})
		->leftJoin('department AS D', function($join) {
			$join->on('D.id','=','sales_invoice.department_id');
				 //->where('sales_invoice.department_id','>',0);
		})
		->leftJoin('groupcat AS GP', function($join) {
			$join->on('GP.id','=','IM.group_id');
		})
		->leftJoin('groupcat AS SGP', function($join) {
			$join->on('GP.id','=','IM.subgroup_id');
		})
		->leftJoin('category AS CAT', function($join) {
			$join->on('CAT.id','=','IM.category_id');
		})
		->leftJoin('category AS SCAT', function($join) {
			$join->on('CAT.id','=','IM.subcategory_id');
		})
		->leftJoin('vehicle AS V', function($join) {
			$join->on('V.id','=','sales_invoice.vehicle_id');
		})
		->where('POI.status',1)
		->where('POI.deleted_at','0000-00-00 00:00-00')
		->where('sales_invoice.status',1)
		->whereIn('POI.is_transfer',[1])
		->where('sales_invoice.deleted_at','0000-00-00 00:00-00');
		
if(isset($attributes['group_id']))
	$query->whereIn('IM.group_id', $attributes['group_id']);

if(isset($attributes['subgroup_id']))
	$query->whereIn('IM.subgroup_id', $attributes['subgroup_id']);

if(isset($attributes['category_id']))
	$query->whereIn('IM.category_id', $attributes['category_id']);

if(isset($attributes['subcategory_id']))
	$query->whereIn('IM.subcategory_id', $attributes['subcategory_id']);
		
if( $date_from!='' && $date_to!='' ) { 
	$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
}

if( $attributes['search_type']=='daily' ) { 
	$query->whereBetween( 'sales_invoice.voucher_date', array(date('Y-m-d'), date('Y-m-d')) );
}
if(isset($attributes['customer_id']) && $attributes['customer_id']!='')
$query->whereIn('sales_invoice.customer_id', $attributes['customer_id']);		

if(isset($attributes['item_id']) && $attributes['item_id']!='')
	$query->whereIn('POI.item_id', $attributes['item_id']);

//if($attributes['salesman_id']!='') { 
 	//$query->whereIn('sales_invoice.salesman_id', $attributes['salesman']);
//}
if(isset($attributes['salesman_id']) && $attributes['salesman_id']!='')
	$query->whereIn('sales_invoice.salesman_id', $attributes['salesman_id']);
	
	
if( $attributes['search_type']=='department') { 
	$query->where('sales_invoice.department_id','!=',0);
}

if($attributes['vehicle_no']!='') { 
	$query->where('V.reg_no', $attributes['vehicle_no']);//voucher_id subtotal
}
    $query->select('sales_invoice.voucher_no','sales_invoice.reference_no','AM.master_name AS customer','sales_invoice.total','sales_invoice.vat_amount','sales_invoice.subtotal',
                'sales_invoice.amount_transfer','S.name AS salesman','sales_invoice.discount','AST.is_cash_voucher','POI.is_transfer',
                'POI.line_total','POI.item_total','POI.vat_amount','IM.description','sales_invoice.voucher_date','POI.item_id',
                     'POI.quantity','POI.balance_quantity','SO.voucher_no AS jo_no' ,'POI.unit_price','AM.account_id','AM.master_name','AM.vat_no',
               'sales_invoice.net_total','POI.tax_code','D.name','sales_invoice.department_id','sales_invoice.document_id',
                'POI.tax_include','IM.item_code','GP.group_name AS group','SGP.group_name AS subgroup','AST.voucher_name',
              'CAT.category_name AS category','SCAT.category_name AS subcategory','V.reg_no','sales_invoice.voucher_id');
  if( $attributes['search_type']=='job_order' )
			 $query->groupBy('sales_invoice.id');
				
							 
			return $query->get();
		
					  
	}	
	public function getCustomerIitems($id, $attributes)
	{
		
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		$query = $this->sales_invoice->where('sales_invoice.customer_id',$id);
		
		$query->join('account_master AS AM', function($join) {
							$join->on('AM.id','=','sales_invoice.customer_id');
						})
					->join('sales_invoice_item AS poi', function($join) {
							$join->on('poi.sales_invoice_id','=','sales_invoice.id');
					  })
					  ->join('units AS u', function($join){
						  $join->on('u.id','=','poi.unit_id');
					  }) 
					   ->join('item_unit AS iu', function($join){
						  $join->on('iu.unit_id','=','poi.unit_id')
							   ->on('iu.itemmaster_id','=','poi.item_id');
					  })
					  ->join('itemmaster AS im', function($join){
						  $join->on('im.id','=','poi.item_id');
					  })
					  ->where('poi.status',1);
					  
				if($date_from!='' && $date_to!='')
					$query->whereBetween('sales_invoice.voucher_date', [$date_from, $date_to]);
					  
						
		return $query->select('poi.*','u.unit_name','im.item_code','iu.packing','iu.is_baseqty',
							 'sales_invoice.voucher_no','sales_invoice.voucher_date','AM.master_name')
					 ->groupBy('poi.id')
					 ->orderBY('poi.id')
					 ->get();
	}
	
	
	public function getTransactionList($attributes) 
	{
		//echo '<pre>';print_r($attributes);exit;
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		
		$qry = $this->sales_invoice
								   ->join('sales_invoice_item AS SI', function($join) {
									   $join->on('SI.sales_invoice_id','=','sales_invoice.id');
								   })
								   ->join('itemmaster AS IM', function($join) {
									   $join->on('IM.id','=','SI.item_id');
								   })
								   ->where('SI.status',1)
								   ->where('SI.deleted_at','0000-00-00 00:00:00')
								   ->where('sales_invoice.status',1);
							
							if($date_from !='' && $date_to != '')	   
								$qry->whereBetween('sales_invoice.voucher_date',[$date_from, $date_to]);

					       /* if($attributes['search_by']=='Group')
						        $qry->where('IM.group_id','!=',0);
							
							if($attributes['search_by']=='Subgroup')
						        $qry->where('IM.subgroup_id','!=',0);
								
							if($attributes['search_by']=='Category')
						        $qry->where('IM.category_id','!=',0);

							if($attributes['search_by']=='Subcategory')
						        $qry->where('IM.subcategory_id','!=',0);*/

		$result = $qry->select('sales_invoice.id','sales_invoice.voucher_no','sales_invoice.voucher_date',
								'IM.item_code','IM.description','SI.quantity','SI.unit_price','SI.vat_amount','SI.line_total AS total_price')
								   ->orderBY('sales_invoice.voucher_date', 'ASC')
								   ->get();
								   
		return $result;
	}
	
	public function salesInvoiceSRListCount($dept=null)
	{
		$query = $this->sales_invoice->where('sales_invoice.status',1)->where('sales_invoice.is_transfer',0);
		if($dept)
			$query->where('sales_invoice.department_id', $dept);
				
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.customer_id');
						} )
					->count();
	}
	
	public function salesInvoiceSRList($type,$start,$limit,$order,$dir,$search, $dept=null)
	{
		$query = $this->sales_invoice->where('sales_invoice.status',1)->where('sales_invoice.is_transfer',0)
						->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.customer_id');
						} )
						->leftJoin('sales_order AS SO', function($join) {
							$join->on('SO.id','=','sales_invoice.document_id');
						} )
						->leftJoin('vehicle AS V', function($join) {
							$join->on('V.id','=','sales_invoice.vehicle_id');
						} );
				if($dept && $dept!=null)
					$query->where('sales_invoice.department_id', $dept);
				
				if($search) {
					
					$query->where(function($qry) use($search) {
						$date = date('Y-m-d', strtotime($search));
						$qry->where('sales_invoice.voucher_no','LIKE',"%{$search}%")
							->orWhere('am.master_name', 'LIKE',"%{$search}%")
							->orWhere('sales_invoice.voucher_date','LIKE',"%{$date}%");
					});
				}
				
				$query->select('sales_invoice.*','am.master_name AS customer','V.reg_no','V.name AS vehicle','SO.voucher_no AS jo_no')
					->offset($start)
                    ->limit($limit)
                    ->orderBy($order,$dir);
					
				if($type=='get')
					return $query->get();
				else
					return $query->count();
	}
	
	private function getVatAccounts($department_id=null) {
		
		if(Session::get('department')==1 && $department_id!=null) {
			$vatres = DB::table('vat_department')->where('department_id', $department_id)->first();
			if(!$vatres)
				$vatres = DB::table('vat_master')->where('status', 1)->whereNull('deleted_at')->first();
			return $vatres;
		} else {
			return DB::table('vat_master')->where('status', 1)->whereNull('deleted_at')->first();
		}
	}
	
	private function checkAndSetCostAccountingParameters($attributes) {
		
		if(Session::get('cost_accounting')==1 && Session::get('department')==1) { 
			$result = DB::table('department_accounts')->where('department_id', $attributes['department_id'])->select('stock_acid','cost_acid')->first();
			if($result){
				Session::put('stock', $result->stock_acid);
				Session::put('cost_of_sale', $result->cost_acid);
			} else {
				$result = DB::table('voucher_account')->whereIn('account_field', ['stock','cost_of_sale'])->select('account_id','account_field')->get();
				foreach($result as $res) {
					if($res->account_field=='stock')
						Session::put('stock', $res->stock_acid);
					else
						Session::put('cost_of_sale', $res->cost_acid);
						
				}
			}
		}
	}
	
	private function setSalesLogAssemblyItem($items, $qty, $attributes, $act) {
		
		$arritms = explode(',', $items);
		$arritmsqty = explode(',', $qty);
		foreach($arritms as $key => $item) {
			$itmattr = DB::table('item_unit')->where('itemmaster_id',$item)->select('unit_id','sell_price','cost_avg')->first();
			$sale_cost = $this->objUtility->updateItemQuantitySalesAssembly($item, $arritmsqty[$key]);
				$CostAvg_log = $this->objUtility->updateLastPurchaseCostAndCostAvgAssembly($item, $arritmsqty[$key], $itmattr, $attributes);
					$this->setSaleLogAssembly($item, $arritmsqty[$key], $itmattr, $CostAvg_log, $sale_cost, $this->sales_invoice->id, $act, $attributes);
										
		}
	}
	
	private function setSaleLogAssembly($itemid, $itmqty, $itmattr, $cost_avg, $sale_cost, $document_id, $action, $attributes) 
	{
		//CHECK ITEM UNIT QUANTITY AS 0
		$irow = DB::table('item_unit')->where('itemmaster_id', $itemid)->select('cur_quantity')->first();
		if($irow->cur_quantity == 0) {
			$stocks = DB::table('item_log')->where('item_id', $itemid)
								   ->where('trtype', 1)
								   ->where('status',1)->whereNull('deleted_at')
								   ->select('pur_cost','cur_quantity')
								   ->orderBy('id','DESC')->first();
								   
			$cost_avg = $stocks->pur_cost;
		}
		
		if($action=='add') {
			$cur_quantity = ($irow)?$irow->cur_quantity:0;			
			DB::table('item_log')->insert([
							 'document_type' => 'SI',
							 'document_id'   => $document_id,
							 'item_id' 	  => $itemid,
							 'unit_id'    => $itmattr->unit_id,
							 'quantity'   => $itmqty,
							 'unit_cost'  => (isset($attributes['is_fc']))?(($itmattr->sell_price==0)?$itmattr->cost_avg:$itmattr->sell_price)*$attributes['currency_rate']:(($itmattr->sell_price==0)?$itmattr->cost_avg:$itmattr->sell_price),
							 'trtype'	  => 0,
							 'cost_avg' => $cost_avg,
							 'pur_cost' => $sale_cost,
							 'sale_cost' => $sale_cost,
							 'packing' => 1,
							 'status'     => 1,
							 'created_at' => now(),
							 'created_by' => Auth::User()->id,
							 'voucher_date' => ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date'])),
							 'sale_reference' => $cur_quantity
							]);
			
		} else if($action=='update') {
				DB::table('item_log')->where('document_type','SI')
								->where('document_id', $document_id)
								->where('item_id', $itemid)
								->where('unit_id', $itmattr->unit_id)
								->update(['item_id' => $itemid,
									 'unit_id' => $itmattr->unit_id,
									 'quantity'   => $itmqty,
									 'unit_cost'  => (isset($attributes['is_fc']))?(($itmattr->sell_price==0)?$itmattr->cost_avg:$itmattr->sell_price)*$attributes['currency_rate']:(($itmattr->sell_price==0)?$itmattr->cost_avg:$itmattr->sell_price),
									 'cur_quantity' => $itmqty,
									 'cost_avg' => $cost_avg,
									 'pur_cost' => $sale_cost,
									 'sale_cost' => $sale_cost,
									 'voucher_date' => ($attributes['voucher_date']=='')?date('Y-m-d'):date('Y-m-d', strtotime($attributes['voucher_date']))
								]);
			
		}
		
		return true;
	}
	
	
	//APR25
	private function checkCDOLogs($attributes, $key) {
		
		$ids = explode(',', $attributes['document_id']);
		$row = DB::table('item_log')->where('document_type','CDO')
						->whereIn('document_id', $ids)
						->where('item_id',$attributes['item_id'][$key])
						->where('status',1)->whereNull('deleted_at')
						->select('id', DB::raw('SUM(quantity) AS quantity'))
						->groupBY('item_id')
						->first();
		
		//return ($row)?true:false;
		return $row;
	}
	
	//APR25
	private function checkCDOLogsOnUpdate($attributes, $key) {
		
		$ids = explode(',', $attributes['document_id']);
		$row = DB::table('item_log')->where('document_type','CDO')
						->whereIn('document_id', $ids)
						->where('item_id',$attributes['item_id'][$key])
						->select('id', DB::raw('SUM(quantity) AS quantity'))
						->groupBY('item_id')
						->first();
		
		//return ($row)?true:false;
		return $row;
	}
	
	//APR25
	public function updateLastPurchaseCostOnTransfer($attributes, $key, $type, $DOlogs)
	{
		
		$pids = explode(',', $attributes['document_id']);
		$other_cost = (isset($attributes['other_cost']))?$attributes['other_cost']:0;
		
		if($DOlogs->quantity==$attributes['quantity'][$key]) {
		    //DISABLE SDO TRANSACTION LOG.... 50,25,25   90
	    	DB::table('item_log')->where('document_type','CDO')->whereIn('document_id',$pids)->update(['status'=> 0,'deleted_at'=>now()]);
		} else {
		    //PARTIAL TRANSFER OF DO TO SI HANDLING LOG PARIAL QUANTITY.....
		    $siquantity = $attributes['quantity'][$key];
		    foreach($pids as $pid) {
		       $drow = DB::table('item_log')->where('document_type','CDO')->where('document_id',$pid)->select('quantity')->first();//25 < 15
		       if($drow && $drow->quantity <= $siquantity) {
		           DB::table('item_log')->where('document_type','CDO')->where('document_id',$pid)->update(['status'=> 0,'deleted_at'=>now()]);
		           $siquantity = $siquantity - $drow->quantity;//15
		       } else {
		           $finalqty = $drow->quantity - $siquantity;
		           DB::table('item_log')->where('document_type','CDO')->where('document_id',$pid)->update(['quantity'=> $finalqty]);
		       }
		    }
		        
		}
		
		
		
		$itmlogs = DB::table('item_log')->where('item_id', $attributes['item_id'][$key])
										->where('status', 1)
										->where('trtype', 0)
										->where('cur_quantity', '>', 0)
										->whereNull('deleted_at')
										->where(function ($query) use($pids) {
											$query->whereNotIn('document_id',$pids)
												  ->orWhere('document_type','!=','CDO');
										})
										->select('cur_quantity','pur_cost','unit_cost')
										->get();
										
		if($type==0) {								
			$itmcost = $itmqty = 0;
		} else {
			$itmcost = $attributes['quantity'][$key] * $attributes['cost'][$key];
			$itmqty = $attributes['quantity'][$key];
		}
		
		foreach($itmlogs as $log) {
			$itmcost += ($log->cur_quantity * $log->pur_cost);
			$itmqty += $log->cur_quantity;
		}
		
		if($itmcost > 0 && $itmqty > 0) {
			$cost_avg = round( (($itmcost / $itmqty) + $other_cost), 3);
			$cost = (isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key];
		} else {
			$row = DB::table('item_log')->where('item_id', $attributes['item_id'][$key])->where('status',1)->whereNull('deleted_at')->select('cost_avg')->orderBy('id', 'DESC')->first();
			if($row)
				$cost_avg = $cost = $row->cost_avg;
			else
				$cost_avg = $cost = 0;
		}
		
		DB::table('item_unit')
				->where('itemmaster_id', $attributes['item_id'][$key])
				->update([//'last_purchase_cost' => $cost,
						  //'pur_count' 		   => DB::raw('pur_count + 1'),
						  'cost_avg'		   => $cost_avg
						]);
							
		return $cost_avg;
		
	}
	
	//APR25
	public function updateLastPurchaseCostOnTransferUpdate($attributes, $key, $type, $DOlogs)
	{
		
		$pids = explode(',', $attributes['document_id']);
		$other_cost = (isset($attributes['other_cost']))?$attributes['other_cost']:0;
		//echo '<pre>';print_r($DOlogs);
		if($DOlogs->quantity==$attributes['quantity'][$key]) {
		    //DISABLE SDO TRANSACTION LOG.... 
	    	DB::table('item_log')->where('document_type','CDO')->whereIn('document_id',$pids)->update(['quantity' => 0, 'status'=> 0, 'deleted_at'=>now()]);
		} else {
		    //PARTIAL TRANSFER OF DO TO SI HANDLING LOG PARIAL QUANTITY.....
		    $siquantity = $attributes['quantity'][$key];
		    $siquantity_act = $attributes['quantity_old'][$key]+$DOlogs->quantity;
		    foreach($pids as $pid) {
		       $drow = DB::table('item_log')->where('document_type','CDO')->where('document_id',$pid)->select('quantity')->first();//echo '<pre>';print_r($drow); //quantity_old
		       if($drow && $drow->quantity < $siquantity) {
		           $finalqty = $siquantity_act - $attributes['quantity'][$key];  //echo $finalqty.' a';
		           if($finalqty==0)
		                DB::table('item_log')->where('document_type','CDO')->where('document_id',$pid)->update(['quantity' => 0, 'status'=> 0, 'deleted_at'=>now()]);
		           else
		                DB::table('item_log')->where('document_type','CDO')->where('document_id',$pid)->update(['quantity'=> $finalqty, 'status'=> 1, 'deleted_at'=>'0000-00-00 00:0:00']);
		           $siquantity = $siquantity - $drow->quantity;
		       } else {
		           $finalqty = $siquantity_act - $siquantity;  //echo $finalqty.' b';
		           DB::table('item_log')->where('document_type','CDO')->where('document_id',$pid)->update(['quantity'=> $finalqty, 'status'=> 1, 'deleted_at'=>'0000-00-00 00:0:00']);
		       }
		    }
		        
		}
		
		//exit;
		
		$itmlogs = DB::table('item_log')->where('item_id', $attributes['item_id'][$key])
										->where('status', 1)
										->where('trtype', 0)
										->where('cur_quantity', '>', 0)
										->whereNull('deleted_at')
										->where(function ($query) use($pids) {
											$query->whereNotIn('document_id',$pids)
												  ->orWhere('document_type','!=','CDO');
										})
										->select('cur_quantity','pur_cost','unit_cost')
										->get();
										
		if($type==0) {								
			$itmcost = $itmqty = 0;
		} else {
			$itmcost = $attributes['quantity'][$key] * $attributes['cost'][$key];
			$itmqty = $attributes['quantity'][$key];
		}
		
		foreach($itmlogs as $log) {
			$itmcost += ($log->cur_quantity * $log->pur_cost);
			$itmqty += $log->cur_quantity;
		}
		
		if($itmcost > 0 && $itmqty > 0) {
			$cost_avg = round( (($itmcost / $itmqty) + $other_cost), 3);
			$cost = (isset($attributes['is_fc']))?$attributes['cost'][$key]*$attributes['currency_rate']:$attributes['cost'][$key];
		} else {
			$row = DB::table('item_log')->where('item_id', $attributes['item_id'][$key])->where('status',1)->whereNull('deleted_at')->select('cost_avg')->orderBy('id', 'DESC')->first();
			if($row)
				$cost_avg = $cost = $row->cost_avg;
			else
				$cost_avg = $cost = 0;
		}
		
		DB::table('item_unit')
				->where('itemmaster_id', $attributes['item_id'][$key])
				->update([//'last_purchase_cost' => $cost,
						  //'pur_count' 		   => DB::raw('pur_count + 1'),
						  'cost_avg'		   => $cost_avg
						]);
							
		return $cost_avg;
		
	}
	
	
	public function getLevelwiseReport($attributes) 
	{ 
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		$department_id = (isset($attributes['department_id']))?$attributes['department_id']:'';	
		
		$query = $this->sales_invoice->where('sales_invoice.status',1)
								   ->join('sales_invoice_item AS SI', function($join) {
									   $join->on('SI.sales_invoice_id','=','sales_invoice.id');
								   })
								   ->join('itemmaster AS IM', function($join) {
									   $join->on('IM.id','=','SI.item_id');
								   })
								   ->Join('groupcat AS GP', function($join) {
									$join->on('GP.id','=','IM.group_id');
								   });
												   
			
			if(($date_from!='') && ($date_to!=''))
				$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
			
			if($department_id!='')
				$query->where('sales_invoice.department_id', $department_id);
			
			$result = $query->select('GP.description AS group_name',DB::raw('SUM(SI.quantity) AS quantity'),DB::raw('SUM(SI.line_total) AS amount'))
							   ->groupBy('GP.id')
							   ->get();
			return $result; 
		
	}
	
	public function getItemwiseReport($attributes) 
	{ 
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		$department_id = (isset($attributes['department_id']))?$attributes['department_id']:'';	
		
		$query = $this->sales_invoice->where('sales_invoice.status',1)
								   ->join('sales_invoice_item AS SI', function($join) {
									   $join->on('SI.sales_invoice_id','=','sales_invoice.id');
								   })
								   ->join('itemmaster AS IM', function($join) {
									   $join->on('IM.id','=','SI.item_id');
								   })
								   ->Join('groupcat AS GP', function($join) {
									$join->on('GP.id','=','IM.group_id');
								   });
												   
			
			if(($date_from!='') && ($date_to!=''))
				$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
			
			if($department_id!='')
				$query->where('sales_invoice.department_id', $department_id);
			
				$result = $query->select('GP.description AS group_name','IM.group_id','IM.item_code','IM.description',
									 DB::raw('SUM(SI.quantity) AS quantity'),'SI.line_total')	->groupBy('SI.item_id')	 
							   ->get();
			return $result; 
		
	}
	
	public function salesRentalList($type,$start,$limit,$order,$dir,$search,$dept=null)
	{
		//CHECK DEPARTMENT.......
		$deptid = (Session::get('department')==1)?Auth::user()->department_id:0;
		
		$query = $this->sales_invoice->where('sales_invoice.status',1)->where('sales_invoice.is_rental',1)->where('sales_invoice.department_id','=',6)
						->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.customer_id');
						} )
						->leftJoin('sales_order AS SO', function($join) {
							$join->on('SO.id','=','sales_invoice.document_id');
						} )
						->leftJoin('vehicle AS V', function($join) {
							$join->on('V.id','=','sales_invoice.vehicle_id');
						} );
				
				if($deptid!=0) //dept chk
					$query->where('sales_invoice.department_id', $deptid);
				else {
					if($dept!='' && $dept!=0) {
						$query->where('sales_invoice.department_id', $dept);
					}
				}
			
				if($search) {
					
					$query->where(function($qry) use($search) {
						$date = date('Y-m-d', strtotime($search));
						$qry->where('sales_invoice.voucher_no','LIKE',"%{$search}%")
							->orWhere('am.master_name', 'LIKE',"%{$search}%")
							->orWhere('sales_invoice.voucher_date','LIKE',"%{$date}%");
					});
				}
				
				$query->select('sales_invoice.*','am.master_name AS customer','V.reg_no','V.name AS vehicle','SO.voucher_no AS jo_no')
					->offset($start)
                    ->limit($limit)
                    ->orderBy($order,$dir);
					
				if($type=='get')
					return $query->get();
				else
					return $query->count();
	}
	
	public function salesRentalListCount()
	{
		//CHECK DEPARTMENT.......
		$deptid = (Session::get('department')==1)?Auth::user()->department_id:0;
		
		$query = $this->sales_invoice->where('sales_invoice.status',1)->where('sales_invoice.is_rental',1);
			if($deptid!=0)
				$query->where('sales_invoice.department_id', $deptid);
			
		return $query->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.customer_id');
						} )
					->count();
	}
	
	public function getItemsrent($id,$mod=null)
	{
		$query = $this->sales_invoice->where('sales_invoice.id',$id);
		
		$query->join('sales_invoice_item AS poi', function($join) {
							$join->on('poi.sales_invoice_id','=','sales_invoice.id');
						})
					  ->join('units AS u', function($join){
						  $join->on('u.id','=','poi.unit_id');
					  }) 
					   ->join('item_unit AS iu', function($join){
						  $join->on('iu.unit_id','=','poi.unit_id')
							   ->on('iu.itemmaster_id','=','poi.item_id');
					  })
					  ->join('itemmaster AS im', function($join){
						  $join->on('im.id','=','poi.item_id');
					  })
					  ->where('sales_invoice.is_rental',1)
					  ->where('poi.status',1);
					  
					  if($mod) {
						$val = ($mod=='ser')?2:1;
						$query->where('im.class_id',$val);
					  }
						
		return $query->select('poi.*','u.unit_name','im.item_code','iu.packing','iu.is_baseqty')->groupBy('poi.id')->orderBY('poi.id')->get();
					  //->groupBY('im.id')
					  
	}
	
	public function salesInvoiceListjob($type,$start,$limit,$order,$dir,$search,$dept=null)
	{
		//CHECK DEPARTMENT.......
		$deptid = (Session::get('department')==1)?Auth::user()->department_id:0;
		
		$query = $this->sales_invoice->where('sales_invoice.status',1)->where('sales_invoice.department_id',4)
						->join('account_master AS am', function($join) {
							$join->on('am.id','=','sales_invoice.customer_id');
						} )
						->leftJoin('sales_order AS SO', function($join) {
							$join->on('SO.id','=','sales_invoice.document_id');
						} )
						->leftJoin('vehicle AS V', function($join) {
							$join->on('V.id','=','sales_invoice.vehicle_id');
						} );
				
				if($deptid!=0) //dept chk
					$query->where('sales_invoice.department_id', $deptid);
				else {
					if($dept!='' && $dept!=0) {
						$query->where('sales_invoice.department_id', $dept);
					}
				}
			
				if($search) {
					
					$query->where(function($qry) use($search) {
						$date = date('Y-m-d', strtotime($search));
						$qry->where('sales_invoice.voucher_no','LIKE',"%{$search}%")
							->orWhere('am.master_name', 'LIKE',"%{$search}%")
							->orWhere('sales_invoice.voucher_date','LIKE',"%{$date}%");
					});
				}
				
				$query->select('sales_invoice.*','am.master_name AS customer','V.reg_no','V.name AS vehicle','SO.voucher_no AS jo_no')
					->offset($start)
                    ->limit($limit)
                    ->orderBy($order,$dir);
					
				if($type=='get')
					return $query->get();
				else
					return $query->count();
	}
	
	public function getReportPmode($attributes) {
		
		$date_from = ($attributes['date_from']!='')?date('Y-m-d', strtotime($attributes['date_from'])):'';
		$date_to = ($attributes['date_to']!='')?date('Y-m-d', strtotime($attributes['date_to'])):'';
		$department = (Session::get('department')==1)?$attributes['department_id']:null;
		
		$query = $this->sales_invoice
					->join('account_setting AS SA', function($join) {
						$join->on('SA.id','=','sales_invoice.voucher_id');
					})
					->join('account_master AS AM', function($join) {
						$join->on('AM.id','=','sales_invoice.customer_id');
					})
					->leftJoin('salesman AS S', function($join) {
						$join->on('S.id','=','sales_invoice.salesman_id');
					});
							
					if( $date_from!='' && $date_to!='' ) { 
						$query->whereBetween('sales_invoice.voucher_date', array($date_from, $date_to));
					}
					
					if($attributes['salesman']!='') { 
						$query->where('sales_invoice.salesman_id', $attributes['salesman']);
					}
					
					if( $attributes['search_type']=='cash' ) { 
						$query->where('sales_invoice.voucher_id', 9);
					}
					
					if( $attributes['search_type']=='credit' ) { 
						$query->where('sales_invoice.voucher_id', 4);
					}
					
					if($department)
						$query->where('sales_invoice.department_id', $department); //amount_transfer
					
		return $query->select('sales_invoice.voucher_no','sales_invoice.reference_no','sales_invoice.total','sales_invoice.vat_amount','sales_invoice.amount_transfer','S.name AS salesman',
							  'sales_invoice.voucher_date','AM.account_id','AM.master_name','AM.vat_no','sales_invoice.net_total','sales_invoice.voucher_id',
							  'sales_invoice.subtotal','SA.voucher_name','sales_invoice.discount'
							  )->get();
	}
	
	public function getSellExp($id)
	{
		$query = $this->sales_invoice->where('sales_invoice.id',$id);
		
		return $query->join('si_selling_exp AS SI', function($join) {
							$join->on('SI.sales_invoice_id','=','sales_invoice.id');
						} )
					  ->join('account_master AS im', function($join){
						  $join->on('im.id','=','SI.dr_account_id');
					  })
					  ->leftJoin('account_master AS im2', function($join){
						  $join->on('im2.id','=','SI.cr_account_id');
					  })
					  ->where('SI.status',1)
					  ->select('SI.*','im.id AS dr_id','im.master_name AS dr_name','im2.id AS cr_id','im2.master_name AS cr_name')->get();
	}
	
	public function ajax_upload($file)
	{ 
		$photo = '';
		$fname = pathinfo($file->getClientOriginalName(), PATHINFO_FILENAME);
		
		if($file) {
			$ext = $file->getClientOriginalExtension();
			if($ext=='.jpg' ||$ext=='.JPG' || $ext=='.png' || $ext=='.PNG') {
				$photo = rand(1, 999).$fname.'.'.$ext;
				$destinationPath = public_path() . $this->imgDir.'/'.$photo;
				$destinationPathThumb = public_path() . $this->imgDir.'/thumb_'.$photo;

				// resizing an uploaded file
				Intervention\Image\Facades\Image::make($file->getRealPath())->resize($this->width, $this->height, function($constraint) { $constraint->aspectRatio(); })->save($destinationPath);

				// thumb
				Intervention\Image\Facades\Image::make($file->getRealPath())->resize($this->thumbWidth, $this->thumbHeight, function($constraint) { $constraint->aspectRatio(); })->save($destinationPathThumb);
			} else {
				 $photo = rand(1, 999).$fname.'.'.$ext;
				 $destinationPath = public_path() . $this->imgDir;
				 $file->move($destinationPath,$photo);
			}
		}
		
		return $photo;

	}
}

//SELECT location.code,SIL.invoice_id,SIL.quantity FROM sales_invoice JOIN sales_invoice_item ON(sales_invoice_item.sales_invoice_id=sales_invoice.id) LEFT JOIN item_location_si AS SIL ON(SIL.invoice_id=sales_invoice_item.id) WHERE sales_invoice_item.status=1 AND sales_invoice_item.deleted_at='0000-00-00 00:00:00' AND sales_invoice.id={id} ORDER BY sales_invoice_item.id ASC

//SELECT account_master.master_name,account_master.account_id,account_master.phone,packing_list.voucher_no,packing_list.voucher_date,packing_list.carton_qty,packing_list.item_qty,packing_list.invoice_nos,packing_list.description,itemmaster.item_code,itemmaster.description AS item_name,itemmaster.serial_no AS hs_code,itemmaster.other_info AS origin,itemmaster.weight,packing_list_items.carton_no,packing_list_items.carton_qty FROM `packing_list` JOIN packing_list_items ON(packing_list_items.packing_list_id=packing_list_id) JOIN itemmaster ON(itemmaster.id=packing_list_items.item_id) JOIN account_master ON(account_master.id=packing_list.customer_id) WHERE packing_list.id=1 AND packing_list_items.deleted_at IS NULL ORDER BY packing_list_items.carton_no ASC,packing_list_items.id ASC;

