<?php

namespace App\Http\Controllers;
use App\Repositories\Area\AreaInterface;
use App\Repositories\Itemmaster\ItemmasterInterface;
use App\Repositories\Terms\TermsInterface;
use App\Repositories\Jobmaster\JobmasterInterface;
use App\Repositories\AccountMaster\AccountMasterInterface;
use App\Repositories\Currency\CurrencyInterface;
use App\Repositories\VoucherNo\VoucherNoInterface;
use App\Repositories\PackingList\PackingListInterface;
use App\Repositories\PurchaseOrder\PurchaseOrderInterface;
use App\Repositories\Salesman\SalesmanInterface;
use App\Repositories\QuotationSales\QuotationSalesInterface;
use App\Repositories\AccountSetting\AccountSettingInterface;
use App\Repositories\Country\CountryInterface;
use App\Repositories\Acgroup\AcgroupInterface;
use App\Repositories\Forms\FormsInterface;
use App\Repositories\Location\LocationInterface;

use Illuminate\Http\Request;

use App\Http\Requests;
use Session;
use Response;
use Input;
use Excel;
use App;
use DB;
use Mail;
use PDF;
use Auth;

class PackingListController extends Controller
{

	protected $itemmaster;
	protected $terms;
	protected $jobmaster;
	protected $accountmaster;
	protected $currency;
	protected $voucherno;
	protected $packing_list;
	protected $purchase_order;
	protected $salesman;
	protected $quotation_sales;
	protected $country;
	protected $group;
	protected $area;
	protected $forms;
	protected $formData;
	protected $location;
	
	public function __construct(PackingListInterface $packing_list, AreaInterface $area, QuotationSalesInterface $quotation_sales, ItemmasterInterface $itemmaster, TermsInterface $terms, JobmasterInterface $jobmaster, AccountMasterInterface $accountmaster, CurrencyInterface $currency, VoucherNoInterface $voucherno, SalesmanInterface $salesman, CountryInterface $country,AcgroupInterface $group,FormsInterface $forms,LocationInterface $location,PurchaseOrderInterface $purchase_order) {
		
		parent::__construct( App::make('App\Repositories\Parameter1\Parameter1Interface'), App::make('App\Repositories\VatMaster\VatMasterInterface') );
		
		$this->middleware('auth');
		$this->itemmaster = $itemmaster;
		$this->terms = $terms;
		$this->jobmaster = $jobmaster;
		$this->accountmaster = $accountmaster;
		$this->currency = $currency;
		$this->voucherno = $voucherno;
		$this->packing_list = $packing_list;
		$this->purchase_order = $purchase_order;
		$this->salesman = $salesman;
		$this->quotation_sales = $quotation_sales;
		$this->country = $country;
		$this->group = $group;
		$this->area = $area;
		$this->forms = $forms;
		$this->formData = $this->forms->getFormData('SO');
		$this->location = $location;
		
		$this->mod_consolidate_item = DB::table('parameter2')->where('keyname', 'mod_consolidate_item')->where('status',1)->select('is_active')->first();
	}
	
    public function index() { 
		
		$quotations = DB::table('packing_list')->where('packing_list.deleted_at',null)
								->join('account_master','account_master.id','=','packing_list.customer_id')
								->select('account_master.master_name','packing_list.*')
								->get();

		return view('body.packinglist.index')
					->withPlist($quotations)
					->withSettings($this->acsettings);
	}
	
	public function ajaxPaging(Request $request)
	{
		if($this->acsettings->doc_approve==1) {
		    $columns = array( 
                            0 =>'packing_list.id', 
                            1 =>'voucher_no',
                            2=> 'customer',
                            3=> 'voucher_date',
                            4=> 'net_total',
							5=> 'status'
                        );
		} else {
		    $columns = array( 
                            0 =>'packing_list.id', 
                            1 =>'voucher_no',
                            2=> 'customer',
                            3=> 'voucher_date',
                            4=> 'net_total',
							5=> 'reference_no'
                        );
		}
						
		$totalData = $this->packing_list->packingListListCount();
            
        $totalFiltered = $totalData; 

        $limit = $request->input('length');
        $start = $request->input('start');
        $order = 'packing_list.voucher_no';
        $dir = 'desc';
		$search = (empty($request->input('search.value')))?null:$request->input('search.value');
        
		$invoices = $this->packing_list->packingListList('get', $start, $limit, $order, $dir, $search);
		//echo '<pre>';print_r($invoices);exit;
		if($search)
			$totalFiltered =  $this->packing_list->packingListList('count', $start, $limit, $order, $dir, $search);
		
		$prints = DB::table('report_view_detail')
							->join('report_view','report_view.id','=','report_view_detail.report_view_id')
							->where('report_view.code','SO')
							->select('report_view_detail.name','report_view_detail.id')
							->get();
							
        $data = array();
        if(!empty($invoices))
        {
           
			foreach ($invoices as $row)
            {
                $edit =  '"'.url('packing_list/edit/'.$row->id).'"';
                $delete =  'funDelete("'.$row->id.'","'.$row->is_editable.'")';
				$print = url('packing_list/print/'.$row->id);
				
                $nestedData['id'] = $row->id;
                $nestedData['voucher_no'] = $row->voucher_no;
				$nestedData['voucher_date'] = date('d-m-Y', strtotime($row->voucher_date));
				$nestedData['customer'] = ($row->customer=='CASH CUSTOMERS') ? (($row->customer_name!='')?$row->customer.'('.$row->customer_name.')':$row->customer) : $row->customer;
				$nestedData['net_total'] = $row->net_total;
				$nestedData['reference_no'] = $row->reference_no;
                $nestedData['edit'] = "<p><button class='btn btn-primary btn-xs' onClick='location.href={$edit}'>
												<span class='glyphicon glyphicon-pencil'></span></button></p>";
												
				$nestedData['delete'] = "<button class='btn btn-danger btn-xs delete' onClick='{$delete}'>
												<span class='glyphicon glyphicon-trash'></span>";
				
				$apr = ($this->acsettings->doc_approve==1)?[1]:[0,1,2];
				
				$opts = '';					
				foreach($prints as $doc) {
					$opts .= "<li role='presentation'><a href='{$print}/".$doc->id."' target='_blank' role='menuitem'>".$doc->name."</a></li>";
				}
				
				if(in_array($row->doc_status, $apr))	 {
					if($row->is_fc==1) {								
						$nestedData['print'] = "<p><a href='{$print}' target='_blank' class='btn btn-primary btn-xs'><span class='fa fa-fw fa-print'></span></a>
												<a href='{$print}/FC' target='_blank' class='btn btn-primary btn-xs'><span class='fa fa-fw fa-print'></span>FC</a></p>";
					} else {
						//$nestedData['print'] = "<p><a href='{$print}' target='_blank' class='btn btn-primary btn-xs'><span class='fa fa-fw fa-print'></span></a></p>";
						$nestedData['print'] = "<div class='btn-group drop_btn' role='group'>
											<button type='button' class='btn btn-primary btn-xs dropdown-toggle m-r-50'
													id='exampleIconDropdown1' data-toggle='dropdown' aria-expanded='false'>
												<i class='fa fa-fw fa-print' aria-hidden='true'></i><span class='caret'></span>
											</button>
											<ul style='min-width:100px !important;' class='dropdown-menu' aria-labelledby='exampleIconDropdown1' role='menu'>
												".$opts."
											</ul>
										</div>";
					}
				} else {
					$nestedData['print'] = "";
				}	
				
				if($this->acsettings->doc_approve==1) {
					if($row->doc_status==1)
						$status = '<span class="label label-sm label-success">Approved</span>';
					else if($row->doc_status==0)
						$status = '<span class="label label-sm label-warning">Pending</span>';
					else if($row->doc_status==2)
						$status = '<span class="label label-sm label-danger">Rejected</span>';
					
					$nestedData['status'] = $status;
				} else 
					$nestedData['status'] = '';
				
				$data[] = $nestedData;

            }
        }
          
        $json_data = array(
                    "draw"            => intval($request->input('draw')),  
                    "recordsTotal"    => intval($totalData),  
                    "recordsFiltered" => intval($totalFiltered), 
                    "data"            => $data   
                    );
            
        echo json_encode($json_data);
	}
	
	public function add($id = null, $doctype = null) {

		$data = array(); //echo '<pre>';print_r($this->formData);exit;
		$res = $this->voucherno->getVoucherNo('PL');
		$row = DB::table('packing_list')->where('status',1)->where('deleted_at',null)->orderBy('id','DESC')->select('id')->first();
		
		if($row)
			$lastid = $row->id;
		else
			$lastid = null;
		
		$print = DB::table('report_view_detail')
							->join('report_view','report_view.id','=','report_view_detail.report_view_id')
							->where('report_view.code','PL')
							->where('report_view_detail.is_default',1)
							->select('report_view_detail.id')
							->first();
	//	echo '<pre>';print_r($print);exit;					
		$prntjobs = [];/* DB::table('packing_list')->where('status',1)->where('deleted_at','0000-00-00 00:00:00')
						->select('id','voucher_no')
						->offset(0)->limit(10)
						->orderBy('id','DESC')
						->get(); */
		
		if($id) {
			$ids = explode(',', $id); $invs ='';
			if($doctype=='SI') {
				$quoteRow = $this->packing_list->findSIdata($ids[0]);
				$quoteItems = $this->packing_list->getSIitems($ids); //$this->consolidateItems(
				$ar = DB::table('sales_invoice')->whereIn('id',$ids)->select('voucher_no')->get(); //echo '<pre>';print_r($ar);exit;
				foreach($ar as $rw) {
					$invs .= ($invs=='')?$rw->voucher_no:','.$rw->voucher_no;
				}
				//echo $invs;exit;
			}
			//echo '<pre>';print_r($quoteItems);exit;
			return view('body.packinglist.addquote2')
						->withQuoterow($quoteRow)
						->withVoucherno($res)
						->withQuoteitems($quoteItems)
						->withQuoteid($id)
						->withVoucherdt(Session::get('voucher_date'))
						->withVatdata($this->vatdata)
						->withSettings($this->acsettings)
						->withFormdata($this->formData)
						->withLocation([])
						->withInvnos($invs)
						->withPrintid($lastid)
						->withData($data);
		}
		
		return view('body.packinglist.add')
					->withVoucherno($res)
					->withVatdata($this->vatdata)
					->withSettings($this->acsettings)
					->withPrintid($lastid)
					->withFormdata($this->formData)
					->withPrint($print)
					->withPrntjobs($prntjobs)
					->withData($data);
	}
	
	public function getInvoice($customer_id, $url)
	{
		$data = array(); 
		$qry = DB::table('sales_invoice')
							->leftJoin('salesman AS S', function($join) {
									$join->on('S.id','=','sales_invoice.salesman_id');
								} )
							->where('sales_invoice.status', 1);
							
						if($customer_id)
						$qry->where('sales_invoice.customer_id', $customer_id);

						$invoices = $qry->where('sales_invoice.is_transfer', 0)
							->select('sales_invoice.id','sales_invoice.voucher_no','sales_invoice.voucher_date','sales_invoice.net_total','S.name')
							->get();//print_r($invoices);exit;

		return view('body.packinglist.invoice')
					->withQuotations($invoices)
					->withUrl($url)
					->withData($data);
	}

	private function consolidateItems($array) { //echo '<pre>';print_r($array);exit;63
		
		$combined = array(); $qty = 0;
		foreach( $array as $values )  {
		  if( ( $key = array_search( $values->item_id, array_column( $combined, 'item_id') ) ) !== false )  {
			//$combined[$key]['quantity'] += $values->quantity;
			$qty += $values->quantity;
			$combined[$key]['quantity'] = $qty;
		  } else {
			$combined[] = $values;
		  }
		}
		return $combined;
	}
	
	public function save(Request $request) { //echo '<pre>';print_r(Input::all());exit;
	
		DB::beginTransaction();
		try {
			$input = $request->all();
			$id = DB::table('packing_list')
						->insertGetId([
							'voucher_no' => $request->get('voucher_no'),
							'voucher_date' => date('Y-m-d', strtotime($request->get('voucher_date'))),
							'customer_id' => $request->get('customer_id'),
							'invoice_ids' => $request->get('invoice_ids'),
							'status' => 1,
							'created_at' => date('Y-m-d h:i:s'),
							'created_by' => Auth::User()->id,
							'invoice_nos' => $request->get('invoice_nos'),
							'carton_qty' => $request->get('total_crtn'),
							'item_qty' => $request->get('total_qty'),
							'description' => $request->get('description')
						]);

			foreach($input['item_id'] as $k => $row) {
				if($row!='') {
					DB::table('packing_list_items')
						->insert([
							'packing_list_id' => $id,
							'item_id' => $input['item_id'][$k],
							'quantity' => $input['quantity'][$k],
							'carton_no' => $input['crtno'][$k],
							'carton_qty' => $input['crtqty'][$k],
							'balance_qty' => $input['balqty'][$k],
							'is_sub' => $input['is_sub'][$k]
						]);
				} 
			}
			DB::table('voucher_no')->where('voucher_type','PL')->update(['no' => DB::raw('no + 1')]);
			DB::commit();
			
			Session::flash('message', 'Packing List added successfully');
			return redirect('packing_list/add');
			
		} catch(\Exception $e) {
			
			DB::rollback(); echo $e->getLine().' '.$e->getMessage();exit;
			return Redirect::to('packing_list/add')->withErrors($e->getErrors());
		}
		
		if($this->packing_list->create(Input::all()))
			Session::flash('message', 'Packing List added successfully.');
		else
			Session::flash('error', 'Something went wrong, Order failed to add!');
		
		return redirect('packing_list/add');
	}
	
	public function destroy($id)
	{
		DB::table('packing_list')->where('id',$id)->update(['deleted_at' => date('Y-m-d h:i:s') ]);
		DB::table('packing_list_items')->where('packing_list_id',$id)->update(['deleted_at' => date('Y-m-d h:i:s') ]);
		Session::flash('message', 'Packing List deleted successfully.');
		return redirect('packing_list');
	}
	
	public function checkRefNo() {

		$check = $this->packing_list->check_reference_no(Input::get('reference_no'), Input::get('id'));
		$isAvailable = ($check) ? false : true;
		echo json_encode(array(
							'valid' => $isAvailable,
						));
	}
	
	private function makeTreeArr($result) {
		
		$childs = array();
		foreach($result as $item)
			$childs[$item->item_detail_id][] = $item;
		
		return $childs;
	}
	
	public function edit($id) { 

		$orderrow = DB::table('packing_list')->where('packing_list.id',$id)
								->join('account_master','account_master.id','=','packing_list.customer_id')
								->select('account_master.master_name','packing_list.*')
								->first();
								//echo '<pre>';print_r($orderrow);exit;
		$orditems = DB::table('packing_list_items')->where('packing_list_items.packing_list_id',$id)
									->join('itemmaster', 'itemmaster.id','=','packing_list_items.item_id')
									->where('packing_list_items.deleted_at',null)
									->select('packing_list_items.*','itemmaster.item_code','itemmaster.description')
									->orderBy('packing_list_items.id','ASC')
									->get();
		
		$print = DB::table('report_view_detail')
							->join('report_view','report_view.id','=','report_view_detail.report_view_id')
							->where('report_view.code','SO')
							->where('report_view_detail.is_default',1)
							->select('report_view_detail.id')
							->first();
							
		
		return view('body.packinglist.edit') //editsp  edit
					->withOrderrow($orderrow)
					->withOrditems($orditems)
					->withSettings($this->acsettings)
					->withPrintid($id)
					->withPrint($print);

	}
	
	public function update(Request $request, $id)
	{
		DB::beginTransaction();
		try {
			$input = $request->all();
			DB::table('packing_list')
						->where('id', $id)
						->update([
							'voucher_date' => date('Y-m-d', strtotime($request->get('voucher_date'))),
							'modify_at' => date('Y-m-d h:i:s'),
							'modify_by' => Auth::User()->id,
							'carton_qty' => $request->get('total_crtn'),
							'item_qty' => $request->get('total_qty'),
							'description' => $request->get('description')
						]);

			foreach($input['row_id'] as $k => $row) {
				if($row!='') {
					DB::table('packing_list_items')
						->where('id', $row)
						->update([
							'carton_no' => $input['crtno'][$k],
							'carton_qty' => $input['crtqty'][$k],
							'balance_qty' => $input['balqty'][$k],
							'is_sub' => $input['is_sub'][$k]
						]);
				} else {
					DB::table('packing_list_items')
						->insert([
							'packing_list' => $id,
							'item_id' => $input['item_id'][$k],
							'quantity' => $input['quantity'][$k],
							'carton_no' => $input['crtno'][$k],
							'carton_qty' => $input['crtqty'][$k],
							'balance_qty' => $input['balqty'][$k],
							'is_sub' => $input['is_sub'][$k]
						]);
				}
			}

			DB::commit();
			
			Session::flash('message', 'Packing List updated successfully');
			return redirect('packing_list/add');
			
		} catch(\Exception $e) {
			
			DB::rollback(); echo $e->getLine().' '.$e->getMessage();exit;
			return Redirect::to('packing_list/add')->withErrors($e->getErrors());
		}
		
		
	}
	
	public function ajax_getcode($category)
	{
		$group = $this->group->getGroupCode($category);
		$row = $this->accountmaster->getGroupCode($category);
		if($row)
			$no = intval(preg_replace('/[^0-9]+/', '', $row->account_id), 10);
		else 
			$no = 0;
		
		$no++;
		
		return json_encode(array(
							'code' => strtoupper($group->code).''.$no,
							'category' => $group->category
							));
		//return $code = strtoupper($group->code).''.$no;
		//return $group->account_id;

	}
	
	public function show($id) { 

		$data = array();
		$acmasterrow = $this->accountmaster->accountMasterView($id);
		//echo '<pre>';print_r($acmasterrow);exit;
		return view('body.accountmaster.view')
					->withMasterrow($acmasterrow)
					->withData($data);
	}

	public function checkVchrNo() { 

		$check = $this->packing_list->check_voucher_no(Input::get('voucher_no'), Input::get('id'));
		$isAvailable = ($check) ? false : true;
		echo json_encode(array(
							'valid' => $isAvailable,
						));
	}
	
	public function getCustomer($deptid=null)
	{
		$data = array();
		$customers = [];//$this->accountmaster->getCustomerList($deptid);//
		//print_r($customers);exit;
		$country = $this->country->activeCountryList();
		$area = $this->area->activeAreaList();
		$cus_code = json_decode($this->ajax_getcode($category='CUSTOMER'));
		return view('body.packinglist.customer')//customer
					->withCustomers($customers)
					->withArea($area)
					->withCusid($cus_code->code)
					->withCategory($cus_code->category)
					->withFormdata($this->formData)
					->withCountry($country)
					->withDeptid($deptid)
					->withData($data);
	}
	
	public function getSalesman()
	{
		$data = array();
		$salesmans = $this->salesman->getSalesmanList();
		return view('body.packinglist.salesman')
					->withSalesmans($salesmans)
					->withData($data);
	}
	
	public function getItem($num)
	{
		$data = array();
		$itemmaster = $this->itemmaster->getActiveItemmasterList();
		return view('body.packinglist.item')
					->withItems($itemmaster)
					->withNum($num)
					->withData($data);
	}
	
	public function getOrder($customer_id, $url)
	{
		$data = array();
		$orders = $this->packing_list->getCustomerOrder($customer_id);
		return view('body.packinglist.order')
					->withOrders($orders)
					->withUrl($url)
					->withData($data);
	}
	
	public function getPrint($id,$rid=null)
	{
		//echo '<pre>';print_r($rid);exit;
		//$viewfile = DB::table('report_view')->where('code', 'SO')->where('status',1)->select('view_name')->first();
		$viewfile = DB::table('report_view_detail')->where('id', $rid)->select('print_name')->first();
		
		if($viewfile->print_name=='') {
			$attributes['document_id'] = $id;
			$attributes['is_fc'] = ($fc)?1:'';
			$result = $this->packing_list->getOrder($attributes);
			$titles = ['main_head' => 'Packing List','subhead' => 'Packing List'];
			return view('body.packinglist.print') //printsp print
						->withDetails($result['details'])
						->withTitles($titles)
						->withFc($attributes['is_fc'])
						->withItems($result['items']);
		} else {
			$path = app_path() . '/stimulsoft/helper.php';
			return view('body.packinglist.viewer')->withPath($path)->withView($viewfile->print_name);
		}
		
	}
	
	public function setSessionVal()
	{
		Session::put('voucher_no', Input::get('vchr_no'));
		Session::put('reference_no', Input::get('ref_no'));
		Session::put('voucher_date', Input::get('vchr_dt'));
		Session::put('lpo_date', Input::get('lpo_dt'));
	}
	
	protected function makeTree($result)
	{
		$childs = array();
		foreach($result as $item)
			$childs[$item['voucher_no']][] = $item;
		
		return $childs;
	}

	protected function makeArrGroup($result)
	{
		$childs = array();
		foreach($result as $item)
			$childs[$item['voucher_no']][] = $item;
		
		$arr = array();
		foreach($childs as $child) {
			$pending_qty = $pending_amt = $vat_amount = $net_amount = $discount = 0;
			foreach($child as $row) {
			    $pending_qty = ($row->balance_quantity==0)?$row->quantity:$row->balance_quantity;
			    $pending_amt += $pending_qty * $row->unit_price;
				$vat = $row->unit_vat / $row->quantity;
				$vat_amount += $vat * $pending_qty;
				$net_amount = $vat_amount + $pending_amt;
				$voucher_no = $row->voucher_no;
				$refno = $row->reference_no;
				$suppname = $row->master_name;
				$salesman = $row->salesman;
				$discount = $row->discount;
				$jobcode = $row->jobcode;
			}
			$arr[] = ['voucher_no' => $voucher_no,'reference_no' => $refno, 'master_name' => $suppname, 'discount' => $discount, 
					  'total' => $pending_amt,'vat_amount' => $vat_amount, 'net_total' => $net_amount, 'salesman' => $salesman,
					  'jobcode' => $jobcode];
			
		}

		return $arr;
	}

	public function getSearch()
	{
		$data = array();
		
		$reports = $this->packing_list->getPendingReport(Input::all());//echo '<pre>';print_r($reports);exit;
		
		if(Input::get('search_type')=="summary")
			$voucher_head = 'Packing List Summary';
		elseif(Input::get('search_type')=="summary_pending") {
			$voucher_head = 'Packing List Pending Summary';
			$reports = $this->makeArrGroup($reports);
		} elseif(Input::get('search_type')=="detail") {
			$voucher_head = 'Packing List Detail';
			$reports = $this->makeTree($reports);
		} elseif(Input::get('search_type')=="jobwise") {
			$voucher_head = 'Packing List - Jobwise';
		} elseif(Input::get('search_type')=="customer_wise") {
			$voucher_head = 'Packing List - Customer Wise';
		} elseif(Input::get('search_type')=="detail_pending") {
			$voucher_head = 'Packing List Pending Detail';
			$reports = $this->makeTree($reports);
		}
		
		//echo '<pre>';print_r($reports);exit;
		return view('body.packinglist.preprint') //preprint
					->withReports($reports)
					->withVoucherhead($voucher_head)
					->withType(Input::get('search_type'))
					->withFromdate(Input::get('date_from'))
					->withTodate(Input::get('date_to'))
					->withJobids(json_encode(Input::get('job_id')))
					->withSalesman(Input::get('salesman'))
					->withSettings($this->acsettings)
					->withData($data);
	}
	
	public function dataExport()
	{
		$data = array();
		$datareport[] = ['','','','',strtoupper(Session::get('company')),'','',''];
		$datareport[] = ['','','','','','',''];
		
		Input::merge(['type' => 'export']);
		Input::merge(['job_id' => json_decode(Input::get('job_id'))]);
		$reports = $this->packing_list->getPendingReport(Input::all());
		
		if(Input::get('search_type')=="summary")
			$voucher_head = 'Packing List Summary';
		elseif(Input::get('search_type')=="summary_pending") {
			$voucher_head = 'Packing List Pending Summary';
			$reports = $this->makeArrGroup($reports);
		} elseif(Input::get('search_type')=="detail") {
			$voucher_head = 'Packing List Detail';
		} else {
			$voucher_head = 'Packing List Pending Detail';
		}
		
		$datareport[] = ['','','','',strtoupper($voucher_head), '','',''];
		$datareport[] = ['','','','','','',''];
		
		 //echo '<pre>';print_r($reports);exit;
		
		if(Input::get('search_type')=='detail' || Input::get('search_type')=='detail_pending') {
			
			$datareport[] = ['SI.No.','SO.#', 'SO.Ref#', 'Job No', 'Customer','Salesman','Item Code','Description','SO.Qty','Rate','Total Amt.'];
			$i=0;
			foreach ($reports as $row) {
				$i++;
				$datareport[] = [ 'si' => $i,
								  'po' => $row['voucher_no'], 
								  'ref' => $row['reference_no'],
								  'jobcode' => $row['jobcode'],
								  'supplier' => $row['master_name'],
								  'salesman' => $row['salesman'],
								  'item_code' => $row['item_code'],
								  'description' => $row['description'],
								  'quantity' => $row['quantity'],
								  'unit_price' => number_format($row['unit_price'],2),
								  'net_amount' => number_format($row['net_total'],2)
								];
			}
		} else {
			
			$datareport[] = ['SI.No.','SO.#', 'SO.Ref#', 'Job No', 'Customer','Salesman','Gross Amt.','VAT Amt.','Net Total'];
			$i=0;
			$total=0;$gross=0;$vat=0;	
		    $tot=0;$gs=0;$vt=0;
			foreach ($reports as $row) {
					$i++;
					$datareport[] = [ 'si' => $i,
									  'po' => $row['voucher_no'],
									  'ref' => $row['reference_no'],
									  'jobcode' => $row['jobcode'],
									  'supplier' => $row['master_name'],
									  'salesman' => $row['salesman'],
									  'gross' => number_format($row['total'],2),
									  'vat' => number_format($row['vat_amount'],2),
									  'total' => number_format($row['net_total'],2)
									];
									$total+= $row['net_total'];
							        $tot=number_format($total,2) ;
									$gross+= $row['total'];
							        $gs=number_format($gross,2) ;
									$vat+= $row['vat_amount'];
							        $vt=number_format($vat,2) ;
									
			}
			$datareport[] = ['','','','','','',''];			
		    $datareport[] = ['','','','','','Total:',$gs,$vt,$tot];
		}
		 //echo $voucher_head.'<pre>';print_r($datareport);exit;
		Excel::create($voucher_head, function($excel) use ($datareport,$voucher_head) {

        // Set the spreadsheet title, creator, and description
        $excel->setTitle($voucher_head);
        $excel->setCreator('NumakPro ERP')->setCompany(Session::get('company'));
        $excel->setDescription($voucher_head);

        // Build the spreadsheet, passing in the payments array
		$excel->sheet('sheet1', function($sheet) use ($datareport) {
			$sheet->fromArray($datareport, null, 'A1', false, false);
		});

		})->download('xlsx');
		
	}
	
	public function getNewCustomer($deptid=null)
	{
		$data = array();
		$customers = $this->accountmaster->getCustomerList($deptid);//print_r($customers);exit;
		$country = $this->country->activeCountryList();
		$area = $this->area->activeAreaList();
		$cus_code = json_decode($this->ajax_getcode($category='CUSTOMER'));
		return view('body.packinglist.newcustomer')//customer
					->withCustomers($customers)
					->withArea($area)
					->withCusid($cus_code->code)
					->withCategory($cus_code->category)
					->withCountry($country)
					->withDeptid($deptid)
					->withData($data);
	}
	
	public function getItemDetails($id) 
	{
		$data = array();
		$items = $this->packing_list->getItems(array($id));
		return view('body.packinglist.itemdetails')
					->withItems($items)
					->withData($data);
	}
	public function getPackingList()
	{
		$data = array();
		$orders = $this->packing_list->getSOdata();
		//echo '<pre>';print_r($orders);exit;
		return view('body.packinglist.orders')
					->withOrders($orders)
					->withData($data);
	}
	
	
	public function poadd($id) {
		$data = array();
		$itemmaster = $this->itemmaster->activeItemmasterList();
		$terms = $this->terms->activeTermsList();
		$jobs = $this->jobmaster->activeJobmasterList();
		$currency = $this->currency->activeCurrencyList();
		$res = $this->voucherno->getVoucherNo('SO'); //echo '<pre>';print_r($res);exit;
		//$vno = $res->no;
		$row = DB::table('packing_list')->where('status',1)->where('deleted_at','0000-00-00 00:00:00')->orderBy('id','DESC')->select('id','doc_status')->first();
		$apr = ($this->acsettings->doc_approve==1)?[1]:[0,1,2];
		$location = $this->location->locationList();
		if($row && in_array($row->doc_status, $apr))
			$lastid = $row->id;
		else
			$lastid = null;
		
		$print = DB::table('report_view_detail')
							->join('report_view','report_view.id','=','report_view_detail.report_view_id')
							->where('report_view.code','SO')
							->where('report_view_detail.is_default',1)
							->select('report_view_detail.id')
							->first();
							
		if($id) {
			$ids = explode(',', $id);
			$quoteRow = $this->purchase_order->findPOdata($ids[0]);
			$quoteItems = $this->purchase_order->getPOitems($ids);//echo '<pre>';print_r($quoteRow);exit;
			
			$total = 0; $vat_amount = 0; $nettotal = 0;
			foreach($quoteItems as $item) {
				if($item->balance_quantity==0)
					$quantity = $item->quantity;
				else
					$quantity = $item->balance_quantity;
				
				$total 		+= ($quantity * $item->unit_price) - $item->discount;
				$vat_amount += ($total * $item->vat) / 100;
			}
			$nettotal = $total + $vat_amount;
			return view('body.packinglist.addquote')
						->withItems($itemmaster)
						->withTerms($terms)
						->withJobs($jobs)
						->withCurrency($currency)
						->withQuoterow($quoteRow)
						->withVoucherno($res)
						->withQuoteitems($quoteItems)
						->withQuoteid($id)
						->withTotal($total)
						->withVatamount($vat_amount)
						->withNettotal($nettotal)
						//->withVoucherno(Session::get('voucher_no'))
						->withReferenceno(Session::get('reference_no'))
						->withVoucherdt(Session::get('voucher_date'))
						->withLpodt(Session::get('lpo_date'))
						->withVatdata($this->vatdata)
						->withSettings($this->acsettings)
						->withFormdata($this->formData)
						->withLocation($location)
						->withPoso(true)
						->withData($data);
		}
		
	}
	
	public function getOrderNo(Request $request) {
		
		if($request->get('search')=='') {
			$result = DB::table('packing_list')->where('status',1)->where('deleted_at','0000-00-00 00:00:00')
						->where('customer_id',$request->get('cid'))
						->where('job_type',0)
						->select('id','voucher_no as text')
						->offset(0)->limit(10)
						->orderBy('id','DESC')
						->get();
		} else {
			$result = DB::table('packing_list')->where('status',1)->where('deleted_at','0000-00-00 00:00:00')
						->where('customer_id',$request->get('cid'))
						->where('job_type',0)
						->where('voucher_no', 'like', '%' . $request->get('search') . '%')
						->select('id','voucher_no as text')
						->offset(0)->limit(10)
						->orderBy('id','DESC')
						->get();
		}
		
		//$data[] = array("id"=>12, "text"=>"AsD");
		echo json_encode($result);
	}
	
	public function getCounter($id) {
		
		$row = DB::table('packing_list')->where('id',$id)->select('voucher_no','jctype')->first();
		echo json_encode($row);
	}
	
	public function getReport($id) {
		
		$result = $this->packing_list->getReportById($id);
		echo '<pre>';print_r($result);exit;
	}

	public function ajaxCustomerList(Request $request)
	{
		$columns = array( 
                            0 =>'account_id', 
                            1 =>'master_name',
                            2=> 'cl_balance',
                            3=> 'op_balance'
                        );
		
		$limit = $request->input('length');
        $start = $request->input('start');
        $order = $columns[$request->input('order.0.column')];
        $dir = $request->input('order.0.dir');
		$search = (empty($request->input('search.value')))?null:$request->input('search.value');
        $dept = $request->input('dept');
		$cat = $request->input('type');
		$arrtype = ['dept' => $dept, 'cat' => $cat];

		$totalFiltered = $totalData = $this->accountmaster->accountMasterList('count', $start, $limit, $order, $dir, $search, $arrtype);
		
		$acmasters = $this->accountmaster->accountMasterList('get', $start, $limit, $order, $dir, $search, $arrtype);
		
		//if($search)
			//$totalFiltered =  $this->accountmaster->accountMasterList('count', $start, $limit, $order, $dir, $search, $dept);
		
	$data = array();
	if(!empty($acmasters))
	{
		foreach ($acmasters as $row)
		{
			
			$rid = $row->id;
			$nestedData['id'] = $row->id;
			$nestedData['account_id'] = "<a href='' class='custRow' data-id='".$row->id."' data-name='".$row->master_name."' data-clbalance='".number_format($row->cl_balance,2)."' data-pdc='".number_format($row->pdc_amount,2)."' data-crlimit='".number_format($row->credit_limit,2)."' data-groupid='".$row->account_group_id."' data-trnno='".$row->vat_no."' data-group='".$row->category."' data-term='".$row->terms_id."' data-dismiss='modal'>".$row->account_id."</a>";
			$nestedData['master_name'] = "<a href='' class='custRow' data-id='".$row->id."' data-name='".$row->master_name."' data-clbalance='".number_format($row->cl_balance,2)."' data-pdc='".number_format($row->pdc_amount,2)."' data-crlimit='".number_format($row->credit_limit,2)."' data-groupid='".$row->account_group_id."' data-trnno='".$row->vat_no."' data-group='".$row->category."' data-term='".$row->terms_id."' data-dismiss='modal'>".$row->master_name."</a>";
			$nestedData['cl_balance'] = $row->cl_balance;
			$nestedData['op_balance'] = $row->op_balance;
			
			$data[] = $nestedData;

		}
	}
          
        $json_data = array(
                    "draw"            => intval($request->input('draw')),  
                    "recordsTotal"    => intval($totalData),  
                    "recordsFiltered" => intval($totalFiltered), 
                    "data"            => $data   
                    );
            
        echo json_encode($json_data);
	
	}

	public function getAccount($type=null)
	{
		$data = array();
		$accounts = $this->accountmaster->getAccountByGroup($type);
		return view('body.packinglist.account')
					->withAccount($accounts)
					->withData($data);
	}
}

